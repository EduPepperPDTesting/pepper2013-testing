<%! from django.utils.translation import ugettext as _ %>

<%!
from django.core.urlresolvers import reverse
from courseware.courses import course_image_url, get_course_about_section
from courseware.access import has_access
from certificates.models import CertificateStatuses
from xmodule.modulestore import MONGO_MODULESTORE_TYPE
from xmodule.modulestore.django import modulestore
import json
from administration.models import CustomEmail
from student.models import State,District,School,Cohort,User,UserProfile
from permissions.utils import check_user_perms
%>

<%
import os
workdir = os.getcwd()
base_path = workdir + '/lms/templates/emails/'
subject_path = base_path + 'activation_email_subject.txt'
email_path = base_path + 'activation_email.txt'
f = open(subject_path, 'r')
subject_to_edit = f.read()
f.close()
f = open(email_path, 'r')
email_to_edit = f.read()
f.close()
%>

<%inherit file="../main.html"/>
<script type="text/javascript" src="/static/js/ckeditor/ckeditor.js" charset="utf-8"></script>
<script type="text/javascript" src="/static/js/admin_ui_controls.js"></script>
<script type="text/javascript" src="/static/js/jquery-blink.js"></script>
<script type="text/javascript" src="/static/js/tablesorter/js/jquery.tablesorter.js"></script>
<script type="text/javascript" src="/static/js/tablesorter/js/extras/jquery.tablesorter.pager.min.js"></script>
<script type="text/javascript" src="/static/js/tablesorter/js/widgets/widget-filter.min.js"></script>
<script type="text/javascript" src="/static/js/tablesorter/js/widgets/widget-storage.min.js"></script>
<script type="text/javascript" src="/static/js/tablesorter/js/widgets/widget-output.min.js"></script>
<link rel="stylesheet" href="/static/css/admin_ui_controls.css" type="text/css" media="screen" />
<link rel = "stylesheet" href = "/static/css/pepconn.css" type = "text/css" media = "screen"/>
<link rel = "stylesheet" href = "/static/js/tablesorter/css/theme.blue.min.css" media="screen"/>
<link rel = "stylesheet" href = "/static/js/tablesorter/css/jquery.tablesorter.pager.min.css" media = "screen" />
<!-- User Data Import -->
<div class="data_import_top">
  <div class="main, data_import_content">
    <div class="expand_title expand_title_collapse">
      Data Import <div class="icon"></div>
    </div>

      <div class="expand_div">
        <a href="#" onclick="toggle('district')" class="district-button"><div class="section-tab district">Districts</div></a>
        <a href="#" onclick="toggle('school')" class="school-button"><div class="section-tab school">Schools</div></a>
        <a href="#" onclick="toggle('user')" class="user-button"><div class="section-tab user">Users</div></a>
        <a href="#" onclick="toggle('cohort')" class="cohort-button"><div class="section-tab cohort">Cohorts</div></a>
        <div class="district-section import-section">
            <form method="" id="districtDataImportForm" action="">

                <div style="padding: 1em 7px 7px 7px;">
                    CSV File: <input name="file" value="" type="file">

                    <p style="margin-top:1em;"><label style="font-style:normal;color:#555;">* CSV file should
                        contain the following columns (District ID, District Name, State).</label></p>

                </div>
                <div style="padding:10px 5px">
                    <input class="form_submit" name="" value="Import Districts" type="submit">
                    <div class="add-area" onclick="$('#singleDistrictForm').slideToggle()">Add Single <span>[+]</span></div>
                </div>
            </form>
            <div id="singleDistrictForm" style="display:none">
                <form method="post" id="singleDistrictImportForm" action="${reverse('pepconn_single_district_submit')}">
                    <input type="hidden" name="csrfmiddlewaretoken" value="${csrf_token}">

                    <div style="padding: 1em 7px 7px 7px;">
                        <label class="label required">District ID:<br/>
                            <input name="id" value="" chkmsg="District ID can't be empty." chktype="Require" type="">
                        </label><br/>
                        <label class="label">State:<br/>
                            <select id="state" name="state_id" autocomplete="off" chkmsg="You must select a state." chktype="Require">
                          <option value=""></option>
                          %for item in State.objects.all().order_by('name'):
                          <option value="${item.id}">${item.name}</option>
                          %endfor
                        </select>
                        </label><br/>
                        <label class="label required">District Name:<br/>
                                <input name="name" value="" chkmsg="District Name can't be empty." chktype="Require" type="">
                        </label><br/>
                    </div>
                    <div style="padding:10px 5px">
                        <input class="form_submit" name="" value="Create District" type="submit">
                    </div>
                </form>
            </div>
        </div><span style="display:none" id="cohort_select"><select class="cohort_selector"><option value=""></option>
        %for item in Cohort.objects.all().order_by('code'):
            <option value="${item.id}">${item.code}</option>
        %endfor
      </select></span>
        <span class = 'hidden' id="sso_select">
            <select id = "sso_idp_select_box"></select><p></p>
            Select SSO Type:<select id = "sso_type_select_box">
                <option value = ""></option>
                <option value = "EasyIEP">EasyIEP</option>
                <option value = "OAuth2">OAuth2</option>
                <option value = "SAML">SAML</option>
            </select>
        </span>
        <div class="school-section import-section">
            <form method="" id="schoolDataImportForm" action="">
                <div style="padding: 1em 7px 7px 7px;">
                    CSV File: <input name="file" value="" type="file">

                    <p style="margin-top:1em;"><label style="font-style:normal;color:#555;">* CSV file should
                        contain the following column (School Name, School Code, State, District ID).</label></p>

                </div>
                <div style="padding:10px 5px">
                    <input class="form_submit" name="" value="Import Schools" type="submit">
                     <div class="add-area" onclick="$('#singleSchoolForm').slideToggle()">Add Single <span>[+]</span></div>
                </div>

            </form>
            <div id="singleSchoolForm" style="display:none">
                <form method="post" id="singleSchoolImportForm" action="${reverse('pepconn_single_school_submit')}">
                    <input type="hidden" name="csrfmiddlewaretoken" value="${csrf_token}">

                    <div style="padding: 1em 7px 7px 7px;">
                        <label class="label required">School Code:<br/>
                            <input name="id" value="" chkmsg="School Code can't be empty." chktype="Require" type="">
                        </label><br/>
                        <label class="label required">School Name:<br/>
                            <input name="name" value="" chkmsg="School Name can't be empty." chktype="Require" type="">
                        </label><br/>
                        <label class="label">State:<br/>
                            <select id="state_single" name="state_id" autocomplete="off">
                                <option value="" class="null_case"></option>
                                %for item in State.objects.all().order_by('name'):
                                    <option class="${item.id}" value="${item.id}">${item.name}</option>
                                %endfor
                            </select>
                        </label><br/>
                        <label class="label required">District ID:<br/>
                            <select id="district_id_single" name="district_id" autocomplete="off" chkmsg="You must select a district." chktype="Require">

                            </select>
                        </label><br/>
                    </div>
                    <div style="padding:10px 5px">
                        <input class="form_submit" name="" value="Create School" type="submit">
                    </div>
                </form>
            </div>
        </div>


    <div class="user-section import-section">
      <form method="" id="userDataImportForm" action="">
        <!--
        <div class="control filter">
          <textarea class="setting">
            {
            "fields":{
            "state":{"display":"State","type":"drop","require":[],"url":"${reverse('pepconn_drop_states')}","format":"<option value='{id}'>{name}</option>"},
            "district":{"display":"District","type":"drop","require":["state"],"url":"${reverse('pepconn_drop_districts')}","format":"<option value='{id}'>{name}</option>"},
            "school":{"display":"School","type":"drop","require":["district"],"url":"${reverse('pepconn_drop_schools')}","format":"<option value='{id}'>{name}</option>"}
            },
            "favorite":{
               "show":true,
               "urls":{
                  "load":"${reverse('pepconn_favorite_filter_load')}",
                  "save":"${reverse('pepconn_favorite_filter_save')}",
                  "remove":"${reverse('pepconn_favorite_filter_delete')}"
                }
            }
            }
          </textarea>
          <span class="body" style="display:inline-block;"></span>
        </div>
         -->
        <ul class="list">
          <li>
            <label>
              <input type="checkbox" class="send-email" name="send_registration_email" value="true" autocomplete="off"/>
              Send registration emails to imported users
            </label>
          </li>
          <li class="customize-email">
            <label style="cursor: pointer !important;">
              <input class="custom-email-checkbox" id="cec-1" type="checkbox" name="customize_email" value="true" autocomplete="off"/>
              Customize registration email
            </label>
          </li>
          <%include file="custom_email.html" args="subject_to_edit=subject_to_edit,email_to_edit=email_to_edit,ck_name='custom_email_001'" />
        </ul>
        <div style="padding:7px;">
          <span style="float: right;margin-right: 525px;margin-top: -8px;">
              <button style="display:none;" id="delete-email-1">Delete Email</button>
              <button style="display:none;" id="save-email-1">Save Email</button>
          </span>
          CSV File: <input type="file" name="file" value="" />
          <p style="margin-top:1em;">
            <label style="font-style:normal;color:#555;cursor:default;">
            * CSV file should contain the following columns (email address, state, district).
            </label>
          </p>
        </div>
        <div style="padding:10px 5px">
          <input class="form_submit" type="submit" name="" value="Import Users" />
        <div class="add-area" onclick="$('#singleUserForm').slideToggle()">Add Single <span>[+]</span></div>
      </div>
    </form>
        <div id="singleUserForm" style="display:none">
            <form method="post" id="singleUserImportForm" action="${reverse('pepconn_single_user_submit')}">
                <ul class="list">
                  <li>
                    <label>
                      <input type="checkbox" class="send-email" name="send_registration_email" value="true" autocomplete="off"/>
                      Send registration emails to imported users
                    </label>
                  </li>
                  <li class="customize-email">
                    <label style="cursor: pointer !important;">
                      <input class="custom-email-checkbox" id="cec-3" type="checkbox" name="customize_email" value="true" autocomplete="off"/>
                      Customize registration email
                    </label>
                  </li>
                  <%include file="custom_email.html" args="subject_to_edit=subject_to_edit,email_to_edit=email_to_edit,ck_name='custom_email_003'" />
                </ul>
                <input type="hidden" name="csrfmiddlewaretoken" value="${csrf_token}">

                <div style="padding: 1em 7px 7px 7px;">
                    <span style="float: right;margin-right: 525px;margin-top: -8px;">
                        <button style="display:none;" id="delete-email-3">Delete Email</button>
                        <button style="display:none;" id = "save-email-3">Save Email</button>
                    </span>
                    <label class="label">State:<br/>
                        <select id="user_state_single" name="state" autocomplete="off" chkmsg="You must select a state." chktype="Require">
                            <option class="null_case" value=""></option>
                            %for item in State.objects.all().order_by('name'):
                                <option class="${item.id}" value="${item.id}">${item.name}</option>
                            %endfor
                    </select>
                    </label><br/>
                    <label class="label required">District:<br/>
                        <select id="user_district_id" name="district" autocomplete="off" chkmsg="You must select a district." chktype="Require">

                        </select>
                    </label><br/>
                    <label class="label required">E-Mail:<br/>
                        <input name="email" value="" chkmsg="E-Mail can't be empty." chktype="Require" type="">
                    </label><br/>
                </div>
                <div style="padding:10px 5px">
                    <input class="form_submit" name="" value="Create User" type="submit">
                </div>
            </form>
        </div>
    </div>
    <div class="cohort-section import-section">
        <form method="post" id="cohortImportForm" action="${reverse('pepconn_cohort_submit')}">
            <input type="hidden" name="csrfmiddlewaretoken" value="${csrf_token}">
            <input type="hidden" name="id" value="" />
            <div style="padding: 1em 7px 7px 7px;">
                <label class="label required">Cohort ID:<br/>
                    <input name="code" value="" chkmsg="Cohort ID can't be empty." chktype="Require" type="">
                </label><br/>
                <label class="label">State:<br/>
                    <select id="cohort_state_single" name="state_id" autocomplete="off">
                        <option class="null_case" value=""></option>
                        %for item in State.objects.all().order_by('name'):
                            <option class="${item.id}" value="${item.id}">${item.name}</option>
                        %endfor
                    </select>
                </label><br/>
                <label class="label required">District:<br/>
                    <select id="cohort_district_id" name="district_id" autocomplete="off" chkMsg="District can't be empty." chkType="Require">

                    </select>
                </label><br/>
                <label class="label required">Licences:<br/>
                        <input name="licences" value="" chkmsg="Licences must be a number." chktype="Number" type="">
                </label><br/>
                <label class="label required">Term Months:<br/>
                        <input name="term_months" value="12" chkmsg="Term Months must be a number." chktype="Number" type="">
                </label><br/>
                <label class="label required">Start Date:<br/>
                        <input id="start_date" name="start_date" value="" chkmsg="Start Date is invalid." chktype="Date">
                        <span style="color:#999;">Format: YYYY-MM-DD.</span>
                </label>
            </div>
            <div style="padding:10px 5px">
                <input class="form_submit" name="" value="Create Cohort" type="submit">
            </div>
        </form>
    </div>

  </div>
</div>
<span id="organization_obj" o_name="pepconn"></span>
<div class="data_import_bottom">
  <div class="main, data_import_content">
    <div class="expand_title expand_title_collapse">
      Management & Reporting <div class="icon"></div>
    </div>
    <div class="expand_div">
          <a href="#" onclick="toggle2('district_table'); return false;" class="district-button"><div class="table-tab district district_table">Districts</div></a>
          <a href="#" onclick="toggle2('school_table'); return false;" class="school-button"><div class="table-tab school school_table">Schools</div></a>
          <a href="#" onclick="toggle2('user_table'); return false;" class="user-button"><div class="table-tab user user_table">Users</div></a>
          <a href="#" onclick="toggle2('cohort_table'); return false;" class="cohort-button"><div class="table-tab cohort cohort_table">Cohorts</div></a><br>

    <div class="district_table-section table-section">
        <div class="add-area" onclick="$('#filterArea').slideToggle()">
            FILTER
        </div>
        <div class="filter" style="padding:10px 5px; border: 1px solid #ddd; border-width: 1px 0; height:auto;">
            <div id="filterArea">

                <select type="search" data-column="2" class="search-districts" id="District_state_select">
                  <option value="" selected class="select-option" class="null_case">Select State</option>
                  %for item in State.objects.all().order_by('name'):
                  <option class="${item.id}" value="${item.name}">${item.name}</option>
                  %endfor
                </select>

                <input id="District_search" placeholder="Search District" class="search-districts" type="search" data-column="1">
                <img onclick="openBookmark('District')" class="bookmark_icon" src="/static/images/bookmark.png"><br><br>
                <span onclick="$('#district-select').slideToggle();" class="select-add-area"><b>Select Columns</b></span>
                <span class="selectall"><input type="checkbox" id="selectalldistrict" name="district">&nbsp<span><b>Select All</b></span></span>
                <div  class="select-columns" id="district-select"><br>
                <input type="checkbox" checked onchange="$('.district_code').toggle();"><label><i>District ID</i></label><br>
                <input type="checkbox" checked onchange="$('.district_name').toggle();"><label><i>District Name</i></label><br>
                <input type="checkbox" checked onchange="$('.district_state_name').toggle();"><label><i>State</i></label><br>
                </div>
                </div>
        </div>
        <div>
            <table class="tablesorter-blue" id="district_table_init">
                <thead>
                    <tr>
                        <th class="district_code">District Id</th>
                        <th class="district_name">District Name</th>
                        <th class="district_state_name">State</th>
                        <th data-sorter="false"></th>
                    </tr>
                </thead>
                <tbody id="district_data_tbody">
                </tbody>
            </table>
        </div>

        <span id="district-pager" class="pager">
          <form>
            <img src="/static/js/tablesorter/css/images/first.png" class="first"/>
            <img src="/static/js/tablesorter/css/images/prev.png" class="prev"/>
            <span class="pagedisplay"></span> <!-- this can be any element, including an input -->
            <img src="/static/js/tablesorter/css/images/next.png" class="next"/>
            <img src="/static/js/tablesorter/css/images/last.png" class="last"/>
            <select class="pagesize">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
            </select>
          </form>
        </span><hr>
        <span class="download">
          Download Districts:
          <input type="button" name="" value="Download CSV" class="small" id="downloadDistrictCSV"/>
          <input type="button" name="" value="Download Excel" class="small" id="downloadDistrictXLS"/>
          <input type="button" value="Delete Selected Districts" class ="small" style="float:right" id="delete_selected_districts"/>
        </span>
    </div>
    <div class="school_table-section table-section">
        <div class="add-area" onclick="$('#filterArea2').slideToggle()">
            FILTER
        </div>
        <div class="filter" style="padding:10px 5px; border: 1px solid #ddd; border-width: 1px 0; height:auto;">
            <div id="filterArea2">
                <select type="search" class="search-schools" data-column="4" id="School_state_select">
                    <option value="" class="null_case">Select State</option>
                    %for item in State.objects.all().order_by("name"):
                        <option class="${item.id}" value="${item.name}">${item.name}</option>
                    %endfor
                </select>
                <select type="search" class="search-schools" data-column="2" id="School_district_select">

                </select>

                <input placeholder="Search Schools" class="search-schools" type="search" data-column="1" id="School_search">
                <img onclick="openBookmark('School')" class="bookmark_icon" src="/static/images/bookmark.png"><br><br>
                <span onclick="$('#school-select').slideToggle();" class="select-add-area"><b>Select Columns</b></span>
                <span class="selectall"><input type="checkbox" id="selectallschool" name="district">&nbsp<span><b>Select All</b></span></span>
                <div id="school-select" class="select-columns"><br>
                <input type="checkbox" checked onchange="$('.school_code').toggle();"><label><i>School Code</i></label><br>
                <input type="checkbox" checked onchange="$('.school_name').toggle();"><label><i>School Name</i></label><br>
                <input type="checkbox" checked onchange="$('.school_district_id').toggle();"><label><i>District</i></label><br>
                <input type="checkbox" checked onchange="$('.school_district_two').toggle();"><label><i>District ID</i></label><br>
                <input type="checkbox" checked onchange="$('.school_state').toggle();"><label><i>State</i></label><br>
                </div>

            </div>
        </div>
        <div>
            <table class="tablesorter-blue" id="school_table_init">
                <thead>
                    <tr>
                        <th class="school_code">School Code</th>
                        <th class="school_name">School Name</th>
                        <th class="school_district_id">District</th>
                        <th class="school_district_two">District ID</th>
                        <th class="school_state">State</th>
                        <th data-sorter="false"></th>
                    </tr>
                </thead>
                <tbody id="school_data_tbody">
                </tbody>
            </table>
        </div>

        <span id="school-pager" class="pager">
          <form>
            <img src="/static/js/tablesorter/css/images/first.png" class="first"/>
            <img src="/static/js/tablesorter/css/images/prev.png" class="prev"/>
            <span class="pagedisplay"></span> <!-- this can be any element, including an input -->
            <img src="/static/js/tablesorter/css/images/next.png" class="next"/>
            <img src="/static/js/tablesorter/css/images/last.png" class="last"/>
            <select class="pagesize">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
            </select>
          </form>
        </span><hr>
        <span class="download">
          Download Districts:
          <input type="button" name="" value="Download CSV" class="small" id="downloadSchoolCSV"/>
          <input type="button" name="" value="Download Excel" class="small" id="downloadSchoolXLS"/>
          <input type="button" value="Delete Selected Schools" class ="small" style="float:right" id="delete_selected_schools"/>
        </span>
    </div>

    <div class="user_table-section table-section">
        <div class="add-area" onclick="$('#filterArea2').slideToggle()">
            FILTER
        </div>
        <div class="filter" style="padding:10px 5px; border: 1px solid #ddd; border-width: 1px 0; height:auto;">
            <div id="filterArea2">
                <select type="search" class="search-users" data-column="6" id="User_state_select">
                    <option value="" class="null_case">Select State</option>
                    %for item in State.objects.all().order_by('name'):
                        <option class="${item.id}" value="${item.name}">${item.name}</option>
                    %endfor
                </select>
                <select type="search" class="search-users" data-column="4" id="User_district_select">
                </select>
                <select type="search" class="search-users" data-column="3" id="User_school_select">
                </select>
                <select type="search" class="search-users" data-column="10" id="User_registration_select">
                    <option value="" class="null_case">Select Registration Status</option>
                    <option value="Registered">Registered</option>
                    <option value="Unregistered">Unregistered</option>
                    <option value="Imported">Imported</option>
                    <option value="Inactive">Inactive</option>
                </select>
                <input placeholder="Search by Last Name" class="search-users" type="search" data-column="1" id="User_search_last">
                <input placeholder="Search by First Name" class="search-users" type="search" data-column="2" id="User_search_first">
                <input placeholder="Search by Cohort" class="search-users" type="search" data-column="5" id="User_search_cohort">
                <input placeholder="Search by Email" class="search-users" type="search" data-column="7" id="User_search_email">
                <!--<input placeholder="Search All" class="search-users" type="search" data-column="all" id="User_search">-->
                <img onclick="openBookmark('User')" class="bookmark_icon" src="/static/images/bookmark.png"><br><br>
                <span onclick="$('#user-select').slideToggle();" class="select-add-area"><b>Select Columns</b></span>
                <span class="selectall"><input type="checkbox" id="selectalluser" name="district">&nbsp<span><b>Select All</b></span></span>
                <div class="select-columns" id="user-select"><br>
                <input type="checkbox" checked onchange="$('.user_id_select').toggle();"><label><i>User ID</i></label><br>
                <input type="checkbox" checked onchange="$('.user_lname').toggle();"><label><i>Last Name</i></label><br>
                <input type="checkbox" checked onchange="$('.user_fname').toggle();"><label><i>First Name</i></label><br>
                <input type="checkbox" checked onchange="$('.user_email').toggle();"><label><i>E-Mail</i></label><br>
                <input type="checkbox" checked onchange="$('.user_sso_type').toggle();"><label><i>SSO Type</i></label><br>
                <input type="checkbox" checked onchange="$('.user_sso_idp').toggle();"><label><i>SSO IDP</i></label><br>
                <input type="checkbox" checked onchange="$('.user_school').toggle();"><label><i>State</i></label><br>
                <input type="checkbox" checked onchange="$('.user_school').toggle();"><label><i>School</i></label><br>
                <input type="checkbox" checked onchange="$('.user_district').toggle();"><label><i>District</i></label><br>
                <input type="checkbox" checked onchange="$('.user_cohort').toggle();"><label><i>Cohort</i></label><br>
                <input type="checkbox" checked onchange="$('.user_registration').toggle();"><label><i>Registration Status</i></label><br>
                <input type="checkbox" checked onchange="$('.user_enrollment_status').toggle();"><label><i>Enrollment Status</i></label><br>
                </div>
            </div>
        </div>
        <div>
            <table class="tablesorter-blue" id="user_table_init">
                <thead>
                    <tr>
                      <th class="user_id_select">ID</th>
                      <th class="user_lname">Last Name</th>
                      <th class="user_fname">First Name</th>
                      <th class="user_school">School</th>
                      <th class="user_district">District</th>
                      <th class="user_cohort">Cohort</th>
                      <th class="user_state">State</th>
                      <th class="user_email">E-Mail</th>
                      <th class="user_sso_type">SSO Type</th>
                      <th class="user_sso_idp">SSO IDP</th>
                      <th class="user_registration">Registration Status</th>
                      <th class="user_activation_link" data-sorter="false">Activation Link</th>
                      <th class="user_enrollment_status">Enrollment Start</th>
                      <th data-sorter="false"></th>
                    </tr>
                </thead>
                <tbody id="user_data_tbody">
                </tbody>
            </table>
        </div>

        <span id="user-pager" class="pager">
          <form>
            <img src="/static/js/tablesorter/css/images/first.png" class="first"/>
            <img src="/static/js/tablesorter/css/images/prev.png" class="prev"/>
            <span class="pagedisplay"></span> <!-- this can be any element, including an input -->
            <img src="/static/js/tablesorter/css/images/next.png" class="next"/>
            <img src="/static/js/tablesorter/css/images/last.png" class="last"/>
            <select class="pagesize">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
            </select>
          </form>
        </span><hr>
        <span class="download">
          Download Users:
          <input type="button" name="" value="Download CSV" class="small" id="downloadUserCSV"/>
          <input type="button" name="" value="Download Excel" class="small" id="downloadUserXLS"/>
        </span>
        <span style="float:right">
            <input type="button" value="Delete Users" style="padding-right:10px;" class="small" id="delete_selected_user"/>
            <input type="button" value="Send Registration Mail" class="small" id="register_selected_user"/>
            <input type="button" name="" onclick="addToSSO()" style="padding-left:10px;" value="Edit SSO" class="small" id="userAddToSSO"/>
            <input type="button" name="" onclick="addToCohort()" style="padding-left:10px;" value="Add To Cohort" class="small" id="userAddToCohort"/>
            <input type="button" name="" onclick="removeFromCohort()" style="padding-left:10px;" value="Remove From Cohort" class="small" id="userRemoveFromCohort"/>
        </span>
        <ul class="list" id="user_table_custom_email_form">
          <li>
            <label>
              <input style="display:none" type="checkbox" class="send-email" name="send_registration_email" value="true" autocomplete="off"/>
            </label>
          </li>
          <li class="customize-email" style="display: list-item">
            <label style="cursor: normal !important; float: right;">
              <input  class="custom-email-checkbox" id="cec-2" type="checkbox" name="customize_email" value="true" autocomplete="off"/>
              Customize registration email
            </label>
          </li>
          <%include file="custom_email.html" args="subject_to_edit=subject_to_edit,email_to_edit=email_to_edit,ck_name='custom_email_002'"/>
        </ul>
        <span style="float: right;margin-right: 525px;margin-top: -8px;">
            <button style="display:none;" id="delete-email-2">Delete Email</button>
            <button style="display:none;" id="save-email-2">Save Email</button>
        </span>
    </div>
    <div class="cohort_table-section table-section">
        <div class="add-area" onclick="$('#filterArea3').slideToggle()">
            FILTER
        </div>
        <div class="filter" style="padding:10px 5px; border: 1px solid #ddd; border-width: 1px 0; height:auto;">
            <div id="filterArea3">
                <select type="search" class="search-cohorts" data-column="6" id="Cohort_state_select">
                    <option value="" class="null_case">Select State</option>
                    %for item in State.objects.all().order_by('name'):
                        <option class="${item.id}" value="${item.name}">${item.name}</option>
                    %endfor
                </select>
                <select type="search" class="search-cohorts" data-column="4" id="Cohort_district_select">

                </select>
                <input placeholder="Search Cohorts" class="search-cohorts" type="search" data-column="0" id="Cohort_search">
                <img onclick="openBookmark('Cohort')" class="bookmark_icon" src="/static/images/bookmark.png"><br><br>
                <span onclick="$('#cohort-select').slideToggle();" class="select-add-area"><b>Select Columns</b></span>
                <span class="selectall"><input type="checkbox" id="selectallcohort" name="district">&nbsp<span><b>Select All</b></span></span>
                <div id="cohort-select" class="select-columns"><br>
                <input type="checkbox" checked onchange="$('.cohort_id').toggle();"><label><i>Cohort ID</i></label><br>
                <input type="checkbox" checked onchange="$('.cohort_license').toggle();"><label><i>Liscenses</i></label><br>
                <input type="checkbox" checked onchange="$('.cohort_term').toggle();"><label><i>Term Months</i></label><br>
                <input type="checkbox" checked onchange="$('.cohort_start').toggle();"><label><i>Subscription Start Date</i></label><br>
                </div>
            </div>
        </div>
        <div>
            <table class="tablesorter-blue" id="cohort_table_init">
                <thead>
                    <tr>
                        <th class="cohort_id">Cohort ID</th>
                        <th class="cohort_license">Licences</th>
                        <th class="cohort_term">Terms Months</th>
                        <th class="cohort_start">Subscription Start Date</th>
                        <th class="cohort_district_name">District Name</th>
                        <th class="cohort_district_code">District Code</th>
                        <th class="cohort_state">State</th>
                        <th data-sorter="false"></th>
                    </tr>
                </thead>
                <tbody id="cohort_data_tbody">
                </tbody>
            </table>
        </div>
        <span id="cohort-pager" class="pager">
          <form>
            <img src="/static/js/tablesorter/css/images/first.png" class="first"/>
            <img src="/static/js/tablesorter/css/images/prev.png" class="prev"/>
            <span class="pagedisplay"></span> <!-- this can be any element, including an input -->
            <img src="/static/js/tablesorter/css/images/next.png" class="next"/>
            <img src="/static/js/tablesorter/css/images/last.png" class="last"/>
            <select class="pagesize">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
            </select>
          </form>
        </span><hr>
        <span class="download">
          Download Cohorts:
          <input type="button" name="" value="Download CSV" class="small" id="downloadCohortCSV"/>
          <input type="button" name="" value="Download Excel" class="small" id="downloadCohortXLS"/>
          <input type="button" value="Delete Selected Cohorts" class ="small" style="float:right" id="delete_selected_cohort"/>
        </span>
    </div><br><br>
    </div>
    <!-- Course Permissions -->
    <style type="text/css" media="screen">
     .filters-menu>li{display:inline-block;color:#1564F6;cursor:pointer;}
     .filters-menu>li.active{display:inline-block;color:#72BB53;text-decoration:underline;}
     .filters-submenu{
       display:none;
     }
     .filters-submenu>li{
       display:inline-block;
       background:#2196F3;
       padding:10px;
       margin-right:10px;
       margin-bottom:10px;
       color:#fff;
       cursor:pointer;
       border:5px solid #fff0;
     }
     .filters-submenu>li.active{
       border:5px solid #555;
     }
     .course-perm-sub-title{
       cursor:pointer;
     }
    </style>    
    <script type="text/javascript" src="/static/js/multi-sele-dropdown/multi-sele-dropdown.js"></script>
    <link rel="stylesheet" href="/static/js/multi-sele-dropdown/css/default.css" type="text/css" media="screen" />
    <div class="expand_title expand_title_collapse">
      Course Permissions <div class="icon"></div>
    </div>
    <div class="expand_div">
      <section id="course_permission_user_table">
        <h2 style="margin:20px;font-weight:bold;text-transform:none;font-size:24px;" class="course-perm-sub-title">View Access / Select Users</h2>
        <div style="display:none;">
        <div class="" style="height:120px;padding:20px;">
          % if check_user_perms(request.user, access_level='System'):
          <select id="lst-user-filter-state" name="" autocomplate="off" class="mu" label="State">
            % for item in State.objects.all().order_by('name'):
            <option class="${item.id}" value="${item.id}">${item.name}</option>
            % endfor
          </select>
          % endif
          % if check_user_perms(request.user, access_level='System'):
          <select id="lst-user-filter-district" name="" autocomplate="off" class="mu" label="District">
          </select>
          % elif check_user_perms(request.user, access_level='State'):
          ${request.user.profile.district.state.name}
          <select id="lst-user-filter-district" name="" autocomplate="off" class="mu" label="District">
          % for item in District.objects.filter(state=request.user.profile.district.state):
            <option value="${item.id}">${item.name}</option>
          % endfor
          </select>
          % endif
          % if check_user_perms(request.user, access_level='District'):
          <select id="lst-user-filter-school" name="" autocomplate="off" class="mu" label="School">
          </select>
          % endif
        </div>
        % if check_user_perms(request.user, access_level='System'):
        <div style="reset:all;text-align:right;padding-right:20px;">
          <input id="btnCoursePermCsvLoad" type="button" name="" value="Bulk CSV Load" style="background:#DFEDD6;"/>
          <input type="file" name="" value="" style="display:none;"/>
        </div>
        % endif
        <ul style="padding:10px;font-size:28px;" class="filters-menu">
          <li id="filters-subject" class="active">Subject</li> |
          <li id="filters-author">Author</li> |
          <li id="filters-grade">Grade Level</li>
        </ul>
        <ul class="filters-submenu" id="filters-subject-submenu">
          <li data-value="AR">Assessments and Reporting</li>
          <li data-value="DC">Digital Citizenship</li>
          <li data-value="ELA">English Language Arts</li>
          <li data-value="ELL">English Language Learners</li>
          <li data-value="MA">Mathematics</li>
          <li data-value="PEP">Pepper</li>
          <li data-value="POW">Pepper's Online Workshops!</li>
          <li data-value="SC">Science</li>
          <li data-value="SE">Special Education</li>
          <li data-value="TCH">Teacher ToolKit</li>
          <li data-value="TECH">Technology</li>
          <li data-value="ARTS">Visual & Performing Arts</li>
          <li data-value="WR">Writing and Poetry</li>  
        </ul>
        <ul class="filters-submenu" id="filters-author-submenu">
          <li data-value="A.L.L.">Accelerated Literacy Learning (A.L.L.)</li>
          <li data-value="CHADD">CHADD</li>
          <li data-value="Common Sense Education">Common Sense Education</li>
          <li data-value="CT Core Standards">CT Core Standards</li>
          <li data-value="Manteca Unified School District">Manteca Unified School District</li>
          <li data-value="Media Power Youth">Media Power Youth</li>
          <li data-value="O'Neill Sea Odyssey">O'Neill Sea Odyssey</li>
          <li data-value="Oklahoma SDE">Oklahoma SDE</li>
          <li data-value="PCG Education">PCG Education</li>
          <li data-value="SEADAE">SEADAE</li>
          <li data-value="Understanding Language Initiative at Stanford">Understanding Language Initiative at Stanford</li>
          <li data-value="WestEd">WestEd</li>                  
        </ul>
        <ul class="filters-submenu" id="filters-grade-submenu">
          <li data-value="PreK-3">PreK-3</li>
          <li data-value="K-5">K-5</li>
          <li data-value="6-8">6-8</li>
          <li data-value="K-12">K-12</li>
          <li data-value="9-12">9-12</li>
        </ul>        
        <div style="text-align: right;padding:20px;"> <input id="btnUserLoad" type="button" name="" value="Load" style="background:#2E7D32;color:#fff;"/> </div>
        <div style="padding:10px;" id="course_permission_user">
          <table class="tablesorter-blue">
            <thead>
              <tr>
                <th class="id">Select Users to Edit Access <input type="checkbox" class="check-all"/></th>
                <th class="first_name">First Name</th>
                <th class="last_name">Last Name</th>
                <th class="email">Email</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="">
            <span class="pager">
              <form>
                <img src="/static/js/tablesorter/css/images/first.png" class="first"/>
                <img src="/static/js/tablesorter/css/images/prev.png" class="prev"/>
                <span class="pagedisplay"></span> <!-- this can be any element, including an input -->
                <img src="/static/js/tablesorter/css/images/next.png" class="next"/>
                <img src="/static/js/tablesorter/css/images/last.png" class="last"/>
                <select class="pagesize">
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                  <option value="200">200</option>
                </select>
              </form>
            </span>
          </div>
          <p style="padding:20px;"><input type="button" id="btnCoursePermDownloadExcel" value="Export to Excel" style="background:#2E7D32;color:#fff;"/></p>
        </div>
        </div>
      </section>
      
      <section id="course_permission_course">
        <h2 style="margin:20px;font-weight:bold;text-transform:none;font-size:24px;" class="course-perm-sub-title">Select Courses, Access Level and Notifications</h2>
        <div style="display:none">
        <div class="" style="height:120px;padding:20px;display:none;">
          <select id="lst-course-filter-subject" name="" autocomplate="off" class="mu" label="Subject">
            <option value="AR">Assessments and Reporting</option>
            <option value="DC">Digital Citizenship</option>
            <option value="ELA">English Language Arts</option>
            <option value="ELL">English Language Learners</option>
            <option value="MA">Mathematics</option>
            <option value="PEP">Pepper</option>
            <option value="POW">Pepper's Online Workshops!</option>
            <option value="SC">Science</option>
            <option value="SE">Special Education</option>
            <option value="TCH">Teacher ToolKit</option>
            <option value="TECH">Technology</option>
            <option value="ARTS">Visual & Performing Arts</option>
            <option value="WR">Writing and Poetry</option>              
          </select>
          
          <select id="lst-course-filter-author" name="" autocomplate="off" class="mu" label="Author">
            <option value="A.L.L.">Accelerated Literacy Learning (A.L.L.)</option>
            <option value="CHADD">CHADD</option>
            <option value="Common Sense Education">Common Sense Education</option>
            <option value="CT Core Standards">CT Core Standards</option>
            <option value="Manteca Unified School District">Manteca Unified School District</option>
            <option value="Media Power Youth">Media Power Youth</option>
            <option value="O'Neill Sea Odyssey">O'Neill Sea Odyssey</option>
            <option value="Oklahoma SDE">Oklahoma SDE</option>
            <option value="PCG Education">PCG Education</option>
            <option value="SEADAE">SEADAE</option>
            <option value="Understanding Language Initiative at Stanford">Understanding Language Initiative at Stanford</option>
            <option value="WestEd">WestEd</option>            
          </select>
          
          <select id="lst-course-filter-grade-level" name="" autocomplate="off" class="mu" label="Grade Level">
            <option value="PreK-3">PreK-3</option>
            <option value="K-5">K-5</option>
            <option value="6-8">6-8</option>
            <option value="K-12">K-12</option>
            <option value="9-12">9-12</option>
          </select>     
          % if check_user_perms(request.user, access_level='System'):
          <select id="lst-course-filter-state" name="" autocomplate="off" class="mu" label="State">
            %for item in State.objects.all().order_by('name'):
            <option class="${item.id}" value="${item.id}">${item.name}</option>
            %endfor
          </select>
          <select id="lst-course-filter-district" name="" autocomplate="off" class="mu" label="District">
          </select>
          % endif
      
        </div>
        <div style="text-align: right;padding:20px;"><input id="btnCourseLoad" type="button" name="" value="Load" style="background:#2E7D32;color:#fff;"/></div>
        <div style="padding:10px;">
          <table class="tablesorter-blue">
            <thead>
              <tr>
                <th class="">Subject</th>
                <th class="">Author</th>
                <th class="">Grade Level</th>
                <th class="">Course Name</th>
                <th class="">Access</th>
                <th class="">Enrollment</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="">
            <span class="pager">
              <form>
                <img src="/static/js/tablesorter/css/images/first.png" class="first"/>
                <img src="/static/js/tablesorter/css/images/prev.png" class="prev"/>
                <span class="pagedisplay"></span> <!-- this can be any element, including an input -->
                <img src="/static/js/tablesorter/css/images/next.png" class="next"/>
                <img src="/static/js/tablesorter/css/images/last.png" class="last"/>
                <select class="pagesize">
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                  <option value="200">200</option>
                </select>
              </form>
            </span>
          </div>
        </div>
        <p style="text-align:right;margin-right:20px;"><input type="button" name="" value="Save" id="btnSave" style="background:#2E7D32;color:#fff;"></p>
        <p style="text-align:right;margin-right:20px;"><input type="button" name="" value="Save & Send Notification" id="btnSaveSend" style="background:#2E7D32;color:#fff;"></p>
        </div>
      </section>
      <!-- end of course permission -->
    </div>
  </div>
</div>

<style>
 .toggle{
   width:54px;
   height:24px;
   display:inline-block;
   background:#ED1C24;
   border-radius:10px;
 }
 .toggle:before{
   content:"";
   display:inline-block;
   height:20px;
   width:20px;
   background:#fff;
   border-radius:10px;
   margin-top:2px;
   margin-left:2px;
 }
 .toggle.on{
   background:#4FBE79;
 }
 .toggle.on:before{
   margin-left:32px;
 }
 input[type=button]{
   border:1px solid #000;
   box-shadow:none;
   text-shadow:none;
   color:#000;
   text-transform:none;
 }
</style>

<script type="text/javascript">
  function CoursePermission(){
    this.selection=[];
    this.initUI();
  }
  CoursePermission.prototype.downloadExcel = function(url){
    var user_state_ids = $("#lst-user-filter-state").get_selection();
    var user_district_ids = $("#lst-user-filter-district").get_selection();
    var user_school_ids = $("#lst-user-filter-school").get_selection();    
    var courses = [];
    $('#course_permission_course .tablesorter-blue tbody tr').each(function(){
      courses.push($(this).find("td:nth-child(5)").text())
    });
    var url = "${reverse('pepconn_course_permission_download_excel')}?";
    url += "&states=" + user_state_ids.join(",");
    url += "&districts=" + user_district_ids.join(",");
    url += "&schools=" + user_school_ids.join(",");
    url += "&courses=" + courses.join(",");
    window.open(url, "_blank");
  }  
  CoursePermission.prototype.save = function(send_notification){
    var self = this;
    var users = []
    $('#course_permission_user .tablesorter-blue').find("tbody tr td:nth-child(1) input:checked").each(function(){
      users.push(this.value);
    });
    if(!users.length){
      new Dialog($('#dialog')).show("Warn", "No user selected");
      return;
    }
    var courses = [];
    var access = [];
    var enroll = [];
    $('#course_permission_course .tablesorter-blue tbody tr').each(function(){
      courses.push($(this).find("td:nth-child(5)").text())
      access.push($(this).find("td:nth-child(6) .toggle").hasClass("on")?1:0);
      enroll.push($(this).find("td:nth-child(7) .toggle").hasClass("on")?1:0);
    });
    $.post("${reverse('pepconn_update_course_permission')}", {
      send_notification: send_notification ? "1" : "0",
      users: users.join(","),
      courses: courses.join(","),
      access: access.join(","),
      enroll: enroll.join(",")}, function(r){
        if(r.success){
          self.loadUserTable(true);
        }
      });
  }
  CoursePermission.prototype.addTimeStamp = function(url){
    var r = url.replace(/&timestamp=\d*/, "") + "&timestamp=" + new Date().getTime();
    return r;
  }
  CoursePermission.prototype.loadCourseTable = function(){
    var self = this;

    var subjects = $("#lst-course-filter-subject").get_selection();
    var authors = $("#lst-course-filter-author").get_selection();
    var grade_levels = $("#lst-course-filter-grade_level").get_selection();
    var state_ids = $("#lst-course-filter-state").get_selection();
    var district_ids = $("#lst-course-filter-district").get_selection();
    var url = "${reverse('pepconn_get_course_permission_course_rows')}?page={page}&size={size}&{filterList:fcol}&{sortList:col}";

    if(subjects) url += "&subjects=" + subjects;
    if(authors) url += "&authors=" + authors;
    if(grade_levels) url += "&grade_levels=" + grade_levels;
    if(state_ids) url += "&states=" + state_ids.join(",");
    if(district_ids) url += "&districts=" + district_ids.join(",");
    
    var pagerOptions = {
      container: '',
      output: '{startRow} - {endRow} / {filteredRows} ({totalRows})',
      fixedHeight: false,
      removeRows: false,
      cssGoto: '.gotoPage',
      ajaxUrl: '',
      ajaxProcessing: function(data){
        return data;
      },
      processAjaxOnInit: true,
      page: 0,
      size: 10
    };
    var tablesorterOptions = {
      theme: 'blue',
      widthFixed: true,
      widgets: ["zebra", "filter", "output"],
      widgetOptions: {
        filter_external: '',
        filter_columnFilters: false,
        filter_placeholder: {search: 'Search...'},
        filter_saveFilters: false,
        filter_reset: '.reset',
        filter_serversideFiltering: true,
        output_saveFileName: 'data.csv'
      }
    };

    pagerOptions.container = $("#course_permission_course .pager");
    pagerOptions.ajaxUrl = url
    var $table = $('#course_permission_course table.tablesorter-blue');
    if($table[0].config){
      var c = $table[0].config;
      var p = c.pager;
      p = $.extend(p, p.last);
      p.ajaxUrl = url + "&timestamp=" + new Date(); 
      p.reload();
      return;
    }
    
    $table.tablesorter(tablesorterOptions).tablesorterPager(pagerOptions);
    $table.bind("pagerComplete", function (a) {
      $(this).find("tbody tr").each(function(){
        var id = $(this).find("td:nth-child(5)").text();
        $(this).find("td:nth-child(5)").hide();
        var on1, on2;
        var toggle1 = $("<div class='toggle'/>").appendTo($(this).find("td").eq(5));
        var toggle2 = $("<div class='toggle'/>").appendTo($(this).find("td").eq(6));
        toggle1.click(function(){
          if(on1)
            $(this).removeClass("on"); else $(this).addClass("on");
          on1 = !on1;
        });
        toggle2.click(function(){
          if(on2)
            $(this).removeClass("on"); else $(this).addClass("on");
          on2 = !on2;
        });
      });
    });
  }
  
  CoursePermission.prototype.loadUserTable = function(use_old_filter){
    var self = this;
    var $table = $('#course_permission_user .tablesorter-blue');

    var course_subject = ($("#filters-subject-submenu li.active").attr("data-value"))
    var course_author = ($("#filters-author-submenu li.active").attr("data-value"))
    var course_grade_level = ($("#filters-grade-submenu li.active").attr("data-value"))

    var user_state_ids = $("#lst-user-filter-state").get_selection();
    var user_district_ids = $("#lst-user-filter-district").get_selection();
    var user_school_ids = $("#lst-user-filter-school").get_selection();

    var url = "${reverse('pepconn_get_course_permission_user_rows')}?page={page}&size={size}&{sortList:col}";

    if(course_subject) url += "&subject=" + course_subject;
    if(course_author) url += "&author=" + course_author;
    if(course_grade_level) url += "&grade_level=" + course_grade_level;
    if(user_state_ids) url += "&states=" + user_state_ids.join(",");
    if(user_district_ids) url += "&districts=" + user_district_ids.join(",");
    if(user_school_ids) url += "&schools=" + user_school_ids.join(",");

    /** reload with new filters or not */
    if($table[0].config){
      var c = $table[0].config;
      var p = c.pager;
      p = $.extend(p, p.last);
      if(use_old_filter){
        p.ajaxUrl = this.addTimeStamp(p.ajaxUrl);
        $table.find("td:nth-child(1) input").each(function(){
          self.selection.push(this.checked);
        });
      }else{
        p.ajaxUrl = this.addTimeStamp(url);
      }
      p.reload();
      return;
    }

    /** init */
    var courses;
    var pagerOptions = {
      container: $("#course_permission_user .pager"),
      output: '{startRow} - {endRow} / {filteredRows} ({totalRows})',
      fixedHeight: false,
      removeRows: false,
      cssGoto: '.gotoPage',
      ajaxUrl: url,
      ajaxProcessing: function(data){
        courses = data[2];
        return data;
      },
      processAjaxOnInit: true,
      page: 0,
      size: 10
    };
    var tablesorterOptions = {
      theme: 'blue',
      widthFixed: true,
      widgets: ["zebra", "filter", "output"],
      widgetOptions: {
        filter_external: '',
        filter_columnFilters: false,
        filter_placeholder: {search: 'Search...'},
        filter_saveFilters: false,
        filter_reset: '.reset',
        filter_serversideFiltering: true,
        output_saveFileName: 'data.csv'
      }
    };
    $table.tablesorter(tablesorterOptions).tablesorterPager(pagerOptions);
    $table.bind("pagerComplete", function (a) {
      // $(this).trigger('refreshColumnSelector', [[0, 1, 2]]);
      // $(this).find("th:nth-child(1)").width(160)

      var this_table=this;
      
      $(this).find(".check-all").click(function(){
        $(this_table).find("tbody tr td:nth-child(1) input").prop("checked", this.checked);
      });
      
      var selection = self.selection;

      $(this).find("td:nth-child(1)").each(function(i){
        var v = $(this).text();
        $(this).html("");
        var check = $("<input type='checkbox'>").appendTo(this).val(v);
        if(selection[i]){
          check.prop('checked', true);
        }
      });

      self.selection = [];

      /** hide headers only for filter  */
      $(this).find("th:nth-child(5)").hide();
      $(this).find("td:nth-child(5)").hide();
      $(this).find("th:nth-child(6)").hide();
      $(this).find("td:nth-child(6)").hide();
      $(this).find("th:nth-child(7)").hide();
      $(this).find("td:nth-child(7)").hide();
      var $tr = $(this).find("thead tr");
      /** headers of filtered courses */
      $tr.find("th:gt(6)").remove();
      $.each(courses, function(i, c){
        $("<th>" + c.display_name + "</th>").appendTo($tr);         
      });
    });
  }
  CoursePermission.prototype.dropDistrictMu = function(select, state_ids, callback){
    $(select).find("option").remove();
    $(select).reload();
    if(!state_ids.length)
      return;
    $.get('/pepper-utilities/drop/districts',{access_level: 'System', state: state_ids.join(",")}, function(r){
      $.each(r, function(i, d){
        $(select).append("<option value='" + d.id + "'>" + d.name + "</option>");
      });
      $(select).reload();
    });
  }
  CoursePermission.prototype.dropSchoolMu = function(select, district_ids, callback){
    $(select).find("option").remove();
    $(select).reload();
    if(!district_ids.length)
      return;
    $.get('/pepper-utilities/drop/schools',{access_level: 'System', district: district_ids.join(",")}, function(r){
      $.each(r, function(i, d){
        $(select).append("<option value='" + d.id + "'>" + d.name + "</option>");
      });
      $(select).reload();
    });
  }
  CoursePermission.prototype.loadCsv=function(){
    var $file =  $("#btnCoursePermCsvLoad").next("input");
    $file.click();
    $file.change(function(){
      if(this.value){
        var courses = [];
        var access = [];
        var enroll = [];
        
        $('#course_permission_course .tablesorter-blue tbody tr').each(function(){
          courses.push($(this).find("td:nth-child(5)").text())
          access.push($(this).find("td:nth-child(6) .toggle").hasClass("on")?1:0);
          enroll.push($(this).find("td:nth-child(7) .toggle").hasClass("on")?1:0);
        });
        
        var fd = new FormData();
        fd.append('attachment', this.files[0]);
        fd.append('courses', courses);
        fd.append('access', access);
        fd.append('enroll', enroll);
        
        $.ajax({
          url: "${reverse('pepconn_course_permission_load_csv')}",
          data: fd,
          processData: false,
          contentType: false,
          type: 'POST',
          beforeSend: function (x) {
            if (x && x.overrideMimeType) {
              x.overrideMimeType("multipart/form-data");
            }
          },
          enctype: 'multipart/form-data',
          mimeType: 'multipart/form-data',
          error: function(xhr, status){
            // checkAjaxSessionTimeout(xhr)
          },
          success: function(data){
            alert("finish")
          }
        });            
      }
    });
  }
  CoursePermission.prototype.initUI = function(){
    var self = this;
    /** filter subject/author/grade menu */
    $(".filters-submenu").each(function(){
      $(this).find("li").each(function(i){
        var colors=["#2196F3", "#E93578", "#C238EB", "#629C44", "#006E8C"];
        $(this).css("background", colors[i % colors.length])
        $(this).click(function(){
          var on = $(this).hasClass("active");
          $(this).parent().find("li").removeClass("active");
          if(!on)
            $(this).addClass("active");
        });
      })
    });
    $(".filters-menu li").click(function(){
      $(this).parent().find("li").removeClass("active");
      $(this).addClass("active");
      $(".filters-submenu").hide();
      $("#" + this.id + "-submenu").show();
    });
    $(".filters-menu li").eq(0).click(); /** show subject at 1st */
    /** filter dropdowns */
    $(".mu").multi_sele_dropdown().change(function(e){
      if(this.id == "lst-user-filter-state"){
        var sele = ("#lst-user-filter-district");
        self.dropDistrictMu(sele, $(this).get_selection());
      }else if(this.id == "lst-user-filter-district"){
        var sele = ("#lst-user-filter-school");
        self.dropSchoolMu(sele, $(this).get_selection());              
      }else if(this.id == "lst-course-filter-state"){
        var sele = ("#lst-course-filter-district");
        self.dropDistrictMu(sele, $(this).get_selection());
      }
    });
    /** btns load table */
    $("#btnUserLoad").click(function(){
      self.loadUserTable();
    });
    $("#btnCourseLoad").click(function(){
      self.loadCourseTable();
    });
    /** btn save */
    $("#btnSave").click(function(){
      self.save(false);
    });
    $("#btnSaveSend").click(function(){
      self.save(true);
    });
    $("#btnCoursePermCsvLoad").click(function(){
      self.loadCsv();      
    });
    $("#btnCoursePermDownloadExcel").click(function(){
      self.downloadExcel();      
    });
    $(".course-perm-sub-title").click(function(){
      var $div = $(this).next("div");
      if($div.is(":visible"))
        $div.slideUp();
      else
        $div.slideDown();
    });
  }
  new CoursePermission()
</script>

<!-- dialog -->
<div style="" id="dialog" class="modal">
  <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0">
    <div class="titlebar">
      <h3 class="dialog-title"></h3>
      <div class="close-modal" id="dialog_close"></div>
    </div>
    <div class="content"></div>
  </div>
</div>
<div id = "districtEditForm" class = "hidden">
    <p>
        Edit District Form
    </p><br>
    Code:<input type = 'text' id = 'districtCodeValue'><br><br>
    Name:<input type = 'text' id = 'districtNameValue'><br><br>
    <button type = 'submit' id = 'submitDistrictEditButton'>Submit</button>
</div>
<script type="text/javascript">
function editDistrictsInfo(id){
    $.post('${reverse("pepconn_district_get_info")}', {
        id: id
    }, function (r) {
        var code = " <h2>Edit District Form</h2>Code:<input type = 'text' id = 'districtCodeValue' value = '"+ r.code+"'></input><br><br>Name:<input type = 'text' id = 'districtNameValue' value = '"+ r.name +"'></input><br><br><button data-id = '"+id+"' onclick = 'submitDistrictEdit()' type = 'submit' id = 'submitDistrictEditButton'>Submit</button><p id = 'districtEditMessage'</p>"
        new Dialog($('#dialog')).show("Edit District",code);
    });
}
function submitDistrictEdit(){
    $.post('${reverse("pepconn_district_edit_info")}',{
        id:$("#submitDistrictEditButton").attr("data-id"),
        name:$("#districtNameValue").val(),
        code:$("#districtCodeValue").val()
    },function(r){
        if(r.success == 'true'){
            $("#districtEditMessage").text("Updated Successfully.").css("color", "green");
        }else{
            $("#districtEditMessage").text(r.error).css("color", "red");
        }
    });
}
function editSchoolsData(id){
    $.post('${reverse("pepconn_school_get_info")}', {
        id: id
    }, function (r) {
        var code = r.code;
        new Dialog($('#dialog')).show("Edit School",code);
    });
}
function submitSchoolEdit(){
    $.post('${reverse("pepconn_school_edit_info")}',{
        id:$("#submitSchoolEditButton").attr("data-id"),
        name:$("#schoolNameValue").val(),
        code:$("#schoolCodeValue").val(),
        district:$("#schoolDistrictValue").val()
    }, function(r){
        if(r.success == 'true'){
            $("#schoolEditMessage").text("Updated Successfully.").css("color", "green");
        }else{
            $("#schoolEditMessage").text(r.error).css("color", "red");
        }
    });
}
function editCohortData(id){
    $.post('${reverse("pepconn_cohort_get_info")}', {
        id: id
    }, function (r) {
        var code = r.code;
        new Dialog($('#dialog')).show("Edit Cohort",code);
    });
}
function submitCohortEdit(){
    $.post('${reverse("pepconn_cohort_edit_info")}',{
        id:$("#submitCohortEditButton").attr("data-id"),
        code:$("#cohortCodeValue").val(),
        district:$("#cohortDistrictValue").val(),
        licences:$("#cohortLicenceValue").val(),
        term:$("#cohortTermValue").val()
    }, function(r){
        if(r.success == 'true'){
            $("#cohortEditMessage").text("Updated Successfully.").css("color", "green");
        }else{
            $("#cohortEditMessage").text(r.error).css("color", "red");
        }
    });
}
function editUserData(id){
    $.post('${reverse("pepconn_user_get_info")}', {
        id: id
    }, function (r) {
        var code = r.code;
        new Dialog($('#dialog')).show("Edit User",code);
        id=$("#userDistrictValue").val();
        $("#userCohortValue > option").each(function() {
            if($(this).attr("data-district") != id){
                $(this).hide();
            } else $(this).show();
        });
        $("#userSchoolValue > option").each(function() {
            if($(this).attr("data-district") != id){
                $(this).hide();
            }else $(this).show();
        });
        if($("#userSchoolValue option:selected" ).attr("data-district") != id){
            $("#userSchoolValue").val("");
        }
        if($("#userCohortValue option:selected" ).attr("data-district") != id){
            $("#userSchoolValue").val("");
        }
        $("#userDistrictValue").change(function(){
            id=$(this).val();
            $("#userCohortValue > option").each(function() {
                if($(this).attr("data-district") != id){
                    $(this).hide();
                } else $(this).show();
            });
            $("#userSchoolValue > option").each(function() {
                if($(this).attr("data-district") != id){
                    $(this).hide();
                }else $(this).show();
            });
            if($("#userSchoolValue option:selected" ).attr("data-district") != id){
                $("#userSchoolValue").val("");
            }
            if($("#userCohortValue option:selected" ).attr("data-district") != id){
                $("#userSchoolValue").val("");
            }
        });
    });
}
function submitUserEdit(){
    $.post('${reverse("pepconn_user_edit_info")}',{
        id:$("#submitUserEditButton").attr("data-id"),
        first:$("#userFirstValue").val(),
        last:$("#userLastValue").val(),
        cohort:$("#userCohortValue").val(),
        district:$("#userDistrictValue").val(),
        school:$("#userSchoolValue").val(),
        ssotype:$("#userSSOTypeValue").val(),
        ssoidp: $("#userSSOIDPValue").val()
    }, function(r){
        if(r.success == 'true'){
            $("#userEditMessage").text("Updated Successfully.").css("color", "green");
            $("#user_table_init").trigger("pagerUpdate");
        }else{
            $("#userEditMessage").text(r.error).css("color", "red");
        }
    });
}
$("#singleDistrictImportForm").submit(function () {
    var flds = ["id", "name", "state", "csrfmiddlewaretoken"];
    var data = getFormData(this, flds);
    if (data) {
        $.post('${reverse("pepconn_single_district_submit")}', data, function (r) {
                    if (r.success) {
                        new Dialog($('#dialog')).show('Success', 'The district was successfully created!');
                    } else {
                        new Dialog($('#dialog')).show("Error", "The following error occurred: " + r.error);
                    }
                }
        );
    }
    return false;
});

$("#singleSchoolImportForm").submit(function () {
    var flds = ["name", "id", "state_id", "district_id", "csrfmiddlewaretoken"];
    var data = getFormData(this, flds);
    if (data) {
        $.post('${reverse("pepconn_single_school_submit")}', data, function (r) {
                    if (r.success) {
                        new Dialog($('#dialog')).show('Success', 'The school was successfully created!');
                    } else {
                        new Dialog($('#dialog')).show("Error", "The following error occurred: " + r.error);
                    }
                }
        );
    }
    return false;
});

$("#singleUserImportForm").submit(function () {
    syncCKEditorData();
    var flds = ["district", "email", "csrfmiddlewaretoken", "send_registration_email", "customize_email", "custom_email_003", "custom_email_subject"];
    var data = getFormData(this, flds);
    if (data) {
        $.post('${reverse("pepconn_single_user_submit")}', data, function (r) {
                    if (r.success) {
                        new Dialog($('#dialog')).show('Success', 'The user was successfully created!');
                    } else {
                        new Dialog($('#dialog')).show("Error", "The following error occurred: " + r.error);
                    }
                }
        );
    }
    return false;
});

function cleanInput(input){
    return input.replace("'", "\'");
}

function clearDropdown(dropdown){
    $(dropdown).html("");
}

$(document).ready(function () {
    $("#User_state_select").change(function () {
       var id = $("#User_state_select :selected").attr("class");
        clearDropdown("#User_district_select");
        filterUserDropOptions('district', id, '#User_district_select');
    });

    $("#User_district_select").change(function () {
       var id = $("#User_district_select :selected").attr("class");
        clearDropdown("#User_school_select");
        filterUserDropOptions('school', id, '#User_school_select');
    });
    var custom_email_loaded = [false, false, false];

    $("input[id^=cec-]").change(function(){
        var idNum = $(this).attr('id').split('-')[1];
        $("#save-email-" + idNum).toggle();
    });
    $("img[id^=saved_email_button_custom_email_00]").click(function(e) {
        var idNum = $(this).attr('id').split('00')[1];

        var html = '<div class="email-save-wrapper"> Filter By:<br>';
        html += '<label><input type="radio" name="ops" value="private" id="user_exclusive" checked></input> Private</label><br>';
        html += '<label><input type="radio" name="ops" value="public" id="system_exclusive"></input> Public</label><br>';
        html += '<label><input type="radio" name="ops" value="organization"></input> Organization</label><br>';
        html += '<span id="ops" style="display: none;">';
        html += 'State: <select id="state_select"></select><br>';
        html += 'District: <select id="select_district_email"></select><br>';
        html += 'School: <select id="school_select_email"></select></span><br><br>';
        html += 'Email: <select id="custom_email_name_custom_email"></select><br><br>';
        html += '<button id="load_saved_email_custom_email">Load</button>';
        html += '</div>';

        var load_dialog = new Dialog($('#dialog'));
        load_dialog.show('Saved Emails', html);

        // var options = $("#custom_email_name_custom_email > option");
        var select_id = '#custom_email_name_custom_email';
        filterOptionsByAttribute(select_id, 'private', true);

        $("input[name=ops]:radio").change(function () {
            var ops = $(this).val();
            if (ops == 'organization') {
                filterDropOptions('state', false, '#state_select');
                $("#ops").show();
                $('#custom_email_name_custom_email').html('');
            } else {
                $("#ops").hide();
                filterOptionsByAttribute(select_id, ops, true)
            }
        });

        $("#state_select").change(function () {
            var id = $(this).val();
            filterDropOptions('district', id, '#select_district_email');
            $('#school_select_email').html('');
            filterOptionsByAttribute(select_id, 'state', id);
        });
        $("#select_district_email").change(function () {
            var id = $(this).val();
            filterDropOptions('school', id, '#school_select_email');
            filterOptionsByAttribute(select_id, 'district', id);
        });
        $("#school_select_email").change(function() {
            var id = $(this).val();
            filterOptionsByAttribute(select_id, 'school', id);
        });

        $("#load_saved_email_custom_email").click(function(){
            var id = $("#custom_email_name_custom_email").val();
            $.post("${reverse('pepconn_get_custom_email')}", {id: id}, function(data){
                CKEDITOR.instances['custom_email_00' + idNum].setData(data.message);
                load_dialog.hide();
                $("#delete-email-" + idNum).show();
                custom_email_loaded[idNum] = id;
            });
        });
    });

    $("button[id^=save-email-]").click(function(e){
        e.preventDefault();

        var idNum = $(this).attr('id').split("-")[2];

        var private_checked = ' checked';
        var name_hidden = '';

        var html = '<div class="email-save-wrapper">';
        if (custom_email_loaded[idNum]) {
            private_checked = '';
            name_hidden = ' style="display: none;"';
            html += '<label><input type="radio" name="ops" value="update" id="update_current" checked></input> Update Current</label><br>';
        }
        html += '<label><input type="radio" name="ops" value="private" id="user_exclusive"' + private_checked + '></input> Private</label><br>';
        html += '<label><input type="radio" name="ops" value="public" id="system_exclusive"></input> Public</label><br>';
        html += '<label><input type="radio" name="ops" value="organization"></input> Organization</label><br>';
        html += '<span id="ops" style="display: none;">';
        html += 'State: <select id="state_select"></select><br>';
        html += 'District: <select id="select_district_email"></option></select><br>';
        html += 'School: <select id="school_select_email"></select></span><br><br>';
        html += '<label' + name_hidden + ' id="email_name_label">Save Name: <input type="text" id="email_name"></input></label><br><br>';
        html += '<button id="save_email_post">Save</button><br><span id="save_email_message"></span>';
        html += '</div>';

        new Dialog($('#dialog')).show("Custom Email", html);

        $("input[name=ops]:radio").change(function () {
            var op = $('input[name=ops]:checked').val();
            if (op == 'organization') {
                filterDropOptions('state', false, '#state_select');
                $("#ops").show();
                $('#email_name_label').show();
            } else {
                $("#ops").hide();
                if (op == 'update') {
                    $('#email_name_label').hide();
                } else {
                    $('#email_name_label').show();
                }
            }
        });

        $("#state_select").change(function () {
            var id = $(this).val();
            filterDropOptions('district', id, '#select_district_email');
        });
        $("#select_district_email").change(function () {
            var id = $(this).val();
            filterDropOptions('school', id, '#school_select_email');
        });

        $("#save_email_post").click(function(e){
            e.preventDefault();
            var op = $('input[name=ops]:checked').val();
            var state = $("#state_select").val();
            var district = $("#select_district_email").val();
            var school = $("#school_select_email").val();
            var name = $("#email_name").val();
            if (op == 'organization' && state == 'null_case') {
                alert('You must select at least a state if you are saving by organization.');
            } else if (op != 'update' && !name.length) {
                alert('You must enter a name for your custom email.')
            } else {
                var data = {
                    "csrfmiddlewaretoken": "${csrf_token}",
                    "name": name,
                    "message": CKEDITOR.instances['custom_email_00' + idNum].getData(),
                    "op": op,
                    "state": state,
                    "district": district,
                    "school": school,
                    "id": custom_email_loaded[idNum]
                };

                $.post("${reverse('pepconn_save_custom_email')}", data, function (r) {
                    if (r.success == true) {
                        $("#save_email_message").css("color", "green");
                        $("#save_email_message").html("<br>Successfully " + r.op + " message.");
                    } else if (r.error == 'duplicate') {
                        $("#save_email_message").css("color", "red");
                        $("#save_email_message").html("<br>This email name is already in use.");
                    } else {
                        $("#save_email_message").css("color", "red");
                        $("#save_email_message").html("<br>There was an error saving your email.");
                    }
                });
            }
        });
    });

    $("button[id^=delete-email-]").click(function(e){
        e.preventDefault();
        var button = this;

        if (confirm('Are you sure you want to delete this message?')) {
            var idNum = $(this).attr('id').split("-")[2];

            var data = {
                "csrfmiddlewaretoken": "${csrf_token}",
                "id": custom_email_loaded[idNum]
            };

            $.post("${reverse('pepconn_delete_custom_email')}", data, function (r) {
                if (r.success) {
                    alert('Message successfully deleted.');
                    custom_email_loaded[idNum] = false;
                    $(button).hide();
                } else {
                    alert('There was an error deleteing the message. Please contact support.');
                }
            });
        }
    });

    $(".table-section").hide();
    $(".district_table-section").show();
    $("#selectalldistrict").click(function () {
        if (this.checked) {
            $("#district_table_init input[type=checkbox]").each(function () {
                this.checked = true;
            });
        } else {
            $("#district_table_init input[type=checkbox]").each(function () {
                this.checked = false;
            });
        }
    });
    $(".dialog_close").click(function(){
        console.log("hit");
        $("#dialog").hide();
    });
    $("#selectallschool").click(function () {
        if (this.checked) {
            $("#school_table_init input[type=checkbox]").each(function () {
                this.checked = true;
            });
        } else {
            $("#school_table_init input[type=checkbox]").each(function () {
                this.checked = false;
            });
        }
    });
    $("#selectalluser").click(function () {
        if (this.checked) {
            $("#user_table_init input[type=checkbox]").each(function () {
                this.checked = true;
            });
        } else {
            $("#user_table_init input[type=checkbox]").each(function () {
                this.checked = false;
            });
        }
    });
    $("#selectallcohort").click(function () {
        if (this.checked) {
            $("#cohort_table_init input[type=checkbox]").each(function () {
                this.checked = true;
            });
        } else {
            $("#cohort_table_init input[type=checkbox]").each(function () {
                this.checked = false;
            });
        }
    });

    $("#delete_selected_districts").click(function () {
        var ids = [];
        $(".district_select_box:checked").each(function () {
            ids.push($(this).val());
        });
        if (!ids.length)return new Dialog($('#dialog')).show("Error", "Please select at least one district to delete.");

        if (!confirm("Really delete selected districts?")) return;
        $.get("${reverse('district_delete')}", {ids: ids.join()}, function (r) {
            if (r.success) {
                new Dialog($('#dialog')).show("Success", "Selected districts have been deleted successfully.");
                $(".district_select_box:checked").each(function () {
                    var identify = $(this).val();
                    $("#district_" + identify).hide();
                });
            } else new Dialog($('#dialog')).show("Error", "The following error has occurred: " + r.error);
        });
    });
    $("#delete_selected_schools").click(function () {
        var ids = [];
        $(".school_select_box:checked").each(function () {
            ids.push($(this).val());
        });
        if (!ids.length)return new Dialog($('#dialog')).show("Error", "Please select at least one school to delete.");
        if (!confirm("Really delete selected schools?")) return;
        $.get("${reverse('school_delete')}", {ids: ids.join()}, function (r) {
            if (r.success) {
                new Dialog($('#dialog')).show("Success", "Selected schools have been deleted.");
                $(".school_select_box:checked").each(function () {
                    var identify = $(this).val();
                    $("#school_" + identify).hide();
                });
            } else new Dialog($('#dialog')).show("Error", "The following error has occurred: " + r.error);
        });
    });
    $("#delete_selected_user").click(function () {
        var ids = [];
        $(".user_select_box:checked").each(function () {
            ids.push($(this).val());
        });
        if (!ids.length)return new Dialog($('#dialog')).show("Error", "Please select at least one user to delete.");
        if (!confirm("Really delete selected users?")) return;
        $.post("${reverse('user_delete')}", {ids: ids.join()}, function (r) {
            if (r.success) {
                new Dialog($('#dialog')).show("Success", "Selected users successfully deleted.");
                $(".user_select_box:checked").each(function () {
                    var identify = $(this).val();
                    $("#user_" + identify).hide();
                    $("#user_table_init").trigger("pagerUpdate");
                });
            } else new Dialog($('#dialog')).show("Error", "The following error has occurred: " + r.error);
        });
    });
    $("#delete_selected_cohort").click(function () {
        var ids = [];
        $(".cohort_select_box:checked").each(function () {
            ids.push($(this).val());
        });
        if (!ids.length)return new Dialog($('#dialog')).show("Error", "Please select at least one cohort to delete.");
        if (!confirm("Really delete selected cohorts?")) return;
        $.get("${reverse('cohort_delete')}", {ids: ids.join()}, function (r) {
            if (r.success) {
                new Dialog($('#dialog')).show("Success", "Selectd cohorts deleted..");
                $(".cohort_select_box:checked").each(function () {
                    var identify = $(this).val();
                    $("#cohort_" + identify).hide();
                });
            } else new Dialog($('#dialog')).show("Error", "The following error occurred: " + r.error);
        });
    });
    $("#register_selected_user").click(function () {
        var ids = [];
        $(".user_select_box:checked").each(function () {
            ids.push($(this).attr("value"));
        });
        if (!ids.length == 0) {
            if (confirm("Send Registration Emails to Selected Users?")) {
                syncCKEditorData();
                $.post("${reverse('pepconn_registration_send_email')}", {
                    'ids': ids.join(),
                    'customize_email': $("#user_table_custom_email_form .custom-email-checkbox").val(),
                    'custom_email_002': $("#user_table_custom_email_form .email-editor").val(),
                    'custom_email_subject': $("#user_table_custom_email_form input[name='custom_email_subject']").val()
                }, function (r) {
                    if (r.success) {
                        self.taskId = r.taskId;
                        $("#user_table_init").trigger("pagerUpdate");
                    }
                });
            }
        } else new Dialog($('#dialog')).show("Error", "Please select at least one user.");

    });

    function filterOptions(item, id) {
        $(item).removeAttr('selected');
        if ($(item).attr("parent-class") != id && $(item).attr("class") != "null_case" && id != 'null_case' && $(item).attr('value') != 'null_case') {
            $(item).css("display", "none");
        } else {
            $(item).css("display", "");
        }
    }
    function filterDropOptions(item, id, select) {
        if (id != 'null_case') {
            var url = '';
            var data = {};
            if (item == 'state') {
                url = "${reverse('pepper_utilities_drop_states')}";
            } else if (item == 'district') {
                url = "${reverse('pepper_utilities_drop_districts')}";
                data['state'] = id;
            } else if (item == 'school') {
                url = "${reverse('pepper_utilities_drop_schools')}";
                data['district'] = id;
            }
            $.get(url, data, function (r) {
                var options = '<option value="null_case" selected>Select ' + item[0].toUpperCase() + item.substr(1) + '</option>';
                $.each(r, function (k, v) {
                    options += '<option value="' + v.id + '">' + v.name + '</option>';
                });
                $(select).html(options);
            });
        } else {
            $(select).html('');
        }
    }

    function filterImportDropOptions(item, id, select) {
        if (id != 'null_case') {
            var url = '';
            var data = {};
            if (item == 'state') {
                url = "${reverse('pepper_utilities_drop_states')}";
            } else if (item == 'district') {
                url = "${reverse('pepper_utilities_drop_districts')}";
                data['state'] = id;
            } else if (item == 'school') {
                url = "${reverse('pepper_utilities_drop_schools')}";
                data['district'] = id;
            }
            $.get(url, data, function (r) {
                var options = '<option value="null_case" selected>Select ' + item[0].toUpperCase() + item.substr(1) + '</option>';
                $.each(r, function (k, v) {
                    options += '<option value="' + v.id + '" class="' + v.id + '">' + v.name + '</option>';
                });
                $(select).html(options);
            });
        } else {
            $(select).html('');
        }
    }

    function filterUserDropOptions(item, id, select) {
        if (id != 'null_case') {
            var url = '';
            var data = {};
            if (item == 'state') {
                url = "${reverse('pepper_utilities_drop_states')}";
            } else if (item == 'district') {
                url = "${reverse('pepper_utilities_drop_districts')}";
                data['state'] = id;
            } else if (item == 'school') {
                url = "${reverse('pepper_utilities_drop_schools')}";
                data['district'] = id;
            }
            $.get(url, data, function (r) {
                var options = '<option value="" class="null_case">Select ' + item[0].toUpperCase() + item.substr(1) + '</option>';
                $.each(r, function (k, v) {
                    options += '<option value="' + v.name + '" class="' + v.id + '">' + v.name + '</option>';
                });
                $(select).html(options);
            });
        } else {
            $(select).html('');
        }
    }
    function filterOptionsByAttribute(select, attribute, value) {
        var data = {};
        data[attribute] = value;
        $.get("${reverse('pepconn_get_custom_email_list')}", data, function (r) {
            var options = '';
            $.each(r, function (k, v) {
                options += '<option value="' + v.id + '">' + v.name + '</option>';
            });
            $(select).html(options);
        });
    }
    $("#user_state_single").change(function () {
        var id = $(this).children(":selected").attr("class");
        filterImportDropOptions('district', id, "#user_district_id");
    });
    $("#cohort_state_single").change(function () {
        var id = $(this).children(":selected").attr("class");
        filterImportDropOptions('district', id, "#cohort_district_id");
    });
    $("#School_state_select").change(function () {
        var id = $(this).children(":selected").attr("class");
        clearDropdown('#School_district_select');
        filterUserDropOptions('district', id, '#School_district_select');
    });
    $("#Cohort_state_select").change(function () {
        var id = $(this).children(":selected").attr("class");
        clearDropdown('#Cohort_district_select');
        filterUserDropOptions('district', id, '#Cohort_district_select');
    });

    $("#state_single").change(function () {
        var id = $(this).children(":selected").attr("class");
        filterImportDropOptions('district', id, "#district_id_single");
    });
});
function addToSSO(){
    var code = "<span id = 'innersso'>Select SSO IDP: " + $("#sso_select").html() + "</span><center><span id = 'ssoAddSuccess' style='color:green'></span><br><button onClick='submitAddToSSO()'>Submit</button>";
    new Dialog($("#dialog")).show("Select SSO Type", code);
    $.get('${reverse("sso_idp_metadata_all_json")}', {
    }, function (r) {
        var inner = "<option value=''></option>"
        $.each(r,function(i,e){
            inner+="<option value ='"+ e.sso_name +"'>"+ e.sso_name+"</option>";
        });
        $("#innersso > #sso_idp_select_box").empty().append(inner);
    });

}
function submitAddToSSO(){
    var ids = [];
    $("#user_table_init tr").each(function (i, val) {
        var $row = $(val);
        var $checkedBoxes = $row.find("input:checked");
        $checkedBoxes.each(function (i, box) {
            var $checkbox = $(box);

            $.post('${reverse("pepconn_sso_add_submit")}', {
                id: $checkbox.val(),
                sso: $("#innersso > #sso_idp_select_box").val(),
                ssotype: $("#innersso > #sso_type_select_box").val()
            }, function (r) {
                //console.log(r.message);
                if (r.message == "success") {
                    $("#ssoAddSuccess").html("Added successfully to SSO Type");
                } else new Dialog($('#dialog')).show("Error", "The following error has occurred: " + r.message);
            });
        });
    });
}
function addToCohort() {
    var code = "<p id = 'innercohort'>Select Cohort: " + $("#cohort_select").html() + "</p><center><span id = 'cohortAddSuccess' style='color:green'></span><br><button onClick='submitAddToCohort()'>Submit</button>";
    new Dialog($("#dialog")).show("Select Cohort", code);
}
function removeFromCohort(){
    new Dialog($("#dialog")).show("Remove From Cohort", "<span id = 'cohort_remove_span'><p>Really remove selected users from cohort?</p><button onClick='submitRemoveFromCohort()'>Submit</button></span>");
}
function submitAddToCohort() {
    //console.log("processing");
    var ids = [];
    $("#user_table_init tr").each(function (i, val) {
        var $row = $(val);
        var $checkedBoxes = $row.find("input:checked");
        $checkedBoxes.each(function (i, box) {
            var $checkbox = $(box);

            $.post('${reverse("pepconn_cohort_add_submit")}', {
                id: $checkbox.val(),
                cohort: $("#innercohort .cohort_selector").val()
            }, function (r) {
                //console.log(r.message);
                if (r.message = "success") {
                    $("#cohortAddSuccess").html("Added successfully to Cohort");
                    $("#user_table_init").trigger("pagerUpdate");
                } else new Dialog($('#dialog')).show("Error", "The following error has occurred: " + r.message);
            });

        });
    });

}
function submitRemoveFromCohort() {
    $("#user_table_init tr").each(function (i, val) {
        var $row = $(val);
        var $checkedBoxes = $row.find("input:checked");
        var finished_good = true;
        $checkedBoxes.each(function (i, box) {
            var $checkbox = $(box);
            $.post('${reverse("pepconn_cohort_remove_submit")}', {
                id: $checkbox.val()
            }, function (r) {
                if (r.message = "success") {
                    $("#user_table_init").trigger("pagerUpdate");
                } else {
                    finished_good = false;
                }
            });
        });
        if (finished_good){
            $("#cohort_remove_span").html("<p>The selected users have been removed from their cohorts.</p>");
        }else $("#cohort_remove_span").html("<p>The following error has occurred: " + r.message + "</p>");

    });
}

function openBookmark(table) {
    var code = "<p>Select Filter: <select id = 'bookmark_select_" + table + "'>";
    var saveCode = "<hr><p><input placeholder = 'Enter Bookmark Name Here' type = 'text' id = 'bookmark_newname_" + table + "'></input><br><br><button onClick = 'saveBookmark(\"" + table + "\");'>Save Bookmark</button></p>";
    $.post('${reverse("pepconn_favorite_filter_load")}', function (r) {
        for (i = 0; i < r.length; i++) {
            var data = jQuery.parseJSON(r[i].filter);
            if (data.table == table) {
                code += "<option class = '" + r[i].id + "' id = '" + i + "' value = '" + i + "'>" + r[i].name + "</option>";
            }
        }
        code += "</select><br><br><button onClick = 'loadBookmark(\"" + table + "\");'>Load</button>&nbsp &nbsp <button onClick = 'deleteBookmark(\"" + table + "\");'>Delete</button></p><span style = 'color:green' id = 'modalMessage'></span><hr>";
        new Dialog($('#dialog')).show(table + ' Bookmarks', code + saveCode);
    });

}

function saveBookmark(table) {
    var nameData = $("#bookmark_newname_" + table).val();
    var state = $("#" + table + "_state_select :selected").attr("id");
    var district = $("#" + table + "_district_select :selected").attr("id");
    var search = $("#" + table + "_search").val();
    var first = $("#" + table + "_search_first").val();
    var last = $("#" + table + "_search_last").val();
    var email = $("#" + table + "_search_email").val();
    var filterData = '{"table":"' + table + '", "state":"' + state + '", "district":"' + district + '", "search":"' + search + '", "firstName":"' + first + '", "lastName":"' + last + '", "email":"' + email + '"}';
    $.get("${reverse('pepconn_favorite_filter_save')}", {name: nameData, filter: filterData}, function (data) {
        $("#modalMessage").html("Your filter was saved!");
    });
}
function loadBookmark(table) {
    var id = $("#bookmark_select_" + table).val();
    $.post('${reverse("pepconn_favorite_filter_load")}', function (r) {
        var data = jQuery.parseJSON(r[id].filter);
        $("#" + table + "_district_select option[id=" + data.district + "]").prop("selected", true).change();
        $("#" + table + "_state_select option[id=" + data.state + "]").prop("selected", true).change();
        $("#" + table + "_search").val(data.search).change();
        $("#" + table + "_search_first").val(data.firstName).change();
        $("#" + table + "_search_last").val(data.lastName).change();
        $("#" + table + "_search_email").val(data.email).change();
        $("#modalMessage").html("Your filter was loaded!");
    });
}
function deleteBookmark(table) {
    if (confirm("Are you sure you want to delete the selected Bookmark?")) {
        var ids = $("#bookmark_select_" + table + " :selected").attr('class');

        $.get("${reverse('pepconn_favorite_filter_delete')}", {id: ids}, function (data) {

            $("#modalMessage").html("Your filter was deleted.");
        });
    }
}

var pagerOptions = {
    // target the pager markup - see the HTML block below
    container: '',
    // output string - default is '{page}/{totalPages}'; possible variables: {page}, {totalPages}, {startRow}, {endRow} and {totalRows}
    output: '{startRow} - {endRow} / {filteredRows} ({totalRows})',
    // if true, the table will remain the same height no matter how many records are displayed. The space is made up by an empty
    // table row set to a height to compensate; default is false
    fixedHeight: false,
    // remove rows from the table to speed up the sort of large tables.
    // setting this to false, only hides the non-visible rows; needed if you plan to add/remove rows with the pager enabled.
    removeRows: false,
    // go to page selector - select dropdown that sets the current page
    cssGoto: '.gotoPage',
    ajaxUrl: '',
    ajaxProcessing: function(data){
        return data;
    },
    processAjaxOnInit: true,
    page: 0,
    size: 10
};
var tablesorterOptions = {
    theme: 'blue',
    widthFixed: true,
    widgets: ["zebra", "filter", "output"],
    widgetOptions: {
        filter_external: '',
        filter_columnFilters: false,
        filter_placeholder: {search: 'Search...'},
        filter_saveFilters: false,
        filter_reset: '.reset',
        filter_serversideFiltering: true,
        output_saveFileName: 'data.csv'
    }
};

$(function () {
    tablesorterOptions.widgetOptions.filter_external = '.search-districts';
    pagerOptions.container = $("#district-pager");
    pagerOptions.ajaxUrl = '${reverse('pepconn_get_district_rows')}?page={page}&size={size}&{filterList:fcol}&{sortList:col}';
    $('#district_table_init').tablesorter(tablesorterOptions).tablesorterPager(pagerOptions);
    $("#downloadDistrictCSV").click(function () {
        $("#district_table_init").data('tablesorter').widgetOptions.output_delivery = "d";
        $("#district_table_init").data('tablesorter').widgetOptions.output_saveFileName = "district.csv";
        $("#district_table_init").trigger('outputTable');
    });
    $("#downloadDistrictXLS").click(function () {
        $("#district_table_init").data('tablesorter').widgetOptions.output_delivery = "d";
        $("#district_table_init").data('tablesorter').widgetOptions.output_saveFileName = "district.xls";
        $("#district_table_init").trigger('outputTable');
    });

    tablesorterOptions.widgetOptions.filter_external = '.search-users';
    pagerOptions.container = $("#user-pager");
    pagerOptions.ajaxUrl = '${reverse('pepconn_get_user_rows')}?page={page}&size={size}&{filterList:fcol}&{sortList:col}';
    $('#user_table_init').tablesorter(tablesorterOptions).tablesorterPager(pagerOptions);
    $("#downloadUserCSV").click(function () {
        $("#user_table_init").data('tablesorter').widgetOptions.output_delivery = "d";
        $("#user_table_init").data('tablesorter').widgetOptions.output_saveFileName = "user.csv";
        $("#user_table_init").trigger('outputTable');
    });
    $("#downloadUserXLS").click(function () {
        $("#user_table_init").data('tablesorter').widgetOptions.output_delivery = "d";
        $("#user_table_init").data('tablesorter').widgetOptions.output_saveFileName = "user.xls";
        $("#user_table_init").trigger('outputTable');
    });

    tablesorterOptions.widgetOptions.filter_external = '.search-schools';
    pagerOptions.container = $("#school-pager");
    pagerOptions.ajaxUrl = '${reverse('pepconn_get_school_rows')}?page={page}&size={size}&{filterList:fcol}&{sortList:col}';
    $('#school_table_init').tablesorter(tablesorterOptions).tablesorterPager(pagerOptions);
    $("#downloadSchoolCSV").click(function () {
        $("#school_table_init").data('tablesorter').widgetOptions.output_delivery = "d";
        $("#school_table_init").data('tablesorter').widgetOptions.output_saveFileName = "school.csv";
        $("#school_table_init").trigger('outputTable');
    });
    $("#downloadSchoolXLS").click(function () {
        $("#school_table_init").data('tablesorter').widgetOptions.output_delivery = "d";
        $("#school_table_init").data('tablesorter').widgetOptions.output_saveFileName = "school.xls";
        $("#school_table_init").trigger('outputTable');
    });

    tablesorterOptions.widgetOptions.filter_external = '.search-cohorts';
    pagerOptions.container = $("#cohort-pager");
    pagerOptions.ajaxUrl = '${reverse('pepconn_get_cohort_rows')}?page={page}&size={size}&{filterList:fcol}&{sortList:col}';
    $('#cohort_table_init').tablesorter(tablesorterOptions).tablesorterPager(pagerOptions);
    $("#downloadCohortCSV").click(function () {
        $("#cohort_table_init").data('tablesorter').widgetOptions.output_delivery = "d";
        $("#cohort_table_init").data('tablesorter').widgetOptions.output_saveFileName = "cohort.csv";
        $("#cohort_table_init").trigger('outputTable');
    });
    $("#downloadCohortXLS").click(function () {
        $("#cohort_table_init").data('tablesorter').widgetOptions.output_delivery = "d";
        $("#cohort_table_init").data('tablesorter').widgetOptions.output_saveFileName = "cohort.xls";
        $("#cohort_table_init").trigger('outputTable');
    });
});

function getFormData(form, flds) {
    var data = {};
    $.each(flds, function (i, n) {
        var field = $(form[n]);
        var field_value = field.val();
        if (field.attr('chktype')) {
            var chktype = field.attr('chktype');
            var chkmsg = field.attr('chkmsg');
            if (field_value == '') {
                new Dialog($('#dialog')).show("Error", "The following error occurred: " + chkmsg);
                data = false;
                return false;
            }
        }
        if (field.attr('type') != 'checkbox' || field.prop('checked')) {
            data[n] = field_value;
        }
    });
    return data;
}

$("#cohortImportForm").submit(function () {
    var flds = ["id", "code", "licences", "term_months", "start_date", "district_id", "csrfmiddlewaretoken"];
    var data = getFormData(this, flds);
    if (data) {
        $.post('${reverse("pepconn_cohort_submit")}', data, function (r) {
                    if (r.success) {
                        new Dialog($('#dialog')).show('Success', 'The cohort was successfully created!');
                    } else {
                        new Dialog($('#dialog')).show("Error", "The following error occurred: " + r.error);
                    }
                }
        );
    }
    return false;
});

function toggle(which) {
    $(".import-section").hide();
    $("." + which + "-section").show();
    $(".section-tab").css("padding-top", "4px");
    $(".section-tab." + which).css("padding-top", "10px")
}
function toggle2(which) {
    $(".table-section").hide();
    $("." + which + "-section").show();
    $(".table-tab").css("padding-top", "4px");
    $(".table-tab." + which).css("padding-top", "10px");
    $(".search").val('').change();
}

if (typeof CKEDITOR != 'undefined') {
    CKEDITOR.replaceAll(function (textarea, config) {
        if (textarea.className == 'email-editor') {
            // Add token plugin
            config.extraPlugins = 'token';
            // Configure available tokens
            config.availableTokens = [
                ["", ""],
                ["email", "email"],
                ["district", "district"],
                ["site", "site"],
                ["key", "key"]
            ];
            return true;
        }
        return false;
    });
}

//* global
//** add csrf token to json
function safeJSON(j) {
    j.csrfmiddlewaretoken = "${csrf_token}"
    return j;
}
function syncCKEditorData() {
    $.each(CKEDITOR.instances, function (name, inst) {
        if (inst.element.$.tagName.toLowerCase() == 'textarea') {
            $(inst.element.$).val(inst.getData());
        }
    });
}
//** init custom email
$(".custom-email-checkbox").click(function () {
    var textarea = $(this).parent().parent().next(".custom-email");
    if ($(this).prop('checked')) {
        textarea.slideDown();
    } else {
        textarea.slideUp();
    }
});
//** init expand title
$(".expand_title").click(function () {
    var $div = $(this).next("div.expand_div");
    if ($div.is(':visible')) {
        $div.slideUp();
        $(this).removeClass("expand_title_expanded");
    } else {
        $div.slideDown();
        $(this).addClass("expand_title_expanded");
    }
});
//** init filter controls
$(".control.filter").each(function () {
    var el = this;
    new FilterControl(this);
    this.onFavoriteServerUpdated = function () {
        $(".control.filter").each(function () {
            if (!$(el).is(this)) this.control.createFavorite();
        });
    }
});
//** init table controls
$(".control.table").each(function () {
    new TableControl(this)
});

//* controller for user data import
var userDataImport = {
    submit: function () {
        var self = this;
        var form = this.$form[0];
        // input checking
        /* var state_id=$(form.state_id).val();
           var district_id=$(form.district_id).val();
           if(!state_id || !district_id){
           new Dialog($('#dialog')).show('Error','You must select a State, District and file to import.');
           return false;
           } */
        if (!((/\.csv/i).test(form.file.value))) {
            new Dialog($('#dialog')).show('Error', 'Please select a CSV file.');
            return false;
        }
        syncCKEditorData();
        $.ajax({
            url: "${reverse('pepconn_import_user_submit')}",
            data: new FormData(form), processData: false, contentType: false, type: 'POST',
            /* enctype: 'multipart/form-data',
               mimeType: 'multipart/form-data', */
            success: function (data) {
                self.renderProgress(data.taskId);
            }
        });
    },
    renderProgress: function (taskId) {
        var dialog = new Dialog($('#dialog'));
        dialog.show("User Import", "<p style='font-size:20px;font-weight:bold;'>Import Started</p>\
<br>You may monitor the progress in the Unread Tasks, below.\
<br>If there are any errors, you will receive them in an email.");
    },
    init: function () {
        function pcSlider(clicked, target) {
            if (clicked.prop('checked')) {
                target.slideDown();
            } else {
                target.slideUp();
            }
        }

        var self = this;
        this.$form = $("#userDataImportForm");
        $(".send-email").click(function () {
            var checkboxArea = $(this).parent().parent().next(".customize-email");
            var checkbox = $(checkboxArea).children("label").children(".custom-email-checkbox");
            if (checkbox.prop('checked')) {
                checkbox.removeProp('checked');
                var textarea = checkbox.parent().parent().next(".custom-email");
                pcSlider(checkbox, textarea);
            }
            pcSlider($(this), checkboxArea);
        });
        this.$form.submit(function () {
            self.submit();
            return false;
        });
    }
};
userDataImport.init();

//* controller for district data import
var districtDataImport = {
    submit: function (form) {
        var self = this;
        var form = this.$form[0];
        // input checking
        /* var state_id=$(form.state_id).val();
           var district_id=$(form.district_id).val();
           if(!state_id || !district_id){
           new Dialog($('#dialog')).show('Error','You must select a State, District and file to import.');
           return false;
           } */
        if (!((/\.csv/i).test(form.file.value))) {
            new Dialog($('#dialog')).show('Error', 'Please select a CSV file.');
            return false;
        }
        syncCKEditorData();
        $.ajax({
            url: "${reverse('pepconn_import_district_submit')}",
            data: new FormData(form), processData: false, contentType: false, type: 'POST',
            /* enctype: 'multipart/form-data',
               mimeType: 'multipart/form-data', */
            success: function (data) {
                self.renderProgress(data.taskId);
            }
        });
    },
    renderProgress: function (taskId) {
        var dialog = new Dialog($('#dialog'));
        dialog.show("District Import", "<p style='font-size:20px;font-weight:bold;'>Import Started</p>\
<br>You may monitor the progress in the Unread Tasks, below.\
<br>If there are any errors, you will receive them in an email.");
    },
    init: function () {
        function pcSlider(clicked, target) {
            if (clicked.prop('checked')) {
                target.slideDown();
            } else {
                target.slideUp();
            }
        }

        var self = this;
        this.$form = $("#districtDataImportForm");

        this.$form.submit(function () {
            self.submit();
            return false;
        });
    }
};
districtDataImport.init();

//* controller for school data import
var schoolDataImport = {
    submit: function (form) {
        var self = this;
        var form = this.$form[0];

        if (!((/\.csv/i).test(form.file.value))) {
            new Dialog($('#dialog')).show('Error', 'Please select a CSV file.');
            return false;
        }
        syncCKEditorData();
        $.ajax({
            url: "${reverse('pepconn_import_school_submit')}",
            data: new FormData(form), processData: false, contentType: false, type: 'POST',
            /* enctype: 'multipart/form-data',
               mimeType: 'multipart/form-data', */
            success: function (data) {
                self.renderProgress(data.taskId);
            }
        });
    },
    renderProgress: function (taskId) {
        var dialog = new Dialog($('#dialog'));
        dialog.show("School Import", "<p style='font-size:20px;font-weight:bold;'>Import Started</p>\
<br>You may monitor the progress in the Unread Tasks, below.\
<br>If there are any errors, you will receive them in an email.");
    },
    init: function () {
        function pcSlider(clicked, target) {
            if (clicked.prop('checked')) {
                target.slideDown();
            } else {
                target.slideUp();
            }
        }

        var self = this;
        this.$form = $("#schoolDataImportForm");
        this.$form.submit(function () {
            self.submit();
            return false;
        });
    }
};
schoolDataImport.init();
</script>
