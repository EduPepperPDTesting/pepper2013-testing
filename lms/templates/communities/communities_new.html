<%! from django.utils.translation import ugettext as _ %>
<%!
    from django.core.urlresolvers import reverse
    from courseware.courses import course_image_url, get_course_about_section
    from courseware.access import has_access
    from certificates.models import CertificateStatuses
    from xmodule.modulestore import MONGO_MODULESTORE_TYPE
    from xmodule.modulestore.django import modulestore
    from student.models import State,District,Transaction,Cohort,School,SubjectArea,GradeLevel,YearsInEducation, UserProfile, User
    from baseinfo.models import Enum
    from communities.models import CommunityCommunities, CommunityUsers
    from communities.views import user_in_community, community_in_state, community_in_district

%>
<%! navbar_show_extended=False %>
<%inherit file="../main.html" />
<%namespace name='static' file='../static_content.html'/>
<%block name="title"><title>Communities</title></%block>
<link rel="stylesheet" type="text/css"  href="/static/tmp-resource/css/ppd-general01.css"/>

<link rel="stylesheet" href="/static/css/admin_ui_controls.css" type="text/css" media="screen"/>
<link rel="stylesheet" href="/static/css/bootstrap-iso.css"/>
<link rel="stylesheet" href="/static/css/pepreg.css" type="text/css" media="screen"/>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

<style type="text/css" media="screen">
a.district-button, a.school-button, a.user-button {
    outline: none;
}

.section-tab.public {
    border-color: rgb(103, 141, 11) rgb(103, 141, 11) rgb(83, 121, 11);
    box-shadow: 0 1px 0 0 rgb(123, 221, 91) inset;
    background-color: rgb(123, 181, 51);
    background-image: linear-gradient(to bottom, rgb(123, 221, 91) 0%, rgb(123, 181, 51) 50%, rgb(103, 161, 31) 50%, rgb(103, 161, 31) 100%);
    text-shadow: 0 -1px 1px rgb(83, 121, 11);
}
.section-tab.private {
    border-color: rgb(47, 107, 189) rgb(47, 107, 189) rgb(47, 87, 169);
    box-shadow: 0 1px 0 0 rgb(47, 207, 269) inset;
    background-color: rgb(47, 167, 229);
    background-image: linear-gradient(to bottom, rgb(47, 207, 269) 0%, rgb(47, 167, 229) 50%, rgb(47, 147, 209) 50%, rgb(47, 147, 209) 100%);
    text-shadow: 0 -1px 1px rgb(47, 87, 169);
    padding-top: 10px;
}
.section-tab.mydistrict {
    border-color: rgb(174, 50, 7) rgb(174, 50, 7) rgb(154, 30, 7);
    box-shadow: 0 1px 0 0 rgb(294, 170, 67) inset;
    background-color: rgb(234, 110, 7);
    background-image: linear-gradient(to bottom, rgb(294, 170, 67) 0%, rgb(234, 110, 7) 50%, rgb(214, 90, 7) 50%, rgb(214, 90, 7) 100%);
    text-shadow: 0 -1px 1px rgb(154, 30, 7);
}
.section-tab {
    border-width: 0 1px 1px 1px;
    border-style: solid;
    -moz-border-top-colors: none;
    -moz-border-right-colors: none;
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    border-image: none;
    border-radius: 0 0 5px 5px;
    color: #FFF;
    display: inline-block;
    text-align: center;
    text-decoration: none;
    font: 1.2rem/1.6rem "Open Sans",Verdana,Geneva,sans-serif;
    letter-spacing: 1px;
    padding: 4px 20px;
    text-transform: uppercase;
    vertical-align: top;
    margin-left: 5px;
}
#page-nav,#page-footer {
    width: 1180px;
}
#btn-logged-user{
     display: none;
}
.form-select {
    font-size: 14px !important;
    width: 180px;
}
.image-link-style {
    border-radius: 6px;
    -moz-border-radius: 6px;
    -webkit-border-radius: 6px;
    display: block;
    float: left;
    margin: 30px;
    width:240px;
    height:150px;
    background-size: auto 100px;
    background-color: white;
    background-position: 50% 0;
    background-repeat: no-repeat;
}
.image-bottom-style {
    border-radius: 0 0 6px 6px;
    -moz-border-radius: 0 0 6px 6px;
    -webkit-border-radius: 0 0 6px 6px;
    display: block;
}
.card-link {
    display: table-cell;
    width: 240px;
    height: 60px;
    vertical-align: middle;
    padding: 0 17px;
    font-size: 22px;
    background: rgba(18,111,154,0.95);
    text-decoration: none !important;
}
.card-link span {
    color: #FFFFFF;
}
.data_import_top {
    padding-top: 20px;
}
.data_import_content {
    margin: auto;
    background: #e4e4e4;
    width: 960px;
}
.grade_title {
    float: left;
    width: 920px;
    height: 20px;
    background-color: #fff;
    text-align: left;
    padding-left: 40px;
    color: #666;
    font-size: 16px;
    font-weight: bold;
    font-family: "Open Sans",Verdana,Geneva,sans-serif;
    padding-top: 4px;
    padding-bottom: 2px;
}
a.btnx:hover {
    background: #638194;
    transition-delay: 0s, 0s, 0s;
    transition-duration: 0.25s, 0.25s, 0.25s;
    transition-property:color, background,​box-shadow;
    transition-timing-function:cubic-bezier(0.42, 0, 0.58, 1), cubic-bezier(0.42, 0, 0.58, 1), cubic-bezier(0.42, 0, 0.58, 1);
    color: #fff;
}
a.btnx {
    background-color: #556370;
    padding-bottom: 2px !important;
    padding-left: 10px;
    padding-right: 10px;
    padding-top: 2px !important;
    text-decoration: none !important;
    cursor: pointer;
    font-family: 'Open Sans',Verdana,Geneva,sans-serif;
    color: #fff;
    transition-timing-function: cubic-bezier(0.42, 0, 0.58, 1), cubic-bezier(0.42, 0, 0.58, 1), cubic-bezier(0.42, 0, 0.58, 1);
}
a.btnx:normal {
    background-color: #126F9A;
    text-decoration: none;
    cursor: pointer;
    font-family: 'Open Sans',Verdana,Geneva,sans-serif;
    color: #fff;
    transition-timing-function: cubic-bezier(0.42, 0, 0.58, 1), cubic-bezier(0.42, 0, 0.58, 1), cubic-bezier(0.42, 0, 0.58, 1);
}
div.expand_title {
    color: #08a;
    font-size: 20px;
    padding: 5px 5px 10px 5px;
    cursor: pointer;
    background-color: #ccc;
    box-shadow: 0 1px 0 0 #fff inset;
    background-image: linear-gradient(to bottom, #fff 0%, #ddd 50%, #ccc 50%, #ccc 100%);
    text-shadow: 0 -1px 1px #aaa;
}

div.expand_title .icon {
    display: inline-block;
    position: relative;
    top: 5px;
    width: 23px;
    height: 23px;
    background: url("../images/arrows.png") no-repeat 0 0;
}
div.expand_div{
    display:block !important;
}

/*--new style----------------------------------*/
.con-maincontent-all{
    width:680px;
    margin-left:27px;
    float:left;
    position: relative;
    margin-bottom:0px;
    background-color:#fff;
    margin-bottom:15px;

    border: 0px solid;
}
.community-banner{
    width:680px;
    height:138px;
    position:relative;
}
.community-banner-title{
    position:absolute;
    left:45px;
    top:35px;

    font-family: Arial, Helvetica, sans-serif !important;
    font-size:25px;
    font-weight:bold;
    color:#000;
    line-height:25px;
}
.community-banner-title2{
    position:absolute;
    left:45px;
    top:87px;

    font-family: Arial, Helvetica, sans-serif !important;
    font-size:15px;
    color:#fff;
}
.community-find{
    height:70px;
    width:640px;
    background-color:#2abaee;
    margin:auto;
    margin-top:20px;
    
    border-radius: 20px;
    -moz-border-radius: 20px;
    -webkit-border-radius: 20px;
}
.community-all{
    width:640px;
    background-color:#e4e4e4;
    margin:auto;
    margin-top:15px;
    margin-bottom:15px;
}
.community-all-title{
    width:100%;
    height:30px;
    background-color:#535456;
    color:#fff;
    font-size:17px;
    text-align:center;
    padding-top:10px;
}
.communities-column{
    width:193px;
    float:left;
    background-color:#fff;
    margin-left:15px;
    margin-top:15px;
    margin-bottom:15px;
}

.my-communities-title{
    width:100%;
    height:30px;
    color:#fff;
    font-size:14px;
    padding-top:10px;
    text-align:center;
}
.my-communities-all{
    width:100%;
    height:500px;
    overflow-y:auto;
}

.communities-text{
    width:130px;
    margin:auto;
    border-bottom:1px solid #ccc;
    font-size:13px;
    padding-top:25px;
    padding-bottom:25px;
}
.communities-text a{
    color:#000;
    font-size:13px;
    text-decoration:none !important;
}
.communities-text:last-child{
    border-bottom:0px !important;
}


/*-----------akogan-----------*/
.label{color: #000000 !important;}
.switch i{ bottom: 15px !important;}
.step-page .move{right: 25px !important;}
.step-content{ width: 720px !important;}

.form-row span{font: normal 16px "Open Sans",Verdana,Geneva,sans-serif !important; color: #3c3c3c !important;padding-right: 0px !important}
.form-row label{font: normal 16px "Open Sans",Verdana,Geneva,sans-serif !important; color: #3c3c3c !important;padding-right: 0px !important}
.form-row span.label{font: 12px "Open Sans",Verdana,Geneva,sans-serif !important; color: #3c3c3c !important;padding-right: 0px !important}
.form-row select{color: #222;}
.form-row input{color: #222 !important;}
.form-row textarea{color: #222 !important;}

h1, h2, section.outside-app h1, h3, h4, h5, h6{font: normal 1.2em/1.2em Georgia,Cambria,"Times New Roman",Times,serif !important;}

#dlg-warning{height: 210px;}

/*-----------old create community -----------*/
.community-error-box {
    border-color: red !important;
}
#community-courses,#community-resources {
    clear: both;
    display: block;
    text-align: left;
    margin-bottom: 20px;
}

#community-courses input, #community-resources input {
    /*display: block;
    float: left;*/
    margin: 0 20px 2px 0;
}
#community-resources .community-resource{
    margin-bottom:25px !important;
    /*border-bottom:1px solid;*/
}
#community-courses select {
    display: block;
    float: left;
    margin: 0 20px 20px 0;
    font-weight:bold;
    font-style:italic;
}
#community-resources .add, #community-courses .add {
    padding: 0 6px;
    color:#fff !important;
}
#community-resources .minus, #community-courses .minus {
    padding: 0 8px;
    color:#fff !important;
}
.community-course, .community-resource, #community-state {
    clear: both;
}
.resource-logo-label{
    font-size:13px;
    font-weight:bold;
    font-style:italic;
}
.community-logo-thumb {
    float: left;
    width: 150px;
    margin-right: 10px;
}
.icon-edit:before {font-family:FontAwesome; }
.icon-remove:before {font-family:FontAwesome;   }
/*-----------create community form-----------*/
#community-name input{
    padding:5px 12px;
    width:500px;
    margin-top:5px;
}

#community-motto input{
    padding:5px 12px;
    max-width:650px !important;
    width:650px;
    margin-top:5px;
}
#community-private input{
    margin-left:5px;
    margin-top:0px;
}

.select-lock{
    color:#ccc !important;
    border-color:#ccc;
}

.select-lock option{
    color:#ccc;
}
</style>
<link rel="stylesheet" href="/static/css/amazeui.cropper.css">
<link rel="stylesheet" href="/static/css/custom_up_img.css">
<script src="/static/js/amazeui.min.js" charset="utf-8"></script>
<script src="/static/js/cropper.min.js" charset="utf-8"></script>
<script src="/static/js/custom_up_img2.js" charset="utf-8"></script>
<script>
    function fsubmit(){
        var communities = [];
        %for community in communities:
            communities[${community['id']}] = "${reverse('community_view', args=[community['id']])}";
        %endfor
        var community = $("#community_list_form .form-select").val();
        window.location.href =  communities[community];
        return false;
    }
</script>
<%
    district_id = ''
    if request.user.profile.district_id:
        district_id = request.user.profile.district_id

    state_id = ''
    for item in State.objects.all().order_by('name'):
        if district_id:
            if item.name == request.user.profile.district.state.name:
                state_id = item.id
                break
%>
<span id="organization_obj" o_name="communities"></span>
<section class="content-wide" style="margin-top:0px;background-color:#e7e7e8;">
    <section class="communities-new" style="margin:0 auto;width:1240px;padding-top:14px;">

        <!--Communities-My Trending Topics-->
        <%include file="../navigation_left_list.html" />

        <!--Communities-->
        <div class="con-maincontent-all clearfix">
            <div class="community-banner">
                <img src="/static/images/ppd-courses-banner.jpg" width="680" height="138"/>
                <div class="community-banner-title">
                    PROFESSIONAL
                    <br/>
                    LEARNING COMMUNITIES
                </div>
                <div class="community-banner-title2">
                    build and enhance your community of practice
                </div>
            </div>
            <div class="community-find">
                <div style="padding-top:22px;padding-left:30px;">
                    <form method="" id="community_list_form" action="">
                        <div style="padding:0px;color:#666;display:inline-block;">
                            <span style="color:#fff;font-size:14px;">Find a Community</span>
                        </div>
                        <div style="display:inline-block;padding:0 5px 0 5px;">
                            <select name="subject_id" class="form-select">
                                %for community in communities:
                                    <option value="${community['id']}">${community['name']}</option>
                                %endfor
                            </select>
                        </div>
                        <a href="#" class="btnx" onClick="fsubmit();" style="padding:0px 30px 0px 30px;font-size:14px;">Find</a>
                        %if request.user.is_superuser:
                            <div style="padding-left:10px;color:#666;display:inline-block;">
                                <span><a href="#" style="font-size:14px;text-decoration:none;" onclick="return pepreg.addTraining();">Create a New Community</a></span>
                            </div>
                        %endif
                    </form>
                </div>
            </div>
            <div class="community-all">
                <div class="community-all-title">
                    Pepper Communities
                </div>
                <div class="community-content">
                    <div class="my-communities communities-column">
                        <div class="my-communities-title" style="background-color:#28bcec;">My Communities</div>
                        <div class="my-communities-all">
                            %for community in communities:
                                %if user_in_community(community['id'], request.user.id):
                                    <div class="communities-text">
                                        <a href="${reverse('community_view', args=[community['id']])}">${community['name']}</a>
                                    </div>
                                %endif
                            %endfor
                        </div>
                    </div>

                    <div class="public-communities communities-column">
                        <div class="my-communities-title" style="background-color:#f8801f;">Public Communities</div>
                        <div class="my-communities-all">
                            %for community in communities:
                                %if community['private'] == 0:
                                    <div class="communities-text">
                                        <a href="${reverse('community_view', args=[community['id']])}">${community['name']}</a>
                                    </div>
                                %endif
                            %endfor
                        </div>
                    </div>

                    <div class="my-district-communities communities-column">
                        <div class="my-communities-title" style="background-color:#89c651;">My District Communities</div>
                        <div class="my-communities-all">
                            %for community in communities:
                                %if community_in_district(community['id'], request.user.id):
                                    <div class="communities-text">
                                        <a href="${reverse('community_view', args=[community['id']])}">${community['name']}</a>
                                    </div>
                                %endif
                            %endfor
                        </div>
                    </div>

                    <div style="clear:both;"></div>
                </div>
            </div>
            
        </div>

        <!--Courses-My Learning Plan-->
        <%include file="../navigation_right_list.html" />

        <div style="clear:both;"></div>
    </section>
</section>
<div class="modal bootstrap-iso" id="dlg-warning" style="width:500px;margin-left:-250px;border-radius:0;">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0;border-radius:0;">
        <div class="titlebar">
            <h3 class="dialog-title"></h3>
            <div class="close-modal" id="dialog_close">✕</div>
        </div>
        <div class="content" style="padding:30px;overflow-x:auto;overflow-y:auto;position:relative;background:#fff;border-radius:0;"></div>
    </div>
</div>
<div class="modal bootstrap-iso" id="dlg-upload_picture" style="width:600px;margin-left:-300px;border-radius:0;height:520px;">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0;border-radius:0;">
        <div class="titlebar">
            <h3 class="dialog-title"></h3>
            <div class="close-modal" id="dialog_close">✕</div>
        </div>
        <div style="padding:10px;overflow-x:auto;overflow-y:auto;position:relative;background:#fff;border-radius:0;">
            <div class="am-modal-dialog up-frame-parent up-frame-radius">
                <div class="am-modal-bd  up-frame-body">
                    <div class="am-g am-fl">
                        <div class="am-form-group am-form-file">
                            <input type="file" id="inputImage">
                        </div>
                    </div>
                    <div class="am-g am-fl" >
                        <div class="up-pre-before up-frame-radius">
                            <img alt="" src="" id="image" >
                        </div>
                        <div class="up-pre-after up-frame-radius">
                        </div>
                    </div>
                </div>
            </div>
            <div class="up-control-btns" style='float:left;margin-left: 20px;margin-top:5px;'>
                <button class="am-icon-rotate-left"  onclick="rotateimgleft()">turnleft</button>
                <button class="am-icon-rotate-right" onclick="rotateimgright()">turnright</button>
                <button class="am-icon-check" id="up-btn-ok">confirm</button>
            </div>
        </div>
    </div>
</div>
<div class=" modal bootstrap-iso" id="dlg-add-training" style="width:800px;margin-left:-400px; position: absolute; top: 120px; height:500px;border-radius:0;">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0;border-radius:0;">
        <!-- <div class="titlebar">
        <h3 class="dialog-title">Add Training</h3>
        <div class="close-modal" id="dialog_close">✕</div>
        </div> -->
        <input type="hidden" name="id" value=""/>
        <div class="content" style="height:508px;overflow:hidden;position:relative;background:#fff;padding:0;border-radius:0;">
            <div class="" style="width:100%;height:100%;overflow:hidden;">
                <div class="step-page">
                    <div class="step-content">
                        <h5>Create Community: Step 1 of 5</h5>
                        <h4>General Information</h4>
                        <div class="form-row" style="font-size:12px;">
                            <label id="community-name">
                                <span>Community Name:</span></br>
                                <input type="text" name="name" value="" placeholder="The name of the community">
                            </label>
                        </div>
                        <div class="form-row" style="font-size:12px;">
                            <label id="community-motto">
                                <span>Description (Motto):</span></br>
                                <input type="text" name="motto" value="" placeholder="A description or motto for this community">
                            </label>
                        </div>
                        <div class="form-row" style="font-size:12px;">
                            <label id="community-logo"><span>Logo </span>
                            <span class="about-field" style="color:#999 !important;font-size:80% !important;">(380px X 260px or larger for best results)</span>:</br>
                            <span class="edit-name" id='edit_photo' style="cursor:pointer;color:#1d9dd9 !important;">Select Picture</span></label>
                            <input type='hidden' name='logo' id="logo">
                        </div>
                        <div class="form-row" style="font-size:12px;margin-top:100px;">
                            <label id="community-private"><span>Private Group:</span><input type="checkbox" name="private" value=""></label>
                        </div>
                    </div>
                </div>
                <div class="step-page">
                    <div class="step-content">
                        <h5>Create Community: Step 2 of 5</h5>
                        <h4>Organization Information</h4>
                        <div class="form-row" style="font-size:14px;">
                            %if request.user.is_superuser:
                                <label id="community-state"><span>Select State:</span></br>
                                    <select id="state-dropdown" name="state-dropdown"></select>
                                </label>
                            %else:
                                <label id="community-state"><span>Select State:</span>
                                    <select id="state-dropdown" name="state-dropdown" disabled class="select-lock"></select>
                                </label>
                            %endif
                        </div>
                        <div class="form-row" style="font-size:12px;margin-top:50px;">
                            %if request.user.is_superuser:
                                <label id="community-district"><span>Select District:</span></br>
                                    <select id="district-dropdown" name="district-dropdown" style="min-width:100px;"></select>
                                </label>
                            %else:
                                <label id="community-district"><span>Select District:</span>
                                    <select id="district-dropdown" name="district-dropdown" disabled class="select-lock" style="min-width:100px;"></select>
                                </label>
                            %endif
                        </div>
                    </div>
                </div>
                <div class="step-page">
                    <div class="step-content">
                        <h5>Create Community: Step 3 of 5</h5>
                        <h4>Add Courses</h4>
                        <div class="form-row" style="font-size:14px;">
                            <label><span>courses:</span></label></br>
                            <div style="overflow-y:auto;height:320px;">
                                <div id="community-courses">
                                    %for idx, course in enumerate(courses):
                                        <div class="community-course">
                                            <select name="course[${idx}]">
                                                <option value="">Select a Course</option>
                                                %for course_option in courses_drop:
                                                    %if course == course_option['id']:
                                                        <option value="${course_option['id']}" selected="selected">${course_option['number']} | ${course_option['name']}</option>
                                                    %else:
                                                        <option value="${course_option['id']}">${course_option['number']} | ${course_option['name']}</option>
                                                    %endif
                                                %endfor
                                            </select>
                                            <input type="button" class="add operation" value="+" onclick="newCourse()">
                                        </div>
                                    %endfor
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="step-page">
                    <div class="step-content">
                        <h5>Create Community: Step 4 of 5</h5>
                        <h4>Add resources</h4>
                        <div class="form-row" style="font-size:14px;">
                            <label><span>Resources:</span></label></br>
                            <div style="overflow-y:auto;height:320px;">
                                <div id="community-resources">
                                    %for idx, resource in enumerate(resources):
                                        <div class="community-resource">
                                            <input class="resource-name" type="text" name="resource_name[${idx}]" value="${resource['name']}" placeholder="Resource name"><input class="resource-link" type="text" name="resource_link[${idx}]" value="${resource['link']}" placeholder="Resource link"><input type="button" class="add operation" value="+" onclick="newResource()"/>
                                            <div>
                                                <div class="resource-logo-label">Logo:</div>
                                                %if resource['logo']:
                                                    <div class="community-resource-logo-wrap">
                                                        <img src="${get_file_url(resource['logo'])}" class="community-logo-thumb">
                                                        <input class="community-resource-logo typelogo" type="hidden" name="resource_logo[${idx}]" value="${resource['logo'].id}" id="resource_logo[${idx}]">
                                                        <a href="#" class="remove"></a>
                                                    </div>
                                                %else:
                                                    <input class="resource-logo typelogo" type="file" name="resource_logo[${idx}]" id="resource_logo[${idx}]">
                                                %endif
                                            </div>
                                        </div>
                                    %endfor
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="step-page">
                    <div class="step-content">
                        <h5>Create Community: Step 5 of 5</h5>
                        <h4>Add/Remove Facilitators</h4>
                        <div class="form-row" style="font-size:14px;">
                            <div style="width:100%;height:240px;overflow-y:scroll;border:1px solid #999;">
                                <table width="100%" cellspacing="" cellpadding="" border="0">
                                    <thead>
                                        <tr>
                                            <th width="30" align="center"></th>
                                            <th width="70">Default</th>
                                            <th align="center">Email</th>
                                            <th width="150" align="center">Edit Community</th>
                                            <th width="150" align="center">Delete Community</th>
                                        </tr>
                                    </thead>
                                    <tbody id="community_facilitators_list">
                                        <!--
                                        <tr>
                                            <td></td>
                                            <td style='padding-left:15px;'><input name='showinui' type='radio' value='' /></td>
                                            <td>matrixsniper@163.com</td>
                                            <td style='padding-left:30px;'><input name='aa1' type='checkbox' value='' /></td>
                                            <td style='padding-left:40px;'><input name='aa2' type='checkbox' value='' /></td>
                                        </tr>
                                        -->
                                    </tbody>    
                                </table>
                            </div>
                        </div>
                        <div class="form-row" style="font-size:14px;">
                            <i>Select a <b>Community Facilitator</b> by searching email (start typing and select email of
                                <b>Facilitator</b>):</i>
                            <div style="margin:5px 0 5px 0;">
                                <select id="complete-email" name="member" style="min-width:100px;margin:5px 5px 0 0;">
                                    %for user_option in users_drop:
                                        %if request.user.id == user_option['user_id']:
                                            <option value="${user_option['user_id']}" selected="selected">${user_option['email']}</option>
                                        %else:
                                            <option value="${user_option['user_id']}">${user_option['email']}</option>
                                        %endif
                                    %endfor
                                </select>
                                <!--<input type="text" name="member" id="complete-email" autocomplete="off">-->
                                <input type="button" name="" value="Add" class="btn-add-facilitator" style="color:#fff !important;"/>
                            </div>
                            <i>You may add more <b>Facilitators</b> after selecting the first one.</i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    function newCourse() {
        var course_num = $('.community-course').length;
        $('.community-course').each(function(index) {
            $(this).find('.operation').replaceWith('<input type="button" class="minus operation" value="-" onclick="removeCourse(' + index + ')">');
        });
        var entry = '<div class="community-course"><select name="course[' + course_num + ']"><option value="">Select a Course</option>';
        %for course_option in courses_drop:
            entry += '<option value="${course_option['id']}">${course_option['number']} | ${course_option['name'].replace("'", r"\'")}</option>';
        %endfor
        entry += '</select><input type="button" class="add operation" value="+" onclick="newCourse()"></div>';
        $('#community-courses').append(entry);
    }

    function removeCourse(index) {
        $('.community-course').each(function(i) {
            if (i == index) {
                $(this).remove();
            } else {
                var num = 0;
                if (i < index) {
                    num = i;
                }
                if (i > index) {
                    num = i - 1;
                }
                $(this).children('select').attr('name', 'course[' + num + ']');
            }
        });
        $('.community-course .minus').each(function(index) {
            $(this).replaceWith('<input type="button" class="minus operation" value="-" onclick="removeCourse(' + index + ')">');
        });
    }

    function newResource() {
        var resource_num = $('.community-resource').length;
        $('.community-resource').each(function(index) {
            $(this).find('.operation').replaceWith('<input type="button" class="minus operation" value="-" onclick="removeResource(' + index + ')">');
        });
        var entry = '<div class="community-resource">';
        entry += '<input class="resource-name" type="text" name="resource_name[' + resource_num + ']" value="" placeholder="Resource name">';
        entry += '<input class="resource-link" type="text" name="resource_link[' + resource_num + ']" value="" placeholder="Resource link">';
        entry += '<input type="button" class="add operation" value="+" onclick="newResource()">';
        entry += '<div><div class="resource-logo-label">Logo:</div><input class="resource-logo typelogo" type="file" name="resource_logo[' + resource_num + ']" id="resource_logo[' + resource_num + ']"></div>';
        $('#community-resources').append(entry);
    }

    function removeResource(index) {
        $('.community-resource').each(function(i) {
            if (i == index) {
                $(this).remove();
            } else {
                var num = 0;
                if (i < index) {
                    num = i;
                }
                if (i > index) {
                    num = i - 1;
                }
                $(this).children('.resource-link').attr('name', 'resource_link[' + num + ']');
                $(this).children('.resource-name').attr('name', 'resource_name[' + num + ']');
                //$(this).children('.resource-logo').attr('name', 'resource_logo[' + num + ']');
                $(this).find('.resource-logo').attr('name', 'resource_logo[' + num + ']');
                $(this).find('.resource-logo').attr('id', 'resource_logo[' + num + ']');
            }
        });
        $('.community-resource .minus').each(function(index) {
            $(this).replaceWith('<input type="button" class="minus operation" value="-" onclick="removeResource(' + index + ')">');
        });
    }
</script>

<script type="text/javascript">
    function PepReg($content) {
        var self = this;
        this.$content = $content;
        this.initContent();
        this.formdata = '';
    }

    PepReg.prototype.addTraining = function () {
        var self = this;
        var steps = this.initForm({district_id:${request.user.profile.district_id}}, function (data) {          
            //submit
            if (einfo = self.validateAllPage(data)) {
                self.warning(einfo.error[1], self.dlgForm);
                self.steps.switchTo(einfo.id);
                return;
            }
            console.log("jsondata: ",data);
            self.createFormdata(data);
            /*
            $.post("${reverse('community_edit_process_new')}", data, function (r) {
                if (r.success) {
                    $("#dlg-add-training").hide();
                    $(".lean-overlay").hide();
                    //self.reloadTable();
                    console.log("return ok");
                }
            });
            */
            
            $.ajax({
                url: "${reverse('community_edit_process_new')}",  //server script to process data
                type: 'POST',
                //Ajax事件
                success: function(r){
                    console.log(r);
                    console.log("ok");
                },
                error: function(r){},
                // Form数据
                data: self.formdata,
                //Options to tell JQuery not to process data or worry about content-type
                cache: false,
                contentType: false,
                processData: false
            });
            
            console.log("ajax end");
        });
        return false;
    };

    PepReg.prototype.initForm = function (data, finishCallback) {
        var self = this;
        var dlg = this.dlgForm = new Dialog($("#dlg-add-training"));
        dlg.show();
        var steps = this.steps = new StepsForm($("#dlg-add-training"),
                ["#A6CE69", "#8CBE41", "#5FC4ED", "#38B6E9", "#F6B262"]); //"#F18200"
        // ************* add dlg close button to each step
        $("#dlg-add-training").find(".close-modal").remove();
        $("<div class='close-modal'>✕</div>").appendTo($("#dlg-add-training").find(".step-content:eq(0)")).click(function () {//style='right:-50px;'
            dlg.hide();
        });

        $('.community-error-box').removeClass('community-error-box');
        // ************* before switch to another page
        steps.onBeforeSwitch = function (curr, dest) {
            var $content = this.getContent(curr);
            
            var data = self.getInput();
            console.log("initForm getInput: ", data);
            if (!this.visited(dest) && (error = self.validatePage(curr, data))) {
                return self.warning(error[1], self.dlgForm);
            }
            //akogan
            if ( dest > -1 ){
                $(".step-page .close-modal").remove();
                $("<div class='close-modal'>✕</div>").appendTo($("#dlg-add-training").find(".step-content:eq(" + dest + ")")).click(function () {
                    dlg.hide();
                });
            }
            return dest == 0 || this.visited(dest - 1) || self.warning("Please finish the previous pages before switch to that page", self.dlgForm); // return true if ready to switch
        };
        // ************* when finish form
        steps.onFinish = function () {
            console.log("finish==============");
            finishCallback && finishCallback(self.getInput());
        };
        // ************* unlock all pages when editing
        if (data && data.id) {
            steps.unlockAll();
        } else {
            self.clearData();
        }
        //self.fillData(data); 

        // ************* btn upload Picture
        $("#edit_photo").click(function(){
            self.upload_picture("", self.dlgForm);
        });
        

        // ************* input facilitators
        $(".btn-add-facilitator").unbind("click").bind("click", function () {
            var email = $("#complete-email").find("option:selected").text();
            var user_id = $("#complete-email").val();
            self.addFacilitator(email);
        });

        return steps;
    };

    PepReg.prototype.repeatFacilitator = function () {
        var ar = [];       
        $("#community_facilitators_list").find("tr").each(function () {
            var email = $(this).find("td").eq(2).text();
            ar.push(email);
        });
        return ar;
    };

    PepReg.prototype.addFacilitator = function (email) {
        if(email){
            var curr = this.repeatFacilitator();
            if(curr.indexOf(email) < 0){
                var tmp_tr = $("<tr><td><a class='icon icon-remove' style='cursor:pointer;'></a></td></tr>");
                var data_have = $("#community_facilitators_list").find("tr").html();
                if(!data_have){
                    var tmp_td1 = $("<td style='padding-left:15px;'><input name='showinui' type='radio' value='' checked='checked'/></td>");
                    var tmp_td3 = $("<td style='padding-left:30px;'><input name='aa1' type='checkbox' value='' checked='checked'/></td>");
                    var tmp_td4 = $("<td style='padding-left:40px;'><input name='aa2' type='checkbox' value='' checked='checked'/></td>");
                }
                else{
                    var tmp_td1 = $("<td style='padding-left:15px;'><input name='showinui' type='radio' value='' /></td>");
                    var tmp_td3 = $("<td style='padding-left:30px;'><input name='aa1' type='checkbox' value='' /></td>");
                    var tmp_td4 = $("<td style='padding-left:40px;'><input name='aa2' type='checkbox' value='' /></td>");
                }
                var tmp_td2 = $("<td>" + email + "</td>");
                tmp_tr.append(tmp_td1).append(tmp_td2).append(tmp_td3).append(tmp_td4);
                $("#community_facilitators_list").append(tmp_tr);

                tmp_tr.find("a").click(function(e){
                    e.preventDefault();
                    $(this).parent().parent().remove();
                });
            }
        }
    }
    PepReg.prototype.getFacilitators = function () {
        var ar = [];       
        $("#community_facilitators_list").find("tr").each(function () {
            var defalut = ($(this).find("input").eq(0).is(":checked")) ? "1" : "0";
            var email = $(this).find("td").eq(2).text();
            var can_edit = ($(this).find("input").eq(1).is(":checked")) ? "1" : "0";
            var can_delete = ($(this).find("input").eq(2).is(":checked")) ? "1" : "0";
            ar.push(email + "::" + defalut + "::" + can_edit + "::" + can_delete);
        });
        return ar;
    };

    PepReg.prototype.getCourses = function () {
        //get courses exclude repeat
        var courses = [];       
        $("#community-courses").find("select").each(function () {
            var course_id = $(this).val();
            if(course_id){
                courses.push(course_id); 
            }
        });
        if(courses){
            var result = [], hash = {};
            for (var i = 0, elem; (elem = courses[i]) != null; i++){
                if (!hash[elem]){
                    result.push(elem);
                    hash[elem] = true;
                }
            }
            courses = result;
        }
        return courses;
    };
    PepReg.prototype.getResource_names = function () {
        var resource_names = [];       
        $("#community-resources").find(".resource-name").each(function () {
            var name = $(this).val();
            resource_names.push(name); 
        });
        return resource_names;
    };
    PepReg.prototype.getResource_links = function () {
        var getResource_links = [];       
        $("#community-resources").find(".resource-link").each(function () {
            var link = $(this).val();
            getResource_links.push(link); 
        });
        return getResource_links;
    };
    /*
    PepReg.prototype.getFacilitators = function () {
        var ar = [];       
        $("#community_facilitators_list").find("tr").each(function () {
            var email = $(this).find("td").eq(2).text();
            var all_edit = ($(this).find("input").eq(1).is(":checked")) ? "1" : "0";
            var all_delete = ($(this).find("input").eq(2).is(":checked")) ? "1" : "0";
            ar.push(email + "::" + all_edit + "::" + all_delete);
            ar.push(email);
        });
        return ar;
    };
    PepReg.prototype.appendFacilitators = function (emails) {
        if (emails) {
            var curr = this.getFacilitators();
            console.log(emails.split(","));
            console.log("curr----: ",curr);
            $.each(emails.split(","), function (i, email) {
                console.log(i,email);
                if (email && curr.indexOf(email) < 0) {
                    console.log(curr.indexOf(email));
                    var tmp = email.split("::");
                    if(tmp[0] != ""){
                        var tmp_tr = $("<tr><td><a class='icon icon-remove' style='cursor:pointer;'></a></td></tr>");
                        var tmp_td1 = $("<td style='padding-left:15px;'><input name='showinui' type='radio' value='' /></td>");
                        var tmp_td2 = $("<td>" + tmp[0] + "</td>");
                        var tmp_td3 = $("<td style='padding-left:30px;'><input name='aa1' type='checkbox' value='' /></td>");
                        var tmp_td4 = $("<td style='padding-left:40px;'><input name='aa2' type='checkbox' value='' /></td>");
                        tmp_tr.append(tmp_td1).append(tmp_td2).append(tmp_td3).append(tmp_td4);
                        $("#community_facilitators_list").append(tmp_tr);
                        
                        //if(tmp[1] == "1")           tmp_td2.find("input").attr("checked", "checked");
                        //if(tmp[2] == "1")           tmp_td3.find("input").attr("checked", "checked");
                        
                        tmp_tr.find("a").click(function(e){
                            e.preventDefault();
                            $(this).parent().parent().remove();
                        });
                    }
                }
            });
        }
    };
    */

    PepReg.prototype.initContent = function () {
        //this.initFilter();
        //this.initTable();
    };

    PepReg.prototype.initFilter = function () {
        var self = this;

        function filterOptions(item, id) {
            if ($(item).attr("class") != id) {
                $(item).css("display", "none");
            } else {
                $(item).css("display", "");
            }
            if (id == "null_case" || $(item).attr("class") == "null_case") {
                $(this).css("display", "");
            }
        }

        $("#state_select").change(function () {
            var id = $(this).children(":selected").attr("class");
            $("#district_select > option").each(function () {
                filterOptions(this, id)
            });
        });
        $("#filter-suject-drop").change(function () {
            var val = $(this).val();
            var $input = $(this).next("select"); //("input");
            $input.val("");
            if (val == "Other") {
                $input.show();
            } else {
                $input.hide();
                //$input.val(val);
            }
            //$input.change();
        });
    };

    PepReg.prototype.clearData = function () {
        var empty = {};
        $.each(this.getInput(), function (k, v) {
            empty[k] = "";
        });
        this.fillData(empty);
    };

    PepReg.prototype.getInput = function () {
        var $form = $("#dlg-add-training");
        var json = {
            community_id: "new",
            name: $form.find("input[name=name]").val(),
            motto: $form.find("input[name=motto]").val(),
            logo: $form.find("input[name=logo]").val(),
            private: ($form.find("input[name=private]").is(":checked")) ? "1" : "0",
            state: $form.find("select[name=state-dropdown]").val(),
            district: $form.find("select[name=district-dropdown]").val(),
            courses: this.getCourses().join(","),
            resource_names: this.getResource_names().join(","),
            resource_links: this.getResource_links().join(","),
            facilitators: this.getFacilitators().join(",")
        };
        return json;
    };
    
    PepReg.prototype.createFormdata = function (data) {
        var self = this;
        var jsondata = data;
        self.formdata = null;
        self.formdata = new FormData();
        for(var k in jsondata){
            self.formdata.append(k, jsondata[k]);
        }
        
        $("#community-resources").find(".typelogo").each(function (i) {
            var id = $(this).attr("id");
            var name = $(this).attr("name");
            var type = $(this).attr("type");
            
            if(type == 'file'){
                var fileObj = document.getElementById(id).files[0];
                if(fileObj){
                    self.formdata.append(name, fileObj);
                } 
                else{
                    self.formdata.append(name, '');
                }
            }
            else{
                self.formdata.append(name, $(this).val());
            }
        });
    };

    PepReg.prototype.fillData = function (data) {
        var self = this;
        data = data || {};
        /*
        var state = '${request.user.profile.district.state.name} United States';
        if (data.geo_props) {
            var props = JSON.parse(data.geo_props);
            this.markPlace(this.map_edit, props.lat, props.lon, 15);
        } else {
            this.showPlace(this.map_edit, state);
        }
        $.each(data, function (k, v) {
            var $entry = $("#dlg-add-training").find("*[name=" + k + "]");
            if ($entry.prop("tagName") == "INPUT" && ($entry.attr("type") == "radio" || $entry.attr("type") == "checkbox")) {
                $entry.prop('checked', false);
                $entry.filter("*[value=" + v + "]").prop('checked', true);
            } else if (k == "instructor_emails") {
                //$("#instructor_emails").html("");
                $("#training_instructors_list").html("");
                self.appendInstructors(v);
            } else {
                $entry.val(v);
            }
        });
        var $subject = $("#dlg-add-training").find("select[name=subject]");
        if (data.subject) {console.log("data="+data.subjectother);
            //var $opts = $subject.find("option[value=" + data.subject + "]");
            //if (!$opts.length) {
            if (data.subjectother != ""){
                $subject.next("input[name=subject-other]").show().val(data.subjectother);
                $subject.val("Other");
            }
        } else {
            $subject.next("input[name=subject-other]").val("");
        }
        */
    };

    PepReg.prototype.validatePage = function (page, data) {
        $('.community-error-box').removeClass('community-error-box');
        
        if (page == 0) {
            if (!data.name) {
                $('#community-name input').addClass('community-error-box');
                return ["name", "Community Name is required."];
            }
            else if(!/[A-Za-z]/.test(data.name)){
                $('#community-name input').addClass('community-error-box');
                return ["name", "Community Name format wrong."];
            }
        }
        else if (page == 1) {
        } 
        else if (page == 2) {
        } 
        else if (page == 3) {
        }  
        else if(page == 4){
            var facilitator = $("#community_facilitators_list").find("tr").html();
            if(!facilitator){
               return ["facilitator", "You must add at least one facilitator."];
            }
            else{
                var facilitators_info = this.getFacilitators();
                var default_sum = 0;
                var edit_sum = 0;
                for(var i=0;i<facilitators_info.length;i++){
                    var check_info = facilitators_info[i].split("::");
                    var default_f = parseInt(check_info[1]);
                    var can_edit = parseInt(check_info[2]);
                    default_sum += default_f;
                    edit_sum += can_edit;
                }
                if(default_sum == 0){
                    return ["facilitator", "Community need a default facilitator."];
                }
                else if(edit_sum == 0){
                    return ["facilitator", "At least one facilitator need edit privilege."];
                }
            }
        }
    };

    PepReg.prototype.validateAllPage = function (data) {
        var self = this;
        var r = null;
        $("#dlg-add-training").find(".step-page").each(function (i) {
            if (error = self.validatePage(i, data)) {
                r = {id: i, error: error};
            }
        });
        return r;
    };

    PepReg.prototype.warning = function (s, dlgFlyOn) {
        var self = this;
        if (dlgFlyOn){
            dlgFlyOn.hideOverlay();
        }
        var dlg = new Dialog($("#dlg-warning"));
        if(s && s.indexOf("Thank you")===0){
            dailogTitle = "Confirmation";
        }else{
            dailogTitle = "Warning";
        }
        dlg.show(dailogTitle, s);
        dlg.lift(100);
        $("#dlg-warning").bind("hide", function () {
            $(this).unbind('hide');
            if (dlgFlyOn){
                dlgFlyOn.showOverlay();
            }
        });
    };

    PepReg.prototype.upload_picture = function (s, dlgFlyOn) {
        $(".lean-overlay").remove();
        var self = this;
        if (dlgFlyOn){
            dlgFlyOn.hideOverlay();
        }
        var dlg = new Dialog($("#dlg-upload_picture"));
        dailogTitle = "Add Profile Picture";
        dlg.show(dailogTitle, s);
        dlg.lift(100);
        $("#dlg-upload_picture").bind("hide", function () {
            $(this).unbind('hide');
            if (dlgFlyOn){
                dlgFlyOn.showOverlay();
            }
        });
    };

    $("#up-btn-ok").click(function(){
        $("#dlg-upload_picture").hide();
        $(".lean-overlay").remove();
    });

    $(document).ready(function () {
        //** init controller
        window.pepreg = new PepReg();
        //window.pepreg = new PepReg($(".expand_div").eq(0));

        var district_id = ${district_id};
        var state_id = ${state_id};
        $.get('${reverse('pepper_utilities_drop_states')}', function (data) {
            // Build the options.
            var options = '<option value=""></option>';
            $.each(data, function (index, object) {
                options += '<option value="' + object.id+ '"';
                if (object.id == state_id) {
                    options += ' selected';
                }
                options += '>' + object.name + '</option>';
            });
            // Add them to the state dropdown.
            $('#state-dropdown').append(options);

            $("#state-dropdown").change(function () {
                if ($(this).val()) {
                    // Clear the current district and school options since the state changed.
                    $('#district-dropdown option').remove();
                    // Get the allowed Districts
                    $.get('${reverse('pepper_utilities_drop_districts')}', {state: $(this).val()}, function (data) {
                        var content = '<option value=""></option>';
                        $.each(data, function (index, object) {
                            content += '<option value="' + object.id + '"';
                            if (object.id == district_id) {
                                content += ' selected';
                            }
                            content += '>' + object.name + '</option>';
                        });
                        // Add it to the form.
                        $('#district-dropdown').append(content);
                    });
                }
                else{
                    $('#district-dropdown').html('<option value=""></option>');
                }
            });
            if (state_id) {
                $("#state-dropdown").trigger('change');
            }
        });


        //** init expand title
        /*
        $(".expand_title").next("div.expand_div").slideDown(); //akogan
        //$(".expand_title").off("click").bind("click", function () {
        $(".expand_title").on("click", function () {
            if ($(".expand_div").is(':visible')) {
                $(".expand_div").slideUp();
                $(this).removeClass("expand_title_expanded");
            } else {
                $(".expand_div").slideDown();
                $(this).addClass("expand_title_expanded");
            }
        });
        */
        // $(".expand_title").click();
        /*
        $(".print-map").click(function (e) {
            e.preventDefault();
            return false;
        });
        */
    });
</script>

