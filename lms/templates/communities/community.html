<%inherit file="../main.html" />
<%!
from django.core.urlresolvers import reverse
from courseware.courses import course_image_url, get_course_about_section
from student.views import course_from_id
from administration.configuration import has_hangout_perms
from communities.utils import is_facilitator, is_member
from file_uploader.utils import get_file_url
from django.utils import timezone
from datetime import date
%>
<%namespace name='static' file='../static_content.html'/>
<%block name="title">
    <title>${community.name}</title>
</%block>
<script type="text/javascript" src="/static/js/admin_ui_controls.js"></script>
<script type="text/javascript" src="https://secure.skypeassets.com/i/scom/js/skype-uri.js"></script>
<script type="text/javascript" src="/static/js/ckeditor/ckeditor.js" charset="utf-8"></script>
<style type="text/css" media="screen">
    .remove_skype_span:hover{
        cursor: pointer;
    }
    .remove_skype_span{
        padding-left:5px;
        padding-bottom:2px;
    }
    .circle {
      width: 20px;
      height: 20px;
      background: #22B14C;
      border-radius: 10px;
      position:absolute;
      right:0;
    }

    #community-main {
        width: 1185px;
        margin: 30px auto;
        text-align: left;
    }
    #community-main-content {
        width: 880px;
        float: left;
    }
    #community-main-sidebar {
        width: 266px;
        float: right;
        top: 0;
        text-align: center;
    }
    #community-sidebar-header {
        border: 2px solid #ddd;
        height: 53px;
        text-align: center;
        vertical-align: middle;
        font: 700 1.2em/2.4em "Open Sans",Verdana,Geneva,sans-serif;
    }
    #community-sidebar {
        width: 208px;
        padding: 20px 20px 0 20px;
        border: 2px solid #ddd;
        margin: auto;
        border-top: 0;
        text-align: left;
    }
    .sidebar-section {
        margin: 0 0 20px 0;
    }
    #community-member {
        margin-top: 10px;
    }
    .sidebar-section h2 {
        border-bottom: 2px solid #90BF70;
        padding-bottom: 5px;
        margin: 0 0 10px 0;
        color: #006EBF;
        font-weight: bold;
        text-transform: none;
        font-size: 1em;
        line-height: 1em;
    }
    .sidebar-sub-section {
        margin: 0 10px;
    }
    .trending-title {
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .trending-name {
        font-size: 80%;
        display: block;
        margin-bottom: 5px;
    }
    .trending-name span {
        font-weight: bold;
    }
    .status-name {
        display: block;
        margin-bottom: 5px;
    }
    #community-header {
        border: 2px solid #ddd;
        width: 100%;
        position: relative;
        min-height: 260px;
    }
    #community-header h1 {
        text-align: left;
        color: #006EBF;
        margin: 15px 0 0 20px;
        font-weight: bold;
        font-size: 160%;
    }
    #community-header h2 {
        margin: 15px 0 0 20px;
        text-transform: none;
        font-weight: bold;
    }
    #community-header h3 {
        color: #006EBF;
        padding: 10px 0;
    }
    #community-header h4 {
        font-weight: bold;
    }
    #community-avatar {
        width: 100px;
        float: left;
        margin: 0 15px 0 0;
    }
    #community-logo {
        float: right;
        width: 380px;
        height: 260px;
        overflow: hidden;
        margin: 15px;
        text-align: center;
        background-color: white;
    }
    #community-logo img {
        height: 260px;
    }
    .facilitator-wrap {
        position: absolute;
        width: 450px;
        bottom: 20px;
        left: 20px;
    }
    #community-content-area h1 {
        color: #006EBF;
        padding: 20px 3px;
        font-size: 20px;
        font-weight: bold;
        text-align: left;
        border-bottom: 2px solid #90BF70;
        display: inline-block;
    }
    #community-content h1 {
        width: 100%;
    }
    #community-content, #community-discussions {
        color: #000;
        padding: 20px 3px;
    }
    #community-content-area label {
        font-style: normal;
        display: inline-block;
        width: 3.5em;
        text-align: left;
        font-weight: bold;
    }
    #community-content-area span {
        /*font-size: 12px;*/
    }
    #community-content {
        width: 270px;
        height: 700px;
        float: left;
    }
    #community-content-scroller {
        width: 270px;
        height: 640px;
        overflow-y: scroll;
        overflow-x: hidden;
    }
    #community-discussions {
        width: 578px;
        margin-right: 20px;
        float: left;
    }
    .discussion {
        clear: both;
        position: relative;
        border: 2px solid #ddd;
        border-radius: 10px;
        padding: 15px 20px 15px 94px;
        background-color: #fff;
        margin-bottom: 15px;
    }
    .discussion h2 {
        margin-bottom: 5px;
        width: 370px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .discussion-post-info-header {
        float: left;
        width: 463px;
    }
    .discussion-post-info div {
        display: inline-block;
    }
    .discussion-post-info span {
        font-weight: bold;
    }
    .discussion-byline {
        overflow: hidden;
        height: 1.5em;
        width: 370px;
        white-space: nowrap;
        text-overflow: ellipsis;
    }
    .discussion-stats-header {
        float: left;
        width: 100px;
    }
    .discussion-stats {
        float: right;
        width: 80px;
    }
    .discussion-stats span {
        display: block;
    }
    .discussion-avatar {
        position: absolute;
        width: 64px;
        display: block;
        top: 15px;
        left: 20px;
    }
    .community-clear {
        clear: both;
        height: 1px;
        margin-top: -1px;
    }
    #discussion-pager {
        text-align: center;
        line-height: 24px;
        clear: both;
        margin: 20px 0;
    }
    #discussion-pager a {
        width: auto;
        line-height: 24px;
        padding: 2px 5px;
        color: #333;
        border: 1px solid #ccc;
        margin-left: 3px;
    }
    #discussion-pager a:hover {
        color: #ff6600;
    }
    #discussion-pager .up_page {
        display: inline-block;
        width: 17px !important;
        line-height: 24px;
        height: 20px;
        background: url(/static/tmp-resource/image/up_page.png) no-repeat;
        border: none;
        vertical-align: middle;
    }
    #discussion-pager .next_page {
        display: inline-block;
        width: 17px !important;
        height: 20px;
        background: url(/static/tmp-resource/image/next_page.png) no-repeat;
        border: none;
        margin-left: 13px;
        vertical-align: middle;
    }
    #discussion-pager .page_active {
        color: #ff6600 !important;
    }
    #discussion-pager .page_active:hover {
        color: #ff9933 !important;
    }
    #discussion-pager .page_num {
        display: inline-block;
        padding: 2px 5px;
    }
    div.cke{
        width:580px;
    }
    .community-resource {
        display: block;
        clear: both;
        margin-bottom: 20px;
        border: 0 solid #f0870c;
        height: 160px;
        width: 242px;
        box-shadow: rgba(0, 0, 0, 0.1) 3px 7px 7px 0;
        border-radius: 6px;
        overflow: hidden;
        position: relative;
    }
    .community-resource img {
        display: block;
        width: 242px;
        border-radius: 6px;
    }
    .community-resource a {
        display: block;
        position: absolute;
        bottom: 0;
        left: 0;
        height: 60px;
        background: #f0870c;
        color: #fff;
        font-size: 14px;
        border-radius: 0 0 6px 6px;
    }
    .community-resource div {
        display: table-cell;
        height: 60px;
        vertical-align: middle;
        width: 242px;
        text-align: center;
    }
    #table-members th {
        color: #006EBF;
        padding: 20px 3px;
        font-size: 20px;
    }
    .card-link span {
        color: #FFFFFF;
    }
    .course-card {
        margin: 0 0 20px 0 !important
    }
    div.card-bottom table tr:nth-child(2) {
        display: none;
    }
    #members {
        display: inline-block;
        overflow-x: hidden;
        padding: 10px 0;
        width: 100%;
        position: relative;
    }
    #members a {
        margin-right: 5px;
        display: inline-block;
    }
    #members a img {
        vertical-align: middle;
    }
    .modal {
        position: absolute;
        opacity: 1;
        z-index: 11000;
        left: 50%;
        margin-left: -349px;
        top: 40px;
        background: none repeat scroll 0 0 rgba(255, 255, 255, 1);
        border-radius: 5px;
        box-shadow: 0px 15px 80px 15px rgba(0, 0, 0, 0.5);
        padding: 0 0 8px 0;
        width: 680px;
        display: none;
    }
    #fixed-dialog, #skype-dialog {
        position: fixed;
    }
    .modal .close-modal {
        border-radius: 2px;
        cursor: pointer;
        display: inline-block;
        vertical-align: baseline;
        padding: 10px;
        position: absolute;
        right: 2px;
        top: 0;
        z-index: 3;
        color: #333;
    }
    .modal .titlebar {
        height: 70px;
        background: #ccc;
    }
    .modal .dialog-title {
        margin: 0;
        padding: 20px 0 0 30px;
        color: #666;
    }
    .modal .content {
        color: #333;
        text-align: left;
        font-size: 16px;
        padding: 20px 10px;
        line-height: 20px;
    }
    .modal .discussion-error {
        color: #f00;
        font-weight: bold;
        font-size: 120%;
        line-height: 120%;
    }
    .modal .inner-wrapper form textarea {
        height: 100px;
    }
    .hangout_container {
        text-align: center;
        padding-top: 20px;
    }
    .hangout_container img {
        width: 120px;
        vertical-align: top;
    }
    .hangout_container .side-button {
        background: #8cbe41 url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAQAAAAngNWGAAAAAmJLR0QA/4ePzL8AAAAJcEhZcwAAAEgAAABIAEbJaz4AAAAJdnBBZwAAABQAAAAUAKM7KtEAAAB2SURBVCjPY/zPQBxgIlIdTRReYfiPFZ5HUsXNMJ/hP24A06P9/8r//4QVpvz/CuHgU8jzfzGCgxvo/b+O4DD+xx3iPxg4iAue38SGoynDZSQeXs9w/p9NjGcgwRPz/zNxChn+a0IC/AoOZVeR4pP7/3zGIZAeAdFoNZxQb6AuAAAAAElFTkSuQmCC) no-repeat 10px 10px;
        height: 20px;
    }
    .side-button {
        color: white !important;
        display: block;
        padding: 10px;
        border-width: 1px;
        border-style: solid;
        text-align: center;
        margin-top: 5px;
    }
    .blue-button {
        border-color: #45719E;
        background: #5A9BD5;
    }
    .green-button {
        border-color: #595;
        background: #8cbe41;
    }
    .red-button {
        border-color: #df0000;
        background: #ED2828;
    }
    #poll-form {
        display: none;
        margin-top: 15px;
        clear: both;
    }
    .poll-answer-input {
        width: 80% !important;
        display: inline !important;
    }
    .discussion-attachment {
        float: left;
        padding-top: 16px;
    }
    .discussion-poll {
        float: right;
        display: block;
        vertical-align: middle;
        padding-top: 16px;
    }
    #members-title {
        border-bottom: 2px solid #90BF70;
        color: #006EBF;
        font-size: 20px;
        padding: 20px 3px;
        font-weight: bold;
        clear: both;
    }
    #table-members {
        width: 100%;
        table-layout: fixed;
        margin-bottom: 20px;
    }
    #table-members tr {
        border-bottom: 2px solid #90BF70;
    }
    .member-arrows {
        width: 20px;
        vertical-align: middle;
    }
    .member-arrows div {
        cursor: pointer;
        width: 17px;
        height: 20px;
    }
    .member-arrow-left {
        background: url(/static/tmp-resource/image/up_page.png);
    }
    .member-arrow-right {
        background: url(/static/tmp-resource/image/next_page.png);
    }
    .member-column {
        white-space: nowrap;
    }
    .discussion-error-box {
        border-color: red !important;
    }
    #create-skype {
        float: left;
        margin: 0 20px 0 0;
    }
    .skype-container {
        float: left;
    }
    .skype-button .side-button {
        background: #5A9BD5 url(https://swx.cdn.skype.com/skypewebsdk/shareButton/v/latest/assets/images/s_logo.svg) no-repeat 10px 10px/20px 20px;
        height: 20px;
    }
</style>
<link rel="stylesheet" type="text/css"  href="static/tmp-resource/css/ppd-general01.css"/>
<body style="text-align:center">
<div id="community-main" class="clearfix">
    <section id="community-main-content">
        <div id="community-header">
            %if community.logo:
                <div id="community-logo"><img src="${get_file_url(community.logo)}" alt="Community Logo"/></div>
            %endif
            <h1>${community.name}</h1>
            <h2>${community.motto}</h2>
            %if facilitator:
                <div class="facilitator-wrap">
                    <img src="${reverse('user_photo', args=[facilitator.user.id])}" id="community-avatar" alt="Facilitator Avatar" />
                    <h3>${facilitator.user.first_name} ${facilitator.user.last_name}</h3>
                    <h4>Community Facilitator</h4>
                </div>
            %endif
            <div class="community-clear"></div>
        </div>

        <div id="community-content-area">
            <div id="community-discussions">
                <a name="discussions"></a>
                <h1 class="discussion-post-info-header">Community Discussion</h1>
                <h1 class="discussion-stats-header">Activity</h1>
                <div class="discussions">
                %for i,d in enumerate(discussions):
                    <div class="discussion">
                        <img class="discussion-avatar" src="${reverse('user_photo', args=[d.user.id])}">
                        <div class="discussion-stats">
                            <span>Replies: ${d.replies}</span>
                            <span>Views: ${d.views}</span>
                        </div>
                        <h2><a href="${reverse('community_discussion_view', args=[d.id])}">${d.subject}</a></h2>
                        <div class="discussion-post-info">
                            <div class="discussion-byline"><span>Posted By: </span>${d.user.first_name} ${d.user.last_name}</div>
                            <div class="discussion-date"><span> On: </span>${'{dt:%b}. {dt.day}, {dt.year}'.format(dt=d.date_create)}</div>
                        </div>
                        <div class="community-clear"></div>
                    </div>
                %endfor
                </div>
                <div id="discussion-pager">
                    <span>Total Discussions: ${pager['total']}</span>&nbsp;&nbsp;&nbsp;
                    %if pager['page'] > 1:
                        <a href="#discussions" onclick="replaceDiscussions(${pager['page']-1})" class="up_page"></a>
                    %endif
                    %for p in pager['jumps']:
                        %if p=='c':
                            <a href="#discussions" onclick="replaceDiscussions(${pager['page']})" class="page_active">${pager['page']}</a>
                        %else:
                            <a href="#discussions" onclick="replaceDiscussions(${p})">${p}</a>
                        %endif
                    %endfor
                    %if pager['pages'] > pager['page']:
                        <a href="#discussions" onclick="replaceDiscussions(${pager['page']+1})" class="next_page"></a>
                    %endif
                </div>
            </div>
            <div id="community-content">
                <h1>Content Collections</h1>
                <div id="community-content-scroller">
                    %for i,cc in enumerate(courses):
                        <% c=course_from_id(cc.course) %>
                        <%include file="../course.html" args="course=c" />
                    %endfor
                    %for i,r in enumerate(resources):
                        <div class="community-resource">
                            <img src="${get_file_url(r.logo)}" alt="${r.name}" />
                            <a href="${r.link}" target="_blank">
                                <div>
                                    ${r.name}
                                </div>
                            </a>
                        </div>
                    %endfor
                </div>
            </div>
        </div>

        <div id="members-title">Members</div>
        <table id="table-members" cellspacing="" cellpadding="" border="0">
            <tr>
                <td class="member-arrows">
                    <div class="member-arrow-left" onclick="left()"> </div>
                </td>
                <td class="member-column">
                    <div id="members">
                      %for u in users:
                      <%
                      user = u.user
                      active_before = (timezone.now().date() - user.profile.last_activity.date()).days if user.profile.last_activity else 999999
                      active_recent = active_before < 1
                      %>
                      <a href="${reverse('dashboard',args=[u.user.id])}" target="_blank" style="position:relative;">
                        %if request.user.is_superuser and active_recent:
                        <div class="circle"></div>
                        %endif
                        <img src="${reverse('user_photo',args=[u.user.id])}" alt="${u.user.first_name}" />
                      </a>
                      %endfor
                    </div>
                </td>
                <td class="member-arrows">
                    <div class="member-arrow-right" onclick="right()"></div>
                </td>
            </tr>
        </table>
    </section>
    <section id="community-main-sidebar">
        <div id="community-sidebar-header">
            ${request.user.username}
        </div>
        <div id="community-sidebar">
            <div class="sidebar-section" style="text-align: center;">
                <img src="/static/images/pcg_columns_transparent.png" alt="PCG Logo" />
                %if is_member(request.user, community):
                    <div id="community-member">MEMBER</div>
                %else:
                    <a href="#" class="side-button green-button" onclick="joinMe()">Add Me</a>
                %endif
            </div>
            <div class="sidebar-section">
                <h2>Community Status</h2>
                <div class="sidebar-sub-section">
                    <span class="status-name">Discussions: ${total_discussions}</span>
                    <!--<span class="trending-name">Messages: </span>-->
                    <span class="status-name">Members: ${users.count()}</span>
                </div>
            </div>
            <div class="sidebar-section">
                <h2>Trending</h2>
                <div class="sidebar-sub-section">
                    %for i, d in enumerate(trending):
                        <span class="trending-title"><a href="${reverse('community_discussion_view', args=[d.id])}">${d.subject}</a></span>
                        <span class="trending-name"><span>Posted: </span>${'{dt:%b}. {dt.day}, {dt.year}'.format(dt=d.date_create)}</span>
                    %endfor
                </div>
            </div>
            <div class="sidebar-section">
                <a href="${reverse('communities')}" class="blue-button side-button">My Communities</a>
                %if is_member(request.user, community) or request.user.is_superuser:
                    <a href="#" class="blue-button side-button" id="newDiscussionButton" onclick="newDiscussion()">Start a New Discussion</a>
                %endif
                %if is_facilitator(request.user, community) or request.user.is_superuser:
                    <a href="${reverse('community_edit',args=[community.id])}" class="green-button side-button">Edit</a>
                    <a href="${reverse('community_delete',args=[community.id])}" class="red-button side-button delete-icon">Delete</a>
                    <a href="${reverse('community_mange_member',args=[community.id])}" class="blue-button side-button">Manage Members</a>
                %endif
                %if has_hangout_perms(request.user) and community.hangout:
                    <div class="hangout_container" id="hangout_div">
                        <img src="/static/images/community_google_hangouts.png" class="" alt="" />
                        <a class="side-button green-button" href="${community.hangout}" target="_blank">Join Hangout</a>
                    </div>
                %endif
                %if request.user.is_superuser:
                    <div class="skype-button">
                        <a href="#" id="skype-start" class="side-button blue-button">Start Skype Call</a>
                    </div>
                %endif
            </div>
        </div>
    </section>
</div>
<div style="" id="dialog" class="modal">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0">
        <div class="titlebar">
            <h3 class="dialog-title"></h3>
            <div class="close-modal" id="dialog_close">✕</div>
        </div>
        <div class="content"></div>
    </div>
</div>
<div style="" id="fixed-dialog" class="modal">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0">
        <div class="titlebar">
            <h3 class="dialog-title"></h3>
            <div class="close-modal" id="dialog_close">✕</div>
        </div>
        <div class="content"></div>
    </div>
</div>
<div style="" id="skype-dialog" class="modal">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0">
        <div class="titlebar">
            <h3 class="dialog-title">Start Skype Call</h3>
            <div class="close-modal" id="dialog_close">✕</div>
        </div>
        <div class="content">
            <form>
                <label>Select Skype Usernames from the below list to add to call.</label><br>
                <select id = "skype_usernames_select">
                    <option id = "uname_null" val="">Select Username</option>
                    %for u in users:
                        %if u.user.profile.skype_username != "NULL":
                            <option class='skype_uname_option' id="${u.user.username}" val="${u.user.profile.skype_username}">${u.user.profile.skype_username}</option>
                        %endif
                    %endfor
                </select>
                <span id="selected_skype_names"></span><br>
                <label>Topic (optional):<input type="text" name="skype-topic"></label>
                <input type="button" value="Create" id="create-skype">
                <div class="skype-container">
                    <script type="text/javascript">
                        function startSkype(params) {
                            var skype_button = Skype.ui(params);
                            if (skype_button) {
                                var id = $('.skype-container').attr('id');
                                $('#' + id + '_paraElement img').css({'margin': '0', 'vertical-align': '0'});
                            }
                        }
                    </script>
                </div>
            </form>
            <div class="community-clear"></div>
        </div>
    </div>
</div>
<script type="text/javascript">
    function joinMe(){
        var user_id = "${request.user.id}";
        $.post("${reverse('community_join', args=[community.id])}",{user_ids:user_id}, function(r){
            if(r.success)
                window.location.reload();
        });
    }
    function validateDiscussionForm() {
        $('.discussion-error-box').removeClass('discussion-error-box');
        var valid = true;
        var errors = ['The following errors occurred:\n'];
        if (!/[A-Za-z]/.test($('.discussion-subject input').val())) {
            valid = false;
            errors.push('Subject is required.');
            $('.discussion-subject input').addClass('discussion-error-box');
        }
        if (!/[A-Za-z]/.test($('.discussion-post textarea').val())) {
            valid = false;
            errors.push('Discussion is required.');
            $('.discussion-post textarea').addClass('discussion-error-box');
        }
        if ($('#new-discussion-submit .poll-add').is(':checked')) {
            if (!/[A-Za-z]/.test($('.poll-question').val())) {
                valid = false;
                errors.push('Question is required.');
                $('.poll-question').addClass('discussion-error-box');
            }
            if ($('.poll-answer-input').length < 2) {
                valid = false;
                errors.push('You need at least two answers to choose from.');
            }
            $('.poll-answer-input').each(function() {
                if (!/[A-Za-z]/.test($(this).val())) {
                    valid = false;
                    errors.push('Answers must be filled out.');
                    $(this).addClass('discussion-error-box');
                    return false;
                }
            });
            if ($('.poll-expiration').val() != '' && !/^\d?\d\/\d?\d\/\d\d\d\d$/.test($('.poll-expiration').val())) {
                valid = false;
                errors.push('Expiration date must be in the format mm/dd/yyyy.');
                $('.poll-expiration').addClass('discussion-error-box');
            }
        }
        if (!valid) {
            var error = errors.join('\n');
            alert(error);
        }
        return valid;
    }
    function newDiscussion() {
        var content = '<form id="new-discussion-submit" action="${reverse('community_discussion_add')}" method="post" enctype="multipart/form-data">';
        content += '<label class="discussion-subject">Subject:<input type="text" name="subject"></label>';
        content += '<label class="discussion-post">Discussion:<textarea name="post" id="post"></textarea></label>';
        content += '<label class="discussion-attachment">Attachment:<input type="file" name="attachment"></label>';
        content += '<label class="discussion-poll"><img src="/static/images/poll-icon.png" alt="Add Poll"> <input type="checkbox" class="poll-add"> Add Poll</label>';
        content += '<div id="poll-form">';
        content += '<label>Question: <input class="poll-question" type="text" name="question"></label>';
        content += '<label>Answers: <ol id="poll-answers">';
        content += '<li class="poll-answer">';
        content += '<input class="poll-answer-input" type="text" name="answers[0]">';
        content += '</li>';
        content += '<li class="poll-answer">';
        content += '<input class="poll-answer-input" type="text" name="answers[1]"> <input type="button" class="add operation" value="+">';
        content += '</li>';
        content += '</ol></label>';
        content += '<label>Expiration Date: <input class="poll-expiration" type="text" name="expiration" placeholder="mm/dd/yyyy"></label>';
        content += '</div>';
        content += '<input type="hidden" value="${community.id}" name="community_id">';
        content += '<input type="hidden" name="csrfmiddlewaretoken" value="${csrf_token}"/>';
        content += '<div class="community-clear"></div><br/>';
        content += '<input type="submit" name="submit" value="Add">';
        content += '</form><div class="discussion-error"></div>';
        var discussion_dialog = new Dialog($('#dialog'));
        discussion_dialog.show('New Discussion', content);
        CKEDITOR.replace('post');

        $('#new-discussion-submit').submit(function(event) {
            event.preventDefault();
            for (var instanceName in CKEDITOR.instances) {
                CKEDITOR.instances[instanceName].updateElement();
            }
            if (validateDiscussionForm()) {
                var formData = new FormData($(this)[0]);
                var formSelector = $(this);
                $.ajax({
                    url: '${reverse('community_discussion_add')}',
                    type: 'POST',
                    data: formData,
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        if (data.Success) {
                            if ($('#new-discussion-submit .poll-add').is(':checked')) {
                                var pollData = formSelector.serializeArray();
                                pollData[pollData.length] = {name: 'poll_id', 'value': data.DiscussionID};
                                $.post('${reverse('poll_form_submit', args=['discussion'])}', pollData, function (data) {
                                    if (data.Success) {
                                        discussion_dialog.hide();
                                        replaceDiscussions(1);
                                    } else {
                                        $('.discussion-error').append('There was an error adding your discussion. Please try again later.')
                                    }
                                });
                            } else {
                                discussion_dialog.hide();
                                replaceDiscussions(1);
                            }

                        } else {
                            $('.discussion-error').append('There was an error adding your discussion. Please try again later.')
                        }
                    }
                });
            }
        });

        $('.poll-add').click(function() {
            $('#poll-form').toggle();
        });
        $('.poll-answer .add').click(function() {
            newAnswer();
        });
    }
    function replaceDiscussions(page) {
        $.get('${reverse('community_discussion_list', args=[community.id])}', {'page': page}, function(data) {
            var content = '<div class="discussions">';
            for (var x = 0; x < data.discussions.length; x++) {
                content += '<div class="discussion">';
                content += '<img class="discussion-avatar" src="' + data.discussions[x].avatar + '">';
                content += '<div class="discussion-stats">';
                content += '<span>Replies: ' + data.discussions[x].replies + '</span>';
                content += '<span>Views: ' + data.discussions[x].views + '</span>';
                content += '</div>';
                content += '<h2><a href="' + data.discussions[x].url + '">' + data.discussions[x].subject + '</a></h2>';
                content += '<div class="discussion-post-info">';
                content += '<div class="discussion-byline"><span>Posted By: </span>' + data.discussions[x].first_name + ' ' + data.discussions[x].last_name + '</div>';
                content += '<div class="discussion-date"><span>&nbsp;On: </span>' + data.discussions[x].date_create + '</div>';
                content += '</div><div class="community-clear"></div></div>';
            }
            content += '</div>';
            $('#community-discussions .discussions').replaceWith(content);

            content = '<div id="discussion-pager">';
            content += '<span>Total Discussions: ' + data.pager.total + '</span>&nbsp;&nbsp;&nbsp;';
            if (data.pager.page > 1) {
                content += '<a href="#discussions" onclick="replaceDiscussions(' + (data.pager.page - 1) + ')" class="up_page"></a>';
            }
            for (var p = 0; p < data.pager.jumps.length; p++) {
                if (data.pager.jumps[p] == 'c') {
                    content += '<a href="#discussions" onclick="replaceDiscussions(' + data.pager.page + ')" class="page_active">' + data.pager.page + '</a>';
                } else {
                    content += '<a href="#discussions" onclick="replaceDiscussions(' + data.pager.jumps[p] + ')">' + data.pager.jumps[p] + '</a>';
                }
            }
            if (data.pager.pages > data.pager.page) {
                content += '<a href="#discussions" onclick="replaceDiscussions(' + (data.pager.page + 1) + ')" class="next_page"></a>';
            }
            content += '</div>';
            $('#discussion-pager').replaceWith(content);

            window.history.pushState(page, "${community.name}", "${reverse('community_view', args=[community.id])}?page=" + page);
        });
    }
    function newAnswer() {
        var answer_num = $('.poll-answer').length;
        $('.poll-answer').each(function(index) {
            $(this).find('.operation').replaceWith('<input type="button" class="minus operation" value="-" onclick="removeAnswer(' + index + ')">');
        });
        var entry = '<li class="poll-answer">';
        entry += '<input class="poll-answer-input" type="text" name="answers[' + answer_num + ']"> <input type="button" class="add operation" value="+">';
        entry += '</li>';
        $('#poll-answers').append(entry);
        $('.poll-answer .add').click(function() {
            newAnswer();
        });
    }
    function removeAnswer(index) {
        $('.poll-answer').each(function(i) {
            if (i == index) {
                $(this).remove();
            } else {
                var num = 0;
                if (i < index) {
                    num = i;
                }
                if (i > index) {
                    num = i - 1;
                }
                $(this).children('.poll-answer-input').attr('name', 'answers[' + num + ']');
            }
        });
        $('.poll-answer .minus').each(function(index) {
            $(this).replaceWith('<input type="button" class="minus operation" value="-" onclick="removeAnswer(' + index + ')">');
        });
    }
    function isScrolledIntoView(elem, view) {
        var $elem = $(elem);
        var $view = $(view);
        var docViewLeft = $view.offset().left;
        var docViewRight = docViewLeft + $view.width();
        var elLeft = $elem.offset().left;
        var elRight = elLeft + $elem.width();
        // return ((elemRight <= docViewRight) && (elemLeft >= docViewLeft)); // partly visible
        return ((docViewLeft < elLeft) && (docViewRight > elRight));
    }
    function left(){
        var lastHideLeft = null;
        var n=-1;
        $("#members").find("a").each(function(i){
            if(!isScrolledIntoView(this, $("#members"))){
                lastHideLeft=this;
                n=i;
            }else{
                return false;
            }
        });
        if(lastHideLeft) {
            //$(lastHideLeft).css('border',"1px solid #f00");
            $("#members").scrollLeft($("#members").scrollLeft()  + $(lastHideLeft).position().left-1);
        }
    }
    function right(){
        var firstHideRight=null;
        var foundVisible=false;
        var n=-1;
        $("#members").find("a").each(function(i){
            if(!isScrolledIntoView(this, $("#members"))){
                if(foundVisible){
                    firstHideRight=this;
                    n=i;
                    return false;
                }
            }else{
                foundVisible=true;
            }
        });
        if(firstHideRight) {
            $("#members").scrollLeft($("#members").scrollLeft()
                    + $(firstHideRight).position().left
                    - $("#members").width() + $(firstHideRight).width() + 1);
        }
    }
    $(document).ready(function() {
        $("#members").scrollLeft(0);
        $('.card-link').attr('target', '_blank');
        $('.delete-icon').click(function(event) {
            event.preventDefault();
            var title = 'Really Delete This Community?';
            var content = 'If you delete this community, all discussions, memberships and resources will be removed as well. This operation cannot be undone';
            var continue_url = $(this).attr('href');
            new Dialog($('#fixed-dialog')).showYesNo(title, content, function(ans) {
                this.hide();
                if (!ans) return;
                window.location.href = continue_url;
            });
        });
        $("#skype_usernames_select").change(function(){
           if($(this).val() != "Select Username"){
               toggleSkypeAddition($(this).attr("id"));
           }
        });
        $(document).on("click", "img.remove_skype_span", function(){
            $(this).parent().remove();
        });
        $(".skype_uname_option").each(function(){
            if($(this).val() == "None"){
                $(this).remove();
            }
        })
        $("#newDiscussionButton").click(function(e){
            e.preventDefault();
            scroll(0,0)
        });
        $('#skype-start').click(function(e) {
            e.preventDefault();
            $('.skype-container').attr('id', '');
            $('.skype-container').children('p').remove();
            $('#create-skype').off('click');
            var dialog = new Dialog('#skype-dialog');
            dialog.showOverlay();
            dialog.$ei.fadeIn(200);
            $('#create-skype').click(function() {
                var participants = [];
                $(".skype_username_list").each(function(i){
                    participants.push($(this).text());
                });
                var topic = $("input[name='skype-topic']").val();
                var skype_params = {
                    name: "call",
                    element: "SkypeButton_Call_" + participants[0] + "_1",
                    participants: participants,
                    imageSize: 24,
                    imageColor: "skype",
                    video: "true",
                    topic: topic
                };
                $('.skype-container').attr('id', '');
                $('.skype-container').attr('id', "SkypeButton_Call_" + participants[0] + "_1");
                $('.skype-container').children('p').remove();
                startSkype(skype_params);
            });
        });
    });
    function toggleSkypeAddition(id){
        $("#selected_skype_names").append("<div class='skype_username_list'>"+$("#"+id).val()+"<img src='../static/images/red_x.png' width='16px' height='16px' class='remove_skype_span'></img></div>");
        $("#skype_usernames_select").val('');
    }
</script>
</body>
