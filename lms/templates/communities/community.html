<%inherit file="../main.html" />
<%!
from django.core.urlresolvers import reverse
from courseware.courses import course_image_url, get_course_about_section
from student.views import course_from_id
from administration.configuration import has_hangout_perms
from communities.utils import is_facilitator, is_member
from file_uploader.utils import get_file_url
from django.utils import timezone
import datetime
%>
<%namespace name='static' file='../static_content.html'/>
<%block name="title">
    <title>${community.name}</title>
</%block>
<script type="text/javascript" src="/static/js/admin_ui_controls.js"></script>
<script type="text/javascript" src="https://secure.skypeassets.com/i/scom/js/skype-uri.js"></script>
<script type="text/javascript" src="/static/js/ckeditor/ckeditor.js" charset="utf-8"></script>
<link rel="stylesheet" type="text/css" href="/static/css/community.css" />
<link rel="stylesheet" type="text/css" href="/static/css/admin_ui_controls.css" />
<script src="https://apis.google.com/js/platform.js" async defer></script>
<link rel="stylesheet" type="text/css"  href="/static/tmp-resource/css/ppd-general01.css"/>
<body style="text-align:center">
<div id="community-main" class="clearfix">
    <section id="community-main-content">
        <div id="community-header">
            %if community.logo:
                <div id="community-logo"><img src="${get_file_url(community.logo)}" alt="Community Logo"/></div>
            %endif
            <h1>${community.name}</h1>
            <h2>${community.motto}</h2>
            %if facilitator:
                <div class="facilitator-wrap">
                    <img src="${reverse('user_photo', args=[facilitator.user.id])}" id="community-avatar" alt="Facilitator Avatar" />
                    <h3>${facilitator.user.first_name} ${facilitator.user.last_name}</h3>
                    <h4>Community Facilitator</h4>
                </div>
            %endif
            <div class="community-clear"></div>
        </div>

        <div id="community-content-area">
            <div id = "community_content_panel">
                <div id="community_content_header" class="community-content-header">
                    <h1 id="community_content_header_posts" class="section-tab posts-tab community-content-header-object selected">Posts</h1>
                    <h1 id="community_content_header_discussions" class="section-tab discussion-tab community-content-header-object">Discussions</h1>
                </div>
                <div id="community_content_posts" class="community-content-section">
                    <div id="post_content" class="post-content">
                        Filter:
                        <span class="filter-word-label">Filter:</span>
                        <select id = "post_filter_select">
                            <option value = 'newest_post'>Newest Posts</option>
                            <option value = 'oldest_post'>Oldest Posts</option>
                            <option value = 'latest_reply'>Latest Reply</option>
                            <option value = 'oldest_reply'>Oldest Reply</option>
                            <option value = 'alphabetical'>Name (A-Z)</option>
                            <option value = 'reversealpha'>Name (Z-A)</option>
                        </select>
                        <table id="post_content_table">
                            <tr class="post-content-row" id="post_content_new_row">
                                <td class="post-content-left"><img src="${reverse('user_photo',args=[request.user.id])}" class="post-profile-image"></img></td>
                                <td class="post-content-right" style="padding-bottom: 8px;">
                                    <textarea id="new_post_textarea" class="new-post-textarea" placeholder="What's on your mind?"></textarea><br>
                                    <input type="button" class="small" style="float: right;position: relative;" value="Post"></input>
                                </td>
                            </tr>
                            <!--<tr class="post-content-row">
                                <td class="post-content-left"><img src="${reverse('user_photo',args=[request.user.id])}" class="post-profile-image"></img></td>
                                <td class="post-content-right">
                                    <textarea id="post_textarea" class="post-textarea" placeholder="" readonly></textarea>
                                </td>
                            </tr>-->
                        </table>
                    </div>
                </div>
                <div id="community_content_discussions" class="community-content-section">
                    <div class="discussions">
                    %for i,d in enumerate(discussions):
                        <div class="discussion">
                            <img class="discussion-avatar" src="${reverse('user_photo', args=[d.user.id])}">
                            <div class="discussion-stats">
                                <span>Replies: ${d.replies}</span>
                                <span>Views: ${d.views}</span>
                            </div>
                            <h2><a href="${reverse('community_discussion_view', args=[d.id])}">${d.subject}</a></h2>
                            <div class="discussion-post-info">
                                <div class="discussion-byline"><span>Posted By: </span>${d.user.first_name} ${d.user.last_name}</div>
                                <div class="discussion-date"><span> On: </span>${'{dt:%b}. {dt.day}, {dt.year}'.format(dt=d.date_create)}</div>
                            </div>
                            <div class="community-clear"></div>
                        </div>
                    %endfor
                    </div>
                    <div id="discussion-pager">
                        <span>Total Discussions: ${pager['total']}</span>&nbsp;&nbsp;&nbsp;
                        %if pager['page'] > 1:
                            <a href="#discussions" onclick="replaceDiscussions(${pager['page']-1})" class="up_page"></a>
                        %endif
                        %for p in pager['jumps']:
                            %if p=='c':
                                <a href="#discussions" onclick="replaceDiscussions(${pager['page']})" class="page_active">${pager['page']}</a>
                            %else:
                                <a href="#discussions" onclick="replaceDiscussions(${p})">${p}</a>
                            %endif
                        %endfor
                        %if pager['pages'] > pager['page']:
                            <a href="#discussions" onclick="replaceDiscussions(${pager['page']+1})" class="next_page"></a>
                        %endif
                    </div>
                </div>
            </div>
            <!--<div id="community-discussions">
                <a name="discussions"></a>
                <h1 class="discussion-post-info-header">Community Discussion</h1>
                <h1 class="discussion-stats-header">Activity</h1>

            </div> -->
            <div id="community-content">
                <h1 id="content-collection-header">Content Collections</h1>
                <div id="community-content-scroller">
                    %for i,cc in enumerate(courses):
                        <% c=course_from_id(cc.course) %>
                        <%include file="../course.html" args="course=c" />
                    %endfor
                    %for i,r in enumerate(resources):
                        <div class="community-resource">
                            <img src="${get_file_url(r.logo)}" alt="${r.name}" />
                            <a href="${r.link}" target="_blank">
                                <div>
                                    ${r.name}
                                </div>
                            </a>
                        </div>
                    %endfor
                </div>
            </div>
        </div>

        <div id="members-title">Members</div>
        <table id="table-members" cellspacing="" cellpadding="" border="0">
            <tr>
                <td class="member-arrows">
                    <div class="member-arrow-left" onclick="left()"> </div>
                </td>
                <td class="member-column">
                    <div id="members">
                      %for u in users:
                      <%
                      use = u.user
                      utc_month=datetime.datetime.utcnow().strftime("%m")
                      utc_day=datetime.datetime.utcnow().strftime("%d")
                      utc_h=datetime.datetime.utcnow().strftime("%H")
                      utc_m=datetime.datetime.utcnow().strftime("%M")
                      d_min = 60*int(utc_h) + int(utc_m)
                      if use.profile.last_activity:
                        usr=use.profile.last_activity
                        u_min = 60*int(usr.strftime("%H")) + int(usr.strftime("%M"))
                        close = int(d_min) - int(u_min) < 1
                        active_recent = usr.strftime("%d") == utc_day and usr.strftime("%m") == utc_month and close
                      else:
                        active_recent = False
                      %>
                      %if not active_recent:
                          <a href="${reverse('dashboard',args=[u.user.id])}" data-name='${use.first_name} ${use.last_name}' data-uname='${use.username}' data-email='${use.email}' data-id='${use.id}' class="hoverable-profile" target="_blank" style="position:relative;">
                      %else:
                          <a href="${reverse('dashboard',args=[u.user.id])}" data-skype='${use.profile.skype_username}' data-name='${use.first_name} ${use.last_name}' data-uname='${use.username}' data-email='${use.email}' data-id='${use.id}' class="hoverable-profile" target="_blank" style="position:relative;">
                      %endif
                        %if active_recent:
                            <img src="/static/images/online-3.png" class="circle" id="${use.profile.id}" data-email="${use.email}" data-fname="${use.first_name}" data-lname="${use.last_name}" data-skypename="${use.profile.skype_username}" data-id="${use.id}" data-username="${use.username}"></img>
                        %endif
                        <img src="${reverse('user_photo',args=[u.user.id])}" alt="${u.user.first_name}" />
                      </a>
                      %endfor
                    </div>
                </td>
                <td class="member-arrows">
                    <div class="member-arrow-right" onclick="right()"></div>
                </td>
            </tr>
        </table>
    </section>
    <section id="community-main-sidebar">
        <div id="community-sidebar-header">
            ${request.user.username}
        </div>
        <div id="community-sidebar">
            <div class="sidebar-section" style="text-align: center;">
                <img src="/static/images/pcg_columns_transparent.png" alt="PCG Logo" />
                %if is_member(request.user, community):
                    <div id="community-member">MEMBER</div>
                %else:
                    <a href="#" class="side-button green-button" onclick="joinMe()">Add Me</a>
                %endif
            </div>
            <div class="sidebar-section">
                <h2>Community Status</h2>
                <div class="sidebar-sub-section">
                    <span class="status-name">Discussions: ${total_discussions}</span>
                    <!--<span class="trending-name">Messages: </span>-->
                    <span class="status-name">Members: ${users.count()}</span>
                </div>
            </div>
            <div class="sidebar-section">
                <h2>Trending</h2>
                <div class="sidebar-sub-section">
                    %for i, d in enumerate(trending):
                        <span class="trending-title"><a href="${reverse('community_discussion_view', args=[d.id])}">${d.subject}</a></span>
                        <span class="trending-name"><span>Posted: </span>${'{dt:%b}. {dt.day}, {dt.year}'.format(dt=d.date_create)}</span>
                    %endfor
                </div>
            </div>
            <div class="sidebar-section">
                <a href="${reverse('communities')}" class="blue-button side-button">My Communities</a>
                %if is_member(request.user, community) or request.user.is_superuser:
                    <a href="#" class="blue-button side-button" id="newDiscussionButton" onclick="newDiscussion()">Start a New Discussion</a>
                %endif
                %if is_facilitator(request.user, community) or request.user.is_superuser:
                    <a href="${reverse('community_edit',args=[community.id])}" class="green-button side-button">Edit</a>
                    <a href="${reverse('community_delete',args=[community.id])}" class="red-button side-button delete-icon">Delete</a>
                    <a href="${reverse('community_mange_member',args=[community.id])}" class="blue-button side-button">Manage Members</a>
                %endif
                %if has_hangout_perms(request.user) and community.hangout:
                    <div class="hangout_container" id="hangout_div">
                        <img src="/static/images/community_google_hangouts.png" class="" alt="" />
                        <a class="side-button green-button" href="${community.hangout}" target="_blank">Join Hangout</a>
                    </div>
                %endif
                %if request.user.is_superuser or is_facilitator(request.user, community) or is_member(request.user, community):
                    <div class="skype-button">
                        <a href="#" id="skype-start" class="side-button blue-button">Start Skype Call</a>
                    </div>
                %endif
            </div>
        </div>
    </section>
</div>
<div style="" id="dialog" class="modal">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0">
        <div class="titlebar">
            <h3 class="dialog-title"></h3>
            <div class="close-modal" id="dialog_close">✕</div>
        </div>
        <div class="content"></div>
    </div>
</div>
<div style="" id="online_dialog" class="modal">
  <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0">
    <div class="titlebar">
      <h3 style="padding:20px;display:block;text-align:center;" id="dlg-name-title"></h3>
      <div class="close-modal" id="dialog_close">✕</div>
    </div>
    <div style="color:#000;text-align:center;padding:10px;">
      <img src="" class="" alt="" id="dlg-user-photo" width="230"/><br/>
      <div style="display:inline-block;vertical-align:bottom;">
        <img src="/static/images/community_google_hangouts.png" class="" alt="" style="padding-bottom:5px;"/><br/>
          %for u in users:
          <%
            use = u.user
          %>
             <span class="hangout-span" id="hangout_span_${use.id}"><div class="hangout-button"><g:hangout render="createhangout" id="google_hangout" invites="[{id:'${use.email}', invite_type:'EMAIL'}]"></g:hangout></div></span>
          %endfor
        <div id="google_hangout"></div>
      </div>
      <div style="display:inline-block;vertical-align:top;">
        <img src="/static/images/online/skype.jpg" class="" alt="" /><br>
        <a href="skype:?call" id="skype-online-username" class="side-button blue-button skype-button">Start Skype Call</a>
      </div><br><br><a href="#show_personalmessage" rel="leanModal" style="display:inline-block">
                  <div class="message_board_btn" id="message_board_data" data-fullname="" data-name="${user.username}" data-id="${user.user_id}" onclick="imessage_click(this);">
                    <img src="/static/images/ppd-iMessage-none.jpg" width="50" height="50"/>
                    <div id="" style="display:none;"></div>
                  </div>
                </a>

    </div>
  </div>
</div>
<div style="" id="fixed-dialog" class="modal">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0">
        <div class="titlebar">
            <h3 class="dialog-title"></h3>
            <div class="close-modal" id="dialog_close">✕</div>
        </div>
        <div class="content"></div>
    </div>
</div>
<div style="" id="fixed-dialog-likes" class="modal">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0">
        <div class="titlebar">
            <h3 class="dialog-title"></h3>
            <div class="close-modal" id="dialog_close">✕</div>
        </div>
        <div class="content"></div>
    </div>
</div>
<div style="" id="fixed-dialog-share" class="modal">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0">
        <div class="titlebar">
            <h3 class="dialog-title"></h3>
            <div class="close-modal" id="dialog_close">✕</div>
        </div>
        <div class="content"></div>
    </div>
</div>
<div style="" id="skype-dialog" class="modal">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0">
        <div class="titlebar">
            <h3 class="dialog-title">Start Skype Call</h3>
            <div class="close-modal" id="dialog_close">✕</div>
        </div>
        <div class="content">
            <form>
                <label>Select from the below list to add to call.</label><br>
                <select id = "skype_usernames_select" multiple>
                    %for u in users:
                        %if u.user.profile.skype_username:
                            <option class='skype_uname_option' id="${u.user.username}" data-src="${reverse('user_photo',args=[u.id])}" val="${u.user.profile.skype_username}" data-skype="${u.user.profile.skype_username}">${u.user.first_name} ${u.user.last_name}</option>
                        %endif
                    %endfor
                </select><br>
                <span id="selected_skype_names"></span><br>
                <label>Topic (optional):<input type="text" name="skype-topic"></label>
                <input type="button" value="Create" id="create-skype">
                <div class="skype-container">
                    <script type="text/javascript">
                        function startSkype(params) {
                            var skype_button = Skype.ui(params);
                            if (skype_button) {
                                var id = $('.skype-container').attr('id');
                                $('#' + id + '_paraElement img').css({'margin': '0', 'vertical-align': '0'});
                            }
                        }
                    </script>
                </div>
            </form>
            <div class="community-clear"></div>
        </div>
    </div>
</div>
<section id="show_personalmessage" class="modal modal-wide">
            <div class="inner-wrapper" style="width:578px;padding-bottom:0 !important;">
                <header>
                    <h2 class="message_board_full_name"></h2>
                    <hr/>
                </header>
                <div class="message_board_listCon" style="height:350px;overflow-y:auto;overflow-x:hidden;"><div class="message_board_list"></div></div>
                <form id="" method="post" style="padding:0px;line-height:18px;">

                    <div style="width:520px;margin:10px;">
                        <div class="message_board_content" contenteditable="true" style="width:530px;height:150px;background-color:#fff;color:black;padding:10px;border:1px solid #ccc;overflow-y:auto;"><p class="message_board_txt_prompt">Type Your Message Here</p></div>

                        <div style="color:black;font-size:12px;color:#aaa;">
                            Maximum to 1000 Characters  (<span id="curr_char_num">0</span>)
                        </div>
                        <div style="width:530px;height:30px;">
                            <table width="530" border="0" cellpadding="0" cellspacing="0">
                                <tr height="30" style="color:#000;">
                                    <td widht="265" style="vertical-align:middle;">
                  <span class="message_board_uploadBtn" style="width:110px;cursor:pointer;">
                    <img src="/static/images/personalmsg_upload.png" width="22" height="22"/>
                    <span style="padding-left:2px;font-size:14px;color:#aaa;">Add Photos</span>
                  </span>

                  <span class="message_board_linkBtn" style="width:100px;cursor:pointer;margin-left:5px;">
                    <img src="/static/images/personalmsg_link.jpg" width="22" height="22"/>
                    <span style="padding-left:2px;font-size:14px;color:#aaa;">Link</span>
                  </span>

                                    </td>
                                    <td align="right" style="vertical-align:middle;">
                                        <div class="ftg_button ftg_yellow" style="cursor:pointer;">Send</div>
                                    </td>
                                </tr>
                                <tr><td><div id="multiplayer_send_div" style="width:300px;color:#000;margin-left:5px;display:none;"><label><input type="checkbox"/>Send to All Users</label></div></td></tr>
                            </table>
                        </div>
                    </div>
                    <input id="message_board_browseFile" type="file" onchange="message_board_upload_file()" style="width:0px;"/>
                </form>
                <br/>
                <!--
                <div style="width:500px;height:40px;margin:0 auto;text-align:center;">
                <a href="/dashboard" id="view_all_note" class="dashboard_link" style="color:#fff !important;font-size:18px;">
                <div style="display:inline-block;text-align:center;width:250px;">Dashboard</div>
                </a>
                </div>
                -->
                <div class="close-modal" id="message_board_close">
                    <div class="inner">
                        <p>&#10005;</p>
                    </div>
                </div>
            </div>
        </section>
<div style="" id="skype-dialog-online" class="modal">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0">
        <div class="titlebar">
            <h3 class="dialog-title">Start Skype Call</h3>
            <div class="close-modal" id="dialog_close">✕</div>
        </div>
        <div class="content">
            <form>
                <label id="skype-name-exists">Begin a call with: </label><span id="skype-online-name"></span><br>
                <span id ="skype-name-exists-toggle"><label>Topic (optional):<input type="text" name="skype-topic"></label>
                <input type="button" value="Create" id="create-skype-online">
                <div class="skype-container-online">
                    <script type="text/javascript">
                        function startSkypeOnline(params) {
                            var skype_button_online = Skype.ui(params);
                            if (skype_button_online) {
                                var id = $('.skype-container-online').attr('id');
                                $('#' + id + '_paraElement img').css({'margin': '0', 'vertical-align': '0'});
                            }
                        }
                    </script>
                </div>
            </form>
            <div class="community-clear"></div>
        </div>
    </div>
</div>
<div id = 'user_info_div' class="user-info-div">
    <span id='user_info' class="user_info_span"></span>
</div>
<script type="text/javascript">
    var size=0;
    function joinMe(){
        var user_id = "${request.user.id}";
        $.post("${reverse('community_join', args=[community.id])}",{user_ids:user_id}, function(r){
            if(r.success)
                window.location.reload();
        });
    }
    function validateDiscussionForm() {
        $('.discussion-error-box').removeClass('discussion-error-box');
        var valid = true;
        var errors = ['The following errors occurred:\n'];
        if (!/[A-Za-z]/.test($('.discussion-subject input').val())) {
            valid = false;
            errors.push('Subject is required.');
            $('.discussion-subject input').addClass('discussion-error-box');
        }
        if (!/[A-Za-z]/.test($('.discussion-post textarea').val())) {
            valid = false;
            errors.push('Discussion is required.');
            $('.discussion-post textarea').addClass('discussion-error-box');
        }
        if ($('#new-discussion-submit .poll-add').is(':checked')) {
            if (!/[A-Za-z]/.test($('.poll-question').val())) {
                valid = false;
                errors.push('Question is required.');
                $('.poll-question').addClass('discussion-error-box');
            }
            if ($('.poll-answer-input').length < 2) {
                valid = false;
                errors.push('You need at least two answers to choose from.');
            }
            $('.poll-answer-input').each(function() {
                if (!/[A-Za-z]/.test($(this).val())) {
                    valid = false;
                    errors.push('Answers must be filled out.');
                    $(this).addClass('discussion-error-box');
                    return false;
                }
            });
            if ($('.poll-expiration').val() != '' && !/^\d?\d\/\d?\d\/\d\d\d\d$/.test($('.poll-expiration').val())) {
                valid = false;
                errors.push('Expiration date must be in the format mm/dd/yyyy.');
                $('.poll-expiration').addClass('discussion-error-box');
            }
        }
        if (!valid) {
            var error = errors.join('\n');
            alert(error);
        }
        return valid;
    }
    function newDiscussion() {
        var content = '<form id="new-discussion-submit" action="${reverse('community_discussion_add')}" method="post" enctype="multipart/form-data">';
        content += '<label class="discussion-subject">Subject:<input type="text" name="subject"></label>';
        content += '<label class="discussion-post">Discussion:<textarea name="post" id="post"></textarea></label>';
        content += '<label class="discussion-attachment">Attachment:<input type="file" name="attachment"></label>';
        content += '<label class="discussion-poll"><img src="/static/images/poll-icon.png" alt="Add Poll"> <input type="checkbox" class="poll-add"> Add Poll</label>';
        content += '<div id="poll-form">';
        content += '<label>Question: <input class="poll-question" type="text" name="question"></label>';
        content += '<label>Answers: <ol id="poll-answers">';
        content += '<li class="poll-answer">';
        content += '<input class="poll-answer-input" type="text" name="answers[0]">';
        content += '</li>';
        content += '<li class="poll-answer">';
        content += '<input class="poll-answer-input" type="text" name="answers[1]"> <input type="button" class="add operation" value="+">';
        content += '</li>';
        content += '</ol></label>';
        content += '<label>Expiration Date: <input class="poll-expiration" type="text" name="expiration" placeholder="mm/dd/yyyy"></label>';
        content += '</div>';
        content += '<input type="hidden" value="${community.id}" name="community_id">';
        content += '<input type="hidden" name="csrfmiddlewaretoken" value="${csrf_token}"/>';
        content += '<div class="community-clear"></div><br/>';
        content += '<input type="submit" name="submit" value="Add">';
        content += '</form><div class="discussion-error"></div>';
        var discussion_dialog = new Dialog($('#dialog'));
        discussion_dialog.show('New Discussion', content);
        CKEDITOR.replace('post');

        $('#new-discussion-submit').submit(function(event) {
            event.preventDefault();
            for (var instanceName in CKEDITOR.instances) {
                CKEDITOR.instances[instanceName].updateElement();
            }
            if (validateDiscussionForm()) {
                var formData = new FormData($(this)[0]);
                var formSelector = $(this);
                $.ajax({
                    url: '${reverse('community_discussion_add')}',
                    type: 'POST',
                    data: formData,
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        if (data.Success) {
                            if ($('#new-discussion-submit .poll-add').is(':checked')) {
                                var pollData = formSelector.serializeArray();
                                pollData[pollData.length] = {name: 'poll_id', 'value': data.DiscussionID};
                                $.post('${reverse('poll_form_submit', args=['discussion'])}', pollData, function (data) {
                                    if (data.Success) {
                                        discussion_dialog.hide();
                                        replaceDiscussions(1);
                                    } else {
                                        $('.discussion-error').append('There was an error adding your discussion. Please try again later.')
                                    }
                                });
                            } else {
                                discussion_dialog.hide();
                                replaceDiscussions(1);
                            }

                        } else {
                            $('.discussion-error').append('There was an error adding your discussion. Please try again later.')
                        }
                    }
                });
            }
        });

        $('.poll-add').click(function() {
            $('#poll-form').toggle();
        });
        $('.poll-answer .add').click(function() {
            newAnswer();
        });
    }
    function replaceDiscussions(page) {
        $.get('${reverse('community_discussion_list', args=[community.id])}', {'page': page}, function(data) {
            var content = '<div class="discussions">';
            for (var x = 0; x < data.discussions.length; x++) {
                content += '<div class="discussion">';
                content += '<img class="discussion-avatar" src="' + data.discussions[x].avatar + '">';
                content += '<div class="discussion-stats">';
                content += '<span>Replies: ' + data.discussions[x].replies + '</span>';
                content += '<span>Views: ' + data.discussions[x].views + '</span>';
                content += '</div>';
                content += '<h2><a href="' + data.discussions[x].url + '">' + data.discussions[x].subject + '</a></h2>';
                content += '<div class="discussion-post-info">';
                content += '<div class="discussion-byline"><span>Posted By: </span>' + data.discussions[x].first_name + ' ' + data.discussions[x].last_name + '</div>';
                content += '<div class="discussion-date"><span>&nbsp;On: </span>' + data.discussions[x].date_create + '</div>';
                content += '</div><div class="community-clear"></div></div>';
            }
            content += '</div>';
            $('#community-discussions .discussions').replaceWith(content);

            content = '<div id="discussion-pager">';
            content += '<span>Total Discussions: ' + data.pager.total + '</span>&nbsp;&nbsp;&nbsp;';
            if (data.pager.page > 1) {
                content += '<a href="#discussions" onclick="replaceDiscussions(' + (data.pager.page - 1) + ')" class="up_page"></a>';
            }
            for (var p = 0; p < data.pager.jumps.length; p++) {
                if (data.pager.jumps[p] == 'c') {
                    content += '<a href="#discussions" onclick="replaceDiscussions(' + data.pager.page + ')" class="page_active">' + data.pager.page + '</a>';
                } else {
                    content += '<a href="#discussions" onclick="replaceDiscussions(' + data.pager.jumps[p] + ')">' + data.pager.jumps[p] + '</a>';
                }
            }
            if (data.pager.pages > data.pager.page) {
                content += '<a href="#discussions" onclick="replaceDiscussions(' + (data.pager.page + 1) + ')" class="next_page"></a>';
            }
            content += '</div>';
            $('#discussion-pager').replaceWith(content);

            window.history.pushState(page, "${community.name}", "${reverse('community_view', args=[community.id])}?page=" + page);
        });
    }
    function newAnswer() {
        var answer_num = $('.poll-answer').length;
        $('.poll-answer').each(function(index) {
            $(this).find('.operation').replaceWith('<input type="button" class="minus operation" value="-" onclick="removeAnswer(' + index + ')">');
        });
        var entry = '<li class="poll-answer">';
        entry += '<input class="poll-answer-input" type="text" name="answers[' + answer_num + ']"> <input type="button" class="add operation" value="+">';
        entry += '</li>';
        $('#poll-answers').append(entry);
        $('.poll-answer .add').click(function() {
            newAnswer();
        });
    }
    function removeAnswer(index) {
        $('.poll-answer').each(function(i) {
            if (i == index) {
                $(this).remove();
            } else {
                var num = 0;
                if (i < index) {
                    num = i;
                }
                if (i > index) {
                    num = i - 1;
                }
                $(this).children('.poll-answer-input').attr('name', 'answers[' + num + ']');
            }
        });
        $('.poll-answer .minus').each(function(index) {
            $(this).replaceWith('<input type="button" class="minus operation" value="-" onclick="removeAnswer(' + index + ')">');
        });
    }
    function isScrolledIntoView(elem, view) {
        var $elem = $(elem);
        var $view = $(view);
        var docViewLeft = $view.offset().left;
        var docViewRight = docViewLeft + $view.width();
        var elLeft = $elem.offset().left;
        var elRight = elLeft + $elem.width();
        // return ((elemRight <= docViewRight) && (elemLeft >= docViewLeft)); // partly visible
        return ((docViewLeft < elLeft) && (docViewRight > elRight));
    }
    function imessage_click(obj)
      {
        var userInfo=[];
        userInfo['message_people']={id:$(obj).attr("data-id"),fullname:$(obj).attr("data-fullname"),name:$(obj).attr("data-name")};
        userInfo['user']={id:'${user.id}',fullname:'${user.first_name} ${user.last_name}',name:'${user.username}'};
        message_board(userInfo);
      }
    function left(){
        var lastHideLeft = null;
        var n=-1;
        $("#members").find("a").each(function(i){
            if(!isScrolledIntoView(this, $("#members"))){
                lastHideLeft=this;
                n=i;
            }else{
                return false;
            }
        });
        if(lastHideLeft) {
            //$(lastHideLeft).css('border',"1px solid #f00");
            $("#members").scrollLeft($("#members").scrollLeft()  + $(lastHideLeft).position().left-1);
        }
    }
    function right(){
        var firstHideRight=null;
        var foundVisible=false;
        var n=-1;
        $("#members").find("a").each(function(i){
            if(!isScrolledIntoView(this, $("#members"))){
                if(foundVisible){
                    firstHideRight=this;
                    n=i;
                    return false;
                }
            }else{
                foundVisible=true;
            }
        });
        if(firstHideRight) {
            $("#members").scrollLeft($("#members").scrollLeft()
                    + $(firstHideRight).position().left
                    - $("#members").width() + $(firstHideRight).width() + 1);
        }
    }
    function displayOptions(data){
        var focused = $(':focus');
        var code = "<div id='select_name'>"
        for (i=0; i < data.length; i++){
            code+="<div class='anchor-container-select selection_name' data-parent='"+focused.data('id')+"' data-content='"+data[i]+"'>" + data[i] + "</div>";
        }
        code+="</div>";
        $("#select_name").remove();
        focused.after(code);
        $(".selection_name").click(function(e){
            var change = $(this).parent().prev();
            var str = change.val().substr(0, change.val().lastIndexOf("@")+1);
            change.val(str+$(this).data("content") + " ");
            change.focus();
            $("#select_name").remove();
        });
    }
    function getPosts(){
        filter = $("#post_filter_select").val()
        console.log(filter)
        var community=${community.id};
        $.post("${reverse('community_get_posts')}", {community_id: community, size:size, filter:filter}, function (data){
            $("#post_content_table").find("tr:gt(0)").remove();
            $('#post_content_table tr:last').after(data.post);
            $(".post-like-text").click(function(){
                $.post("${reverse('community_submit_new_like')}", {post_id: $(this).data('id'), comment_id: '-1', user_id:'${request.user.id}'},function(data){
                    getPosts();
                });
            });
            $(".post-comment-text").click(function(){
                id=$(this).data('id');
                if($(this).data('name') != ''){
                    $("#focus"+id).val("@"+$(this).data('name')+" ");
                }
                $("#focus"+id).focus();
            });
            $(".post-share-text").click(function(){
                content = $(this).data('content');
                community = $(this).data('community');
                poster = $(this).data("poster");
                type= $(this).data("type");
                options = "<label>Select from the below list to share.</label><br>";
                options += '<select id = "share_usernames_select" multiple>';
                %for u in users:
                    options += "<option class='skype_uname_option' id='${u.user.username}' data-id='${u.user.id}' data-src='${reverse('user_photo',args=[u.id])}' val='${u.user.id}'>${u.user.first_name} ${u.user.last_name}</option>";
                %endfor
                options+="</select><br><br><span id='selected_share_names'></span>";
                html = options+"<br><br><button onclick=\"sharePost('"+content+"', '"+community+"', '"+poster+"', '"+type+"')\">Share</button><br><p id='share_message' style='display:none'></p>"
                new Dialog($('#fixed-dialog-share')).show("Share Post", "<center>"+html+"</center>");
                $("#share_usernames_select").change(function(){
                   if($(this).val() != "Select Username"){
                       toggleShareAddition($(this).attr("id"));
                   }
                });
            });
            $(".comment-like-text").click(function(){
                $.post("${reverse('community_submit_new_like')}", {comment_id: $(this).data('id'), post_id:'-1', user_id:'${request.user.id}'},function(data){
                    getPosts();
                });
            });
            $('.add-comment-text').keyup(function (e) {
                $("#select_name").remove();
                if (e.keyCode === 13) {
                    content=$(this).val();
                    post_id=$(this).data('id')
                    $.post("${reverse('community_submit_new_comment')}", {post_id: post_id, content:content}, function(data){
                        getPosts();
                    });
                }
                var n = $(this)[0].selectionStart;
                var at = $(this).val().indexOf("@");
                if(at > -1){
                    var str = $(this).val().substr(at);
                    var x = str.length;
                    for(var s = str; s.indexOf("@") >-1; s = s.substr(x)){

                        s = s.substr(1);
                        x = s.indexOf("@");
                        if(x>-1)
                            working = s.substr(0, x).split(' ').slice(0,2).join(' ');
                        else
                            working = s.substr(0).split(' ').slice(0,2).join(' ');
                    }
                    loc = $(this).val().indexOf(working);
                    if(n > loc && n <= working.length+loc) {
                        $.post("${reverse('community_lookup_name')}", {name: working}, function(data){
                            if(data.content.length > 0) {
                                displayOptions(data.content);
                            }
                        });
                    }

                }
            });
            safety=0;
            $(".hoverable-profile").hover(function(event) {
                safety++;
                $("#user_info").html("<img class='info-tile-img' src='/static/images/name.png' width=16px height=16px></img>"+$(this).data('name')+"<br><img class='info-tile-img' src='/static/images/username.png' width=16px height=16px></img>"+$(this).data('uname')+"<br><img class='info-tile-img' src='/static/images/email.png' width=16px height=16px></img><a href='mailto:"+$(this).data('email')+"'>"+$(this).data('email')+"</a>");
                if ($(this).data("skype") !== undefined){
                    $("#user_info").append("<br><img class='info-tile-img' src='/static/images/skype.png' width=16px height=16px></img><a href='skype:"+$(this).data('skype')+"?call'>"+$(this).data('skype')+"</a>")
                    $("#user_info").append("<br><img class='info-tile-img' src='/static/images/hangout_icon.png' width=16px height=16px></img><span style='float:right; padding-right:46px;'>"+$('#hangout_span_'+$(this).data("id")).html()+"</span>");
                }
                $("#user_info_div").css({top: $(this).offset().top+20, left: $(this).offset().left}).show();
            }, function() {
                if (!$("#user_info_div").is(":hover") && safety > 1){
                    $("#user_info_div").hide();
                    safety = 0;
                }
            });
            $("#user_info_div").hover(function(e){}, function(){
                $(this).hide()
            });
            $(".like-members-anchor").click(function(){
                var post = $(this).data('post');
                var comment = $(this).data('comment');
                $.post('${reverse('community_get_full_likes')}', {'post': post, 'comment': comment}, function (data){
                    new Dialog($('#fixed-dialog-likes')).show("Likes", "<center>"+data.html+"</center>");
                });
            });
        });
    }
    $(document).ready(function(){
        size=10;
        $("#post_filter_select").change(function(){
            getPosts();
        });
        getPosts();

        $(".small").click(function(){
            var post=$("#new_post_textarea").val();
            var community=${community.id};
            $.post("${reverse('community_submit_new_post')}", {post: post, community_id: community}, function (data) {
                $("#new_post_textarea").val("");
                getPosts();
            });
        });
        $('#community_content_posts').on('scroll', function() {
            if($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight) {
                size+=10;
                getPosts();
            }
        });
        var change_var = 0;
        $.post("${reverse('community_check_content_priority')}", {community_id: ${community.id}}, function (data){4
           if(data.result==0){
                $("#community_content_discussions").hide();
                $("#community_content_header_posts").addClass("selected");
                $("#community_content_header_discussions").removeClass("selected");
                change_var = 1;
           }else{
                $("#community_content_posts").hide();
                $("#community_content_header_posts").removeClass("selected");
                $("#community_content_header_discussions").addClass("selected");
                change_var = 0;
           }
        });

        $("#community_content_header_posts").click(function(){
            $("#community_content_discussions").hide();
            $("#community_content_posts").show();
            $("#community_content_header_posts").addClass("selected");
            $("#community_content_header_discussions").removeClass("selected");
        });
        $("#community_content_header_discussions").click(function(){
            $("#community_content_posts").hide();
            $("#community_content_discussions").show();
            $("#community_content_header_posts").removeClass("selected");
            $("#community_content_header_discussions").addClass("selected");
        });
        $("#message_board_close").click(function(){
            $(".lean-overlay").remove();
        });
        $(".circle").click(function(event){
            event.preventDefault();
            scroll(0,0);
            $(".hangout-span").hide();
            $("#hangout_span_"+$(this).data('id')).show();
            $("#skype-online-username").attr("href", "skype:"+$(this).attr("data-skypename")+"?call")
            $("#skype-online-name").text("");
            $("#skype-name-exists").text("Begin a call with: ");
            $("#skype-name-exists-toggle").show();
            $("#dlg-name-title").html($(this).attr("data-fname")+" "+$(this).attr("data-lname"));
            $("#dlg-user-photo").attr("src", "/user_photo/"+$(this).attr("id"));
            $("#message_board_data").attr("data-fullname", $(this).attr("data-fname") + " " + $(this).attr("data-lname"));
            $("#message_board_data").attr("data-name", $(this).attr("data-username"));
            $("#message_board_data").attr("data-id", $(this).attr("data-id"));
            if($(this).attr("data-skypename") == "None"){
                $("#skype-name-exists").text("This user does not have their skype name set.");
                $("#skype-name-exists-toggle").hide();
            }else{
                $("#skype-online-name").text($(this).attr("data-skypename"));
            }            main_dlg=new Dialog($('#online_dialog'));
            main_dlg.show("Error", "");
            return false;
        });
        $("#members").scrollLeft(0);
        $('.card-link').attr('target', '_blank');
        $('.delete-icon').click(function(event) {
            event.preventDefault();
            var title = 'Really Delete This Community?';
            var content = 'If you delete this community, all discussions, memberships and resources will be removed as well. This operation cannot be undone';
            var continue_url = $(this).attr('href');
            new Dialog($('#fixed-dialog')).showYesNo(title, content, function(ans) {
                this.hide();
                if (!ans) return;
                window.location.href = continue_url;
            });
        });
        $("#skype_usernames_select").change(function(){
           if($(this).val() != "Select Username"){
               toggleSkypeAddition($(this).attr("id"));
           }
        });
        $(document).on("click", "img.remove_skype_span", function(){
            $(this).parent().remove();
            $("option:contains("+$(this).parent().text()+")").show();
        });
        $(".skype_uname_option").each(function(){
            if($(this).val() == "None"){
                $(this).remove();
            }
        })
        $("#newDiscussionButton").click(function(e){
            e.preventDefault();
            scroll(0,0)
        });
        $('#skype-start').click(function(e) {
            e.preventDefault();
            $('.skype-container').attr('id', '');
            $('.skype-container').children('p').remove();
            $('#create-skype').off('click');
            var dialog = new Dialog('#skype-dialog');
            dialog.showOverlay();
            dialog.$ei.fadeIn(200);
            $('#create-skype').click(function() {
                var participants = [];
                $(".skype_username_list").each(function(i){
                    participants.push($(this).data('skype'));
                });
                var topic = $("input[name='skype-topic']").val();
                var skype_params = {
                    name: "call",
                    element: "SkypeButton_Call_" + participants[0] + "_1",
                    participants: participants,
                    imageSize: 24,
                    imageColor: "skype",
                    video: "true",
                    topic: topic
                };
                $('.skype-container').attr('id', '');
                $('.skype-container').attr('id', "SkypeButton_Call_" + participants[0] + "_1");
                $('.skype-container').children('p').remove();
                startSkype(skype_params);
            });
        });
        $('#skype-start-online').click(function(e) {
            e.preventDefault();
            if(main_dlg)main_dlg.hide();
            var dialog = new Dialog('#skype-dialog-online');
            dialog.showOverlay();
            dialog.$ei.fadeIn(200);
            $('#create-skype-online').click(function() {
              var participants = $("span[id='skype-online-name']").text().split(/, ?/);;
              var topic = $("input[name='skype-topic-online']").val();
              var skype_params = {
                name: "call",
                element: "SkypeButton_Call_" + participants[0] + "_1",
                participants: participants,
                imageSize: 24,
                imageColor: "skype",
                video: "true",
                topic: topic
              };
              $('.skype-container-online').attr('id', "SkypeButton_Call_" + participants[0] + "_1");
              startSkypeOnline(skype_params);
            });
          });
    });
    function toggleShareAddition(id){
        var selected = $("#"+id).find('option:selected');
        val = $("#"+id).val()+'';
        vals = val.split(",");
        $.each(vals,function(i){
            if(vals[i] != null) {
                j = $("option:contains(" + vals[i] + ")");
                j.hide();
                $("#selected_share_names").append("<div class='share_username_list' data-id='" + j.data('id') + "'><img src='" + j.data('src') + "' width='16px' height='16px' style='padding-left: 5px; padding-bottom: 2px'></img>" + vals[i] + "<img src='../static/images/red_x.png' width='16px' height='16px' class='remove_skype_span'></img></div>");
            }
        });
        $("#share_usernames_select").val('');
        $(".share_username_list:contains('null')").remove();
    }
    function toggleSkypeAddition(id){
        var selected = $("#"+id).find('option:selected');
        val = $("#"+id).val()+'';
        vals = val.split(",");
        $.each(vals,function(i){
            if(vals[i] != null) {
                j = $("#skype_usernames_select:contains(" + vals[i] + ")");
                j.hide();
                $("#selected_skype_names").append("<div class='skype_username_list' data-skype='" + j.data('skype') + "'><img src='" + j.data('src') + "' width='16px' height='16px' style='padding-left: 5px; padding-bottom: 2px'></img>" + vals[i] + "<img src='../static/images/red_x.png' width='16px' height='16px' class='remove_skype_span'></img></div>");
            }
        });
        $("#skype_usernames_select").val('');
        $(".skype_username_list:contains('null')").remove();
    }
    function sharePost(content, community, poster, type){
        message = "<p style='text-align:left; float-left'>${user.first_name} ${user.last_name} has shared the following "+type+" by "+poster+" with you!</p><p style='text-align:left;font-style:italic'>"+content+"</p>";
        message += "<p style='text-align:left; float-left'>View the full discussion here: <a href='/community/"+community+"'>Community</a></p>"
        $(".share_username_list").each(function(i){
            share_id = $(this).data("id").toString();
            var datainfo = {
                'info': JSON.stringify({
                'sender_id': '${user.id}',
                'recipient_id': share_id,
                'date': (new Date()).toISOString(),
                'body': message
                })
            };
            $.post("${reverse('save_message')}", datainfo, function(data){});
            var messageinfo = {
                'info': JSON.stringify({
                    'user_id': share_id,
                    'interviewer_id': '${request.user.id}',
                    'interviewer_name': '${request.user.first_name}',
                    'interviewer_fullname': '${request.user.first_name} ${request.user.last_name}',
                    'type': 'message',
                    'body': '',
                    'date': (new Date()).toISOString(),
                    'activate': 'false'
                })
            };
            $.post("${reverse('save_interactive_update')}", messageinfo, function() {});
        });
        $("#share_message").html("Message Shared!")
        $("#share_message").css("color", "green");
        $("#share_message").show()
    }
</script>
</body>
