<%!
    from django.utils.translation import ugettext as _
    from django.core.urlresolvers import reverse
    from file_uploader.utils import get_file_url
    from administration.configuration import has_hangout_perms
    from student.models import State,District
    from communities.models import CommunityCommunities
%>
<%! navbar_show_extended=False %>
<%inherit file="../main.html" />
<%namespace name='static' file='../static_content.html'/>
<%block name="title"><title>Communities</title></%block>
<link rel="stylesheet" type="text/css"  href="/static/css/communities.css"/>

<style type="text/css" media="screen">
    #page-nav,#page-footer{width:1180px;}
    #btn-logged-user{display:none;}
    .form-select{font-size:14px !important;width:180px;}
    .image-link-style{
        border-radius: 6px;
        -moz-border-radius: 6px;
        -webkit-border-radius: 6px;
        display: block;
        float: left;
        margin: 30px;
    }
    .image-bottom-style{
        border-radius: 0 0 6px 6px;
        -moz-border-radius: 0 0 6px 6px;
        -webkit-border-radius: 0 0 6px 6px;
        display: block;
    }
    .card-link{
        display: table-cell;
        width: 240px;
        height: 60px;
        vertical-align: middle;
        padding: 0 17px;
        font-size: 22px;
        background: rgba(18,111,154,0.95);
        text-decoration: none!important;
    }
    .card-link span{
        color: #FFFFFF;
    }
    .community-form {
        margin: 0 auto;
        width: 900px;
        padding: 20px;
    }
    #community-name,
    #community-hangouts,
    #community-logo,
    #community-facilitator,
    #community-state,
    #community-district {
        display: block;
        float: left;
        margin: 0 40px 20px 0;
        text-align: left;
        position: relative;
    }
    .community-form label {
        cursor: default !important;
    }
    #community-logo .remove {
        display: block;
        background: #fff center url(/static/images/moderator-delete-icon.png) no-repeat;
        width: 12px;
        height: 11px;
        border: solid 1px #ddd;
        border-radius: 1px;
        position: absolute;
        top: 1.25em;
        right: 2px;
    }
    #community-name input, #community-facilitator input {
        display: block;
        width: 500px;
    }
    #community-logo input,
    #community-state select,
    #community-district select {
        display: block;
    }
    #community-name,
    #community-motto,
    #community-courses,
    #community-resources {
        clear: both;
        display: block;
        text-align: left;
        margin-bottom: 20px;
    }
    #community-motto input {
        display: block;
        width: 860px;
    }
    #community-state {
        float: left;
    }
    #community-private, #community-priority {
        display: block;
        float: right;
        text-align: left;
        clear: both;
    }
    #community-private input, #community-priority input {
        margin-left: 10px;
    }
    #community-hangouts div {
        line-height: 2.5em;
    }
    #community-hangouts input {
        width: 500px;
    }
    #community-courses span, #community-resources span, #community-logo span {
        display: block;
    }
    #community-courses input, #community-courses select, #community-resources input, .resource-logo-label {
        display: block;
        float: left;
        margin: 0 20px 20px 0;
    }
    .resource-link, .resource-name {
        width: 220px;
    }
    #community-form-buttons {
        clear: both;
        margin: 0 auto;
        padding-top: 20px;
        text-align: right;
    }
    #community-cancel {
        float: left;
    }
    #community-resources .add, #community-courses .add {
        padding: 0 6px;
    }
    #community-resources .minus, #community-courses .minus {
        padding: 0 8px;
    }
    .community-course, .community-resource, #community-state {
        clear: both;
    }
    .community-logo-thumb {
        float: left;
        width: 150px;
        margin-right: 10px;
    }
    .community-resource-logo-wrap {
        float: left;
        width: 150px;
        margin-right: 10px;
        position: relative;
    }
    .community-resource-logo-wrap .remove {
        display: block;
        background: #fff center url(/static/images/moderator-delete-icon.png) no-repeat;
        width: 12px;
        height: 11px;
        border: solid 1px #ddd;
        border-radius: 1px;
        position: absolute;
        top: -2px;
        right: -2px;
    }
    .community-error-box {
        border-color: red !important;
    }
    .about-field {
        color: #999;
        font-size: 80%;
        display: inline !important;
    }
</style>
<section class="community-form" style="text-align:center;background:#F5F5F5;">
    <form action="${reverse('community_edit_process')}" method="post" enctype="multipart/form-data" id="community-edit-form">
        <label id="community-name"><span>Community Name:</span><input type="text" name="name" value="${name}" placeholder="The name of the community"></label>
        %if logo != '':
            <label id="community-logo"><span>Logo:</span><img class="community-logo-thumb" src="${logo}"><input type="hidden" name="logo" value="${logo}"><a href="#" class="remove"></a></label>
        %else:
            <label id="community-logo"><span>Logo <span class="about-field">(380px X 260px or larger for best results)</span>:</span><a href="#change_photo" rel="leanModal" class="edit-name">修改图片</a></label>
        %endif
        <label id="community-motto"><span>Description (Motto):</span><input type="text" name="motto" value="${motto}" placeholder="A description or motto for this community"></label>
        <label id="community-facilitator"><span>Facilitator:</span><input type="text" name="facilitator" value="${facilitator}" placeholder="The email of the user who will administer this community"></label>
        %if user_type == 'super':
            <label id="community-state"><span>Select State:</span>
                <select id="state-dropdown" name="state-dropdown"></select>
            </label>
            <label id="community-district"><span>Select District:</span>
                <select id="district-dropdown" name="district-dropdown"></select>
            </label>
        %else:
            <label id="community-state"><span>Select State:</span>
                <select id="state-dropdown" name="state-dropdown" disabled></select>
            </label>
            <label id="community-district"><span>Select District:</span>
                <select id="district-dropdown" name="district-dropdown" disabled></select>
            </label>
        %endif
        %if private:
            <label id="community-private"><span>Private Group:</span><input type="checkbox" name="private" value="1" checked="checked"></label>
        %else:
            <label id="community-private"><span>Private Group:</span><input type="checkbox" name="private" value="1"></label>
        %endif
        <%
            try:
                c = CommunityCommunities.objects.get(id=community)
                dpriority = c.discussion_priority
            except:
                dpriority = 1

        %>
        %if dpriority:
            <label id="community-priority"><input type="radio" name="priority_id" value="0">Post Priority<br><input type="radio" name="priority_id" value="1" checked>Discussion Priority<br></label>
        %else:
            <label id="community-priority"><input type="radio" name="priority_id" value="0" checked>Post Priority<br><input type="radio" name="priority_id" value="1">Discussion Priority<br></label>
        %endif
        %if has_hangout_perms(request.user):
            <label id="community-hangouts"><span>Hangouts Setup:</span>
                <div>
                    <span>1. </span><a href="http://hangouts.google.com/start" target="_blank">Start Hangout</a>&nbsp;&nbsp;&nbsp;
                    <span>2. </span><input type="text" name="hangout" value="${hangout}" placeholder="Copy/Paste Hangout URL Here">
                </div>
            </label>
        %endif
        <label id="community-courses"><span>Courses:</span>
        %for idx, course in enumerate(courses):
            <div class="community-course">
                <select name="course[${idx}]">
                    <option value="">Select a Course</option>
                    %for course_option in courses_drop:
                        %if course == course_option['id']:
                            <option value="${course_option['id']}" selected="selected">${course_option['number']} | ${course_option['name']}</option>
                        %else:
                            <option value="${course_option['id']}">${course_option['number']} | ${course_option['name']}</option>
                        %endif
                    %endfor
                </select>
                <input type="button" class="add operation" value="+" onclick="newCourse()">
            </div>
        %endfor
        </label>
        <label id="community-resources"><span>Resources:</span>
        %for idx, resource in enumerate(resources):
            <div class="community-resource">
                <input class="resource-name" type="text" name="resource_name[${idx}]" value="${resource['name']}" placeholder="Resource name">
                <input class="resource-link" type="text" name="resource_link[${idx}]" value="${resource['link']}" placeholder="Resource link">
                <label><div class="resource-logo-label">Logo:</div>
                %if resource['logo']:
                    <div class="community-resource-logo-wrap">
                        <img src="${get_file_url(resource['logo'])}" class="community-logo-thumb">
                        <input class="community-resource-logo" type="hidden" name="resource_logo[${idx}]" value="${resource['logo'].id}">
                        <a href="#" class="remove"></a>
                    </div>
                %else:
                    <input class="resource-logo" type="file" name="resource_logo[${idx}]">
                %endif
                </label>
                <input type="button" class="add operation" value="+" onclick="newResource()">
            </div>
        %endfor
        </label>
        <input type="hidden" value="${community_id}" name="community_id">
        <input type="hidden" name="csrfmiddlewaretoken" value="${csrf_token}"/>
        <div id="community-form-buttons">
            <input id="community-cancel" type="button" value="Cancel">
            <input id="community-submit" type="submit" value="Submit" name="submit">
        </div>
    </form>
</section>
<script type="text/javascript">
    function newCourse() {
        var course_num = $('.community-course').length;
        $('.community-course').each(function(index) {
            $(this).find('.operation').replaceWith('<input type="button" class="minus operation" value="-" onclick="removeCourse(' + index + ')">');
        });
        var entry = '<div class="community-course"><select name="course[' + course_num + ']"><option value="">Select a Course</option>';
        %for course_option in courses_drop:
            entry += '<option value="${course_option['id']}">${course_option['number']} | ${course_option['name'].replace("'", r"\'")}</option>';
        %endfor
        entry += '</select><input type="button" class="add operation" value="+" onclick="newCourse()"></div>';
        $('#community-courses').append(entry);
    }
    function newResource() {
        var resource_num = $('.community-resource').length;
        $('.community-resource').each(function(index) {
            $(this).find('.operation').replaceWith('<input type="button" class="minus operation" value="-" onclick="removeResource(' + index + ')">');
        });
        var entry = '<div class="community-resource">';
        entry += '<input class="resource-name" type="text" name="resource_name[' + resource_num + ']" value="" placeholder="Resource name">';
        entry += '<input class="resource-link" type="text" name="resource_link[' + resource_num + ']" value="" placeholder="Resource link">';
        entry += '<label><div class="resource-logo-label">Logo:</div><input  class="resource-logo" type="file" name="resource_logo[' + resource_num + ']"></label>';
        entry += '<input type="button" class="add operation" value="+" onclick="newResource()">';
        $('#community-resources').append(entry);
    }
    function removeCourse(index) {
        $('.community-course').each(function(i) {
            if (i == index) {
                $(this).remove();
            } else {
                var num = 0;
                if (i < index) {
                    num = i;
                }
                if (i > index) {
                    num = i - 1;
                }
                $(this).children('select').attr('name', 'course[' + num + ']');
            }
        });
        $('.community-course .minus').each(function(index) {
            $(this).replaceWith('<input type="button" class="minus operation" value="-" onclick="removeCourse(' + index + ')">');
        });
    }
    function removeResource(index) {
        $('.community-resource').each(function(i) {
            if (i == index) {
                $(this).remove();
            } else {
                var num = 0;
                if (i < index) {
                    num = i;
                }
                if (i > index) {
                    num = i - 1;
                }
                $(this).children('.resource-link').attr('name', 'resource_link[' + num + ']');
                $(this).children('.resource-name').attr('name', 'resource_name[' + num + ']');
                $(this).children('.resource-logo').attr('name', 'resource_logo[' + num + ']');
            }
        });
        $('.community-resource .minus').each(function(index) {
            $(this).replaceWith('<input type="button" class="minus operation" value="-" onclick="removeResource(' + index + ')">');
        });
    }
    function checkUser(email) {
        var valid = true;
        $.ajax({
            url: "${reverse('community_check_user')}",
            type: 'GET',
            async: false,
            data: {email: email},
            success: function(data) {
                valid = data.Valid;
            }
        });
        return valid;
    }
    var state_id = '${state}';
    var district_id = '${district}';
    $(document).ready(function() {
        $.get('${reverse('pepper_utilities_drop_states')}', function (data) {
            // Build the options.
            var options = '<option value=""></option>';
            $.each(data, function (index, object) {
                options += '<option value="' + object.id+ '"';
                if (object.id == state_id) {
                    options += ' selected';
                }
                options += '>' + object.name + '</option>';
            });
            // Add them to the state dropdown.
            $('#state-dropdown').append(options);
            $("#state-dropdown").change(function () {
                if ($(this).val()) {
                    // Clear the current district and school options since the state changed.
                    $('#district-dropdown option').remove();
                    // Get the allowed Districts
                    $.get('${reverse('pepper_utilities_drop_districts')}', {state: $(this).val()}, function (data) {
                        var content = '<option value=""></option>';
                        $.each(data, function (index, object) {
                            content += '<option value="' + object.id + '"';
                            if (object.id == district_id) {
                                content += ' selected';
                            }
                            content += '>' + object.name + '</option>';
                        });
                        // Add it to the form.
                        $('#district-dropdown').append(content);
                    });
                }
            });
            if (state_id) {
                $("#state-dropdown").trigger('change');
            }
        });
        $('#community-logo .remove').click(function() {
            var content = '<label id="community-logo"><span>Logo <span class="about-field">(380px X 260px or larger for best results)</span>:</span><a href="#change_photo" rel="leanModal" class="edit-name">修改图片</a></label>';
            $('#community-logo').replaceWith(content);
        });
        $('.community-resource .remove').click(function() {
            var name = $(this).siblings('.community-resource-logo').attr('name');
            var content = '<input class="resource-logo" type="file" name="' + name + '">';
            $(this).parent('.community-resource-logo-wrap').replaceWith(content);
        });
        $('#community-cancel').click(function() {
            %if community_id == 'new':
                window.location.href = "${reverse('communities')}";
            %else:
                window.location.href = "${reverse('community_view', args=[community_id])}";
            %endif
        });
        $('#community-edit-form').submit(function() {
            $('.community-error-box').removeClass('community-error-box');
            var valid = true;
            var errors = ['The following errors occurred:\n'];
            if (!/[A-Za-z]/.test($('#community-name input').val())) {
                valid = false;
                errors.push('Name is required.');
                $('#community-name input').addClass('community-error-box');
            }
            if (!/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/.test($('#community-facilitator input').val())) {
                valid = false;
                errors.push('Valid facilitator email is required.');
                $('#community-facilitator input').addClass('community-error-box');
            } else if (!checkUser($('#community-facilitator input').val())) {
                valid = false;
                errors.push('This email is not currently in our system.');
                $('#community-facilitator input').addClass('community-error-box');
            }
            if (!valid) {
                var error = errors.join('\n');
                alert(error);
            }
            return valid;
        });
    });
</script>

<section id="change_photo" class="modal" style='width:620px'>
  <div class="inner-wrapper" tabindex="-1" id="doc-modal-1" style='width:600px'>
  <header>
      <h2>${_('Add Profile Picture').format()}</h2>
      <hr/>
    </header>
  <div class="am-modal-dialog up-frame-parent up-frame-radius">
    <div class="am-modal-bd  up-frame-body">
      <div class="am-g am-fl">
        <div class="am-form-group am-form-file">
          <input type="file" id="inputImage">
        </div>
      </div>
      <div class="am-g am-fl" >
        <div class="up-pre-before up-frame-radius">
            <img alt="" src="" id="image" >
        </div>
        <div class="up-pre-after up-frame-radius">
        </div>
      </div>
    </div>
    </div>
        <div class="up-control-btns" style='float:left;margin-left: 20px;'>
            <button class="am-icon-rotate-left"  onclick="rotateimgleft()">turnleft</button>
            <button class="am-icon-rotate-right" onclick="rotateimgright()">turnright</button>
            <button class="am-icon-check" id="up-btn-ok" url="upload.php">confirm</button>
        </div>
    <div class="close-modal" id="change_photo_close">
      <div class="inner">
        <p>&#10005;</p>
      </div>
    </div>
    </div>
</section>

<%block name="js_extra">
<script src="https://apis.google.com/js/platform.js" async defer></script>

<script type="text/javascript">
  /*@begin:Click the round button in grade_level table*/
  /*@date:2013-11-02*/
  function click_grade_btn(i){
    var vals={}
    $.each($("#grade_level_id").val().split(","),function(i,v){
      if(v)vals[v]=1;
    });
    var link=document.getElementById("grade_btn"+i);
    if($(link).hasClass("btn_grade_level_active")){
      $(link).removeClass("btn_grade_level_active");
      vals[i]='';
    }else{
      $(link).addClass("btn_grade_level_active");
      vals[i]=1;
    }
    var arVals=[];
    $.each(vals,function(i,v){
      if(v)arVals.push(i)
    });
    arVals.sort(function(a,b){return parseInt(a)-parseInt(b)});
    $("#grade_level_id").val(arVals.join());
  }
  /*@end*/
  (function() {
    $(".email-settings").click(function(event) {
      $("#email_settings_course_id").val( $(event.target).data("course-id") );
      $("#email_settings_course_number").text( $(event.target).data("course-number") );
      if($(event.target).data("optout") == "False") {
        $("#receive_emails").prop('checked', true);
      }
    });
    $(".unenroll").click(function(event) {
      $("#unenroll_course_id").val( $(event.target).data("course-id") );
      $("#unenroll_course_number").text( $(event.target).data("course-number") );
    });
    $('#unenroll_form').on('ajax:complete', function(event, xhr) {
      if(xhr.status == 200) {
        location.href = "${reverse('dashboard')}";
      } else if (xhr.status == 403) {
        location.href = "${reverse('signin_user')}?course_id=" +
          $("#unenroll_course_id").val() + "&enrollment_action=unenroll";
      } else {
        $('#unenroll_error').html(
          xhr.responseText ? xhr.responseText : "An error occurred. Please try again later."
        ).stop().css("display", "block");
      }
    });
    $('#pwd_reset_button').click(function() {
      $.post('${reverse("password_reset")}',
             {"email"  : $('#id_email').val()},
             function(data){
               //$("#password_reset_complete_link").click();
             });
      return false;
    });
    $("#change_email_form").submit(function(){
      var new_email = $('#new_email_field').val();
      /*@begin:Do not need to confirm passowrd when changing email*/
      /*@date:2013-11-02*/
      //var new_password = $('#new_email_password').val();
      $.post('${reverse("change_email")}',
             {"new_email" : new_email, "password" : ""},
             /*@end*/
             function(data) {
               if (data.success) {
                 $("#change_email_title").html("Please verify your new email");
                 $("#change_email_form").html("<p>You'll receive a confirmation in your " +
                                              "in-box. Please click the link in the " +
                                              "email to confirm the email change.</p>");
                 $("#change_email_form").html("<p>${_('You\'ll receive a confirmation in your in-box. Please click the link in the email to confirm the email change.')}</p>");
               } else {
                 $("#change_email_error").html(data.error).stop().css("display", "block");
               }
             });
      return false;
    });
    $("#change_skype_name_form").submit(function(){
       var username = $("#new_skype_name_field").val();
        $.post('${reverse("change_skype_name")}',
             {"username":username},
             function(data) {
               location.reload();
             });
      return false;
    });
    $("#change_name_form").submit(function(){
      /*@begin:Change the name to two fileds*/
      /*@date:2013-11-02*/
      var new_first_name = $('#new_first_name_field').val();
      var new_last_name = $('#new_last_name_field').val();
      var rationale = $('#name_rationale_field').val();
      $.post('${reverse("change_name")}',
             {"new_first_name":new_first_name, "new_last_name":new_last_name,"rationale":rationale},
             /*@end*/
             function(data) {
               if(data.success) {
                 location.reload();
                 // $("#change_name_body").html("<p>Name changed.</p>");
               } else {
                 $("#change_name_error").html(data.error).stop().css("display", "block");
               }
             });
      return false;
    });
<!--@begin:Process the newly added fields in dashboard-->
<!--@date:2013-11-02-->
    $("#change_school_form").find("select[name='school_id']").val('${curr_user.profile.school_id}')
    $("#change_school_form").submit(function(){
      var school_id = $(this.school_id).val();
      $.post('${reverse("change_school")}',
             {"school_id":school_id},
             function(data) {
               if(data.success) {
                 location.reload();
               } else {
                 $("#change_school_error").html(data.error).stop().css("display", "block");
               }
             });
       return false;
    });
    $.each( '${curr_user.profile.grade_level_id}'.split(',') ,function(i,v){
      if($.trim(v))
        click_grade_btn(v);
    });
    $("#change_grade_level_form").submit(function(){
      var grade_level_id = $(this.grade_level_id).val();
      $.post('${reverse("change_grade_level")}',
             {"grade_level_id":grade_level_id},
             function(data) {
               if(data.success) {
                 location.reload();
               } else {
                 $("#change_grade_level_error").html(data.error).stop().css("display", "block");
               }
             });
      return false;
    });
    // change_percent_lunch submit
    $("#change_percent_lunch_form").find("select[name='percent_lunch']").val('${curr_user.profile.percent_lunch}')
      $("#change_percent_lunch_form").submit(function(){
        var percent_lunch = $(this.percent_lunch).val();
        $.post('${reverse("change_percent_lunch")}',
               {"percent_lunch":percent_lunch},
               function(data) {
                 if(data.success) {
                   location.reload();
                 } else {
                   $("#change_percent_lunch_error").html(data.error).stop().css("display", "block");
                 }
               });
        return false;
      });
    // change_percent_iep submit
    $("#change_percent_iep_form").find("select[name='percent_iep']").val('${curr_user.profile.percent_iep}')
      $("#change_percent_iep_form").submit(function(){
        var percent_iep = $(this.percent_iep).val();
        $.post('${reverse("change_percent_iep")}',
               {"percent_iep":percent_iep},
               function(data) {
                 if(data.success) {
                   location.reload();
                 } else {
                   $("#change_percent_iep_error").html(data.error).stop().css("display", "block");
                 }
               });
        return false;
      });
    // change_percent_eng_learner submit
    $("#change_percent_eng_learner_form").find("select[name='percent_eng_learner']").val('${curr_user.profile.percent_eng_learner}')
      $("#change_percent_eng_learner_form").submit(function(){
        var percent_eng_learner = $(this.percent_eng_learner).val();
        $.post('${reverse("change_percent_eng_learner")}',
               {"percent_eng_learner":percent_eng_learner},
               function(data) {
                 if(data.success) {
                   location.reload();
                 } else {
                   $("#change_percent_eng_learner_error").html(data.error).stop().css("display", "block");
                 }
               });
        return false;
      });
    $("#change_major_subject_area_form").find("select[name='major_subject_area_id']").val('${curr_user.profile.major_subject_area_id}')
      $("#change_major_subject_area_form").submit(function(){
        var major_subject_area_id = $(this.major_subject_area_id).val();
        $.post('${reverse("change_major_subject_area")}',
               {"major_subject_area_id":major_subject_area_id},
               function(data) {
                 if(data.success) {
                   location.reload();
                 } else {
                   $("#change_major_subject_area_error").html(data.error).stop().css("display", "block");
                 }
               });
        return false;
      });
    $("#change_years_in_education_form").find("select[name='years_in_education_id']").val('${curr_user.profile.years_in_education_id}')
      $("#change_years_in_education_form").submit(function(){
        var years_in_education_id = $(this.years_in_education_id).val();
        $.post('${reverse("change_years_in_education")}',
               {"years_in_education_id":years_in_education_id},
               function(data) {
                 if(data.success) {
                   location.reload();
                 } else {
                   $("#change_years_in_education_error").html(data.error).stop().css("display", "block");
                 }
               });
        return false;
      });
    $("#change_bio_form").submit(function(){
      var bio = $(this.bio).val();
      $.post('${reverse("change_bio")}',
             {"bio":bio},
             function(data) {
               if(data.success) {
                 location.reload();
               } else {
                 $("#change_bio_error").html(data.error).stop().css("display", "block");
               }
             });
      return false;
    });
    <!--@end-->
    $("#email_settings_form").submit(function(){
      $.ajax({
        type: "POST",
        url: '${reverse("change_email_settings")}',
        data: $(this).serializeArray(),
        success: function(data) {
          if(data.success) {
            location.href = "${reverse('dashboard')}";
          }
        },
        error: function(xhr, textStatus, error) {
          if (xhr.status == 403) {
            location.href = "${reverse('signin_user')}";          
          }
        }
      });
      return false;
    });
  })(this)
  $("#change_photo_form").submit(function(){
    var AllowImgFileSize=512;
    var AllowImgWidth=1024;
    var AllowImgHeight=768; 
    var fileImg = document.getElementById("id_photo"); 
    <!--check file choose-->
    if (fileImg.value=="")
    {
      $("#change_photo_error").html("Update your avatar by uploading an image from your computer.").stop().css("display", "block");
      fileImg.focus();
      return false;
    }
    <!------------------------------------------>
    <!--check file type-->
    var fileImg_url=fileImg.value.toLowerCase();
    var fileImg_ext=fileImg_url.substring(fileImg_url.length-3,fileImg_url.length);
    if (fileImg_ext!="jpg" && fileImg_ext!="peg" && fileImg_ext!="png")
    {
      $("#change_photo_error").html("We accept image only in JPG or PNG.").stop().css("display", "block");
      fileImg.focus();
      return false;
    }
    <!------------------------------------------>
    <!--check file size(less than 2m)-->
    var file_size =  fileImg.files[0].size;
    if (file_size>2048*1024)
    {
      $("#change_photo_error").html("The file size CANNOT exceed 2MB (2048 KB).").stop().css("display", "block");
      fileImg.focus();
      return false;
    }
    <!------------------------------------------>
    document.getElementById("photo_submit").disabled = true;
        $('#image_uploading').show(); 
        $('#change_photo_form').submit(); 
    });

    $("#change_name_close").click(function(){
      $('#change_name_error').hide();
    });
    $("#change_photo_close").click(function(){
      $('#change_photo_error').hide();
      // $('#id_photo')[0].value = "";
    });
    $("#change_bio_close").click(function(){
      $('#id_bio')[0].value = "";
    });
    $("#container_dashboard").click(function(){
      $('#change_name_error').hide();
      $('#change_photo_error').hide();
      $('#id_photo')[0].value = "";
      $('#id_bio')[0].value = "";
    });
<!--@end-->
  //-----------------------------------------------
  $(".portfolio-btn").click(function(){
        if(!$(this).hasClass("disabled_btn")){
            var curr_user={};
            var interviewer={};
            //var course_number=$(this).parent().find("a").eq(0).text().split(' ')[0];
            var course_number=$(this).parent().find("a").attr("course_number");
            interviewer.id="${request.user.id}";
            interviewer.name="${request.user.username}";
            interviewer.fullname="${request.user.first_name} ${request.user.last_name}";
            curr_user.id="${curr_user.id}";
            var datainfo={'info':JSON.stringify({'user_id':curr_user.id,'interviewer_id':interviewer.id,'interviewer_name':interviewer.name,
                                                 'interviewer_fullname':interviewer.fullname,'type':'view_portfolio',
                                                 'course_number':course_number,'date':(new Date()).toISOString(),'activate':'false'})};
            var url = $(this).attr("link");
            $.post("${reverse('save_interactive_update')}",datainfo,function(){window.open(url,'_self');});
        }
   });
    function imessage_click(obj)
  {
    var userInfo=[];
    userInfo['message_people']={id:$(obj).attr("data-id"),fullname:$(obj).attr("data-fullname"),name:$(obj).attr("data-name")};
    userInfo['user']={id:'${user.id}',fullname:'${user.first_name} ${user.last_name}',name:'${user.username}'};
    message_board(userInfo);
  }
  </script>
    <script type="text/javascript" src="https://secure.skypeassets.com/i/scom/js/skype-uri.js"></script>
<style>
    .disabled_btn{ cursor:default !important; color:#999999 !important; }
    .lean-overlay .loading {width: 128px; height: 128px; display: block; border-radius: 100px; position: absolute; left: 50%; top: 300px; margin-left: -64px;}  
</style>
<script>
    function LoadingWin(){
        this.$loader = null;
        this.show();
    }
    LoadingWin.prototype.show = function () {
        if (!this.$loader) {
            this.$loader = $('<div class="lean-overlay"><img class="loading" src="/static/images/loading.gif"></div>');
            this.$loader.appendTo(document.body);
        }
        this.$loader.css('display','block');
    };
    LoadingWin.prototype.hide = function () {
        if (this.$loader) {
            this.$loader.remove();
            this.$loader = null;
        }
    };
    $(document).ready(function(){
        $(".portfolio-btn").each(function(){
            var user_id = "${curr_user.id}";
            var linkx = $(this).attr("link");
            var course_id = linkx.split("/portfolio")[0];
            course_id = course_id.replace("/courses/", "");
            
            $.getJSON("${reverse('portfolio_settings')}", {flag:"getCourseLevel", linkx:linkx, course_id:course_id, user_id:user_id}, function (r) {
                if (r.success) {
                    if(r.level == "1"){
                        $(".portfolio-btn[link='" + r.linkx + "']").removeClass("disabled_btn");
                    }
                }           
            });
        });
        $(".information_left_top_left").css("backgroundColor", $(".nav-fixed").css("backgroundColor"));
        
        //------------------organization_get_info       
        var loadwin = new LoadingWin();     
        var state = "-1";
        var district = "-1";
        var school = "-1";
        % if curr_user.profile.district_id:
        state = "${curr_user.profile.district.state.id}";
        % endif
        % if curr_user.profile.district_id:
        district = "${curr_user.profile.district.id}";
        % endif
        % if curr_user.profile.school_id:
        school = "${curr_user.profile.school.id}";
        % endif         
        $.post("${reverse('organizational_configuration')}", {flag:"organization_get_info", source:"register", state: state, district: district, school: school}, function (r) {        
            if (r.SiteURL_OK){
                if(r.Success){
                    if(r.OrganizationOK){
                        $("#organization_ui_district").html(r.DistrictType + ": ");
                        $("#organization_ui_school").html(r.SchoolType + ": ");
                    }
                }
            }
            loadwin.hide();
        });
    });
</script>
</%block>