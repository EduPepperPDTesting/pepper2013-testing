<%!
from django.core.urlresolvers import reverse
from django.shortcuts import redirect
from courseware.courses import course_image_url, get_course_about_section
from student.views import course_from_id
from administration.configuration import has_hangout_perms
from communities.utils import is_facilitator, is_member, is_private
from file_uploader.utils import get_file_url
from django.utils import timezone
from student.models import State,District,Transaction,Cohort,School,SubjectArea,GradeLevel,YearsInEducation, UserProfile, User
import datetime
%>
<%inherit file="../main.html" />
<%namespace name='static' file='../static_content.html'/>
<%block name="title"><title>community</title></%block>
<script type="text/javascript" src="/static/js/admin_ui_controls.js"></script>
<link rel="stylesheet" href="/static/css/bootstrap-iso.css"/>
<link rel="stylesheet" href="/static/css/pepreg.css" type="text/css" media="screen"/>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

<!--cropper-->
<link rel="stylesheet" href="/static/css/amazeui.cropper.css">
<link rel="stylesheet" href="/static/css/custom_up_img.css">
<script src="/static/js/amazeui.min.js" charset="utf-8"></script>
<script src="/static/js/cropper.min.js" charset="utf-8"></script>
<script src="/static/js/custom_up_img2.js" charset="utf-8"></script>

<style type="text/css" media="screen">
/*-----------create or edit community window-----------*/
/*-----------akogan-----------*/
.label{color: #000000 !important;}
.switch i{ bottom: 15px !important;}
.step-page .move{right: 25px !important;}
.step-content{ width: 720px !important;}

.form-row span{font: normal 16px "Open Sans",Verdana,Geneva,sans-serif !important; color: #3c3c3c !important;padding-right: 0px !important}
.form-row label{font: normal 16px "Open Sans",Verdana,Geneva,sans-serif !important; color: #3c3c3c !important;padding-right: 0px !important}
.form-row span.label{font: 12px "Open Sans",Verdana,Geneva,sans-serif !important; color: #3c3c3c !important;padding-right: 0px !important}
.form-row select{color: #222;}
.form-row input{color: #222 !important;}
.form-row textarea{color: #222 !important;}

h1, h2, section.outside-app h1, h3, h4, h5, h6{font: normal 1.2em/1.2em Georgia,Cambria,"Times New Roman",Times,serif !important;}

#dlg-warning{height: 210px;}

/*-----------old create community -----------*/
.community-error-box {
    border-color: red !important;
}
#community-courses,#community-resources {
    clear: both;
    display: block;
    text-align: left;
    margin-bottom: 20px;
}

#community-courses input, #community-resources input {
    /*display: block;
    float: left;*/
    margin: 0 20px 2px 0;
}
#community-resources .community-resource{
    margin-bottom:25px !important;
    /*border-bottom:1px solid;*/
}
#community-courses select {
    display: block;
    float: left;
    margin: 0 20px 20px 0;
    font-weight:bold;
    font-style:italic;
}
#community-resources .add, #community-courses .add {
    padding: 0 6px;
    color:#fff !important;
}
#community-resources .minus, #community-courses .minus {
    padding: 0 8px;
    color:#fff !important;
}
.community-course, .community-resource, #community-state {
    clear: both;
}
.resource-logo-label{
    font-size:13px;
    font-weight:bold;
    font-style:italic;
}
.community-logo-thumb {
    /*float: left;*/
    width: 120px;
    margin-right: 10px;
}
.community-resource-logo-thumb {
    width: 120px;
}
.icon-edit:before {font-family:FontAwesome; }
.icon-remove:before {font-family:FontAwesome;   }
.icon-remove{
    cursor:pointer;
}
#community-logo .remove {
        display: block;
        background: #fff center url(/static/images/moderator-delete-icon.png) no-repeat;
        width: 12px;
        height: 11px;
        border: solid 1px #ddd;
        border-radius: 1px;
        position: absolute;
        top: 1.25em;
        left: 115px;
    }
.community-resource-logo-wrap .remove {
        display: block;
        background: #fff center url(/static/images/moderator-delete-icon.png) no-repeat;
        width: 12px;
        height: 11px;
        border: solid 1px #ddd;
        border-radius: 1px;
        position: absolute;
        top: -4px;
        left: 115px;
    }

#community-logo {
        display: block;
        /*float: left;*/
        margin: 0 0px 12px 0;
        text-align: left;
        /*position: relative;*/
    }
/*-----------create community form-----------*/
#community-name input{
    padding:5px 12px;
    width:500px;
    margin-top:5px;
}

#community-motto input{
    padding:5px 12px;
    max-width:650px !important;
    width:650px;
    margin-top:5px;
}
#community-private input{
    margin-left:5px;
    margin-top:0px;
}

.select-lock{
    color:#ccc !important;
    border-color:#ccc;
}

.select-lock option{
    color:#ccc;
}

/*----------------------------------community page----------------------------------*/
a{
    text-decoration:none !important;
    cursor: pointer;
}
.overflow-text{
    text-overflow:ellipsis;
    overflow:hidden;
    white-space:nowrap;
}
/*--------------community all--------------*/
.content-wrapper-community{
    margin-top:0px;
    background-color:#e7e7e8;
    padding-bottom: 40px;
}
.sub-title{
    background-color: #2CBAEC;
    color:#fff;
    font-size: 15px;
    width: 100%;
    padding:10px 0 10px 0;
    text-align: center;
    position: relative;
}

.con-main-all{
    width:680px;
    margin-left:27px;
    float:left;
    
    height:500px;
    border: 1px solid;
}
/*--------------community left--------------*/
.community-left{
    width: 250px;
    float:left;
    background-color: #fff;
    padding-bottom: 50px;
}
.facilitator-info,.subcommunities, .trending{
    width:226px;margin-left:13px;margin-top:20px;border:0px solid #f00;
}
.sub-title .btn-addsub{
    color:#fff;
    font-size: 28px;
    position: absolute;
    cursor: pointer;
    top:-4px;
    left:171px;
}
.community-left .user-photo{
    width:60px;height:60px;float:left;margin-right:10px;border:0px solid;
}
.community-left .user-photo img{
    width:60px;height:60px;border-radius:50px;
}
.community-left .user-info{
    width:100px;margin-top:15px;float:left;border:0px solid;
}
.community-left .user-name{
    font-size:14px;font-weight:bold;
}
.community-left .btn-facilitator{
    cursor:pointer;float:left;border:0px solid #f00;
}
.community-left .facilitator-triangle{
    float:left;margin:7px 0 0 3px;width:0;height:0;border-top:5px solid #2CBAEC;border-right: 5px solid transparent;border-left: 5px solid transparent;
}
.community-left .facilitator-menu{
    float:left;width:175px;margin-top:0px;display:none;
}
.community-left .f-menu-triangle{
    float:left;
    margin:2px 0 0 13px;
    width:0;
    height:0;
    border-bottom:6px solid #535456;
    border-right: 6px solid transparent;
    border-left: 6px solid transparent;
}
.community-left .f-lines{
    width:175px;background-color:#535456;margin-top:8px;
}
.community-left .f-rights-line{
    margin-left:15px;margin-right:15px;color:#a4a4a5;padding:10px 0 10px 0;border-bottom:1px solid #a4a4a5;font-size:13px;cursor:pointer;
}
.community-left .f-rights-line:last-child{
    border:0;padding-bottom:12px;
}
.community-left .f-rights-line:hover{
   color:#e2e2e2;
}
.community-left .f-rights-line a{
    color:#a4a4a5;font-size:13px
}
.community-left .f-rights-line a:hover{
    color:#e2e2e2;
}
.community-left .user-email{
    float:left;margin:15px 0 0 5px;border:0px solid;cursor:pointer;
}
.community-left .sub-community-titles{
    width:224px;border:1px solid #ccc;height:163px;overflow-y:auto;
}
.community-left .unjoined{
    width:85%;font-size:13px;margin:10px;padding: 1px 0 1px 0;border:0px solid;
}
.community-left .unjoined a{
    color: #000;font-size:13px;cursor: pointer;
}
.community-left .joined{
    width:90%;font-size:13px;margin:10px;border:0px solid;
}
.community-left .joined a{
    color: #000;font-size:13px;cursor: pointer;font-weight: bold;
}
.community-left .joined-title{
    display:table-cell;padding:1px 5px 1px 0;max-width:160px;
}
.community-left .discussion-count{
    padding:1px 8px 1px 8px;background-color:#F58221;border-radius:6px;font-size:12px;color:#fff;max-width: 22px;
}
.community-left .seemore-sc{
    width:212px;padding:10px 10px 0 0;text-align:right;border:0px solid;
}
.community-left .btn-seemore-sc,.community-left .btn-seemore-t{
   font-size:13px;color:#999;cursor: pointer; 
}
.community-left .trendings{
    width:224px;border:1px solid #ccc;height:145px;overflow-y:auto;
}
.community-left .every-discussion{
    width:85%;margin:10px;padding-bottom:10px;border-bottom:1px solid #ccc;
}
.community-left .discussion-subject{
    font-weight: bold;font-size: 13px;
}
.community-left .discussion-date .posted{
    font-size: 13px;color:#F58221;
}
.community-left .discussion-date .date{
    font-size: 13px;
}
.community-left .seemore-t{
    width:212px;padding:0px 10px 0 0;text-align:right;border:0px solid;
}
/*--------------community right--------------*/
.community-right{
    width: 250px;
    margin-left:27px;
    float:left;
    background-color: #fff;
    padding-bottom: 50px;
    
    border: 0px solid;
}
.communitystatus,.resources{
    width:226px;margin-left:13px;margin-top:20px;border:0px solid #f00;
}
.community-right .community-status{
    width:224px;border:0px solid #ccc;height:180px;overflow-y:auto;
}
.community-right .dis-count{
    width:85%;font-size:14px;margin:15px 10px 2px 15px;border:0px solid;
}
.community-right .members{
    width:85%;font-size:14px;margin:2px 10px 2px 15px;border:0px solid;
}
.community-right .dis-count span{
    font-size:14px;color:#F58221;font-weight:bold;
}
.community-right .members span{
    font-size:14px;color:#F58221;font-weight:bold;
}
.community-right .members a{
    font-size:14px;color:#89C153;
}
.community-right .my-communities{
    width:85%;font-size:14px;margin:4px 10px 2px 15px;border:0px solid;
}
.community-right .my-communities-triangle{
    float:left;margin:7px 0 0 3px;width:0;height:0;border-top:5px solid #000;border-right: 5px solid transparent;border-left: 5px solid transparent;
}
.community-right .my-community{
    width:155px;margin-left:18px;border:0px solid #ccc;
}
.community-right .my-community .subject{
    padding:10px 0 10px 0;border-bottom:1px solid #ccc;
}
.community-right .my-community a{
    color: #000;cursor: pointer;
}
.community-right .my-community .btn-seemore-cs{
    padding:3px 0 5px 0;color:#999;font-size:13px; cursor: pointer;
}
.community-right .community-resources{
    width:224px;border:0px solid #ccc;height:320px;overflow-y:auto;
}
.community-right .every-resource{
    width:80%;;margin-left:20px;padding:15px 0 15px 0;border-bottom:1px solid #ccc;
}
.community-right .community-resources a{
    font-size:13px;color:#000;
}
.community-right .resources-seemore{
    width:80%;margin-left:20px;padding:0px 0 5px 0;
}
.community-right .resources-seemore .btn-seemore-r{
    font-size:13px;color:#999;cursor: pointer;
}
/*--------------community middle top--------------*/
.con-main-all .main-logo img{
    width:100px;
    height:100px;
}
</style>

<%
    district_id = district
    if district_id == '':
        if request.user.profile.district_id:
            district_id = request.user.profile.district_id

    state_id = state
    if state_id == '':
        for item in State.objects.all().order_by('name'):
            if district_id:
                if item.name == request.user.profile.district.state.name:
                    state_id = item.id
                    break
%>
%for course_option in courses_drop:
    <div class="coursesdropdata" cid="${course_option['id']}" cnumber="${course_option['number']}" style="display:none">${course_option['name']}</div>
%endfor
<section class="content-wrapper-community">
    <div class="" style="margin:0 auto;width:1240px;padding-top:30px;">
        <!--width 250 + 30 + 680 + 30 + 250 = 1240-->
        <!--Communities-My Trending Topics-->
        <div class="community-left">
            <div class="sub-community-info"></div>
            %if facilitator:
            <div class="facilitator-info">
                <div class="user-photo">
                    <img src="${reverse('user_photo', args=[facilitator.user.id])}"/>
                </div>
                <div class="user-info">
                    %if user_request_info:
                    <div class="user-name overflow-text">${facilitator.user.first_name} ${facilitator.user.last_name}</div>
                    <div class="btn-facilitator">
                        <div style="font-size:14px;color:#2CBAEC;float:left;">Facilitator</div>
                        <div class="facilitator-triangle"></div>
                    </div> 
                    <div class="facilitator-menu">
                        <div class="f-menu-triangle"></div>
                        <div class="f-lines">
                            %if user_request_info.community_edit:
                            <div class="f-rights-line" onclick="return pepreg.editTraining(${community_id});">Edit Community</div>
                            %endif
                            %if user_request_info.community_delete:
                            <div class="f-rights-line">Delete Community</div>
                            %endif
                            <div class="f-rights-line"><a href="${reverse('community_mange_member',args=[community.id])}">Manage Users</a></div>
                        </div>
                    </div>
                    %else:
                    <div class="user-name overflow-text" style="margin-top:8px;">${facilitator.user.first_name} ${facilitator.user.last_name}</div>
                    %endif
                </div>
                <div class="user-email">
                    <a href="mailto:${facilitator.user.email}"><img src="/static/images/community_new/facilitator-mail-50.png" width="30"/></a>
                </div>
                <div style="clear:both;"></div>
            </div>
            %endif
            <div class="subcommunities">
                <div class="sub-title">Subcommunities&nbsp;&nbsp;&nbsp;&nbsp;<span class="btn-addsub">+</span></div>
                <div class="sub-community-titles">
                    <div class="joined">
                        <div class="overflow-text joined-title">
                            <a>Community Chat</a>
                        </div>
                        <div style="display:table-cell">
                            <div class="discussion-count overflow-text">8</div>
                        </div>
                    </div>
                    <div class="unjoined overflow-text"><a>Februay Workshop Februay Workshop</a></div>
                    <div class="unjoined overflow-text"><a>General</a></div>
                    <div class="joined">
                        <div class="overflow-text joined-title">
                            <a>Random affdf sadfa asdfaasdfa sdfa</a>
                        </div>
                        <div style="display:table-cell">
                            <div class="discussion-count overflow-text">3</div>
                        </div>
                    </div>
                    <div class="seemore-sc">
                        <span class="btn-seemore-sc">See More</span>
                    </div>
                </div>
            </div>
            <div class="trending">
                <div class="sub-title">Trending ${community_id}</div>
                <div class="trendings">
                    <div class="every-discussion">
                        <div class="discussion-subject overflow-text">Welcome to the O Nieill sdfsdfa sadf</div>
                        <div class="discussion-date">
                            <span class="posted">Posted:</span>
                            <span class="date">Sep 7,2016</span>
                        </div>
                    </div>
                    <div class="every-discussion" style="border-bottom:0;padding-bottom:0">
                        <div class="discussion-subject overflow-text">Test post</div>
                        <div class="discussion-date">
                            <span class="posted">Posted:</span>
                            <span class="date">Aug 7,2016</span>
                        </div>
                    </div>
                    <div class="seemore-t">
                        <span class="btn-seemore-t">See More</span>
                    </div>
                </div>
            </div>
        </div>

        <!--Main content-->
        <div class="con-main-all" style="background-color:#fff;">
            
        </div>
        
        <!--Courses-My Learning Plan-->
        <div class="community-right">
            <div class="communitystatus">
                <div class="sub-title">Community Status</div>
                <div class="community-status">
                    <div class="dis-count">Discussions:&nbsp;<span>3</span></div>
                    <div class="members">Members:&nbsp;<span>17</span>&nbsp;<a>[view]</a></div>
                    <div class="my-communities">
                        <div style="font-size:14px;float:left;">My Communities</div>
                        <div class="my-communities-triangle"></div>
                        <div style="clear:both;"></div>
                        <div class="my-community">
                            <div class="subject overflow-text"><a>Oklahoma SPED</a></div>
                        </div>
                        <div class="my-community">
                            <div class="subject overflow-text" style="border-bottom:0"><a>ESPN Ninjas sadf fsadf asdf</a></div>
                        </div>
                        <div class="my-community">
                            <span class="btn-seemore-cs">See More</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="resources">
                <div class="sub-title">Resources</div>
                <div class="community-resources">
                    <div class="every-resource">
                        <a>O Niell Sea Odyssey Website</a>
                    </div>
                    <div class="every-resource">
                        <a>O Niell Sea Odyssey Website sf asdf gagadfsa fa</a>
                    </div>
                    <div class="every-resource">
                        <a>Those were such happy times Those were such</a>
                    </div>
                    <div class="every-resource">
                        <a>And not so long ago dfa</a>
                    </div>
                    <div class="every-resource" style="border-bottom:0;">
                        <a>How I wondered where they d gone</a>
                    </div>
                    <div class="resources-seemore">
                        <span class="btn-seemore-r">See More</span>
                    </div>
                </div>
            </div>
        </div>

        <div style="clear:both;"></div>
    </div>
</section>

<div class="modal bootstrap-iso" id="dlg-warning" style="width:500px;margin-left:-250px;border-radius:0;">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0;border-radius:0;">
        <div class="titlebar">
            <h3 class="dialog-title"></h3>
            <div class="close-modal" id="dialog_close">✕</div>
        </div>
        <div class="content" style="padding:30px;overflow-x:auto;overflow-y:auto;position:relative;background:#fff;border-radius:0;"></div>
    </div>
</div>
<div class="modal bootstrap-iso" id="dlg-upload_picture" style="width:600px;margin-left:-300px;border-radius:0;height:520px;">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0;border-radius:0;">
        <div class="titlebar">
            <h3 class="dialog-title"></h3>
            <div class="close-modal" id="dialog_close">✕</div>
        </div>
        <div style="padding:10px;overflow-x:auto;overflow-y:auto;position:relative;background:#fff;border-radius:0;">
            <div class="am-modal-dialog up-frame-parent up-frame-radius">
                <div class="am-modal-bd  up-frame-body">
                    <div class="am-g am-fl">
                        <div class="am-form-group am-form-file">
                            <input type="file" id="inputImage">
                        </div>
                    </div>
                    <div class="am-g am-fl" >
                        <div class="up-pre-before up-frame-radius">
                            <img alt="" src="" id="image" >
                        </div>
                        <div class="up-pre-after up-frame-radius">
                        </div>
                    </div>
                </div>
            </div>
            <div class="up-control-btns" style='float:left;margin-left: 20px;margin-top:5px;'>
                <button class="am-icon-rotate-left"  onclick="rotateimgleft()">turnleft</button>
                <button class="am-icon-rotate-right" onclick="rotateimgright()">turnright</button>
                <button class="am-icon-check" id="up-btn-ok">confirm</button>
            </div>
        </div>
    </div>
</div>
<div class=" modal bootstrap-iso" id="dlg-add-training" style="width:800px;margin-left:-400px; position: absolute; top: 120px; height:500px;border-radius:0;">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0;border-radius:0;">
        <!-- <div class="titlebar">
        <h3 class="dialog-title">Add Training</h3>
        <div class="close-modal" id="dialog_close">✕</div>
        </div> -->
        <input type="hidden" name="id" value=""/>
        <div class="content" style="height:508px;overflow:hidden;position:relative;background:#fff;padding:0;border-radius:0;">
            <div class="" style="width:100%;height:100%;overflow:hidden;">
                <div class="step-page">
                    <div class="step-content">
                        <h5>Create Community: Step 1 of 5</h5>
                        <h4>General Information</h4>
                        <div class="form-row">
                            <label id="community-name">
                                <span>Community Name:</span></br>
                                <input type="text" name="name" value="" placeholder="The name of the community">
                            </label>
                        </div>
                        <div class="form-row">
                            <label id="community-motto">
                                <span>Description (Motto):</span></br>
                                <input type="text" name="motto" value="" placeholder="A description or motto for this community">
                            </label>
                        </div>
                        <div class="form-row">
                            <label id="community-logo">
                            </label>
                        </div>
                        <div class="form-row">
                            <div id="community-private"><span>Private Group:</span><input type="checkbox" name="private" value=""></div>
                        </div>
                    </div>
                </div>
                <div class="step-page">
                    <div class="step-content">
                        <h5>Create Community: Step 2 of 5</h5>
                        <h4>Organization Information</h4>
                        <div class="form-row" style="font-size:14px;">
                            %if request.user.is_superuser:
                                <label id="community-state"><span>Select State:</span></br>
                                    <select id="state-dropdown" name="state-dropdown"></select>
                                </label>
                            %else:
                                <label id="community-state"><span>Select State:</span>
                                    <select id="state-dropdown" name="state-dropdown" disabled class="select-lock"></select>
                                </label>
                            %endif
                        </div>
                        <div class="form-row" style="font-size:12px;margin-top:50px;">
                            %if request.user.is_superuser:
                                <label id="community-district"><span>Select District:</span></br>
                                    <select id="district-dropdown" name="district-dropdown" style="min-width:100px;"></select>
                                </label>
                            %else:
                                <label id="community-district"><span>Select District:</span>
                                    <select id="district-dropdown" name="district-dropdown" disabled class="select-lock" style="min-width:100px;"></select>
                                </label>
                            %endif
                        </div>
                    </div>
                </div>
                <div class="step-page">
                    <div class="step-content">
                        <h5>Create Community: Step 3 of 5</h5>
                        <h4>Add Courses</h4>
                        <div class="form-row" style="font-size:14px;">
                            <label><span>courses:</span></label></br>
                            <div style="overflow-y:auto;height:320px;">
                                <div id="community-courses">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="step-page">
                    <div class="step-content">
                        <h5>Create Community: Step 4 of 5</h5>
                        <h4>Add resources</h4>
                        <div class="form-row" style="font-size:14px;">
                            <label><span>Resources:</span></label></br>
                            <div style="overflow-y:auto;height:320px;">
                                <div id="community-resources">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="step-page">
                    <div class="step-content">
                        <h5>Create Community: Step 5 of 5</h5>
                        <h4>Add/Remove Facilitators</h4>
                        <div class="form-row" style="font-size:14px;">
                            <div style="width:100%;height:240px;overflow-y:scroll;border:1px solid #999;">
                                <table width="100%" cellspacing="" cellpadding="" border="0">
                                    <thead>
                                        <tr>
                                            <th width="30" align="center"></th>
                                            <th width="70">Default</th>
                                            <th align="center">Email</th>
                                            <th width="150" align="center">Edit Community</th>
                                            <th width="150" align="center">Delete Community</th>
                                        </tr>
                                    </thead>
                                    <tbody id="community_facilitators_list">
                                        <!--
                                        <tr>
                                            <td></td>
                                            <td style='padding-left:15px;'><input name='default' type='radio' value='' /></td>
                                            <td>edutest@163.com</td>
                                            <td style='padding-left:30px;'><input name='edit' type='checkbox' value='' /></td>
                                            <td style='padding-left:40px;'><input name='delete' type='checkbox' value='' /></td>
                                        </tr>
                                        -->
                                    </tbody>    
                                </table>
                            </div>
                        </div>
                        <div class="form-row" style="font-size:14px;">
                            <i>Select a <b>Community Facilitator</b> by searching email (start typing and select email of
                                <b>Facilitator</b>):</i>
                            <div style="margin:5px 0 5px 0;">
                                <select id="complete-email" name="member" style="min-width:100px;margin:5px 5px 0 0;">
                                    %for user_option in users_drop:
                                        %if request.user.id == user_option['user_id']:
                                            <option value="${user_option['user_id']}" selected="selected">${user_option['email']}</option>
                                        %else:
                                            <option value="${user_option['user_id']}">${user_option['email']}</option>
                                        %endif
                                    %endfor
                                </select>
                                <!--<input type="text" name="member" id="complete-email" autocomplete="off">-->
                                <input type="button" name="" value="Add" class="btn-add-facilitator" style="color:#fff !important;"/>
                            </div>
                            <i>You may add more <b>Facilitators</b> after selecting the first one.</i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
$(".btn-facilitator").click(function(){
    $(".facilitator-menu").toggle("slow");
});


    function newCourse() {
        var course_num = $('.community-course').length;
        $('.community-course').each(function(index) {
            $(this).find('.operation').replaceWith('<input type="button" class="minus operation" value="-" onclick="removeCourse(' + index + ')">');
        });
        var entry = '<div class="community-course"><select name="course[' + course_num + ']"><option value="">Select a Course</option>';
        %for course_option in courses_drop:
            entry += '<option value="${course_option['id']}">${course_option['number']} | ${course_option['name'].replace("'", r"\'")}</option>';
        %endfor
        entry += '</select><input type="button" class="add operation" value="+" onclick="newCourse()"></div>';
        $('#community-courses').append(entry);
    }

    function removeCourse(index) {
        $('.community-course').each(function(i) {
            if (i == index) {
                $(this).remove();
            } else {
                var num = 0;
                if (i < index) {
                    num = i;
                }
                if (i > index) {
                    num = i - 1;
                }
                $(this).children('select').attr('name', 'course[' + num + ']');
            }
        });
        $('.community-course .minus').each(function(index) {
            $(this).replaceWith('<input type="button" class="minus operation" value="-" onclick="removeCourse(' + index + ')">');
        });
    }

    function newResource() {
        var resource_num = $('.community-resource').length;
        $('.community-resource').each(function(index) {
            $(this).find('.operation').replaceWith('<input type="button" class="minus operation" value="-" onclick="removeResource(' + index + ')">');
        });
        var entry = '<div class="community-resource">';
        entry += '<input class="resource-name" type="text" name="resource_name[' + resource_num + ']" value="" placeholder="Resource name">';
        entry += '<input class="resource-link" type="text" name="resource_link[' + resource_num + ']" value="" placeholder="Resource link">';
        entry += '<input type="button" class="add operation" value="+" onclick="newResource()">';
        entry += '<div><div class="resource-logo-label">Logo:</div><input class="resource-logo typelogo" type="file" name="resource_logo[' + resource_num + ']" id="resource_logo[' + resource_num + ']"></div>';
        $('#community-resources').append(entry);
    }

    function removeResource(index) {
        $('.community-resource').each(function(i) {
            if (i == index) {
                $(this).remove();
            } else {
                var num = 0;
                if (i < index) {
                    num = i;
                }
                if (i > index) {
                    num = i - 1;
                }
                $(this).children('.resource-link').attr('name', 'resource_link[' + num + ']');
                $(this).children('.resource-name').attr('name', 'resource_name[' + num + ']');
                //$(this).children('.resource-logo').attr('name', 'resource_logo[' + num + ']');
                $(this).find('.resource-logo').attr('name', 'resource_logo[' + num + ']');
                $(this).find('.resource-logo').attr('id', 'resource_logo[' + num + ']');
            }
        });
        $('.community-resource .minus').each(function(index) {
            $(this).replaceWith('<input type="button" class="minus operation" value="-" onclick="removeResource(' + index + ')">');
        });
    }
</script>

<script type="text/javascript">
    function PepReg($content) {
        var self = this;
        this.$content = $content;
        //this.initContent();
        this.formdata = '';
        this.courses_drop = new Array();
        $('.coursesdropdata').each(function(){
            var course_option = {"id": $(this).attr('cid'), "number": $(this).attr('cnumber'), "name": $(this).html()};
            self.courses_drop.push(course_option);
        });
    }

    PepReg.prototype.addTraining = function () {
        var self = this;
        var community_data = '';
        var steps = this.initForm(community_data, function (data) {          
            //submit
            if (einfo = self.validateAllPage(data)) {
                self.warning(einfo.error[1], self.dlgForm);
                self.steps.switchTo(einfo.id);
                return;
            }
            console.log("jsondata: ",data);
            self.createFormdata(data);
            /*
            $.post("${reverse('community_edit_process_new')}", data, function (r) {
                if (r.success) {
                    $("#dlg-add-training").hide();
                    $(".lean-overlay").hide();
                    //self.reloadTable();
                    console.log("return ok");
                }
            });
            */
            $.ajax({
                url: "${reverse('community_edit_process_new')}",  //server script to process data
                type: 'POST',
                //Ajax event
                success: function(r){
                    console.log("ok");
                    //$("#dlg-add-training").hide();
                    //$(".lean-overlay").hide();
                    window.location.href = "/newcommunities";
                },
                error: function(r){},
                // Form data
                data: self.formdata,
                //Options to tell JQuery not to process data or worry about content-type
                cache: false,
                contentType: false,
                processData: false
            });
            console.log("ajax end");
        });
        return false;
    };

    PepReg.prototype.editTraining = function (id) {
        var self = this;
        $.post("${reverse('get_edit_community')}", {id: id}, function (d) {
            
            self.initForm(d, function (data) {
                if (einfo = self.validateAllPage(data)) {
                    self.warning(einfo.error[1], self.dlgForm);
                    self.steps.switchTo(einfo.id);
                    return;
                } 
                console.log("jsondata: ",data);
                self.createFormdata(data);
                
                $.ajax({
                    url: "${reverse('community_edit_process_new')}",  //server script to process data
                    type: 'POST',
                    //Ajax event
                    success: function(r){
                        console.log("ok");
                        //$("#dlg-add-training").hide();
                        //$(".lean-overlay").hide();
                        window.location.href = "${reverse('maincommunity', args=[community_id])}";
                    },
                    error: function(r){},
                    // Form data
                    data: self.formdata,
                    //Options to tell JQuery not to process data or worry about content-type
                    cache: false,
                    contentType: false,
                    processData: false
                });
                console.log("ajax end");
            });
        });
    };

    PepReg.prototype.initForm = function (data, finishCallback) {
        var self = this;
        var dlg = this.dlgForm = new Dialog($("#dlg-add-training"));
        dlg.show();
        var steps = this.steps = new StepsForm($("#dlg-add-training"),
                ["#A6CE69", "#8CBE41", "#5FC4ED", "#38B6E9", "#F6B262"]); //"#F18200"
        // ************* add dlg close button to each step
        $("#dlg-add-training").find(".close-modal").remove();
        $("<div class='close-modal'>✕</div>").appendTo($("#dlg-add-training").find(".step-content:eq(0)")).click(function () {//style='right:-50px;'
            dlg.hide();
        });

        $('.community-error-box').removeClass('community-error-box');
        // ************* before switch to another page
        steps.onBeforeSwitch = function (curr, dest) {
            var $content = this.getContent(curr);
            
            var data = self.getInput();
            console.log("initForm getInput: ", data);
            if (!this.visited(dest) && (error = self.validatePage(curr, data))) {
                return self.warning(error[1], self.dlgForm);
            }
            //akogan
            if ( dest > -1 ){
                $(".step-page .close-modal").remove();
                $("<div class='close-modal'>✕</div>").appendTo($("#dlg-add-training").find(".step-content:eq(" + dest + ")")).click(function () {
                    dlg.hide();
                });
            }
            return dest == 0 || this.visited(dest - 1) || self.warning("Please finish the previous pages before switch to that page", self.dlgForm); // return true if ready to switch
        };
        // ************* when finish form
        steps.onFinish = function () {
            console.log("finish==============");
            finishCallback && finishCallback(self.getInput());
        };
        // ************* unlock all pages when editing
        if (data) {
            console.log("edit--");
            steps.unlockAll();
            self.fillData(data);
        } else {
            console.log("new--");
            self.clearData();
        }
         

        // ************* btn upload Picture
        $("#edit_photo").click(function(){
            self.upload_picture("", self.dlgForm);
        });
        

        // ************* input facilitators
        $(".btn-add-facilitator").unbind("click").bind("click", function () {
            var email = $("#complete-email").find("option:selected").text();
            var user_id = $("#complete-email").val();
            self.addFacilitator(email);
        });

        // ************* remove loaded facilitators
        /*
        $(".icon-remove").unbind("click").bind("click", function (e) {
            e.preventDefault();
            $(this).parent().parent().remove();
        });
        */
        $('#community-logo .remove').click(function() {
            var content = '<span>Logo </span><span class="about-field" style="color:#999 !important;font-size:80% !important;">(380px X 260px or larger for best results)</span>:</br><span class="edit-name" id="edit_photo" style="cursor:pointer;color:#1d9dd9 !important;">Select Picture</span><input type="hidden" name="logo" id="logo">';
            //$('#community-logo').replaceWith(content);
            $('#community-logo').html(content);
            $("#edit_photo").click(function(){
                self.upload_picture("", self.dlgForm);
            });
        });

        $('.community-resource .remove').click(function() {
            var name = $(this).siblings('.community-resource-logo').attr('name');
            var content = '<input class="resource-logo typelogo" type="file" name="' + name + '" id="' + name + '">';
            $(this).parent('.community-resource-logo-wrap').replaceWith(content);
        });
        return steps;
    };

    PepReg.prototype.repeatFacilitator = function () {
        var ar = [];       
        $("#community_facilitators_list").find("tr").each(function () {
            var email = $(this).find("td").eq(2).text();
            ar.push(email);
        });
        return ar;
    };

    PepReg.prototype.addFacilitator = function (email) {
        if(email){
            var curr = this.repeatFacilitator();
            if(curr.indexOf(email) < 0){
                var tmp_tr = $("<tr><td><a class='icon icon-remove'></a></td></tr>");
                var data_have = $("#community_facilitators_list").find("tr").html();
                if(!data_have){
                    var tmp_td1 = $("<td style='padding-left:15px;'><input name='default' type='radio' value='' checked='checked'/></td>");
                    var tmp_td3 = $("<td style='padding-left:30px;'><input name='edit' type='checkbox' value='' checked='checked'/></td>");
                    var tmp_td4 = $("<td style='padding-left:40px;'><input name='delete' type='checkbox' value='' checked='checked'/></td>");
                }
                else{
                    var tmp_td1 = $("<td style='padding-left:15px;'><input name='default' type='radio' value='' /></td>");
                    var tmp_td3 = $("<td style='padding-left:30px;'><input name='edit' type='checkbox' value='' /></td>");
                    var tmp_td4 = $("<td style='padding-left:40px;'><input name='delete' type='checkbox' value='' /></td>");
                }
                var tmp_td2 = $("<td>" + email + "</td>");
                tmp_tr.append(tmp_td1).append(tmp_td2).append(tmp_td3).append(tmp_td4);
                $("#community_facilitators_list").append(tmp_tr);

                tmp_tr.find("a").click(function(e){
                    e.preventDefault();
                    $(this).parent().parent().remove();
                });
            }
        }
    }
    PepReg.prototype.getFacilitators = function () {
        var ar = [];       
        $("#community_facilitators_list").find("tr").each(function () {
            var defalut = ($(this).find("input").eq(0).is(":checked")) ? "1" : "0";
            var email = $(this).find("td").eq(2).text();
            var can_edit = ($(this).find("input").eq(1).is(":checked")) ? "1" : "0";
            var can_delete = ($(this).find("input").eq(2).is(":checked")) ? "1" : "0";
            ar.push(email + "::" + defalut + "::" + can_edit + "::" + can_delete);
        });
        return ar;
    };

    PepReg.prototype.getCourses = function () {
        //get courses exclude repeat
        var courses = [];       
        $("#community-courses").find("select").each(function () {
            var course_id = $(this).val();
            if(course_id){
                courses.push(course_id); 
            }
        });
        if(courses){
            var result = [], hash = {};
            for (var i = 0, elem; (elem = courses[i]) != null; i++){
                if (!hash[elem]){
                    result.push(elem);
                    hash[elem] = true;
                }
            }
            courses = result;
        }
        return courses;
    };
    PepReg.prototype.getResource_names = function () {
        var resource_names = [];       
        $("#community-resources").find(".resource-name").each(function () {
            var name = $(this).val();
            resource_names.push(name); 
        });
        return resource_names;
    };

    PepReg.prototype.getResource_links = function () {
        var getResource_links = [];       
        $("#community-resources").find(".resource-link").each(function () {
            var link = $(this).val();
            getResource_links.push(link); 
        });
        return getResource_links;
    };

    PepReg.prototype.getInput = function () {
        var $form = $("#dlg-add-training");
        var json = {
            community_id: '${community_id}',
            name: $form.find("input[name=name]").val(),
            motto: $form.find("input[name=motto]").val(),
            logo: $form.find("input[name=logo]").val(),
            private: ($form.find("input[name=private]").is(":checked")) ? "1" : "0",
            state: $form.find("select[name=state-dropdown]").val(),
            district: $form.find("select[name=district-dropdown]").val(),
            courses: this.getCourses().join(","),
            resource_names: this.getResource_names().join(","),
            resource_links: this.getResource_links().join(","),
            facilitators: this.getFacilitators().join(",")
        };
        return json;
    };
    
    PepReg.prototype.createFormdata = function (data) {
        var self = this;
        var jsondata = data;
        self.formdata = null;
        self.formdata = new FormData();
        for(var k in jsondata){
            self.formdata.append(k, jsondata[k]);
        }
        
        $("#community-resources").find(".typelogo").each(function (i) {
            var id = $(this).attr("id");
            var name = $(this).attr("name");
            var type = $(this).attr("type");
            console.log("id:",id,"  name:",name,"  type:",type);
            
            if(type == 'file'){
                var fileObj = document.getElementById(id).files[0];
                if(fileObj){
                    self.formdata.append(name, fileObj);
                } 
                else{
                    self.formdata.append(name, '');
                }
            }
            else{
                self.formdata.append(name, $(this).val());
            }
        });
    };

    PepReg.prototype.fillData = function (data) {
        var self = this;
        data = data || {};
        var $form = $("#dlg-add-training");
        //------------step1------------
        //name
        $form.find("input[name=name]").val(data.name);
        //motto
        $form.find("input[name=motto]").val(data.motto);
        //logo
        var logo_html = '';
        if(data.logo){
            logo_html = '<span style="display:block;margin-bottom:2px;">Logo: </span>';
            logo_html += '<img class="community-logo-thumb" src="' + data.logo + '"><input type="hidden" name="logo" value="' + data.logo + '">';
            logo_html += '<a href="#" class="remove"></a>';
        }
        else{
            logo_html = '<span class="about-field" style="color:#999 !important;font-size:80% !important;">(380px X 260px or larger for best results)</span>:</br>';
            logo_html += '<span class="edit-name" id="edit_photo" style="cursor:pointer;color:#1d9dd9 !important;">Select Picture</span>';
            logo_html += '<input type="hidden" name="logo" id="logo">';
        }
        $("#community-logo").html(logo_html);
        //private group
        if(data.private){
            $form.find("input[name=private]").prop('checked', true);
        }
        else{
            $form.find("input[name=private]").prop('checked', false);
        }

        //------------step2------------
        //state
        if(data.state){
            $("#state-dropdown option[value='" + data.state + "']").attr("selected" ,true);
            if(data.district){
                $("#state-dropdown").trigger('change',data.district);
            }
            else{
                $("#state-dropdown").trigger('change','');
            }
        }
        else{
            //$("#state-dropdown option[value='']").attr("selected" ,true);
        }

        //------------step3------------
        //courses
        var courses_html = '';
        for(var i=0;i<data.courses.length;i++){
            courses_html += '<div class="community-course">'
            courses_html += '<select name="course[' + i + ']">';
            courses_html += '<option value="">Select a Course</option>';
            for(var j=0;j<this.courses_drop.length;j++){
                if(this.courses_drop[j].id == data.courses[i]){
                   courses_html += '<option value="'+this.courses_drop[j].id+'" selected="selected">'+this.courses_drop[j].number+' | '+this.courses_drop[j].name+'</option>';   
                }
                else{
                    courses_html += '<option value="'+this.courses_drop[j].id+'">'+this.courses_drop[j].number+' | '+this.courses_drop[j].name+'</option>';   
                }
            }
            courses_html += '</select>';
            courses_html += '<input type="button" class="add operation" value="+" onclick="newCourse()">';
            courses_html += '</div>'
        }
        $("#community-courses").html(courses_html);

        //------------step4------------
        //resources
        var r_html = '';
        for(var i=0;i<data.resources.length;i++){
            r_html += '<div class="community-resource">';
            r_html += '<input class="resource-name" type="text" name="resource_name['+i+']" value="'+data.resources[i].name+'" placeholder="Resource name">';
            r_html += '<input class="resource-link" type="text" name="resource_link['+i+']" value="'+data.resources[i].link+'" placeholder="Resource link">';
            r_html += '<input type="button" class="add operation" value="+" onclick="newResource()"/>';
            r_html += '<div>';
            r_html += '<div class="resource-logo-label">Logo:</div>';
            if(data.resources[i].logo){
                r_html += '<div class="community-resource-logo-wrap" style="position:relative;">';
                r_html += '<img src="'+data.resources[i].logo+'" class="community-resource-logo-thumb">';
                r_html += '<input class="community-resource-logo typelogo" type="hidden" name="resource_logo['+i+']" value="'+data.resources[i].logo_id+'" id="resource_logo['+i+']">';
                r_html += '<a href="#" class="remove"></a>'; 
                r_html += '</div>';
            }
            else{
               r_html += '<input class="resource-logo typelogo" type="file" name="resource_logo['+i+']" id="resource_logo['+i+']">'; 
            }
            r_html += '</div>';
            r_html += '</div>';
        }
        $("#community-resources").html(r_html);
        
        //------------step5------------
        //facilitators
        $("#community_facilitators_list").html("");
        for(var i=0;i<data.facilitators.length;i++){
            var tmp_tr = $("<tr><td><a class='icon icon-remove'></a></td></tr>");
            var tmp_td1, tmp_td3, tmp_td4 = '';
            if(data.facilitators[i].default){
                tmp_td1 = $("<td style='padding-left:15px;'><input name='default' type='radio' value='' checked='checked'/></td>");
            }
            else{
                tmp_td1 = $("<td style='padding-left:15px;'><input name='default' type='radio' value=''/></td>");
            }

            if(data.facilitators[i].edit){
                tmp_td3 = $("<td style='padding-left:30px;'><input name='edit' type='checkbox' value='' checked='checked'/></td>");
            }
            else{
                tmp_td3 = $("<td style='padding-left:30px;'><input name='edit' type='checkbox' value=''/></td>");
            }

            if(data.facilitators[i].delete){
                tmp_td4 = $("<td style='padding-left:40px;'><input name='delete' type='checkbox' value='' checked='checked'/></td>");
            }
            else{
                tmp_td4 = $("<td style='padding-left:40px;'><input name='delete' type='checkbox' value=''/></td>");
            }
            var tmp_td2 = $("<td>" + data.facilitators[i].email + "</td>");
            tmp_tr.append(tmp_td1).append(tmp_td2).append(tmp_td3).append(tmp_td4);
            $("#community_facilitators_list").append(tmp_tr);

            tmp_tr.find("a").click(function(e){
                e.preventDefault();
                $(this).parent().parent().remove();
            });
        }
    };

    PepReg.prototype.clearData = function () {
        var empty = {'name': '', 
                     'motto': '', 
                     'logo': '', 
                     'private': false, 
                     'state': '', 
                     'district': '',
                     'courses': [''],
                     'resources': [{'name': '', 'link': '', 'logo': ''}],
                     'facilitators': []};
        this.fillData(empty);
    };

    PepReg.prototype.validatePage = function (page, data) {
        $('.community-error-box').removeClass('community-error-box');
        
        if (page == 0) {
            if (!data.name) {
                $('#community-name input').addClass('community-error-box');
                return ["name", "Community Name is required."];
            }
            else if(!/[A-Za-z]/.test(data.name)){
                $('#community-name input').addClass('community-error-box');
                return ["name", "Community Name format wrong."];
            }
        }
        else if (page == 1) {
        } 
        else if (page == 2) {
        } 
        else if (page == 3) {
        }  
        else if(page == 4){
            var facilitator = $("#community_facilitators_list").find("tr").html();
            if(!facilitator){
               return ["facilitator", "You must add at least one facilitator."];
            }
            else{
                var facilitators_info = this.getFacilitators();
                var default_sum = 0;
                var edit_sum = 0;
                for(var i=0;i<facilitators_info.length;i++){
                    var check_info = facilitators_info[i].split("::");
                    var default_f = parseInt(check_info[1]);
                    var can_edit = parseInt(check_info[2]);
                    default_sum += default_f;
                    edit_sum += can_edit;
                }
                if(default_sum == 0){
                    return ["facilitator", "Community need a default facilitator."];
                }
                else if(edit_sum == 0){
                    return ["facilitator", "At least one facilitator need edit privilege."];
                }
            }
        }
    };

    PepReg.prototype.validateAllPage = function (data) {
        var self = this;
        var r = null;
        $("#dlg-add-training").find(".step-page").each(function (i) {
            if (error = self.validatePage(i, data)) {
                r = {id: i, error: error};
            }
        });
        return r;
    };

    PepReg.prototype.warning = function (s, dlgFlyOn) {
        var self = this;
        if (dlgFlyOn){
            dlgFlyOn.hideOverlay();
        }
        var dlg = new Dialog($("#dlg-warning"));
        if(s && s.indexOf("Thank you")===0){
            dailogTitle = "Confirmation";
        }else{
            dailogTitle = "Warning";
        }
        dlg.show(dailogTitle, s);
        dlg.lift(100);
        $("#dlg-warning").bind("hide", function () {
            $(this).unbind('hide');
            if (dlgFlyOn){
                dlgFlyOn.showOverlay();
            }
        });
    };

    PepReg.prototype.upload_picture = function (s, dlgFlyOn) {
        $(".lean-overlay").remove();
        var self = this;
        if (dlgFlyOn){
            dlgFlyOn.hideOverlay();
        }
        var dlg = new Dialog($("#dlg-upload_picture"));
        dailogTitle = "Add Profile Picture";
        dlg.show(dailogTitle, s);
        dlg.lift(100);
        $("#dlg-upload_picture").bind("hide", function () {
            $(this).unbind('hide');
            if (dlgFlyOn){
                dlgFlyOn.showOverlay();
            }
        });
    };

    $("#up-btn-ok").click(function(){
        $("#dlg-upload_picture").hide();
        $(".lean-overlay").remove();
    });

    $(document).ready(function () {
        //** init controller
        //window.pepreg = new PepReg($(".expand_div").eq(0));
        window.pepreg = new PepReg();

        var state_id = ${state_id};
        var district_id = ${district_id};
        $.get('${reverse('pepper_utilities_drop_states')}', function (data) {
            // Build the options.
            var options = '<option value=""></option>';
            $.each(data, function (index, object) {
                options += '<option value="' + object.id+ '"';
                if (object.id == state_id) {
                    options += ' selected';
                }
                options += '>' + object.name + '</option>';
            });
            // Add them to the state dropdown.
            $('#state-dropdown').append(options);

            $("#state-dropdown").change(function (e,d_id) {
                if ($(this).val()) {
                    // Clear the current district and school options since the state changed.
                    $('#district-dropdown option').remove();
                    // Get the allowed Districts
                    $.get('${reverse('pepper_utilities_drop_districts')}', {state: $(this).val()}, function (data) {
                        var content = '<option value=""></option>';
                        $.each(data, function (index, object) {
                            content += '<option value="' + object.id + '"';
                            if(d_id){
                               if (object.id == d_id) {
                                    content += ' selected';
                                } 
                            }
                            else{
                                if (object.id == district_id) {
                                    content += ' selected';
                                }
                            }
                            
                            content += '>' + object.name + '</option>';
                        });
                        // Add it to the form.
                        $('#district-dropdown').append(content);
                    });
                }
                else{
                    $('#district-dropdown').html('<option value=""></option>');
                }
            });
            if (state_id) {
                $("#state-dropdown").trigger('change');
            }
        });


        //** init expand title
        /*
        $(".expand_title").next("div.expand_div").slideDown(); //akogan
        //$(".expand_title").off("click").bind("click", function () {
        $(".expand_title").on("click", function () {
            if ($(".expand_div").is(':visible')) {
                $(".expand_div").slideUp();
                $(this).removeClass("expand_title_expanded");
            } else {
                $(".expand_div").slideDown();
                $(this).addClass("expand_title_expanded");
            }
        });
        */
        // $(".expand_title").click();
        /*
        $(".print-map").click(function (e) {
            e.preventDefault();
            return false;
        });
        */
    });
</script>
