<%! from django.utils.translation import ugettext as _ %>
<%!
    from django.core.urlresolvers import reverse
    from courseware.courses import course_image_url, get_course_about_section
    from courseware.access import has_access
    from certificates.models import CertificateStatuses
    from xmodule.modulestore import MONGO_MODULESTORE_TYPE
    from xmodule.modulestore.django import modulestore
    from django.utils import timezone
    from student.models import School,Cohort,District,SubjectArea,GradeLevel,YearsInEducation
    from baseinfo.models import Enum
    import datetime
%>
<!--@begin:Hide Dashboard button in this page-->
<!--@date:2013-11-02-->
<style type="text/css" media="screen">
#image_uploading{display:none;}
/*--from .css-----------------------------------------------------------------*/
.dashboard .dashboard-post{
    display: block;
    float: left;
    width:660px;
    min-width: 610px;
    height: 800px;
    margin-top: 5px;
    margin-left: 8px;
    
    overflow-y:scroll;

}
#searching-text{
    border:0;
    height:25px;
    width: 255px;
    margin-left: 5px;
    outline: none;

    color:#818181;
    font-size: 15px;
    font-family: "Arial" !important;
    font-style:italic;
}
.post_content{
    background-color: #f2f2f2;
    border:2px solid #41719c;
    padding:5px 10px 10px 10px;
    border-bottom-left-radius: 18px;
    border-bottom-right-radius: 18px;
    border-top-left-radius: 18px;
    border-top-right-radius: 18px;
    margin-bottom:0px;
}

a.post_btn{
    font-family: 'Open Sans',Verdana,Geneva,sans-serif;
    color:#fff !important;;
    font-size:13px !important;
    background-color:#5b9bd5;
    border:2px solid #41719c;
    /*box-shadow: inset 0 1px 0 0 #61b8e1;*/
    text-decoration: none;
    padding:0px 23px 0px 23px;
    border-bottom-left-radius: 5px;
    border-bottom-right-radius: 5px;
    border-top-left-radius: 5px;
    border-top-right-radius: 5px;
    cursor: pointer;
}
a.post_btn:hover{
    text-decoration: none;
    background-color:#72ace1;
}
.ds-post-title{
    padding:5px 5px 5px 10px;
    border:0px solid #f00;
}
/*85px fixed*/
.ds-post-title-photo{
    width: 85px;
    position: relative;
    border:0px solid;
}
/*520px modified*/
.ds-post-title-text{
    padding:5px 5px 5px 5px;
    width: 520px;

    border:0px solid;
}
/*20px fixed*/
.ds-post-title-delete{
    text-align: center;
    width: 20px;
    border:0px solid;
}

.ds-post-title-name{
    color:#5c9cd5;
    font-size:14px;
    font-weight:bold;
}
.ds-post-title-from{
    color: #8d8d8d;
    font-size:14px;
}
.ds-post-title-position{
    color:#ff6600;
    font-size:14px;
    font-weight:bold;
}
.ds-post-title-time{
    color: #8d8d8d;
    font-size:13px;
    font-style: italic;
}
.ds-post-content{
    /*width:100%;*/
    color: #404040;
    font-weight: bold;
    padding:5px 5px 5px 5px;
    font-size: 15px;
    line-height: 22px;
    border:0px solid; 
}
.ds-post-footer{
    border-bottom: 0px solid #3891e0;
}

.ds-post-end_line{
    width: 100%;
    border-bottom: 2px solid #3891e0;
    margin-bottom: 15px;
}


/*--left My Courses--------------------------------------------*/
.con-my-courses{
    display:block;
    float:left;
    width:220px;
    /*position: fixed;*/
}
/*
.con-my-courses-placeholder{
    display:block;
    float:left;
    width:220px;
    height:50px;
}
*/
.my-title{
    width:215px;
    text-align:center;
}
.my-title a{
    font-size:16px;
    color:#3C4646;
    text-decoration:none;
    cursor:pointer;
    font-weight:bold;
}
.my-courses-cards{
    margin-top: 10px;
    float: left;
    width: 220px;
}
.my-courses-cards .course-card{
    background-color: #FFFFFF;
    border-radius: 6px;
    -moz-border-radius: 6px;
    -webkit-border-radius: 6px;
    /*box-shadow: 3px 3px 7px 0px rgba(0,0,0,0.1);*/
    float: left;
    width: 215px;
    height:134px;
    position: relative;
    cursor: auto!important;
    text-align: center;
}
.my-courses-cards .card-top{
    position: relative;
}
.my-courses-cards .image-style{
    border-radius: 6px;
    -moz-border-radius: 6px;
    -webkit-border-radius: 6px;
    display: block;
    width:215px;
    height:134px;

}
.my-courses-cards .course-title {
    display: table;
    position: absolute;
    bottom: 0;
}
.my-courses-cards .card-link{
    display: table-cell;
    width: 215px;
    height: 54px;
    vertical-align: middle;
    padding: 0 17px;
    background: rgba(18,111,154,0.95);
    text-decoration: none!important;
    border-radius: 0px 0px 6px 6px;
    -moz-border-radius: 0px 0px 6px 6px;
    -webkit-border-radius: 0px 0px 6px 6px;
}
.my-courses-cards .card-link span{
    color:#fff;
    font-size: 13px;
}
.ds-course-btn{
    float:left;
    line-height:27px;
    height:28px;
    margin-top:3px;
    margin-bottom: 25px;
}
.ds-course-btn .ds-btn-view-portfolio{
    color: #fff;
    text-decoration: none!important;
    font-size:13px;

    padding:5px 13px 5px 13px;
    border-radius: 2px;
    background-color:#556370;
}
.ds-course-btn .ds-btn-view-course{
     color: #fff;
    text-decoration: none!important;
    font-size:13px;

    padding:5px 13px 5px 13px;
    border-radius: 2px;
    background-color:#4ecdc4;
    margin-left: 1px;
}
.ds-view-all-courses{
    width:215px;
    text-align:right;
    float: left;
    margin-top:-10px;
}
.ds-view-all-courses a{
    font-size: 16px;
    color: #0070d5;
    text-decoration: none !important;
    cursor: pointer;
}

.ds-my-status{
    width:185px;
    font-size: 13px;
    border-radius: 6px;
    margin-top: 20px;
    margin-bottom: 20px;
    padding: 15px 15px 15px 15px;
    float: left;
    border:1px solid #666;
}
/*--right My Communities---------------------------------------------*/
.con-my-communities{
    display:block;
    float:right;
    width:220px;
}
.my-communities-cards{
    margin-top: 10px;
    float: left;
    width: 220px;
}
.my-communities-cards .image-link-style {
    border-radius: 6px;
    -moz-border-radius: 6px;
    -webkit-border-radius: 6px;
    display: block;
    float: left;
    width:215px;
    height:134px;
    background-size: auto 80px;
    background-color: white;
    background-position: 50% 0;
    background-repeat: no-repeat;
    text-align: center;
    margin-bottom: 25px;
}
.my-communities-cards .image-bottom-style {
    border-radius: 0 0 6px 6px;
    -moz-border-radius: 0 0 6px 6px;
    -webkit-border-radius: 0 0 6px 6px;
    display: block;
}
.my-communities-cards .card-link {
    display: table-cell;
    width: 215px;
    height: 54px;
    vertical-align: middle;
    padding: 0 17px;
    background: rgba(18,111,154,0.95);
    text-decoration: none !important;
}
.my-communities-cards .card-link span {
    color: #FFFFFF;
    font-size: 13px;
}
.ds-view-all-communities{
    width:215px;
    text-align:right;
    float: left;
    margin-top:-10px;
    margin-bottom: 20px;
}
.ds-view-all-communities a{
    font-size: 16px;
    color: #0070d5;
    text-decoration: none !important;
    cursor: pointer;
}
/*--middle Main Content All-----------------------------------*/
.con-maincontent-all{
    width:680px;
    margin-left:27px;
    float:left;
    margin-bottom:20px;
    background-color:#e4e4e4;
    border-top:3px solid #fff;
    border-left:3px solid #fff;
    border-right:3px solid #fff;
}
.con-feed-activity{
    width:680px;
    height:50px;
    float:left;
    background-color:#e4e4e4;
    border:0px solid #000;
}
.my-feed-btn{
    width:130px;
    height:30px;
    padding-top:15px;

    margin-left: 7px;
    margin-top:3px;
    float:left;
    text-align:center;
    font-weight:bold;
    color:#0b0bdd;
    cursor: pointer;
    font-size:18px;
}
.my-activity-btn{
    width:130px;
    height:30px;
    padding-top:15px;

    margin-top:3px;
    float:left;
    text-align:center;
    font-weight:bold;
    color:#0b0bdd;
    cursor: pointer;
    font-size:18px;
}
.mytab-active{
    background-color:#fff;
    border-left:2px solid #cbcbcb;
    border-top:2px solid #cbcbcb;
    border-right:2px solid #cbcbcb;
    border-radius:5px 5px 0px 0px; 
    cursor: auto !important;
}
.my-feed{
    width:674px;
    float:left;
    border-top:3px solid #d9d9d9;
    border-left:3px solid #d9d9d9;
    border-right:3px solid #d9d9d9;
    border-radius: 6px 6px 0px 0px; 
    display: none;
}
.my-activity{
    width:674px;
    /*height:800px;*/

    float:left;
    border-top:3px solid #d9d9d9;
    border-left:3px solid #d9d9d9;
    border-right:3px solid #d9d9d9;
    border-bottom:3px solid #d9d9d9;
    border-radius: 6px 6px 6px 6px; 
    background-color: #fff;
}
/*----middle Main Content:My Activity----*/
.con-ma-filter{
    width:659px;
    height:30px;
    text-align: right;
    padding-top:8px;
    padding-right:15px;
    padding-bottom:3px;

    border:0px solid;
}
.con-ma-filter select{
    margin-right: 10px;
} 
.ma-btn-filter{
    padding:10px;background-color: #556370;
    padding-bottom: 2px !important;
    padding-left: 10px;
    padding-right: 10px;
    padding-top: 2px !important;color:#fff;
    cursor: pointer;
}
.con-ma-rows{
}
.my-activity-row{
    width:674px;
    min-height:75px;
    border:0px solid;
}
.ma-row-ico{
    width:112px;
    height:69px;
    margin-left:10px;
    float:left;
    text-align:right;
}
.ma-row-cotent{
    width:540px;
    min-height:69px;
    margin-left:5px;
    float:left;
    border-radius:5px;
    font-size: 14px;
    border:1px solid #ccc;
}
.ma-row-cotent-time{
    margin-top: 9px;
    padding: 5px;
    font-style: italic;
    border:0px solid;
}
.ma-row-cotent-info{
    padding: 5px;
    border:0px solid;
    margin-bottom: 9px;
}
.ma-row-cotent-info a{
    color: #000;
    cursor: pointer;
    text-decoration: none !important;
    font-weight: bold;
    font-style: italic;
}
/*--my activity community ico--*/
.ma-community-ico{
    width: 110px;
    height: 69px;
    border: 1px solid #ccc;
    border-radius: 3px;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
}
.ma-community-image-link-style {
    border-radius: 3px;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    display: block;
    float: left;
    width:110px;
    height:69px;
    background-size: auto 41px;
    background-color: white;
    background-position: 50% 0;
    background-repeat: no-repeat;
    text-align: center;
}
.ma-community-image-bottom-style {
    border-radius: 0 0 3px 3px;
    -moz-border-radius: 0 0 3px 3px;
    -webkit-border-radius: 0 0 3px 3px;
    display: block;
}
.ma-community-card-link {
    display: block;
    width: 100px;
    height: 18px;
    vertical-align: middle;
    background: rgba(18,111,154,0.95);
    text-decoration: none !important;
    color: #FFFFFF;
    font-size: 9px;
    cursor: default;
    padding: 5px;

    text-overflow:ellipsis;
    white-space:nowrap;
    overflow:hidden;
}


/*--my activity course ico--*/
.ma-course-course-card{
    background-color: #FFFFFF;
    border-radius: 3px;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    float: left;
    width: 110px;
    height:69px;
    position: relative;
    cursor: auto!important;
    text-align: center;
    border: 1px solid #ccc;
}
.ma-course-card-top{
    position: relative;
}
.ma-course-image-style{
    border-radius: 3px;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    display: block;
    width:110px;
    height:69px;

}
.ma-course-course-title {
    display: table;
    position: absolute;
    bottom: 0;
}
.ma-course-card-link{
    display: table-cell;
    width: 110px;
    height: 28px;
    vertical-align: middle;
    padding: 0 17px;
    background: rgba(18,111,154,0.95);
    text-decoration: none!important;
    border-radius: 0px 0px 3px 3px;
    -moz-border-radius: 0px 0px 3px 3px;
    -webkit-border-radius: 0px 0px 3px 3px;
}
.ma-course-card-link span{
    color:#fff;
    font-size: 9px;
}
</style>
<!--@end-->
<%inherit file="main_new.html" />
<%namespace name='static' file='static_content.html'/>
<%block name="title"><title>${_("Dashboard - {username}".format(username=curr_user.username))}</title></%block>

<!--@date:20161222-->
<script type="text/javascript" src="/static/js/admin_ui_controls.js"></script>
<link rel="stylesheet" type="text/css" href="/static/css/dashboard-new-temp.css" />
<!--@end-->
<script src="/static/js/datetime/moment.js"></script>

<section class="content-wrapper1" style="margin-top:0px;background-color:#eee;">
    <section class="container dashboard" style="margin-top:10px;">
        <!--width 220 + 40 + 660 + 40 + 220 = 1180-->
        <!--Courses Dashboard-->
        <div class="con-my-courses">
            <div class="my-title">
                <a href="/courses">My Course & Workshops</a>
            </div>
            <div class="my-courses-cards">
                %for i,course in enumerate(courses_incomplated):
                    <%
                        course_target = reverse('courseware', args=[course.id])
                    %>
                    <div class="course-card">
                        <div>
                            <img typeof="foaf:Image" class="image-style" src="${course_image_url(course)}" alt="${course.display_number_with_default | h} ${get_course_about_section(course, 'title')} Cover Image">
                        </div>
                        <div class="course-title">
                            <a href="${reverse('cabout', args=[course.id])}" class="card-link" title="${get_course_about_section(course, 'title')}"><span>${get_course_about_section(course, 'title')}</span></a>
                        </div>  
                    </div>
                    <div class="ds-course-btn">
                        %if course.id in show_courseware_links_for:
                            %if curr_user == request.user:              
                                <a href="${reverse('portfolio_about_me',args=[course.id])}" class="ds-btn-view-portfolio">${_('View Portfolio')}</a>
                            %else:
                                <a href="javascript:void(0)" class="ds-btn-view-portfolio" link="${reverse('portfolio_about_me',args=[course.id,curr_user.id])}">${_('View Portfolio')}</a>
                            %endif
                            %if curr_user == request.user and not course.close_course:      
                                <a href="${course_target}" class="ds-btn-view-course">${_('View Course')}</a>
                            %endif
                        %endif
                    </div>
                %endfor
            </div>
            <div class="ds-view-all-courses">
                <a href="/my_courses">View All</a>
            </div>
            <div class="ds-my-status">
                <b>My Pepper Achievements Status</b>
                </br>
                <b>All Course Time:310 Minutes</b>
                </br>
                <b>Collaboration Time:87 Minutes</b>
                </br>
                <b>Total Time:397 Minutes</b>
                </br>
                </br>
                <span>Cetificates</span>
                </br>
                Pep101x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SCI141E
                </br>
                EDU506
            </div>
        </div>
        <!--<div class="con-my-courses-placeholder"></div>-->

        <div class="con-maincontent-all">
            <div class="con-feed-activity">
                <div class="my-feed-btn mytab-active">My Feed</div>
                <div class="my-activity-btn" style="">My Activity</div>
            </div>
            <div id="my_feed" class="my-feed">
                <!--Post Dashboard-->
                <!--w:660,min-h:800-->
                <div id="dashboard_content_posts" class="dashboard-post">
                    <div id="post_content" class="post_content" style="margin-bottom:0px;">
                        <table id="" width="100%" border="0" style="margin-bottom:10px;background-color:#f2f2f2;">
                            <tr class=".post-submit-row" id="post_submit_row">
                                <td width="60"><img src="${reverse('user_photo',args=[request.user.id])}" class="post-submit-profile-image"/></td>
                                <td style="color:#818181;font-size:15px;">
                                    <textarea id="new_post_textarea" class="new-post-textarea" placeholder="What's on your mind?"></textarea>
                                </td>
                            </tr>
                        </table>
                        <table width="100%" border="0">
                            <tr>
                                <td width="50" align="right">
                                    <a href = "#" style="color:#06e !important;" id = "add_post_image">
                                        <img src="static/images/newdashboard/add-a-document-button_318-25290.jpg" width="25" height="25"/>
                                    </a>
                                </td>
                                <td style="padding-left:10px;color:#818181;font-size:14px;">Photo/Video/Document</td>
                                <td align="right" style="padding-right:7px;">
                                    <a id="submit_new_post_button" class="post_btn" value="Post">Post</a>
                                </td>
                            </tr>
                            <tr>
                                <td></td>
                                <td>
                                    <table style="display:none;margin-top:5px;" id="add_images_div">
                                        <tr>
                                            <td style="padding-left:9px;padding-right:10px;"><input id="image_link_input" type="text" placeholder="Enter Image Link Here" style="height:25px;font-size:14px;width:160px;"/></td>
                                            <td style="padding-top:2px;"><input id="embed_checkbox" type="checkbox"/></td>
                                            <td style="font-size:14px;">Embed</td>
                                        </tr>
                                    </table>
                                </td>
                                <td></td>
                            </tr>
                        </table>
                    </div>
                    <table style="margin-top:8px;margin-bottom:8px;">
                        <tr>
                            <td class="filter-word-label">Filter:</td>
                            <td>
                                <select id = "post_filter_select">
                                    <option value = 'newest_post'>Newest Posts</option>
                                    <option value = 'oldest_post'>Oldest Posts</option>
                                    <option value = 'latest_reply'>Latest Reply</option>
                                    <option value = 'oldest_reply'>Oldest Reply</option>
                                    <option value = 'alphabetical'>Last Name (A-Z)</option>
                                    <option value = 'reversealpha'>Last Name (Z-A)</option>
                                    <option value = 'alphauname'>Nickname (A-Z)</option>
                                    <option value = 'ralphauname'>Nickname (Z-A)</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                    <!--663+17(scroll-y)=680-->
                    <table id="post_content_table" width="100%" border="0">
                        <tr class="post-content-row" id="post_content_new_row">
                            <td></td><td></td>
                        </tr>
                    </table>
                    <center><img id="posts_loading_image" src="/static/images/posts-loading.gif"></img></center>
                </div>
            </div>

            <!--w:674 = 680-3*2-->
            <div id="my_activity" class="my-activity">
                <div class="con-ma-filter">
                    <select id = "ma_select_year">
                        <option value = ''>year</option>
                        <option value = '2016'>2016</option>
                        <option value = '2017'>2017</option>
                    </select>
                    <select id = "ma_select_month">
                        <option value = ''>month</option>
                        <option value = '1'>1</option>
                        <option value = '2'>2</option>
                        <option value = '3'>3</option>
                        <option value = '4'>4</option>
                        <option value = '5'>5</option>
                        <option value = '6'>6</option>
                        <option value = '7'>7</option>
                        <option value = '8'>8</option>
                        <option value = '9'>9</option>
                        <option value = '10'>10</option>
                        <option value = '11'>11</option>
                        <option value = '12'>12</option>
                    </select>
                    <span class="ma-btn-filter">Filter</span>
                </div>
                <div class="con-ma-rows">
                </div>
            </div>
        </div>
        <!--Community Dashboard-->
        <div class="con-my-communities">
            <div class="my-title">
                <a href="/communities">Coaching & Collaboration</a>
            </div>
            <div class="my-communities-cards">
                %for community in communities:
                    <div class="image-link-style" style="background-image: url('${community['logo']}');">
                        <div style="height:80px;"></div>
                        <a href="${reverse('community_view', args=[community['id']])}" class="card-link image-bottom-style"><span>${community['name']}</span></a>
                    </div>
                %endfor
            </div>
            <div class="ds-view-all-communities" style="">
                <a href="/communities">View All</a>
            </div>
        </div>
        <div style="clear:both;"></div>
    </section>
</section>
<!--@begin:Add for Dashboard Posts-->
<!--@2016-12-29-->
<div style="" id="fixed-dialog-likes" class="modal">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0">
        <div class="titlebar">
            <h3 class="dialog-title"></h3>
            <div class="close-modal" id="dialog_close">✕</div>
        </div>
        <div class="content"></div>
    </div>
</div>
<div id = 'user_info_div' class="user-info-div">
    <span id='user_info' class="user_info_span"></span>
</div>
<!--@end-->

<script>
//@begin:Add for Dashboard Posts
//@date:2016-12-29
var size = 0;
function getPosts(){
    var local_time =  new Date();
    var local_utc_diff_m = -1 * local_time.getTimezoneOffset();
    filter = $("#post_filter_select").val()
    var master_id = "${curr_user.id}";
    $.post("${reverse('dashboard_get_posts')}", {master_id: master_id, size:size, filter:filter, local_utc_diff_m:local_utc_diff_m}, function (data){
        if(data.all =="DONE"){
            $("#posts_loading_image").remove()
        }
        $("#post_content_table").find("tr:gt(0)").remove();
        $('#post_content_table tr:last').after(data.post);

        //control of element produce by views
        //post function
        $(".post-like-text").click(function(){
            $.post("${reverse('dashboard_submit_new_like')}", {post_id: $(this).data('id'), comment_id: '-1', user_id:'${request.user.id}'},function(data){
                getPosts();
            });
        });
        $(".post-comment-text").click(function(){
            id=$(this).data('id');
            if($(this).data('name') != ''){
                $("#focus"+id).val("@"+$(this).data('name')+" ");
            }
            $("#focus"+id).focus();
        });

        $(".comment-reply-text").click(function(){
            id=$(this).data('id');
            if($(this).data('name') != ''){
                $("#focus"+id).val("@"+$(this).data('name')+" ");
            }
            $("#focus"+id).focus();
        });

        $(".delete-something").click(function(){
            if($(this).attr("data-postid")){
                var pid = $(this).data('postid');
                $.post("${reverse('dashboard_delete_post')}", {post_id:pid, master_id:master_id}, function(data){
                    getPosts()
                });
            }
            if($(this).attr("data-commentid")){
                var cid = $(this).data('commentid');
                $.post("${reverse('dashboard_delete_comment')}", {comment_id:cid, master_id:master_id}, function(data){
                    getPosts()
                });
            }
        })
        
        //comment function
        $(".comment-like-text").click(function(){
            $.post("${reverse('dashboard_submit_new_like')}", {comment_id: $(this).data('id'), post_id:'-1', user_id:'${request.user.id}'},function(data){
                getPosts();
            });
        });

        //comment submit(press enter)
        $('.add-comment-text').keyup(function (e) {
            $("#select_name").remove();
            if (e.keyCode === 13) {
                content=$(this).val();
                post_id=$(this).data('id');
                $.post("${reverse('dashboard_submit_new_comment')}", {post_id: post_id, content:content, master_id:master_id}, function(data){
                    getPosts();
                });
            }
            var n = $(this)[0].selectionStart;
            var at = $(this).val().indexOf("@");
            if(at > -1){
                var str = $(this).val().substr(at);
                var x = str.length;
                for(var s = str; s.indexOf("@") >-1; s = s.substr(x)){
                    s = s.substr(1);
                    x = s.indexOf("@");
                    if(x>-1)
                        working = s.substr(0, x).split(' ').slice(0,2).join(' ');
                    else
                        working = s.substr(0).split(' ').slice(0,2).join(' ');
                }
                loc = $(this).val().indexOf(working);
                if(n > loc && n <= working.length+loc) {
                    $.post("${reverse('dashboard_lookup_name')}", {name: working}, function(data){
                        if(data.content.length > 0) {
                            displayOptions(data.content);
                        }
                    });
                }
            }
        });
        
        //show user_info when mouse on photo
        safety = 0;
        $(".hoverable-profile").hover(function(event) {
            safety++;
            $("#user_info").html("<img class='info-tile-img' src='/static/images/name.png' width=16px height=16px></img>"+$(this).data('name')+"<br><img class='info-tile-img' src='/static/images/username.png' width=16px height=16px></img>"+$(this).data('uname')+"<br><img class='info-tile-img' src='/static/images/email.png' width=16px height=16px></img><a href='mailto:"+$(this).data('email')+"'>"+$(this).data('email')+"</a>");
            if ($(this).data("skype") !== undefined){
                $("#user_info").append("<br><img class='info-tile-img' src='/static/images/skype.png' width=16px height=16px></img><a href='skype:"+$(this).data('skype')+"?call'>"+$(this).data('skype')+"</a>")
                $("#user_info").append("<br><img class='info-tile-img' src='/static/images/hangout_icon.png' width=16px height=16px></img><span style='float:right; padding-right:46px;'>"+$('#hangout_span_'+$(this).data("id")).html()+"</span>");
            }
            $("#user_info_div").css({top: $(this).offset().top+20, left: $(this).offset().left}).show();
        }, function() {
            if (!$("#user_info_div").is(":hover") && safety > 1){
                $("#user_info_div").hide();
                safety = 0;
            }
        });
        $("#user_info_div").hover(function(e){}, function(){
            $(this).hide()
        });
        $(".like-members-anchor").click(function(){
            var post = $(this).data('post');
            var comment = $(this).data('comment');
            $.post("${reverse('dashboard_get_full_likes')}", {'post': post, 'comment': comment}, function (data){
                new Dialog($('#fixed-dialog-likes')).show("Likes", "<center>"+data.html+"</center>");
            });
        });
    });
}
//@end

$(document).ready(function(){
    //@begin:Add for Dashboard Posts
    //@date:2016-12-29
    size = 5;

    $("#post_filter_select").change(function(){
        getPosts();
    });
    $("#add_post_image").click(function(e){
        e.preventDefault();
        $("#add_images_div").toggle();
    });
    getPosts(); //start

    //--Post function--------------------------------------------
    //--post button--
    $("#submit_new_post_button").click(function(){
        var post = $("#new_post_textarea").val();
        var master_id = "${curr_user.id}";
        var images = $("#image_link_input").val()
        var include_var = "no"
        if (images != ""){
            include_var = "yes";
        }
        var embed = 0;
        if ($("#embed_checkbox").is(":checked")){
            embed = 1;
        }
        $.post("${reverse('dashboard_submit_new_post')}", {post: post, master_id: master_id, include_images:include_var, embed:embed, images:images }, function (data) {
            $("#new_post_textarea").val("");
            $("#image_link_input").val("");
            getPosts();
        });
    });
    $('#dashboard_content_posts').on('scroll', function() {
        if($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight) {
            size += 5;
            getPosts();
        }
    });
    waiting = false;
    $(window).scroll(function(){
        if(!waiting) {
            var a = $(this).scrollTop();
            var b = $(this).innerHeight();
            var body = document.body, html = document.documentElement;
            var height = Math.max(body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight);
            if (a + b >= height - 150) {
                size += 5;
                waiting = true;
                setTimeout(function(){
                    waiting = false;
                }, 750);
                getPosts();
            }
        }
    });
    //@end

    //20170221=================================================================================================
    now_show = 2; //1:my feed;2:my activity
    
    if(now_show == 1){
        $(".my-activity-btn").removeClass("mytab-active");
        $(".my-activity").hide();
        $(".my-feed-btn").addClass("mytab-active");
        $(".my-feed").show();   
    }
    else{
        $(".my-activity-btn").addClass("mytab-active");
        $(".my-activity").show();
        $(".my-feed-btn").removeClass("mytab-active");
        $(".my-feed").hide();   
    }

    $(".my-feed-btn").click(function(){
        if(now_show == 2){
            $(".my-activity").hide();
            $(".my-activity-btn").removeClass("mytab-active");
            $(".my-feed").show();
            $(".my-feed-btn").addClass("mytab-active");
            now_show = 1;
        }
    });
    $(".my-activity-btn").click(function(){
        if(now_show == 1){
            $(".my-feed").hide();
            $(".my-feed-btn").removeClass("mytab-active");
            $(".my-activity").show();
            $(".my-activity-btn").addClass("mytab-active");
            now_show = 2;
        }
    });
    get_my_activites();

    $(".ma-btn-filter").click(function(){
        console.log("filter_year: ",$("#ma_select_year").val());
        console.log("filter_month: ",$("#ma_select_month").val());
        $(".con-ma-rows").find("div").remove();
        get_my_activites();
    });

    function get_my_activites(){
        filter_year = $("#ma_select_year").val();
        filter_month = $("#ma_select_month").val();

        $.post("${reverse('get_my_activities')}", {'user_id':'${request.user.id}','filter_year':filter_year,'filter_month':filter_month},function(data_obj){
            my_activitis_init(data_obj);
        });
    }
    function my_activitis_init(data_obj){
        for(var i=0;i<data_obj.data.length;i++)
        {
            my_activity_create(data_obj.data[i]);
        }
    }
    function my_activity_create(data){
        var displayDate = time_to_local(data.time);
        my_activity_create_ico(data);
        
        element_html = '<div class="my-activity-row">';
        element_html += '<div class="ma-row-ico">';
        element_html += data.html_ico;
        element_html += '</div>';
        element_html += '<div class="ma-row-cotent">';
        element_html += '<div class="ma-row-cotent-time">'+displayDate+'</div>';
        element_html += '<div class="ma-row-cotent-info">';
        element_html += data.html_text;
        element_html += '</div>';
        element_html += '</div>';

        element=$(element_html);
        $('.con-ma-rows').append(element);
    }
    function my_activity_create_ico(data){
        //switch_ActivityType
        switch(data.a_type)
        {
            case 'Community':
                data.html_ico = '<div class="ma-community-ico">';
                data.html_ico += '<div class="ma-community-image-link-style" style="background-image:url('+data.logo+')">';
                data.html_ico += '<div style="height:41px;"></div>';
                data.html_ico += '<span class="ma-community-card-link ma-community-image-bottom-style">'+data.name+'</span>';
                data.html_ico += '</div>';
                data.html_ico += '</div>';
                my_activity_create_community_text(data);
                break;
            case 'Course':
                console.log("switch courses");
                break;
            default:
                data.html_ico = '<table border="0" width="110" height="69" cellpadding="0" cellspacing="0">';
                data.html_ico += '<tr>';
                data.html_ico += '<td><img src="/static/images/newdashboard/header_my_reports_45.png"></img></td>';
                data.html_ico += '</tr>';
                data.html_ico += '</table>';
                my_activity_create_others_text(data);
        }
    }

    function my_activity_create_community_text(data){
        //switch_EventType
        if(data.e_type==1){
            console.log("11",data.user_name)
            if(data.user_name){
                data.html_text = 'Added users to <a href="'+data.url+'">'+data.name+'</a>:' + data.user_name;
            }
            else{
                data.html_text = 'Joined <a href="'+data.url+'">'+data.name+'</a>';
            }
            
        }
        else if(data.e_type==2){
            data.html_text = 'Posted on <a href="'+data.url+'">'+data.name+'</a>';
        }
        else if(data.e_type==3){
            data.html_text = 'Posted Comment on <a href="'+data.url+'">'+data.name+'</a>';
        }
        else if(data.e_type==4){
            data.html_text = 'Created <a href="'+data.url+'">'+data.name1+'</a>';
        }
        else if(data.e_type==5){
            data.html_text = 'Replied to <a href="'+data.url+'">'+data.name1+'</a>';
        }
    }

    function my_activity_create_others_text(data){
        if(data.e_type=="1"){
            data.html_text = 'others1';
        }
        else if(data.e_type=="2"){
            data.html_text = 'others2';
        }
        else{
            data.html_text = 'others';
        }
     }

    function time_to_local(time){
        var local_time =  new Date();
        var local_utc_diff_m = -1 * local_time.getTimezoneOffset();
        var local_utc_diff_h = local_utc_diff_m / 60;
        displayDate = ""

        if(isToday(time)) {
           displayDate = "Today at " + moment(time).add(local_utc_diff_h,'hours').format('hh:mm A') 
        }
        else{
            displayDate = moment(time).add(local_utc_diff_h,'hours').format('MMM DD, YYYY')
        }
        return displayDate;
    }

    function isToday(str){
        //var d = new Date(str.replace(/-/g,"/"));
        var d = new Date(str);
        var todaysDate = new Date();
        if(d.setHours(0,0,0,0) == todaysDate.setHours(0,0,0,0)){
            return true;
        } 
        else {
            return false;
        }
    }
});
</script>
