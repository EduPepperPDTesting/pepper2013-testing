<%!
    from django.utils.translation import ugettext as _
    from django.utils import html
    from django.core.urlresolvers import reverse
%>
<link rel="stylesheet" type="text/css" href="/static/css/cms.css" />
<div class="inner-wrapper" style="border:0;border-radius:5px;padding:0">
    <div class="titlebar">
        <h3 class="dialog-title">CMS Resource</h3>
        <div class="close-modal" id="cms_close">âœ•</div>
    </div>
    <div class="content">
        <div id = "library_selection">

        </div>
        <hr>
        <div id = "view_type">
            <span id = "tree_view_head">Tree</span>
            <span id = "search_view_head">Search</span>
        </div><br>
        <div id= "popup_views">
            <span id="tree_view">
            </span>
            <span id="search_view">
                Search
            </span>
        </div>
    </div>
</div>

<script>
base = "https://cms-dev.edplancms.com/api/v1/";
working_lib = 0;

$("#tree_view_head").css("background-color", "lightgray");
$("#tree_view_head").click(function() {
    $("#search_view").hide();
    $("#tree_view").show();
    $(this).css("background-color", "lightgray");
    $("#search_view_head").css("background-color", "white");
});

$("#search_view_head").click(function() {
    $("#tree_view").hide();
    $("#search_view").show()
    $(this).css("background-color", "lightgray");
    $("#tree_view_head").css("background-color", "white");
});

function librariesSelector() {
    user = callAPI("users", {"email":"${request.user.email}"});
    orgs = user[0].orgs;
    org_list = "1870,";
    for (var i = 0; i < orgs.length; i++) {
        org_list += orgs[i] + ",";
    }
    org_list = org_list.slice(0,-1);
    libraries = callAPI("libraries/"+org_list, "");
    html = "";
    for (var i = 0; i < libraries.length; i++) {
        lib = libraries[i];
        html += "<img src='" + lib.image_url + "' class='lib-image' id='" + lib.id + "'></img>";
    }
    $("#library_selection").html(html);
    $(".lib-image").click(function() {
        loadLibrary ($(this).attr("id"));
    });
    return html;
}

function callAPI (endpoint, data) {
    console.log ("Calling: " + base + endpoint);
    console.log ("Sending data: " + data);
    var struct = null;
    $.ajax({
        url: base+endpoint,
        data: data,
        type: 'GET',
        headers: {Authorization: 'Basic cmVzdHVzZXI6d0sleURKTXFUPzdHbkJaSw=='},
        jsonp: false,
        xhrFields: {withCredentials: true},
        async: false,
        success: function (data) {
            struct = data;
        }
    });
    return struct;
}

function loadLibrary(lib_id) {
    working_lib = lib_id;
    lib = callAPI ("library/" + lib_id, "");
    tree = "";
    $.each(lib, function(row) {
        tree += makeTree(lib[row].grade, lib[row].book_id);
    });
    $("#tree_view").html(tree);
    $(".expandable_tree").on("click", function() {
        $(this).next().slideToggle();
    });
    $("#book_header").click(function (e) {
        if ($(this).next().hasClass("tree_level")) {
            $(this).next().slideToggle();
        } else {
            console.log("Loading book...");
            book_id = $(this).data("book_id");
            struct = callAPI ("library/book/" + book_id);
            book = struct[book_id];
            book_html = ""
            book_html += "<div class='tree-level'><div style='margin-left:10px;' class='expandable_tree'>" + book.name + "</div>";
            book_html += makeTree(header, book_id, book.structure, offset=2);
            book_html += "</div>";
            console.log(book_html);
            $(this).append(book_html);
            $(this).next().slideToggle();
        }
    });

    $(".selectable_resource").on("click", function(e) {
        console.log($(this).data("url"));
    });
}

function makeBookTree (header, book_id) {
    html += "";
    html = "<div data-book_id='" + book_id + "' class='expandable_tree book_header'>" + header + "</div>";
    return html;
}
function makeTree (header, book_id, struct=0, offset=0) {
    html = "";
    if (struct == 0) {
        return "";
    } else {
        html += "<div class='tree-level'>";
        $.each(struct, function(i) {
            if (struct[i].children !== undefined) {
                html += "<div style='margin-left: "+(10*offset)+"px' class = 'expandable_tree'>"+struct[i].title +"</div>";
                html += makeTree(header, book_id, struct[i].children, offset+1);
            } else {
                resource_html += makeResourceTree(struct[i].id, offset+1);
                var res_class = "";
                if (resource_html == "") res_class = "";
                else res_class = "expandable_tree";
                html += "<div style='margin-left: "+(10*offset)+"px' class = '" + res_class + "'>"+struct[i].title +"</div>";
                html += resource_html;
            }
        });
        html += "</div>"
    }
    return html;
}
function makeResourceTree (package_id, offset) {
    resources = callAPI("resources", {"package_id": package_id});
    if (resources.length < 1) {
        return "";
    }
    html = "<div class='tree-level'>";
    $.each(resources, function(i) {
       html += "<div style='margin-left: " + (10*offset) + "px' class='selectable_resource' data-url='"+resources[i].url+"'>"+resources[i].title+"</div>";
    });
    html += "</div>";
    return html;
}

function apiTest() {
    $.ajax({
      type: 'GET',
      url: 'https://cms-dev.edplancms.com/api/v1/libraries',
      dataType: 'jsonp',
      async: false,
      headers: {
          'Authorization': "Basic " + btoa('restuser' + ":" + 'wK%yDJMqT?7GnBZK')
      },
      data: "",
      success: function(result) {
          alert(result);
      }
    });
}

</script>