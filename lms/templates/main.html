<%!
    from django.utils.translation import ugettext as _
    from django.utils import html
    from django.core.urlresolvers import reverse
    from student.models import State, District, School, User, UserProfile
    from organization.models import OrganizationMetadata, OrganizationDistricts, OrganizationDashboard, OrganizationMenu, OrganizationMenuitem, OrganizationFooter, Nologindesign, DesignMenu, DesignFooter
%>
<%namespace name='static' file='static_content.html'/>

% if context.get("curr_user"):
    <% curr_user=context.get("curr_user") %>
% else:
    <% curr_user=user %>
% endif
<%  
    if request.path == "/":
        path = ""
    else:
        path = request.path
        
    urlname = ["https://",request.get_host(),path]
    urlname = "".join(urlname)
    new_nologin_flag = "0"
    organization_active = False
    footer = False
    if not request.user.is_authenticated():
        design = ""
        while True:
            for tmp1 in Nologindesign.objects.filter(DesignName=urlname):
                design = tmp1
            if design:
                break
            elif len(urlname)>8:
                a = urlname.rfind('/')
                urlname = urlname[0:a]
            else:
                break
        if design:
            new_nologin_flag = "1"
            organization_obj = design
            design_footer_flag = "0"
            for tmp1 in  DesignMenu.objects.filter(design=design,itemType="Is New Menu"):
                design_menu_flag = tmp1.itemValue
            for tmp1 in DesignMenu.objects.filter(design=design,itemType="Footer Selected"):
                design_footer_flag = tmp1.itemValue

            if design_footer_flag == "1":
                for tmp in DesignFooter.objects.filter(design=design):
                    footer = tmp.DataItem
            
            org_data = {}
            if design_menu_flag == "1":
                for tmp1 in DesignMenu.objects.filter(design=design):
                    org_data[tmp1.itemType] = tmp1.itemValue

    else:
      if request.user.is_authenticated():            
          try:
              state_id = request.user.profile.district.state.id
          except:
              state_id = -1
          try:
              district_id = request.user.profile.district.id
          except:
              district_id = -1
          try:
              school_id = request.user.profile.school.id
          except:
              school_id = -1
              
          organization_obj = OrganizationMetadata()
          if school_id != -1:
              for tmp1 in OrganizationDistricts.objects.filter(OrganizationEnity=school_id, EntityType="School"):
                  organization_obj = tmp1.organization
                  organization_active = True
                  break

          if not organization_active and district_id != -1:
              for tmp1 in OrganizationDistricts.objects.filter(OrganizationEnity=district_id, EntityType="District"):
                  organization_obj = tmp1.organization
                  organization_active = True
                  break
          
          if not organization_active and state_id != -1:
              for tmp1 in OrganizationDistricts.objects.filter(OrganizationEnity=state_id, EntityType="State"):
                  organization_active = True
                  organization_obj = tmp1.organization
                  break
                  
          org_data = {}
          if organization_active:
              org_data["org_id"] = organization_obj.id;
              for tmp1 in OrganizationMenu.objects.filter(organization=organization_obj):
                  org_data[tmp1.itemType] = tmp1.itemValue
              if org_data["Footer Selected"] == "1":
                  footer = OrganizationFooter.objects.get(organization=org_data['org_id']).DataItem
              org_data["PeppTalk"] = ""
              for tmp2 in OrganizationDashboard.objects.filter(organization=organization_obj,itemType='PeppTalk'):
                  org_data["PeppTalk"] = tmp2.itemValue
%>
## Define a couple of helper functions to make life easier when
## embedding theme conditionals into templates. All inheriting
## templates have access to these functions, and we can import these
## into non-inheriting templates via the %namespace tag.
<%def name="theme_enabled()">
  <% return settings.MITX_FEATURES["USE_CUSTOM_THEME"] %>
</%def>

<%def name="stanford_theme_enabled()">
  <% return theme_enabled() and getattr(settings, "THEME_NAME") == "stanford" %>
</%def>

## Convert URLs to absolute if this is being called externally.
<%def name="absolute_url(uri)">
    <% return request.build_absolute_uri(uri) if is_external else uri %>
</%def>

<!DOCTYPE html>
<html>
<head>

  <%block name="title">
    % if stanford_theme_enabled():
      <title>${_("Home")} | class.stanford.edu</title>
    % else:
      ## "edX" should not be translated
<!--@begin:Main module page, change the title-->
<!--@date:2013-11-02-->      
      <title>Pepper</title>
<!--@end-->

      <script type="text/javascript">
        /* immediately break out of an iframe if coming from the marketing website */
        (function(window) {
          if (window.location !== window.top.location) {
            window.top.location = window.location;
          }
        })(this);
      </script>
    % endif
  </%block>

  <script type="text/javascript" src="/jsi18n/"></script>

  <link rel="icon" type="image/x-icon" href="${static.url(settings.FAVICON_PATH)}" />

  <%static:css group='application'/>

  <%static:js group='main_vendor'/>


  <%block name="headextra"/>
  % if theme_enabled():
    <%include file="theme-head-extra.html" />
  % endif

  <!--[if lt IE 9]>
  <script src="${static.url('js/html5shiv.js')}"></script>
  <![endif]-->

  <!--[if lte IE 9]>
  <%static:css group='ie-fixes'/>
  <![endif]-->
  <meta name="path_prefix" content="${MITX_ROOT_URL}">
  <meta name="google-site-verification" content="_mipQ4AtZQDNmbtOkwehQDOgCxUUV2fb_C0b6wbiRHY" />

  % if not course:
    % if theme_enabled():
      <%include file="theme-google-analytics.html" />
    % else:
      <%include file="google_analytics.html" />
    % endif
  % endif

  <%include file="widgets/segment-io.html" />

</head>

% if organization_active:
    % if org_data["PeppTalk"] == "1":
        <%include file="webchat/webslider.html" />
        <%include file="webchat/webvideochat.html" />
        <%include file="webchat/webchat.html" />
    % endif
% endif
<%!
navbar_show_extended=True
%>

<body class="<%block name='bodyclass'/>">

% if theme_enabled():
  <%include file="theme-header.html" />
% elif not suppress_toplevel_navigation:
    % if organization_active and org_data["Is New Menu"] == "1":
        <%include file="navigation_new.html" args="show_extended=navbar_show_extended, organization_obj=organization_obj, org_data=org_data, is_external=False"/>
    % elif new_nologin_flag == "1":
        <%include file="navigation_new2.html" args="show_extended=navbar_show_extended, organization_obj=organization_obj, org_data=org_data, is_external=False"/>
    % else:
        <%include file="navigation.html" args="show_extended=navbar_show_extended, is_external=False"/>
    % endif
% endif
  
<!--@begin:Main module page, change the bottom margin in the body text-->
<!--@date:2013-11-02-->
  % if organization_active and org_data["Is New Menu"] == "1":
    <section class="content-wrapper content-wrapper-fixed" style="padding-bottom: 0;">
  % elif new_nologin_flag == "1":
    <section class="content-wrapper content-wrapper-fixed" style="padding-bottom: 0;">
  % else:
    <section class="content-wrapper" style="padding-bottom: 0;">
  % endif
    ${self.body()}
    <%block name="bodyextra"/>
  </section>
<!--@end-->

% if theme_enabled():
  <%include file="theme-footer.html" />
% elif not suppress_toplevel_navigation:
  <%include file="footer.html" args="alt_footer=footer, is_external=is_external"/>
% endif


  <%static:js group='application'/>
  <%static:js group='module-js'/>
  <%block name="js_extra"/>

</body>
</html>

<%def name="login_query()">${
  "?course_id={0}&enrollment_action={1}".format(
    html.escape(course_id),
    html.escape(enrollment_action)
  ) if course_id and enrollment_action else ""
}</%def>
