## mako
<%namespace name='static' file='static_content.html'/>
<%namespace file='main.html' import="login_query, stanford_theme_enabled, absolute_url"/>
<%page args="show_extended, organization_obj, org_data, is_external" />

<%!
    from django.core.urlresolvers import reverse
    from django.utils.translation import ugettext as _

    # App that handles subdomain specific branding
    import branding
    # app that handles site status messages
    from status.status import get_site_status_msg
    from permissions.utils import check_user_perms
    from django.core.urlresolvers import resolve
    from student.models import State,District,School,User,UserProfile
    from organization.models import OrganizationMetadata, OrganizationDistricts, OrganizationDashboard, OrganizationMenu, OrganizationMenuitem
%>

<%
    base_src = absolute_url("/static/uploads/organization/" + str(org_data['org_id']) + "/")
    org_logos = False
    newMeStyleFlag = 0
    newMeStyleFont = ""
    newMeStyleColor = "#000"
    newMeStyleSize = ""

    #---------------OrganizationMenu
    if org_data.has_key('logo') and org_data['logo'] != "":
        org_logos = True
    if org_data.has_key('organization_logo') and org_data['organization_logo'] != "":
        org_logos = True

    #---------------OrganizationMenuitem
    if org_data.has_key('Is Icon With Text') and org_data['Is Icon With Text'] == "1":
        menu_items = "<ol class='nav-option-ol' style='margin-top:10px !important;'>"
    else:
        menu_items = "<ol class='nav-option-ol' style='margin-top:11px !important;'>"

    for tmp1 in OrganizationMenuitem.objects.filter(organization=organization_obj, ParentID=0):
        if tmp1.isAdmin == 0 or (tmp1.isAdmin == 1 and request.user.is_superuser):
            #---------------Sub Menu
            liClass = ""
            if org_data['Is Icon'] == "1":
                if org_data['Is Icon With Text'] == "1":
                    menu_items_child = "<ul id='admin-dropdown-menu-" + str(tmp1.id) + "' class='admin-dropdown-menu' style='top:66px !important;'>"
                else:
                    menu_items_child = "<ul id='admin-dropdown-menu-" + str(tmp1.id) + "' class='admin-dropdown-menu' style='top:64px !important;'>"
            else:
                menu_items_child = "<ul id='admin-dropdown-menu-" + str(tmp1.id) + "' class='admin-dropdown-menu' style='top:65px !important;'>"

            #---------------
            for tmp2 in OrganizationMenuitem.objects.filter(organization=organization_obj, ParentID=tmp1.id):
                if tmp2.isAdmin == 0 or (tmp2.isAdmin == 1 and request.user.is_superuser):
                    if liClass == "":
                        liClass = " class='pepper-menu-holder'"

                    menu_items_child = menu_items_child + "<li><a href='" + absolute_url(tmp2.Url) + "'>" + tmp2.MenuItem + "</a></li>"

            menu_items_child = menu_items_child + "</ul>"

            tmp1_MenuItem_txt = tmp1.MenuItem

            newMeStyleFont = org_data['Text Font']
            newMeStyleColor = org_data['Text Color']
            newMeStyleSize = org_data['Text Size']

            if org_data['Is Icon'] == "1":
                img_src = base_src + tmp1.Icon

                if org_data['Is Icon With Text'] == "1":
                    newMeStyleFlag = 1
                    newMeStyleFont = org_data['Text Font Icons']
                    newMeStyleColor = org_data['Text Color Icons']
                    newMeStyleSize = org_data['Text Size Icons']
                else:
                    newMeStyleFlag = 2
                    newMeStyleFont = org_data['Text Font Me']
                    newMeStyleColor = org_data['Text Color Me']
                    newMeStyleSize = org_data['Text Size Me']

                tmp_style = " style='font-family:" + org_data['Text Font Icons'] + " !important; color:" + org_data['Text Color Icons'] + "; font-size:" + org_data['Text Size Icons'] + "px !important;'"

                if tmp1_MenuItem_txt == "#Messenger" and not is_external:
                    img_src = "/static/images/ppd-iMessage-default.png"
                    tmp1_MenuItem_txt = "Messenger"
                    icon_a = "<a href='#show_notifications' rel='leanModal' id='show_notifications_link' style='text-decoration:none !important;'>"

                    #---------------icon
                    nav_option_text_top = ""
                    if org_data['Is Icon With Text'] == "1":
                        menu_items_tmp1 = "<li class='nav-option-ol-li' style='margin-left:0;margin-right:" + org_data['Space Betwwen Items'] + "px;'" + liClass + ">" + icon_a + "<table border='0' cellpadding='0' cellspacing='0'>"
                        menu_items_tmp1 = menu_items_tmp1 + "<tr><td height='45' align='center'><img src='" + img_src + "' title='" + tmp1_MenuItem_txt + "' width='45' height='45' />"
                        menu_items_tmp1 = menu_items_tmp1 + "<span class='info_count' style='position:absolute; width:25px; height:20px; text-align:center; top:20px; left:50%; margin-left:-4px; color:#f00;font-weight:bold;font-size:13px;'></span></td></tr>"
                        menu_items_tmp1 = menu_items_tmp1 + "<tr><td height='20'" + tmp_style + ">Messenger</td></tr></table>"

                        nav_option_text_top = "top:0px !important; left:40px !important;"
                    else:
                        menu_items_tmp1 = "<li style='margin:0 " + org_data['Space Betwwen Items'] + "px 0 0;'" + liClass + ">" + icon_a + "<table border='0' cellpadding='0' cellspacing='0'><tr><td height='45' width='45'><img src='" + img_src + "' width='45' height='45'><span class='info_count' style='position:absolute; width:25px; height:20px; text-align:center; top:20px; left:18px; color:#f00;font-weight:bold;font-size:13px;'></span></td></tr><tr><td height='20'></td></tr></table></a>"
                        nav_option_text_top = "top:0px !important; left:40px !important;"

                    menu_items_tmp1 = menu_items_tmp1 + "<div class='nav-option-text' style='" + nav_option_text_top + "'>" + tmp1_MenuItem_txt + "</div>"
                    if liClass != "":
                        menu_items_tmp1 = menu_items_tmp1 + menu_items_childy

                    menu_items_tmp1 = menu_items_tmp1 + "</a></li>"
                else:
                    if liClass == "":
                        icon_a = "<a href='" + absolute_url(tmp1.Url) + "'>"
                    else:
                        icon_a = "<a href='javascript:void(0)' class='pepper-configuration' mid='" + str(tmp1.id) + "'>"

                    #---------------icon
                    nav_option_text_top = ""
                    if org_data['Is Icon With Text'] == "1":
                        menu_items_tmp1 = "<li class='nav-option-ol-li' style='margin-left:0;margin-right:" + org_data['Space Betwwen Items'] + "px;'" + liClass + ">"  + icon_a + "<table border='0' cellpadding='0' cellspacing='0'>"
                        if liClass != "":
                            menu_items_tmp1 = menu_items_tmp1 + "<tr><td height='45' colspan='2' align='center'><img src='" + img_src + "' width='45' height='45'></td></tr>"
                            menu_items_tmp1 = menu_items_tmp1 + "<tr><td height='20' align='center' class1='nav-option-ol-txt'" + tmp_style + ">" + tmp1_MenuItem_txt + "</td><td width='15' style='float:left;font-size:25px; color:" + org_data['Text Color Icons'] + ";'>&#9662;</td></tr></table>"
                        else:
                            menu_items_tmp1 = menu_items_tmp1 + "<tr><td height='45' align='center'><img src='" + img_src + "' width='45' height='45'></td></tr>"
                            menu_items_tmp1 = menu_items_tmp1 + "<tr><td height='20' align='center' class='nav-option-ol-txt'" + tmp_style + ">" + tmp1_MenuItem_txt + "</td></tr></table>"

                        menu_items_tmp1 = menu_items_tmp1 + "</a>"
                        nav_option_text_top = "top:0px !important; left:40px !important;"

                    else:
                        menu_items_tmp1 = "<li style='margin:0 " + org_data['Space Betwwen Items'] + "px 0 0;'" + liClass + ">" + icon_a + "<table border='0' cellpadding='0' cellspacing='0'><tr><td height='45' width='45'><img src='" + img_src + "' width='45' height='45'></td></tr><tr>"
                        if liClass != "":
                            menu_items_tmp1 = menu_items_tmp1 + "<td height='20' align='center' style='font-size:25px; color:" + newMeStyleColor + ";'>&#9662;</td></tr></table>"
                        else:
                            menu_items_tmp1 = menu_items_tmp1 + "<td height='20'></td></tr></table>"

                        menu_items_tmp1 = menu_items_tmp1 + "</a>"
                        nav_option_text_top = "top:0px !important; left:40px !important;"

                    menu_items_tmp1 = menu_items_tmp1 + "<div class='nav-option-text' style='" + nav_option_text_top + "'>" + tmp1_MenuItem_txt + "</div>"
                    if liClass != "":
                        menu_items_tmp1 = menu_items_tmp1 + menu_items_child

                    menu_items_tmp1 = menu_items_tmp1 + "</li>"

            else:
                #---------------text
                if tmp1_MenuItem_txt == "#Messenger" and not is_external:
                    menu_items_tmp1 = "<li class='nav-option-ol-only-txt' style='margin:0 " + org_data['Space Betwwen Items'] + "px 0 0;'><a href='#show_notifications' rel='leanModal' id='show_notifications_link' style='text-decoration:none !important; font-size:" + org_data['Text Size'] + "px !important; color:" + org_data['Text Color'] + " !important; font-family:" + org_data['Text Font'] + " !important;'>Messenger <font style='color:#F5821F'>(<span class='info_count'  style='color:#F5821F;font-weight:bold;font-size:13px;'></span>)</font></a></li>"
                else:
                    tmp_menu_icon = " &#9662;"
                    if liClass == "":
                        text_a = "<a href='" + absolute_url(tmp1.Url) + "' style='font-size:" + org_data['Text Size'] + "px !important; color:" + org_data['Text Color'] + "  !important; font-family:" + org_data['Text Font'] + " !important;'>"
                        tmp_menu_icon = ""
                    else:
                        text_a = "<a href='javascript:void(0)' class='pepper-configuration' mid='" + str(tmp1.id) + "' style='font-size:" + org_data['Text Size'] + "px !important; color:" + org_data['Text Color'] + "  !important; font-family:" + org_data['Text Font'] + " !important;'>"

                    menu_items_tmp1 = "<li class='nav-option-ol-only-txt' style='margin-left:0; margin-right:" + org_data['Space Betwwen Items'] + "px;'>" + text_a +  tmp1.MenuItem + tmp_menu_icon + "</a>"

                    if liClass != "":
                        menu_items_tmp1 = menu_items_tmp1 + menu_items_child

                    menu_items_tmp1 = menu_items_tmp1 + "</li>"

            menu_items = menu_items + menu_items_tmp1

    org_data["menu_items"] = menu_items + "</ol>"
%>

## Provide a hook for themes to inject branding on top.
<%block name="navigation_top" />
<%block cached="False">
    <%
        # print index
        try:
            course_id = course.id
        except:
            # can't figure out a better way to get at a possibly-defined course var
            course_id = None
        site_status_msg = get_site_status_msg(course_id)
    %>
    % if site_status_msg and not is_external:
        <div class="site-status">
            <div class="inner-wrapper">
                <span class="white-error-icon"></span>
                <p>${site_status_msg}</p>
            </div>
        </div>
    % endif
</%block>

<link rel="stylesheet" href="/static/css/admin_ui_controls.css" type="text/css" media="screen" />
<script type="text/javascript" src="/static/js/admin_ui_controls.js"></script>
<script type="text/javascript" src="/static/js/record_time.js"></script>
<script type="text/javascript" src="/static/js/navigation_new.js"></script>
<script type="text/javascript" src="/static/js/string_utils.js"></script>
<link rel="stylesheet" href="/static/css/admin_ui_controls.css" type="text/css" media="screen" />

% if context.get("curr_user"):
    <% curr_user=context.get("curr_user") %>
% else:
    <% curr_user=user %>
% endif
% if not is_external:
    <div id="pepper-logged-in"></div>
% endif

<!--header-->
<header id="pepper-nav" class="pepper-nav pepper-nav-fixed" aria-label="${_('Global Navigation')}" style="background-color: ${org_data['Menu Color']};">
    <!--nav-->
    <nav class="pepper-org">
        <!--sub logo-->

        <h1 class="pepper-logo-wrap">
            <!--@begin:Choose the link of the top logo according user's login status-->
            % if org_data['Is New Menu'] == "1" and org_logos:
                % if org_data.has_key('logo') and org_data['logo'] != "":
                    % if org_data['Logo Url'] != "":
                        <a class="pepper-logo-link" href="${absolute_url(org_data['Logo Url'])}">
                    % else:
                        <a class="pepper-logo-link" href="#">
                    % endif
                    <img class="pepper-logo" src="${base_src}${org_data['logo']}" /></a>
                % endif
                % if org_data.has_key('organization_logo') and org_data['organization_logo'] != "":
                    % if org_data['Organization Logo Url'] != "":
                        <a class="pepper-logo-link" href="${absolute_url(org_data['Organization Logo Url'])}">
                    % else:
                        <a class="pepper-logo-link" href="#">
                    %endif
                    <img class="pepper-logo" src="${base_src}${org_data['organization_logo']}" /></a>
                %endif
            % else:
                <a href="${absolute_url('/dashboard')}">
                <%block name="navigation_logo">
                    <!--@begin:Choose the image of the top logo according to user login status-->
                    % if index != 1:
                        <img class="orig-pepper-logo" src="${absolute_url(branding.get_logo_url(request.META.get('HTTP_HOST')))}" alt="Pepper Home" />
                    % endif
                    <!--@end-->
                </%block>
                </a>
            % endif
        </h1>

        <!--sub userphoto and dropdown menu-->
        <span class="pepper-user">
            <ol>
                <li class="pepper-user-wrap">
                    <span><a href="javascript:void(0)" id="pepper-dropdown">
                        % if newMeStyleFlag == 0:
                        	<table border="0" cellpadding="0" cellspacing="0" style="color:${newMeStyleColor}; font-family:${newMeStyleFont}">
                                <tr>
                                    <td height="45" colspan="2"><img src="${absolute_url(reverse('user_photo',args=[request.user.id]))}" alt="photo" width="45" height="45" style="border:2px solid ${newMeStyleColor} !important; border-radius:50px;"></td>
                                </tr>
                                <tr>
                                	<td height="20" align="right">Me</td>
                                    <td width="20" class="pepper-me-arrow">&#9662;</td>
                                </tr>
                            </table>
                        % else:
                        	<table border="0" cellpadding="0" cellspacing="0" style="color:${newMeStyleColor}; font-size:${newMeStyleSize}px; font-family:${newMeStyleFont}">
                                <tr>
                                    <td height="45" colspan="2"><img src="${absolute_url(reverse('user_photo',args=[request.user.id]))}" alt="photo" width="45" height="45" style="border:2px solid ${newMeStyleColor} !important; border-radius:50px;"></td>
                                </tr>
                                <tr>
                                	<td height="20" align="right">Me</td>
                                    <td width="20" class="pepper-me-arrow">&#9662;</td>
                                </tr>
                            </table>
                        % endif
                  <div class="nav-option-text-left">${request.user.username} </div>
                    </a></span>
                    <ul class="pepper-dropdown-menu-list" id="me-dropdown"> <!-- akogan - added left: inherit to move dropdown pointer under user image -->
                        <li class="pepper-dropdown-menu">
                            <div>
                                <img src="${absolute_url(reverse('user_photo',args=[request.user.id]))}" alt="photo" width="50" height="50" style="border-radius:50px;"/>
                            </div>
                            <div class="pepper-dropdown-menu-drop">
                                <span class="dropdownusername">${ request.user.first_name | h } ${ request.user.last_name | h }</span>
                                <a href="${absolute_url(reverse('user_information',args=[request.user.id]))}">View Profile</a>
                            </div>
                        </li>
                        <%block name="navigation_dropdown_menu_links" >
                            <li><a href="${absolute_url('/static/resource/Pepper_User_Guide.pdf')}" target="_blank">${_("Help")}</a></li>
                        </%block>
                        <li><a href="${absolute_url('/course_credits')}" class="main-link">Course Credits</a></li>
                        <li><a href="${absolute_url(reverse('logout'))}">${_("Log Out")}</a></li>
                    </ul>
                </li>
            </ol>
            <!--unlogin status-->
        </span>

        % if course and not is_external: 
            <script type="text/javascript">                
                $(document).ready(function(){
                    var tmp1 = "<div style=\"text-align:left; padding:5px 0 5px 22px; font-family:'Open Sans',Verdana,Geneva,sans-serif; \">";
                    tmp1 += "<span style='color:#3c3c3c; font-weight:bold; font-size:18px;'>${course.display_org_with_default | h}: </span><span style='color:#646464; font-weight:bold;'>${course.display_number_with_default | h} ${course.display_name_with_default}</span>";
                    tmp1 += "</div>";
                    $(".inner-wrapper").prepend(tmp1);
                    $(".course-tabs").css("paddingTop", "0");
                });
            </script>
        % endif
  		
        % if org_data['Is New Menu'] == "1":
            ${org_data["menu_items"]}
        % endif
    </nav>
</header>

% if course and not is_external:
    <div class="ie-banner">${_('<strong>Warning:</strong> Your browser is not fully supported. We strongly recommend using {chrome_link_start}Chrome{chrome_link_end} or {ff_link_start}Firefox{ff_link_end}.').format(chrome_link_start='<a href="https://www.google.com/intl/en/chrome/browser/" target="_blank">', chrome_link_end='</a>', ff_link_start='<a href="http://www.mozilla.org/en-US/firefox/new/" target="_blank">', ff_link_end='</a>')}</div>
% endif

<%include file="help_modal.html"/>

<!--@begin:show_notifications-->
<!--@date:2014-06-19-->
% if not is_external:
    <section id="show_notifications" class="modal modal-wide" data-id="${request.user.id}" data-name="${request.user.username}" data-fullname="${request.user.first_name} ${request.user.last_name}">
        <div class="inner-wrapper">
            <header>
                <h2>${_("notifications")}</h2>
                <hr/>
            </header>
            <div class="view-all-note">
                <a href="${reverse('notifications')}" id="view_all_note">
                    <div id="view_all_note_text">View All Notifications (0)</div>
                </a>
            </div>
            <div class="info_list"></div>
            <div class="close-modal" id="notifications_close">
                <div class="inner">
                    <p>&#10005;</p>
                </div>
            </div>
        </div>
    </section>
% endif

<!--@begin:show_personalmessage-->
<!--@date:2014-06-30-->
% if not is_external:
    <section id="show_personalmessage" class="modal modal-wide">
        <div class="inner-wrapper">
            <header>
                <h2 class="message_board_full_name">${_("namename")}</h2>
                <hr/>
            </header>
            <div class="message_board_listCon" style="height:350px;overflow-y:auto;overflow-x:hidden;"><div class="message_board_list"></div></div>
            <form id="" method="post">
                <div>
                    <div class="message_board_content" contenteditable="true"><p class="message_board_txt_prompt">Type Your Message Here</p></div>

                    <div class="message_board_max">
                        Maximum to 1000 Characters  (<span id="curr_char_num">0</span>)
                    </div>
                    <div class="message_board">
                        <table width="530" border="0" cellpadding="0" cellspacing="0">
                            <tr height="30">
                                <td width="265" class="message_board_buttons">
                                    <span class="message_board_uploadBtn">
                                        <img src="/static/images/personalmsg_upload.png" width="22" height="22"/>
                                        <span>Add Photos</span>
                                    </span>

                                    <span class="message_board_linkBtn">
                                      <img src="/static/images/personalmsg_link.jpg" width="22" height="22"/>
                                      <span>Link</span>
                                    </span>
                                </td>
                                <td align="right" class="message_board_ftg">
                                    <div class="ftg_button ftg_yellow">Send</div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div id="multiplayer_send_div">
                                        <label><input type="checkbox"/>Send to All Users</label>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <input id="message_board_browseFile" type="file" onchange="message_board_upload_file()"/>
            </form>
            <br/>
            <div class="close-modal" id="message_board_close">
                <div class="inner">
                    <p>&#10005;</p>
                </div>
            </div>
        </div>
    </section>
    <div class="linkwin">
        <h3><b>Insert Hyperlink</b></h3>
        <hr/>
        <form>
            <table>
                <tr>
                    <td>Insert URL:</td>
                    <td><input type="text" id="link_url_val"></td>
                </tr>
                <tr>
                    <td width="100">Title:</td>
                    <td width="350"><input id="link_title_val" type="text"></td>
                </tr>
            </table>
            <input id="hyperlink_okBtn" type="button" value="OK">
            <input id="hyperlink_cancelBtn" type="button" value="Cancel">
        </form>
    </div>
% endif
<!--@end-->

<!-- task panel -->
% if not is_external and (request.user.is_superuser or check_user_perms(request.user, 'time_report')):
    <div class="global_task_panel_wrapper">
        <div class="control global_task_panel">
            <input type="button" name="" value="? running tasks" class="task_pannel_toggle"/>
            <div class="content"></div>
            <textarea class="setting">
                {
                  	"interval": 5000,
                 	"sources": [{
                    "tasks": "${reverse('pepconn_import_user_tasks')}",
                    "message_formatter": function(task){
                        var name = task.type == 'import' ? 'Import' : 'Email';
                        if(task.error){
                            return name + ' - ERROR (' + task.id + ')';
                        }
                        if(task.type == 'import'){
                           return name + ' - ' + task.filename;
                        }else if(task.type == 'email'){
                           return name + ' - ' + task.total + ' email' + (task.total > 1 ? 's' : '');
                        }
                    },
                    "close": "${reverse('pepconn_task_close')}"
                  },
                  {
                    "tasks": "${reverse('pepconn_course_permission_tasks')}",
                    "message_formatter": function(task){
                        if(task.error){
                            return task.type + ' ERROR (' + task.id + ')';
                        }
                        return task.type;
                    },
                    "close": "${reverse('pepconn_course_permission_task_close')}"
                  }]
                }
            </textarea>
        </div>
    </div>
%endif

<script>
	$(document).on('click', function(event) {
		if (!$(event.target).closest('.admin-menu-holder').length) {
			$(".admin-dropdown-menu").hide();
		} else if ($(event.target).closest(".outside_menu").length) {
			$(".admin-dropdown-menu").hide();
		}
		if($('#user-photo-arrow:hidden')){
			$('#user-photo-arrow').css("visibility", "visible");
		}
	});
	$(document).ready(function(){
		 $(".configuration").click(function(event){
			var e = window.event || event;
			if(e.stopPropagation){
				e.stopPropagation();
			}else{
				e.cancelBubble = true;
			}
			if($('#dropdown').hasClass("active")){
				$('ul.dropdown-menu').removeClass("expanded");
				$('#dropdown').removeClass("active");
			}                        
			var tmp_el = $("#admin-dropdown-menu-" + $(this).attr("mid"));
			if(tmp_el.length > 0){
				if(tmp_el.is(":visible"))
					tmp_el.hide();
				else{
					$(".admin-dropdown-menu").hide();
					tmp_el.show();
				}
			}
		});
	});
    //---------------------Notifications variable-----------------------------------------//

    var interactive_update_window_top = 0;

    //---------------------Message board variable-----------------------------------------//

    var message_people = null;
    var user_info = null;
    var message_board_isload = false;
    var message_board_loadNum = 0;
    var message_board_totalNum = 0;
    var message_board_focus = 0;
    var message_board_maxCharNum = 1000;
    var message_board_hover = 0;

    //---------------------Record time variable-------------------------------------------//

    var courseTimer = null;
    var externalTimer = null;
    RecordTime.firstRun = true;
    var timer_record = false;

    //---------------------Pepper stats refresh-------------------------------------------//

    function pepper_stats_refresh() {
        if (document.URL.indexOf('dashboard') >= 0 || document.URL.indexOf('my_courses') >= 0 || document.URL.indexOf('user_profile') >= 0) {
            $.post("${reverse('get_pepper_stats')}", {
                'user_id': "${request.user.id}"
            }, function(data) {
                $('#all_course_time').html(data.all_course_time);
                $('#collaboration_time').html(data.collaboration_time);
                //hide totle adjustment time
                //$('#totle_adjustment_time').html(data.totle_adjustment_time);
                $('#total_time_in_pepper').html(data.total_time_in_pepper);
                $(".course-time,.course-time-completed").each(function() {
                    var course_id = $(this).attr('course_id');
                    var time_type = $(this).attr('time_type');
                    if (time_type == 'course') {
                        $(this).children('span').html(data.course_times[course_id]);
                    } else {
                        $(this).children('span').html(data.external_times[course_id]);
                    }
                });

                $(".total-course-time").each(function() {
                    var course_id = $(this).attr('course_id');
                    $(this).children('span').html(data.total_course_times[course_id]);
                 });
		   	});
		}
	}
    
    //---------------------Record time (Page switching)----------------------------------//

    function record_time(position) {
        timer_record = false;
        %if request.user.id is not None:
            sessionStorage['user_id'] = "${request.user.id}";
        %endif
        %if course:
            RecordTime.setSessionCourseID("${course.id}");
        %endif
        courseTimer.start();
        RecordTime.coursePosition = position;
        RecordTime.sessionInit();
        var vertical_id = $("#sequence-list li .active").attr("data-id");
        var time = new Date().toISOString();
        var path = RecordTime.getCourseFullPath(document.URL, position);
        var data = {
            'type': 'course_page',
            'user_id': RecordTime.userID,
            'time': time,
            'new_vertical_id': vertical_id,
            'prev_vertical_id': RecordTime.getSessionVerticalId(),
            'prev_time': RecordTime.getSessionTime(),
            'location': path
        };
        if (RecordTime.getSessionVerticalId() != vertical_id) {
            RecordTime.ajaxRecordTime(data, function() {
                RecordTime.setSessionVerticalId(vertical_id);
                RecordTime.setSessionTime(time);
                courseTimer.load();
                timer_record = true;
            });

        } else {
           if (RecordTime.firstRun) {
                RecordTime.ajaxRecordTime(data, function() {
                    RecordTime.setSessionVerticalId(vertical_id);
                    RecordTime.setSessionTime(time);
                    RecordTime.firstRun = false;
                    timer_record = true;
                });
            }
        }
	}
	//---------------------Record time (Course refresh or exit)--------------------------//

	function course_refresh_or_exit() {
		%if request.user.id is not None:
            sessionStorage['user_id'] = "${request.user.id}";
            RecordTime.sessionInit();
        %else:
            RecordTime.setSessionVerticalId('');
            RecordTime.setSessionCourseTime(0);
        %endif
        %if course:
            RecordTime.setSessionCourseID("${course.id}");
        %endif
        //RecordTime.sessionInit();
        if (RecordTime.getSessionVerticalId() != "" && document.URL.indexOf('courseware') < 1 && !timer_record) {
            var data = {
                'type': 'new_page',
                'user_id': RecordTime.userID,
                'time': (new Date()).toISOString(),
                'prev_vertical_id': RecordTime.getSessionVerticalId(),
                'prev_time': RecordTime.getSessionTime()
            };
            RecordTime.ajaxRecordTime(data, function() {
                RecordTime.setSessionVerticalId("");
                RecordTime.setSessionTime("");
				pepper_stats_refresh();
			});
			timer_record = true;
		}
		var verticalId = RecordTime.getSessionVerticalId()||'';
		var time = RecordTime.getSessionCourseTime(RecordTime.getSessionCourseType())||0;
		if(verticalId == '' && time == 0){
			pepper_stats_refresh();
		}
	}

	//---------------------------------------------------------------------------//
	function onfocusEventDelay(e){
		course_refresh_or_exit();
		var is_press_logout = $(document.activeElement).is('.dropdown');
		if (document.URL.indexOf('courseware') < 0) {
			if(courseTimer.loadComplete && !is_press_logout){
				courseTimer.isrun = false;
				courseTimer.create();
			}
		} else {
			if (RecordTime.getSessionVerticalId() == "" && !is_press_logout && timer_record) {
				record_time(RecordTime.coursePosition);
			}
		}
	}
	
	function onblurEventDelay(e){
		var isfocusOut = $(document.activeElement).get(0).tagName!='IFRAME';
		course_refresh_or_exit();
		if (document.URL.indexOf('courseware') < 0) {
			courseTimer.stop();
			courseTimer.save();
		}
		if (RecordTime.getSessionVerticalId() != "" && document.URL.indexOf('courseware') >= 0 && isfocusOut) {
			RecordTime.sessionInit();
			var data = {
				'type': 'new_page',
				'user_id': RecordTime.userID,
				'time': (new Date()).toISOString(),
				'prev_vertical_id': RecordTime.getSessionVerticalId(),
				'prev_time': RecordTime.getSessionTime()
			};
			RecordTime.ajaxRecordTime(data, function () {
				RecordTime.setSessionVerticalId("");
				RecordTime.setSessionTime("");
				courseTimer.load();
			});
			
		}
	}
	$(function() {
		$(window).blur(function(e) {
			setTimeout(function(){onblurEventDelay(e);}, 200);
		});
		$(window).focus(function(e) {
			setTimeout(function(){onfocusEventDelay(e);}, 200);
		});
		$('.dropdown').mouseup(function(e){
			if (document.URL.indexOf('courseware') > 0) {
				if (RecordTime.getSessionVerticalId() != ""){
					setTimeout(function(){onblurEventDelay(null);}, 200); 
				}
			}
			else{
				if(RecordTime.getSessionCourseTime(RecordTime.getSessionCourseType()) > 0){
					setTimeout(function(){onblurEventDelay(null);}, 200);
				}
			}
		});
		course_refresh_or_exit();
		courseTimer = new CourseTimer();
		externalTimer = new ExternalTimer();
		
		
		interactive_update();
		$(".info_count_btn").click(function() {
			interactive_update();
		});

		$(".info_btn").click(function() {
			interactive_update();
		});

		$(".ftg_button").click(function() {
			message_board_saveInfo();
		});

		$(".message_board_uploadBtn").click(function() {
			$("#message_board_browseFile").click();
		});

		$(".message_board_linkBtn").click(function() {
			$(".linkwin").show();
		});

		$("#hyperlink_okBtn").click(function() {
			var content = $(".message_board_content");
			if ($("#link_url_val").val() != '') {
				if (!message_board_focus) {
					content.html("");
					message_board_focus = 1;
				}
				content.html(content.html() + message_board_hyperlinks($("#link_url_val").val(), $("#link_title_val").val()));
				$(".linkwin").hide();
			}
		});

		$("#hyperlink_cancelBtn").click(function() {
			$(".linkwin").hide();
		});

		$("#message_board_close").click(function() {
			$(".linkwin").hide();
			message_board_clearContent();
		});

		//-----------------------------------------------------------------
		$(".message_board_content").focusin(function() {
			if (!message_board_focus) {
				$(this).html("");
				message_board_focus = 1;
			}
		});

		$(".message_board_content").keyup(function(event) {
			message_board_updateMaxCharNum();
		});

		$("#show_personalmessage").hover(function() {
			$("body").css("overflow", "hidden");
			message_board_hover = 1;
		}, function() {
			$("body").css("overflow", "");
			message_board_hover = 0;
		});

		$(".message_board_listCon").scroll(function(event) {
			var scrollTop = $(this).scrollTop();
			var scrollHeight = $(".message_board_list").height();
			var windowHeight = $(this).height();
			/*
			  if((scrollTop + windowHeight == scrollHeight) && message_board_isload)
			  {
			  message_board_getMessage(message_board_loadNum);
			  }
			*/
			if (scrollTop == 0 && message_board_isload) {
				message_board_getMessage(message_board_loadNum);
			}
		});
	});

	function interactive_update_createItem(data) {
		var body = data.body == undefined ? '' : data.body;
		interactive_update_switchType(data);
		if(data.type_community){
			element = $('<table width="530" height="70" border="0" cellpadding="0" cellspacing="0" style="margin:auto;background-color:' + interactive_update_getActivateStyle(data).backgroundColor + ';cursor:pointer;"><tr><td width="76"><div style="width:60px;height:60px;margin-left:5px;margin-top:5px;background:url(/user_photo/' + data.interviewer_id + ');background-size:contain;background-repeat:no-repeat;"></div></td><td width="424"><table width="454" border="0" cellpadding="0" cellspacing="0"><tr height="46"><td style="padding-right:5px;color:#388e9b;font-size:14px;line-height:20px;padding-top:7px;"><div>' + data.type_text + '</div><div style="color:#000;text-overflow:ellipsis;overflow:hidden;width:450px;">' + body + '</div></td></tr><tr height="24"><td style="vertical-align:middle;font-size:12px;color:#aaa;">' + interactive_update_dateFormat(data).full_date + '</td></tr></table></td></tr></table><br/>');
		}
		else{
			element = $('<table width="530" height="70" border="0" cellpadding="0" cellspacing="0" style="margin:auto;background-color:' + interactive_update_getActivateStyle(data).backgroundColor + ';cursor:pointer;"><tr><td width="76"><div style="width:60px;height:60px;margin-left:5px;margin-top:5px;background:url(/user_photo/' + data.interviewer_id + ');background-size:contain;background-repeat:no-repeat;"></div></td><td width="424"><table width="454" border="0" cellpadding="0" cellspacing="0"><tr height="46"><td style="padding-right:5px;color:#388e9b;font-size:14px;line-height:20px;padding-top:7px;"><div>' + data.type_text + '</div><div style="color:#000;text-overflow:ellipsis;overflow:hidden;width:320px;white-space:nowrap;">' + body + '</div></td></tr><tr height="24"><td style="vertical-align:middle;font-size:12px;color:#aaa;">' + interactive_update_dateFormat(data).full_date + '</td></tr></table></td></tr></table><br/>');
		}
		$('.info_list').append(element);
		element.click(function() {
			if (data.activate == 'false') {
				interactive_update_activateItem(data);
			} else {
				interactive_update_openWindow(data)
			}
		});
	}

	function interactive_update_switchType(data) {
		data.type_community = 0;
		switch (data.type) {
			case 'discussion':
				data.type_text = "<b>" + data.interviewer_name + "</b> has added a comment to your discussion topic or comment in course " + data.course_number + ".";
				break;
			case 'portfolio':
				data.type_text = "<b>" + data.interviewer_name + "</b> has commented on " + (data.portfolio_username || 'your') + "'s portfolio in course " + data.course_number + ".";
				break;
			case 'add_network':
				data.type_text = "<b>" + data.interviewer_name + "</b> has added you to their personal network."
				break;
			case 'view_portfolio':
				data.type_text = "<b>" + data.interviewer_name + "</b> is checking out your " + data.course_number + " portfolio."
				break;
			case 'message':
				data.type_text = "Personal Message from <b>" + data.interviewer_name + "</b>"
				break;
			case 'my_chunks':
				data.type_text = "<b>" + data.interviewer_name + "</b> has sent you a chunk of content from course " + data.course_number + ".";
				break;
			default:
				data.type_text = data.subject || data.body;
				data.type_community = 1;
		}
	}

	function interactive_update() {
		datainfo = {};
		$.post("${reverse('get_interactive_update')}", datainfo, function(data) {
			interactive_update_init(data);
		});
	}

	function interactive_update_init(data) {
		$("#view_all_note_text").text("View All Notifications (" + data.count + ")");
		if (data.count > 0) {
			$(".info_btn").hide();
			$(".info_count_btn").show();
			var count = data.count > 999 ? 999 : data.count;
			$(".info_count").text(count);
		}
		$('.info_list').empty();
		for (var i = 0; i < data.results.length; i++) {
			interactive_update_createItem(data.results[i]);
		}
	}

	function fillZero(val) {
		return val < 10 ? '0' + val : val;
	}

	function interactive_update_dateFormat(data) {
		dateinfo = {};
		interval = interactive_update_getTimeInterval(data);
		var darr = new Date(data.date).toString().split(' ');
		var sign = 'am';
		if (interval < 1) {
			dateinfo.date = "Today";
		} else if (interval < 2) {
			dateinfo.date = "Yesterday";
		} else {
			dateinfo.date = darr[1] + " " + darr[2];
		}
		var timeArr = darr[4].substr(0, 5).split(":");
		if (timeArr[0] > 12 && timeArr[0] < 24) {
			timeArr[0] = fillZero(timeArr[0] - 12);
			sign = 'pm';
		}
		var time = timeArr[0] + ":" + timeArr[1] + sign;
		dateinfo.full_date = dateinfo.date + " at " + time;
		dateinfo.time = time;
		return dateinfo;
	}

	function interactive_update_activateItem(data) {
		var user_id = "${request.user.id}";
		$.post("${reverse('set_interactive_update')}", {
			_id: data._id,
			_name: 'activate',
			_value: 'true',
			_user_id: user_id,
			_record_id: data.user_id,
			_ismultiple: data.multiple
		}, function(rdata) {
			interactive_update_openWindow(data);
		});
	}

	function interactive_update_getActivateStyle(data) {
		var notActivateColor = data.user_id != 0 ? "#eeeff4" : "#ffffcc";
		//bcolor=((data.activate=='true')||(interactive_update_getTimeInterval(data)>4&&data.user_id!=0))?'#ffffff':notActivateColor;
		bcolor = data.activate == 'true' ? '#ffffff' : notActivateColor;
		return {
			'backgroundColor': bcolor
		};
	}

	function interactive_update_getTimeInterval(data) {
		var t = new Date();
		var today = new Date(t.getFullYear(), t.getMonth(), t.getDate());
		var d = new Date(data.date);
		var date = new Date(d.getFullYear(), d.getMonth(), d.getDate());
		return parseInt((today - date) / 3600000 / 24);
	}

	function interactive_update_openWindow(data) {
		if (data.type == "message" || data.type == "view_portfolio") {
			$("#show_notifications").hide();
			if ($("#show_personalmessage").css("zIndex") < 10000) {
				$("#show_personalmessage").addClass("leanmodalStyle");
			}
			$("#lean_overlay").show();
			$("#show_personalmessage").show();
			$("#show_personalmessage").find(".close-modal").click(function() {
				$("#show_personalmessage").hide();
				$(".linkwin").hide();
				$("#lean_overlay").hide();
				$(window).scrollTop(interactive_update_window_top);
			})
			message_board_clearContent();
			$("#lean_overlay").click(function() {
				$("#show_personalmessage").hide();
				$(".linkwin").hide();
				$(this).hide();
				$(window).scrollTop(interactive_update_window_top);
			})
			var userInfo = [];
			var data_ele = $("#show_notifications");
			userInfo['message_people'] = {
				id: data.interviewer_id,
				fullname: data.interviewer_fullname,
				name: data.interviewer_name
			};
			userInfo['user'] = {
				id: data_ele.data('id'),
				fullname: data_ele.data('fullname'),
				name: data_ele.data('name')
			};
			message_board(userInfo);
			return 0;
		}
		if (data.location.indexOf("/dashboard") >= 0) {
			window.open(data.location);
			return 0;
		}
		if (data.location.indexOf("/my_coursework") >= 0) {
			var curr_user_id = "${request.user.id}";
			var user_id = data.location.substring(data.location.indexOf("/my_coursework") + 15, data.location.lastIndexOf("/"));
			if (curr_user_id != user_id) {
				window.open(data.location, '_blank');
				return 0;
			}
		}
		if (data.location.indexOf("/my_discussions") >= 0) {
			var curr_user_id = "${request.user.id}";
			var user_id = data.location.substring(data.location.indexOf("/my_discussions") + 16, data.location.indexOf("?"));
			if (curr_user_id != user_id) {
				window.open(data.location, '_blank');
				return 0;
			}
		}
		if (window.location.href.indexOf("/courses") >= 0) {
			var curr_url = "/courses" + window.location.href.split("/courses")[1].split("#")[0];
			var location = data.location.split("#")[0];
			if (curr_url != location) {
				window.open(data.location, '_self');
			} else {
				window.location.href = data.location;
				window.location.reload();
			}
		} else {
			window.open(data.location, '_self');
		}

	}
	//-------------------------message_board---------------------//

	function message_board(_user_info) {
		user_info = _user_info;
		message_people = user_info["message_people"];
		$('.message_item').remove();
		message_board_hideLoadMore();
		message_board_isload = false;
		message_board_loadNum = 0;
		message_board_totalNum = 0;
		message_board_focus = 0;
		message_board_clearContent();
		message_board_multiplayerSend_init();
		message_board_getMessage(message_board_loadNum);
	}

	function message_board_getMessage(skip) {
		message_board_isload = false;
		$.post("${reverse('get_message')}", {
			message_people: message_people.id,
			skip: skip,
			limit: 6
		}, function(data) {
			message_board_init(data)
		});
	}

	function message_board_init(data) {
		message_board_loadNum += 6;
		message_board_totalNum = data.count;
		$(".message_board_full_name").text(message_people.fullname);
		$('.message_board_empty_info').remove();
		if (data.results.length == 0) {
			$('.message_board_list').append('<div class="message_board_empty_info">You do not currently have any messages with ' + message_people.fullname.split(' ')[0] + '.</div>');
		} else {
			$('.message_board_empty_info').remove();
		}
		for (var i = 0; i < data.results.length; i++) {
			message_board_createItem(data.results[i], 1);
		}

		if (message_board_loadNum >= message_board_totalNum) {
			message_board_isload = false;
			message_board_hideLoadMore();
		} else {
			message_board_isload = true;
			message_board_hideLoadMore();
			message_board_showLoadMore();
		}
		$('.message_board_listCon').scrollTop($(".message_board_list").height());
	}

	function message_board_saveInfo() {
		var content = $(".message_board_content");
		var msReturnVal = message_board_multiplayerSend_returnVal();
		var winR = 1;
		if (msReturnVal) {
			winR = confirm("Do you want to send this message to all users?", "Warning");
			if (!winR) {
				return 0;
			}
		}
		if (content.text().length > 0 && content.text().length <= message_board_maxCharNum && message_board_focus && winR) {
			var recipient_id = msReturnVal ? 0 : message_people.id.toString();
			var datainfo = {
				'info': JSON.stringify({
					'sender_id': '${user.id}',
					'recipient_id': recipient_id,
					'date': (new Date()).toISOString(),
					'body': content.html()
				})
			};
			$.post("${reverse('save_message')}", datainfo, function(rdata) {
				if ($(".message_board_list").find('.message_board_empty_info').length > 0) {
					$('.message_board_empty_info').remove();
				}
				message_board_createItem(JSON.parse(datainfo.info));
				$('.message_board_listCon').scrollTop($(".message_board_list").height());
				message_board_updateMaxCharNum();
				var interviewer_id = user_info["user"].id.toString();
				var interviewer_name = user_info["user"].name;
				var interviewer_fullname = user_info["user"].fullname;
				var body = content.text().length > 100 ? content.text().substr(0, 100) : content.text();
				var messageinfo = {
					'info': JSON.stringify({
						'user_id': recipient_id,
						'interviewer_id': interviewer_id,
						'interviewer_name': interviewer_name,
						'interviewer_fullname': interviewer_fullname,
						'type': 'message',
						'body': body,
						'date': (new Date()).toISOString(),
						'activate': 'false'
					})
				};
				$.post("${reverse('save_interactive_update')}", messageinfo, function() {});
				content.html("");
			});
		} else {
			if (content.text().length > message_board_maxCharNum)
				alert('Exceed the maximum number of characters.');
		}
	}

	function message_board_user(data) {
		var userObj = [];
		userObj[message_people.id] = message_people;
		userObj[user_info["user"].id] = user_info["user"];
		return userObj[data.sender_id];
	}

	function message_board_createItem(data, _pos) {
		pos = _pos || 0;
        var user_id = ${request.user.id};
        if (user_id != data.sender_id){
            var element = $('<div class="message_item"><table width="530" border="0" cellpadding="0" cellspacing="0" style="margin:auto;background-color:#fff;font-size:14px;"><tr><td width="76" rowspan="2" style="vertical-align:middle;"><div style="width:50px;height:50px;margin-left:5px;border: 1px solid black;border-radius: 60px;background:url(/user_photo/' + data.sender_id + ');background-size:contain;background-repeat:no-repeat;"/></td><td width="227" height="30" style="color:#388e9b;font-weight:bold;vertical-align:middle;">' + message_board_user(data).name + '</td><td width="227" align="right" style="padding-right:6px;font-size:12px;color:#aaa;vertical-align:middle;">' + interactive_update_dateFormat(data).full_date + '</td></tr><tr><td colspan="2" style="font-size:14px;color:#000;padding-top:2px;padding-right:6px;padding-bottom:8px;line-height:18px;"><div style="word-wrap:break-word;overflow:hidden;width:454px;">' + data.body + '</div></td></tr></table><div style="height:2px;"></div></div>');
        }else{
            var element = $('<div class="message_item"><table width="530" border="0" cellpadding="0" cellspacing="0" style="margin:auto;background-color:#fff;font-size:14px;"><tr><td width="227" align="right" style="padding-right:6px;font-size:12px;color:#aaa;vertical-align:middle;text-align:left;">' + interactive_update_dateFormat(data).full_date + '</td><td width="227" height="30" style="color:#388e9b;font-weight:bold;vertical-align:middle;text-align:right;">' + message_board_user(data).name + '</td><td width="76" rowspan="2" style="vertical-align: middle;padding-left: 10px;"><div style="width:50px;height:50px;margin-right:5px;border: 1px solid black;border-radius: 60px;background:url(/user_photo/' + data.sender_id + ');background-size:contain;background-repeat:no-repeat;"/></td></tr><tr><td colspan="2" style="font-size:14px;color:#000;padding-top:2px;padding-right:6px;padding-bottom:8px;line-height:18px;"><div style="word-wrap:break-word;overflow:hidden;width:454px;">' + data.body + '</div></td></tr></table><div style="height:2px;"></div></div>');
        }
		
		if (pos) {
			$('.message_board_list').prepend(element);
		} else {
			$('.message_board_list').append(element);
		}

	}

	function message_board_changeImg(objImg) {
		var max = 300;
		if (objImg.width > max) {
			var scaling = 1 - (objImg.width - max) / objImg.width;
			objImg.width = objImg.width * scaling;
			objImg.height = objImg.height;
		}
		$('.message_board_listCon').scrollTop($(".message_board_list").height());
	}

	function message_board_upload_file() {
		var fd, files, max_filesize, settings;
		var content = $(".message_board_content");
		max_filesize = 0.5 * 1000 * 1000;
		if (/\.(bmp|gif|jpg|jpeg|png|BMP|GIF|JPG|PNG)$/.test($("#message_board_browseFile")[0].files[0].name)) {
			files = "";
			files = $("#message_board_browseFile")[0].files[0];
			if (files != void 0) {
				if (files.size > max_filesize) {
					files = "";
					alert("File is too large. Max file size is 500 Kb.");
					$("#message_board_browseFile")[0].files = [];
					return false;
				}
			}
			fd = new FormData();
			fd.append('image_file', files);
			settings = {
				type: "POST",
				data: fd,
				processData: false,
				contentType: false,
				async: false,
				success: function(response) {
					if (response == null) {
						alert("Network error. Please try again.");
						return false;
					}
					if (response.success == true) {
						alert("Upload success!");
					} else {
						alert("Upload fail");
					}
					if (!message_board_focus) {
						content.html("");
						message_board_focus = 1;
					}
					content.html(content.html() + "<img src='" + response.file_info + "' onload='message_board_changeImg(this);' alt='[Image loading ...]'> </img>");
					message_board_updateMaxCharNum();
				}
			};
			return $.ajax("${reverse('upload_message_image')}", settings);

		} else {
			alert("The file format is not supported.");
		}
	}

	function message_board_showLoadMore() {
		var element = $('<div class="loadMoreBtn" style="width:530px;height:20px;text-align:center;font-size:14px;padding-top:8px;color:#388e9b;background-color:#EDEFF4;margin:auto;">Load more</div>');
		$('.message_board_list').prepend(element);
	}

	function message_board_hideLoadMore() {
		$(".loadMoreBtn").remove();
	}

	function message_board_updateMaxCharNum() {
		var charNum = $(".message_board_content").text().length;
		var num = charNum > message_board_maxCharNum ? "<font color='#ff0000'>" + charNum + "</font>" : charNum;
		$("#curr_char_num").html(num);
	}

	function message_board_hyperlinks(url, title) {
		//return str.replace(new RegExp("("+"[a-zA-z]+://[^ ]*"+")",'g'),"<a href='$1' target='_blank'>$1</a>");
		if (title == "")
			title = url;
		if (url.indexOf('://') < 0)
			url = "http://" + url;
		return "<a href='" + url + "' target='_blank'>" + title + "</a><br/>";
	}

	function message_board_multiplayerSend_init() {
		var isStaff = "${request.user.is_staff}";
		var ms = $("#multiplayer_send_div");
		ms.find("input").attr("checked", false);
		if (isStaff == "True") {
			ms.show();
		} else {
			ms.hide();
		}
	}

	function message_board_multiplayerSend_returnVal() {
		var msCBox = $("#multiplayer_send_div").find("input");
		return (msCBox.is(":visible") && msCBox.is(":checked")) ? true : false;
	}

	function message_board_clearContent() {
		var content = $('.message_board_content');
		content.html("");
		message_board_updateMaxCharNum();
		$('.message_board_listCon').scrollTop(0);
		content.html("<p class='message_board_txt_prompt'>Type Your Message Here</p>");
	}
	
	function LoadingWinNav(){
        this.$loader = null;
        this.show();
    }
    LoadingWinNav.prototype.show = function () {
        if (!this.$loader) {
            this.$loader = $('<div class="lean-overlay-nav"></div>');
            //this.$loader = $('<div class="lean-overlay"><img class="loading" src="/static/images/loading.gif"></div>');
            this.$loader.appendTo(document.body);
        }
        this.$loader.css('display','block');
    };
    LoadingWinNav.prototype.hide = function () {
        if (this.$loader) {
            this.$loader.remove();
            this.$loader = null;
        }
    };
    var loadwinnav = new LoadingWinNav();

    //------------------organization_get_info
    var organization_data;
    $(function(){
        var flag_main;
        if ($(".mainlogo").length > 0) {
            flag_main = "index";
        } else if ($("#organization_obj").length > 0) {
            flag_main = $("#organization_obj").attr("o_name");
		}
		
		if ($("#organization_obj").attr("o_name") === "report"){
            loadwinnav.hide();
        }
		
		$.post("${reverse('organizational_configuration')}", {flag:"organization_get_info", source:"navigation", flag_main: flag_main}, function (r) {
            if (r.SiteURL_OK){
                if (r.flag_main === "index"){
                    if (r.TopMainLogo) {
                        $(".mainlogo").find("img").attr("src", "/static/uploads/organization/main_page/" + r.TopMainLogo);
                    }
                    if (r.MainLogoText) {
                        $(".maintitle").html(r.MainLogoText);
                    }
                    if (r.BottomMainLogo){
                        $(".sub_div_1").html("<img src='/static/uploads/organization/main_page/" + r.BottomMainLogo + "' width='963' height='225' />");
                    }
                    if (r.MainPageBottomImage) {
                        $(".sub_div_2").html("<img src='/static/uploads/organization/main_page/" + r.MainPageBottomImage + "' />");
                        var tmp_Text = (r.MainPageButtonText) ? r.MainPageButtonText : "Join the Pepper Network!";
                        var tmp_Link = (r.MainPageButtonLink) ? r.MainPageButtonLink : "/contact";
                        $(".sub_div_2").append('<div class="sub_div_2_3_btn"><a class="join_btn" href="' + tmp_Link + '" target="_blank">' + tmp_Text + '</a></div>');
                    } else {
                        if (r.MainPageButtonText){
                            $(".sub_div_2_3_btn").find("a").html(r.MainPageButtonText);
                        }
                        if (r.MainPageButtonLink) {
                            $(".sub_div_2_3_btn").find("a").attr("href", r.MainPageButtonLink);
                        }
                    }
                }
				
				if (r.Success && r.OrganizationOK) {
                    if (r.flag_main === "dashboard") {
						if(r.DistrictType != ""){
							$("#organization_obj_dashboard_district").find("b").html(r.DistrictType + ":");
						}
						if(r.SchoolType != ""){
							$("#organization_obj_dashboard_school").find("b").html(r.SchoolType + ":");
							$("#organization_obj_dashboard_school2").html(r.SchoolType + ":");
						}
                    } else if (r.flag_main === "communities") {
                        $(".mydistrict-button").find("div").html(r.DistrictType + " Communities");
                    } else if (r.flag_main === "pepconn") {
                        $("#District_search").attr("placeholder", "Search " + r.DistrictType);
                        $("#district_table_init").find(".district_code").html(r.DistrictType + " Id");
                        $("#district_table_init").find(".district_name").html(r.DistrictType + " Name");

                        $("#School_district_select").find("option:first").html("Select " + r.DistrictType);
                        $("#School_search").attr("placeholder", "Search " + r.SchoolType);
                        $("#school_table_init").find(".school_code").html(r.SchoolType + " Code");
                        $("#school_table_init").find(".school_name").html(r.SchoolType + " Name");
                        $("#school_table_init").find(".school_district_id").html(r.DistrictType);
                        $("#school_table_init").find(".school_district_two").html(r.DistrictType + " ID");

                        $("#User_district_select").find("option:first").html("Select " + r.DistrictType);
                        $("#User_school_select").find("option:first").html("Select " + r.SchoolType);
                        $("#user_table_init").find(".user_school").html(r.SchoolType);
                        $("#user_table_init").find(".user_district").html(r.DistrictType);

                        $("#Cohort_district_select").find("option:first").html("Select " + r.DistrictType);
                        $("#cohort_table_init").find(".cohort_district_name").html(r.DistrictType + " Name");
                        $("#cohort_table_init").find(".cohort_district_code").html(r.DistrictType + " Code");

                    } else if (r.flag_main === "pepreg") {
                        var tmp_first = $("#district_select").find("option:first");
                        if(tmp_first.val() == ""){
                            tmp_first.html("Select " + r.DistrictType);
                        }
                        $("#organization_pepreg_ds1").text(r.DistrictType + "/" + r.SchoolType + " Training or PD Event");
                        $("#organization_pepreg_d1").text(r.DistrictType + ":");
                        $("#organization_pepreg_s1").text(r.SchoolType + ":");
						
					} else if (r.flag_main === "people") {
                        $("select[name='district_id']").find("option:first").html(r.DistrictType);
                        $("select[name='school_id']").find("option:first").html(r.SchoolType);
						
					} else if (r.flag_main === "report") {
						organization_data = r;
					}
				}
			}
			if ($("#organization_obj").attr("o_name") !== "report") {
				loadwinnav.hide();
			}
		});
	});			
</script>