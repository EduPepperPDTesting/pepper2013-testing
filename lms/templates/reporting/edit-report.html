<%
    from django.utils.translation import ugettext as _
    from django.core.urlresolvers import reverse
    from django.utils.html import escape
%>

<%inherit file="../main.html"/>
<link rel="stylesheet" href="/static/css/reporting.css" type="text/css" media="screen">
<script type="text/javascript" src="/static/js/reporting.js"></script>
<script type="text/javascript" src="/static/js/jquery.sortable.js"></script>

<div id="reporting">
    <div id="back">
        <a href="${reverse('reporting_reports')}" class="up_page"></a>&nbsp;
        <a href="${reverse('reporting_reports')}">
            Back to Reports
        </a>
    </div>
    <form id="report-edit" action="${reverse('reporting_report_save', args=['new' if action == 'new' else report.id])}">
        <div class="edit-block report-name">
            <h2>Report</h2>
            %if action == 'edit':
                <input type="text" name="report_name" value="${report.name}"/>
                <input type="text" name="report_description" class="description" value="${report.description}">
            %else:
                <input type="text" name="report_name" placeholder="Name"/>
                <input type="text" name="report_description" class="description" placeholder="Description">
            %endif
            <input type="hidden" name="csrfmiddlewaretoken" value="${csrf_token}"/>
            <input type="hidden" name="action" value="${action}">
            <input type="button" value="Cancel" class="report-button" id="report-cancel">
            <input type="submit" value="Save" class="report-button" id="report-save" disabled>
            %if action == 'edit':
                %for selected_column in selected_columns:
                    <input type="hidden" value="${loop.index}" class="selected-column" name="selected-column[${view_columns.get(id=selected_column).id}]">
                %endfor
            %endif
            <div id="dirty-message">This report has been changed. You <strong>MUST</strong> click save to keep these changes.</div>
        </div>
        <div class="edit-block view-selector">
            <h2>Select Views</h2>
            %if action == 'new':
                <select class="view-select" name="view[0]">
                    <option value="none">Select...</option>
                    %for view in views:
                        <option value="${view.id}">${view.name}</option>
                    %endfor
                </select>
            %else:
                %for selected_view in selected_views:
                    <select class="view-select" name="view[${loop.index}]">
                        <option value="none">Select...</option>
                        %for view in views:
                            %if selected_view == view.id:
                                <option value="${view.id}" selected>${view.name}</option>
                            %else:
                                <option value="${view.id}">${view.name}</option>
                            %endif
                        %endfor
                    </select>
                %endfor
            %endif
        </div>
        <div class="edit-block column-selector">
            <h2>Select Columns</h2>
            <div id="order-title">Select columns to show in the report:<div>Column order:</div></div>
            %if action == 'edit':
                <ul id="selected-columns">
                    %for selected_column in selected_columns:
                        <li data-id="${view_columns.get(id=selected_column).id}">
                            <img class="move" src="/static/images/icons/move.png">
                            ${view_columns.get(id=selected_column).view.name}.${view_columns.get(id=selected_column).name}
                        </li>
                    %endfor
                </ul>
                <ul>
                %for view_column in view_columns:
                    %if loop.index == first_column:
                        </ul><ul>
                    %endif
                    <li><label>
                    %if view_column.id in selected_columns:
                        <input class="column-check" type="checkbox" name="column[${loop.index}]" value="${view_column.id}" checked="checked"> <span class="column-name">${view_column.view.name}.${view_column.name}</span> - ${view_column.description}
                    %else:
                        <input class="column-check" type="checkbox" name="column[${loop.index}]" value="${view_column.id}"> <span class="column-name">${view_column.view.name}.${view_column.name}</span> - ${view_column.description}
                    %endif
                    </label></li>
                %endfor
                </ul>
            %endif
            <div class="clearfix"></div>
        </div>
        <div class="edit-block where-selector">
            <h2>Select Filters</h2>
            %if action == 'edit':
                %for view_filter in report_filters:
                    <div class="where-row" id="where-row[${loop.index}]">
                    %if view_filter.conjunction:
                        <select class="filter-conjunction" name="filter-conjunction[${loop.index}]">
                            %if view_filter.conjunction == 'AND':
                                <option value="AND" selected>AND</option>
                                <option value="OR">OR</option>
                            %else:
                                <option value="AND">AND</option>
                                <option value="OR" selected>OR</option>
                            %endif
                        </select>
                    %endif
                    <select class="filter-column" name="filter-column[${loop.index}]">
                        %for column in view_columns:
                            %if column.id == view_filter.column.id:
                                <option value="${column.id}" selected>${column.view.name}.${column.name}</option>
                            %else:
                                <option value="${column.id}">${column.view.name}.${column.name}</option>
                            %endif
                        %endfor
                    </select>
                    <select class="filter-operator" name="filter-operator[${loop.index}]">
                        %for possible_operator in possible_operators:
                            %if possible_operator == view_filter.operator:
                                <option value="${possible_operator}" selected>${escape(possible_operator)}</option>
                            %else:
                                <option value="${possible_operator}">${escape(possible_operator)}</option>
                            %endif
                        %endfor
                    </select>
                    <input class="filter-value" type="text" name="filter-value[${loop.index}]" value="${view_filter.value}"/>
                    <input class="plus" name="plus[${loop.index}]" type="button" value="+"/>
                    %if loop.index > 0:
                        <input class="minus" name="minus[${loop.index}]" type="button" value="-"/>
                    %endif
                    </div>
                %endfor
            %else:
                <div class="where-row" id="where-row[0]">
                    <select class="filter-column" name="filter-column[0]">
                    </select>
                    <select class="filter-operator" name="filter-operator[0]">
                        <option value="=">=</option>
                        <option value="!=">!=</option>
                        <option value=">">&gt;</option>
                        <option value="<">&lt;</option>
                        <option value=">=">&gt;=</option>
                        <option value="<=">&lt;=</option>
                    </select>
                    <input class="filter-value" type="text" name="filter-value[0]"/>
                    <input class="plus" name="plus[0]" type="button" value="+"/>
                </div>
            %endif
        </div>
        <div class="edit-block sql-area">
            <h2>SQL Statement</h2>
            <input type="button" value="Edit"/>
            <textarea disabled="disabled"></textarea>
        </div>
    </form>
</div>
<div style="" id="dialog" class="modal">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0">
        <div class="titlebar">
            <h3 class="dialog-title"></h3>

            <div class="close-modal" id="dialog_close">âœ•</div>
        </div>
        <div class="content"></div>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        viewSelect('${reverse('reporting_related_views')}', '${reverse('reporting_view_columns')}');
        filterLines();
        submitHandler('#report-edit', function (data) {
            // TODO: Disabling this for now, since this page isn't done yet. Will redirect to the main reports page for now.
            //window.location = '${reverse('reporting_report', args=['placeholder'])}'.replace('placeholder', data.report_id);
            window.location = '${reverse('reporting_reports')}';
        });
        $('#report-cancel').click(function (e) {
            e.preventDefault();
            window.location = '${reverse('reporting_reports')}';
        });
        columnOrdering();
        dirtyReportHandler();
    });
</script>
