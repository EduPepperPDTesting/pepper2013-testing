<%!
    from django.utils.translation import ugettext as _
    from django.core.urlresolvers import reverse
    from django.utils.html import escape
    import json

    possible_operators = ['=', '!=', '>', '<', '>=', '<=']
%>

<%inherit file="../main.html"/>
<link href="/static/css/reporting.css">
<script type="text/javascript" src="/static/js/reporting.js"></script>

<div class="wrapper">
    <div class="report-name">
        <h2>Report</h2>
        <input type="text" name="report_name" value="Name"/>
        <input type="submit" value="Cancel" class="report-button">
        <input type="submit" value="Save" class="report-button">
        <input type="submit" value="Preview" class="report-button">
    </div>
    <div class="view-selector">
        <h2>Select Views</h2>
        %if action == 'new':
            <select class="view-select" name="view[0]">
                <option value="none">Select...</option>
                %for view in views:
                    <option value="${view.id}">${view.name}</option>
                %endfor
            </select>
        %else:
            <%! x = 0 %>
            %for selected_view in selected_views:
                <select class="view-select" name="view[${x}]">
                    <option value="none">Select...</option>
                    %for view in views:
                        %if selected_view.id == view.id:
                            <option value="${view.id}" selected>${view.name}</option>
                        %else:
                            <option value="${view.id}">${view.name}</option>
                        %endif
                    %endfor
                </select>
                <%! x += 1 %>
            %endfor
        %endif
    </div>
    <div class="column-selector">
        <h2>Select Columns</h2>
        %if action == 'edit':
            <%!
            third_column = math.floor(len(view_columns / 3))
            remainder = len(view_columns) % 3
            first_column = third_column + 1 if remainder > 0 else third_column
            second_column = third_column + 1 if remainder > 1 else third_column
            s = selected_columns.values_list('id', flat=True)
            x = 0
            %>
            <ul>
            %for view_column in view_columns:
                <li><label>
                %if view_column.id in s:
                    <input type="checkbox" name="column[${x}]" value="${view_column.id}" checked="checked"> ${view_column.name} - ${view_column.description}
                %else:
                    <input type="checkbox" name="column[${x}]" value="${view_column.id}"> ${view_column.name} - ${view_column.description}
                %endif
                </label></li>
                <%! x += 1 %>
                %if x == second_column or x == third_column:
                    </ul><ul>
                %endif
            }
            %endfor
            </ul>
        %endif
        <div class="clearfix"></div>
    </div>
    <div class="where-selector">
        <h2>Select Filters</h2>
        %if action == 'edit':
            <%! x = 0 %>
            %for view_filter in filters:
                <div class="where-row" id="where-row[${x}]">
                %if view_filter.conjunction:
                    <select class="filter-conjuntion" name="filter-conjuntion[${x}]">
                        %if view_filter.conjunction == 'AND':
                            <option value="AND" selected>AND</option>
                            <option value="OR">OR</option>
                        %else:
                            <option value="AND">AND</option>
                            <option value="OR" selected>OR</option>
                        %endif
                    </select>
                %endif
                <select class="filter-view" name="filter-view[${x}]">
                    %for column in view_columns:
                        <option value="${column.id}">${column.name}</option>
                    %endfor
                </select>
                <select class="filter-operator" name="filter-operator[${x}]">
                    %for possible_operator in possible_operators:
                        %if possible_operator == view_filter.operator:
                            <option value="${possible_operator}" selected>${escape(possible_operator)}</option>
                        %else:
                            <option value="${possible_operator}">${escape(possible_operator)}</option>
                        %endif
                    %endfor
                </select>
                <input class="filter-value" type="text" name="filter-value[${x}]"/>
                <input class="plus" name="plus[${x}]" type="button" value="+"/>
                %if x > 0:
                    <input class="minus" name="minus[${x}]" type="button" value="-"/>
                %endif
                </div>
            %endfor
        %else:
            <div class="where-row" id="where-row[0]">
                <select class="filter-view" name="filter-view[0]">
                </select>
                <select name="filter-operator[0]">
                    <option value="=">=</option>
                    <option value="!=">!=</option>
                    <option value=">">&gt;</option>
                    <option value="<">&lt;</option>
                    <option value=">=">&gt;=</option>
                    <option value="<=">&lt;=</option>
                </select>
                <input class="filter-value" type="text" name="filter-value[0]"/>
                <input class="plus" name="plus[0]" type="button" value="+"/>
            </div>
        %endif
    </div>
    <div class="sql-area">
        <h2>SQL Statement</h2>
        <input type="button" value="Edit"/>
        <textarea disabled="disabled"></textarea>
    </div>
</div>
<div style="" id="dialog" class="modal">
    <div class="inner-wrapper" style="border:0;border-radius:5px;padding:0">
        <div class="titlebar">
            <h3 class="dialog-title"></h3>

            <div class="close-modal" id="dialog_close">âœ•</div>
        </div>
        <div class="content"></div>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        viewSelect('${reverse('related_views')}', '${reverse('reporting_view_columns')}');
        filterLines();
    });
</script>
