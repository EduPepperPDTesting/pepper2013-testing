<%!
from django.core.urlresolvers import reverse
%>

<%inherit file="/main.html" />

<style type="text/css" media="screen">
 #form1 div.row span{display:inline-block;width:160px;text-align:right;}
 #form1 div.row input,
 #form1 div.row textarea,
 #form1 div.row span{vertical-align:top;}
 #form1 div.row span{padding-top:5px;font-size:9px;}
 #form1 div.row input,
 #form1 div.row span{height:25px;}
 #form1 div.row input{width:190px;}
 #form1 div.row textarea{width:610px;height:200px;}
 #form1 div.section{font-size:18px;width:160px;text-align:right;margin:20px 0;}
 #form1{float:left;}
 #form1 textarea{word-break:break-all;}
 .listbox{display:inline-block;width:300px;height:500px;overflow:auto;white-space:nowrap;border:1px solid grey;}
 .listbox div{line-height:25px;cursor:default;width:auto;padding:2px 5px;}
 .listbox div.hover{background:#999;}
 .listbox div.selected {background:#03c;color:#ccc;min-width:100%;}
</style>
<section class="container clearfix" style="padding-bottom:50px;">
  <div style="font-size:30px;padding-top:20px;"> Metadata </div>
  <div style="float:left;">
    <div style="margin:20px 0 5px 0;">IDPs</div>
    <div id="entityList" class="listbox"></div>
    <br/>
    <input type="button" name="" value="+" onclick="md.add()"/>
    <input type="button" name="" value="-" onclick="md.remove()"/>
    <input type="button" name="" value="Save All" onclick="md.saveAll()"/>
  </div>
  <form id="form1" style="display:none;width:800px">
    <div class="section">IDP</div>
    <div class="row">
      <span class="">Type</span>
      <select id="" name="sso_type" autocomplate="off">
        <option>EasyIEP</option>
        <option>OAuth</option>
        <option>SAML</option>
      </select>
    </div>
    <div class="row">
      <span class="">Name</span>
      <input type="" name="sso_name" value="" style="width:500px;"/>
    </div>
    <div class="row">
      <span class="">Federation Metadata</span>
      <textarea name="sso_metadata" value="" style="width:500px;"></textarea>
    </div>

    
    <!--
    <div class="row">
      <span class="">Entity ID</span>
      <input type="" name="sso_entity_id" value="" style="width:500px;"/>
    </div>
    <div class="row">
      <span>Issuer URL</span>
      <input type="" name="sso_issuer_url" value="" style="width:500px;"/>
    </div>
    <div class="row">
      <span>Single sign-on service URL</span>
      <input type="" name="sso_single_sign_on" value="" style="width:500px;"/>
    </div>
    <div class="row">
      <span>Single sign-out service URL</span>
      <input type="" name="sso_single_sign_out" value="" style="width:500px;"/>
    </div>
    <div class="row">
      <span>Request Schema</span>
      <textarea name="sso_request"></textarea>
    </div>
    <div class="row">
      <span>Response Schema</span>
      <textarea name="sso_response"></textarea>
    </div>
    -->
    <div class="section">Attributes</div>
    <div id="divIdpAttributeMapping"></div>
    <div style="margin-left:145px;padding:5px 0;">
      <input type="button" value="+" onclick="md.addField()"/>
    </div>
  </form>
</section>
<script type="text/javascript">
  function Metadata(){
    var self = this;
    $("#form1").show();
    this.data = [];
    this.list=new ListBox($("#entityList"));
    $("#entityList").bind("beforeChange",function(e,index){
      if(index >= 0)
        self.bufferData(index);
    });
    $("#entityList").bind("change",function(e,index){
      self.showData(self.data[index])
    });
    $("input[name=sso_name]").keyup(function(){
      this.value=$.trim(this.value);
      self.list.getSelectedItems().html(self.name4List(this.value));
    });
    /* $("input[name=sso_entity_id]").keyup(function(){
       this.value=$.trim(this.value);
       self.list.getSelectedItems().html(self.entityID4List(this.value));
       }); */
    $("#form1").find("input,textarea").keyup(function(){
      self.bufferData(self.list.getSelectedIndex());
    });
    this.load();
  }
  Metadata.prototype.bufferData = function(index){
    var self = this;
    var $rows = $("#divIdpAttributeMapping").find("div.row");
    /* var entityID = $("input[name=sso_entity_id]").val(); */
    this.data[index] = {}
    this.data[index]['sso_type'] = $("select[name=sso_type]").val();
    this.data[index]['sso_name'] = $("input[name=sso_name]").val();
    this.data[index]['sso_metadata'] = $("textarea[name=sso_metadata]").val();
    /* this.data[index]['sso_entity_id'] = entityID;
       this.data[index]['sso_issuer_url'] = $("input[name=sso_issuer_url]").val();
       this.data[index]['sso_single_sign_on'] = $("input[name=sso_single_sign_on]").val();
       this.data[index]['sso_single_sign_out'] = $("input[name=sso_single_sign_out]").val();
       this.data[index]['sso_request'] = $("textarea[name=sso_request]").val();
       this.data[index]['sso_response'] = $("textarea[name=sso_response]").val(); */
    if(index >= 0){
      var attributes=[];
      $rows.each(function(){
        attributes.push({
          /* type:$(this).find('select[name=type]').val(), */
          name:$(this).find('input[name=name]').val(),
          map:$(this).find('input[name=map]').val()
        });
      });
      this.data[index]['attributes'] = attributes;
    }
  }
  Metadata.prototype.validateData = function(index){
    var idp = this.data[index];
    var n=0;
    /* if($.trim(idp.sso_entity_id) == ''){
       throw {"message": "SSO Entity ID can't be empty."}
       } */
    /* $.each(this.data, function(i,v){
       if(v.sso_entity_id == idp.sso_entity_id){
       if(++n>1) throw {"message": "Same SSO Entity ID already exists."}
       }
       }); */
    var n=0;
    if($.trim(idp.sso_name) == ''){
      throw {"message": "SSO Name can't be empty."}
    }
    $.each(this.data, function(i,v){
      if(v.sso_name == idp.sso_name){
        if(++n>1) throw {"message": "Same SSO Name already exists."}
      }
    });     
  }
  Metadata.prototype.name4List = function(s){
    if(typeof s != "string")
      s = "";
    else
      s = s.trim();
    if(!s.length)
      s = "(unknown)";
    return s;
  }
  Metadata.prototype.showData = function(d){
    $("#divIdpAttributeMapping").html('');
    $("#form1").find("input,textarea,select").each(function(){
      if(this.name){
        value=d[this.name];
        $(this).val(value || "");
      }
    });
    for(i in d.attributes){
      var a=d.attributes[i];
      var $row=this.addField();
      // $row.find("select[name=type]").val(a.type);
      $row.find("input[name=name]").val(a.name);
      $row.find("input[name=map]").val(a.map);
    }
  }
  Metadata.prototype.load = function(){
    var self=this;
    $.get("${reverse('sso_metadata_all_json')}",function(r){
      self.data = r;
      $.each(r,function(i,e){
        self.list.addItem(self.name4List(e.sso_name));
      });
      self.list.setSelectedIndex(0);
    });
  }
  Metadata.prototype.add = function(){
    this.data.push({});
    this.list.addItem(this.name4List(""));
    this.list.setSelectedIndex(this.data.length-1);
  }
  Metadata.prototype.remove = function(){
    var index = this.list.getSelectedIndex();
    this.data.splice(index, 1);
    this.list.removeItem(index);
    this.list.setSelectedIndex(this.list.getNearestNext(index));
  }
  Metadata.prototype.saveAll = function(){
    this.bufferData(this.list.getSelectedIndex());
    var self = this;
    var ok = true;
    $.each(this.data, function(i){
      try{
        self.validateData(i);
      }catch(e){
        ok = false;
        alert(e.message);
        self.list.setSelectedIndex(i);
        return false;
      }
    });
    if(ok){
      $.post("${reverse('sso_metadata_save')}", {data:JSON.stringify(this.data)}, function(r){
        alert("Save success.")
      });
    }
  }
  Metadata.prototype.addField = function(){
    var $row=$("<div style='text-align:left;' class='row'> \
<span>Name</span> <input type='input' name='name'/> \
<span style='width:auto'>Map To</span> <input type='input' name='map'/> \
<input type='button' style='width:20px;padding:0 5px' value='-' class='btnRemove'/></div>").appendTo($("#divIdpAttributeMapping"));
    var $btnRemove=$row.find(".btnRemove");
    $btnRemove.click(function(){
      $(this).parent().remove();
    });
    return $row;
  }
</script>
<script type="text/javascript">
  function ListBox(el, multi){
    this.multi = multi;
    this.$el = $(el);
  }
  ListBox.prototype.getCount = function(){
    return this.$el.find("div").length;
  }
  ListBox.prototype.getNearestNext = function(index){
    var last = this.getCount() - 1;
    if(index > last) index = last;
    return index;
  }  
  ListBox.prototype.getSelectedIndex = function(){
    return this.$el.find("div").index(this.getSelectedItems());
  }
  ListBox.prototype.validIndex = function(index){
    var valid = index >= 0;
    valid = valid && index < this.getCount();
    return valid;
  }
  ListBox.prototype.setSelectedIndex = function(index){
    if(this.validIndex(index))
      this.$el.find("div").eq(index).click();
  }
  ListBox.prototype.fixItemWidth = function(div){
    $(div).width(this.$el[0].scrollHeight);
  }    
  ListBox.prototype.addItem = function(text,value){
    var self = this;
    value = value || text;
    var $opt = $("<div value=" + value + ">" + text + "</div>").appendTo(this.$el);
    $opt.click(function(){
      var is_new = !self.getSelectedItems().is(this);
      if(is_new){
        self.fixItemWidth(this);
        var index = self.getSelectedIndex();
        self.$el.trigger("beforeChange", [index]);
        if(!self.multi) self.clearSelection();
        $(this).addClass("selected");
        var new_index = self.getSelectedIndex();
        self.$el.trigger("change",[new_index]);
      }
    });
    $opt.hover(function(){
      self.fixItemWidth(this);
      $(this).addClass('hover');
    },function(){
      $(this).removeClass('hover');
    });
  }
  ListBox.prototype.clearSelection = function(){
    this.getSelectedItems().removeClass('selected'); 
  }
  ListBox.prototype.getSelectedItems = function(){
    return this.$el.find("div.selected");
  }
  ListBox.prototype.removeItem = function(index){
    this.$el.find("div").eq(index).remove();
  }
  var md=new Metadata();
</script>
