<%!
    from file_uploader.utils import get_file_url, get_file_name
%>

<link rel="stylesheet" type="text/css" href="/static/css/webchat.css">

<div class="pep_textchat_block">
    <div class="pep_text_container"></div>
</div>
<script type="text/javascript">
$(document).ready(function(){

    $(".pep_textchat_block").on("click", ".pep_textchatheader_container", function(e){

        if(e.target.className === "pep_textchatheader_container" || e.target.className === "pep_header_left"){

            var getId = $(this).find(".pep_header_left").attr("id");
            var chatHeads = JSON.parse(sessionStorage.getItem('chatHeads'));

            if($(this).parents(".pep_text_container").css("bottom") !== "-210px"){
                $(this).parents(".pep_text_container").find(".pep_text_chat").css("display","none");
                $(this).parents(".pep_text_container").find(".pep_textchatfooter_container").css("display","none");
                $(this).parents(".pep_text_container").css("bottom","-210px");

                for (var arrInd in chatHeads){
                    headData = chatHeads[arrInd].substring(0, chatHeads[arrInd].indexOf("|")).replace("`", ",");
                    headData = headData.substring(0, headData.indexOf("`"));
                    console.log("headData="+headData+" getId="+getId+" " +(headData == getId));
                    if(headData == getId){
                        chatHeads[arrInd] = chatHeads[arrInd].substring(0, chatHeads[arrInd].indexOf("``")) + "``1";
                        break;
                    }
                }
            }else{
                $(this).parents(".pep_text_container").find(".pep_text_chat").css("display","inline-block");
                $(this).parents(".pep_text_container").find(".pep_textchatfooter_container").css("display","block");
                $(this).parents(".pep_text_container").css("bottom","0px");

                for (var arrInd in chatHeads){
                    headData = chatHeads[arrInd].substring(0, chatHeads[arrInd].indexOf("|")).replace("`", ",");
                    headData = headData.substring(0, headData.indexOf("`"));
                    if(headData == getId){
                        chatHeads[arrInd] = chatHeads[arrInd].substring(0, chatHeads[arrInd].indexOf("``")) + "``0";
                        break;
                    }
                }

            }
            sessionStorage.setItem('chatHeads', JSON.stringify(chatHeads));
        }
    });

    $(".pep_textchat_block").on("click", ".close-chat", function(){
        var textcont = $(this).parents(".pep_text_container");
        var ind = textcont.index();
        var elCount = $(".pep_text_container:has(.pep_text_panel)").length - 1;
        ind = elCount - ind;
        $($(".pep_text_container:has(.pep_text_panel)").get().reverse()).each(function(i, el){
            if(i < ind){
                var posPrev = $(el).prev().offset();
                var leftX = posPrev.left;
                $(el).css({"right": "", "left": leftX + "px"});
            }
        });
        var getId = $(this).parents(".pep_textchatheader_container").find(".pep_header_left").attr("id");
        var chatHeads = JSON.parse(sessionStorage.getItem('chatHeads'));
        var headData;
        var leftX;
        for (var arrInd in chatHeads){
            headData = chatHeads[arrInd].substring(0, chatHeads[arrInd].indexOf("|")).replace("`", ",");
            headData = headData.substring(0, headData.indexOf("`"));
            if(headData == getId){
                leftX = chatHeads[arrInd].substring(chatHeads[arrInd].indexOf("|")+1, chatHeads[arrInd].indexOf("||"));
                chatHeads.splice(arrInd, 1);
                break;
            }
        }
        var movedHeads=[];
        var itemStart, itemEnd;
        for(var i=0; i<arrInd; i++){
            movedHeads[i]=chatHeads[i];
        }
        for(i - 1; i<chatHeads.length; i++){
            itemStart = chatHeads[i].substring(0, chatHeads[i].indexOf("|")+1);
            itemEnd = chatHeads[i].substring(chatHeads[i].indexOf("||"));
            movedHeads[i] = itemStart + leftX + itemEnd;
            leftX = chatHeads[i].substring(chatHeads[i].indexOf("|")+1, chatHeads[i].indexOf("||"));
        }
        sessionStorage.setItem('chatHeads', JSON.stringify(movedHeads));
        $(this).parents(".pep_text_container").remove();
        return false;
    });


    $(".pep_textchat_block").on("change", ".pep_file_input", function(){
        console.log("pep_file_input");
        $(this).parents("#pep_attachment_form").find("#input_label").css("display", "none");
        $(this).parents("#pep_attachment_form").find("#submit_label").css("display", "inline-block");
    });
     $(".pep_textchat_block").on("click", ".pep_send_image", function(){
        console.log("send_image");
        $.ajax({type: "post", url: "${reverse('chat_attachment', args=[request.user.id, user_id])}", success: function (data) {
            console.log("Success=${Success}");
            if("${Success}" == "True"){
                $("textchat_"+${textchatID}).append(
                    '<div class="pep_file_download"><span>Attachment: </span><a href="${get_file_url(fileObj.attachment)}" target="_blank"><img src="/static/images/document-download.png"> ${get_file_name(fileObj.attachment)}</a></div>'
                );
            }else{
                $("textchat_"+${textchatID}).append(
                    '<div class="pep_file_download"><span>Error. </span><span>${Error}</span> </div>'
                );
            }
        }
        $(this).parents("#pep_attachment_form").find("#submit_label").css("display", "none");
        $(this).parents("#pep_attachment_form").find("#input_label").css("display", "inline-block");
    });

});
</script>